<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KESNNUR - Member Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/toastify-js@1.11.2/src/toastify.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 260px;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: #f8fafc;
        }
        .nav-item {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge.active {
            background: #10b98120;
            color: #10b981;
        }
        .badge.pending {
            background: #f59e0b20;
            color: #f59e0b;
        }
        .badge.inactive {
            background: #ef444420;
            color: #ef4444;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .event-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 4px solid #3b82f6;
        }
        .payment-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 4px solid #10b981;
        }
        .calendar-day {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
        }
        .calendar-day.event {
            background: #3b82f620;
            color: #1e40af;
        }
        .calendar-day.today {
            background: #10b98120;
            color: #065f46;
            font-weight: 600;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .subscription-plan {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }
        .subscription-plan:hover {
            border-color: #3b82f6;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1);
        }
        .subscription-plan.recommended {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            transform: scale(1.05);
        }
        .subscription-plan.recommended .text-gray-600 {
            color: rgba(255, 255, 255, 0.9) !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-6 border-b border-white/20">
            <div class="flex items-center space-x-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i class="fas fa-user text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg">KESNNUR</h1>
                    <p class="text-white/80 text-xs">Member Portal</p>
                </div>
            </div>
        </div>
        
        <div class="p-4">
            <!-- DASHBOARD -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4">
                Dashboard
            </div>
            <div class="nav-item active" data-section="dashboard">
                <i class="fas fa-home mr-3"></i>
                My Dashboard
            </div>
            
            <!-- MY PROFILE -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                My Profile
            </div>
            <div class="nav-item" data-section="profile">
                <i class="fas fa-user-circle mr-3"></i>
                My Profile
            </div>
            <div class="nav-item" data-section="documents">
                <i class="fas fa-file-alt mr-3"></i>
                My Documents
            </div>
            
            <!-- MEMBERSHIP -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Membership
            </div>
            <div class="nav-item" data-section="membership">
                <i class="fas fa-id-card mr-3"></i>
                Membership Card
            </div>
            <div class="nav-item" data-section="payments">
                <i class="fas fa-receipt mr-3"></i>
                Payment History
            </div>
            <div class="nav-item" data-section="subscription">
                <i class="fas fa-sync-alt mr-3"></i>
                Subscription Plans
            </div>
            
            <!-- EVENTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Events
            </div>
            <div class="nav-item" data-section="events">
                <i class="fas fa-calendar-alt mr-3"></i>
                Events Calendar
            </div>
            <div class="nav-item" data-section="my-events">
                <i class="fas fa-clipboard-check mr-3"></i>
                My Registrations
            </div>
            
            <!-- RESOURCES -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Resources
            </div>
            <div class="nav-item" data-section="resources">
                <i class="fas fa-book mr-3"></i>
                Resources Library
            </div>
            <div class="nav-item" data-section="announcements">
                <i class="fas fa-bullhorn mr-3"></i>
                Announcements
            </div>
            
            <!-- SUPPORT -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Support
            </div>
            <div class="nav-item" data-section="support">
                <i class="fas fa-question-circle mr-3"></i>
                Help & Support
            </div>
        </div>
        
        <!-- User Info -->
        <div class="p-4 border-t border-white/20 mt-auto">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <p class="font-medium" id="userName">Loading...</p>
                    <p class="text-white/60 text-sm" id="memberId">Loading...</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="p-6 border-b bg-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Member Dashboard</h1>
                    <p class="text-gray-600" id="welcomeMessage">Welcome back</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600" id="membershipStatus">
                        <span class="badge pending">Pending Payment</span>
                    </div>
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="p-2 text-gray-600 hover:text-gray-800 relative">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="p-6" id="contentArea">
            <!-- Loading spinner -->
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading your dashboard...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Complete Payment</h3>
                    <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="bg-blue-50 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium" id="selectedPlanName">Student Plan</p>
                                <p class="text-sm text-gray-600" id="selectedPlanPrice">KSh 100/month</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Amount Due</p>
                                <p class="text-xl font-bold text-blue-600" id="paymentAmount">KSh 100</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-700 mb-3">Payment Method</h4>
                        <div class="space-y-2">
                            <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="selectPaymentMethod('mpesa')">
                                <div class="flex items-center flex-1">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-mobile-alt text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium">M-Pesa</p>
                                        <p class="text-sm text-gray-600">Pay via M-Pesa</p>
                                    </div>
                                </div>
                                <input type="radio" name="paymentMethod" id="mpesa" class="h-4 w-4 text-blue-600" checked>
                            </div>
                            
                            <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="selectPaymentMethod('bank')">
                                <div class="flex items-center flex-1">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-university text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium">Bank Transfer</p>
                                        <p class="text-sm text-gray-600">Direct bank deposit</p>
                                    </div>
                                </div>
                                <input type="radio" name="paymentMethod" id="bank" class="h-4 w-4 text-blue-600">
                            </div>
                        </div>
                    </div>
                    
                    <!-- M-Pesa Instructions -->
                    <div id="mpesaInstructions" class="bg-green-50 rounded-lg p-4 mb-6">
                        <h4 class="font-medium text-green-800 mb-2">M-Pesa Payment Instructions</h4>
                        <ol class="text-sm text-green-700 space-y-1">
                            <li>1. Go to M-Pesa on your phone</li>
                            <li>2. Select Lipa na M-Pesa</li>
                            <li>3. Enter Paybill: <strong>123456</strong></li>
                            <li>4. Enter Account: <strong id="mpesaAccount">Your Member ID</strong></li>
                            <li>5. Enter Amount: <strong id="mpesaAmount">KSh 100</strong></li>
                            <li>6. Enter your M-Pesa PIN</li>
                        </ol>
                    </div>
                    
                    <!-- Bank Instructions -->
                    <div id="bankInstructions" class="bg-blue-50 rounded-lg p-4 mb-6 hidden">
                        <h4 class="font-medium text-blue-800 mb-2">Bank Transfer Instructions</h4>
                        <div class="text-sm text-blue-700 space-y-2">
                            <div>
                                <p class="font-medium">Bank Details:</p>
                                <p>Bank: KCB Bank</p>
                                <p>Account Name: KESNNUR</p>
                                <p>Account Number: 1234567890</p>
                                <p>Branch: Nairobi Main</p>
                            </div>
                            <div>
                                <p class="font-medium">Reference:</p>
                                <p>Use: <strong id="bankReference">Your Member ID</strong></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 mb-2">Transaction Code/Receipt Number *</label>
                        <input type="text" id="transactionCode" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Enter M-Pesa code or bank slip number" required>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closePaymentModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="processPayment()" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                            <i class="fas fa-check-circle mr-2"></i>Confirm Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.11.2/src/toastify.min.js"></script>
    <script>
        // Configuration
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        // Initialize Supabase client
        let supabaseClient = null;
        let currentUser = null;
        let currentMember = null;
        let selectedPlan = null;
        
        // Show toast notifications
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: type === 'success' ? "#10b981" : type === 'error' ? "#ef4444" : "#3b82f6",
                },
                stopOnFocus: true,
            }).showToast();
        }
        
        // Initialize Supabase
        function initSupabase() {
            if (!supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }
        
        // Check authentication state
        async function checkAuth() {
            try {
                // Initialize Supabase
                const supabase = initSupabase();
                
                // Check for existing session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                    showToast('Authentication error', 'error');
                    window.location.href = 'members.html';
                    return false;
                }
                
                if (!session || !session.user) {
                    console.log('No active session found');
                    window.location.href = 'members.html';
                    return false;
                }
                
                currentUser = session.user;
                
                // Get member data from profiles and members tables
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (!profile) {
                    console.log('No profile found');
                    showToast('Profile not found', 'error');
                    window.location.href = 'members.html';
                    return false;
                }
                
                // Get member record
                const { data: member, error: memberError } = await supabase
                    .from('members')
                    .select('*')
                    .eq('profile_id', currentUser.id)
                    .single();
                
                if (memberError) {
                    console.error('Member error:', memberError);
                    showToast('Member profile not found', 'error');
                    return false;
                }
                
                if (!member) {
                    console.log('No member profile found');
                    showToast('Please complete your member registration', 'error');
                    return false;
                }
                
                // Combine profile and member data
                currentMember = {
                    ...profile,
                    ...member,
                    id: member.id
                };
                
                return true;
                
            } catch (error) {
                console.error('Auth check error:', error);
                showToast('Authentication error: ' + error.message, 'error');
                window.location.href = 'members.html';
                return false;
            }
        }
        
        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Show loading state
                document.getElementById('contentArea').innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-600">Loading your dashboard...</p>
                        </div>
                    </div>
                `;
                
                // Check authentication
                const isAuthenticated = await checkAuth();
                
                if (!isAuthenticated) {
                    return;
                }
                
                // Update user info
                updateUserInfo();
                
                // Setup event listeners
                setupEventListeners();
                
                // Load dashboard
                await loadDashboard();
                
                showToast('Welcome to KESNNUR Member Portal!', 'success');
                
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showToast('Error loading dashboard: ' + error.message, 'error');
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 text-4xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">System Error</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="initializeDashboard()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function updateUserInfo() {
            if (!currentMember) return;
            
            const userName = document.getElementById('userName');
            const memberId = document.getElementById('memberId');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const membershipStatus = document.getElementById('membershipStatus');
            
            if (userName) {
                userName.textContent = 
                    currentMember.first_name && currentMember.last_name 
                        ? `${currentMember.first_name} ${currentMember.last_name}`
                        : currentMember.email || 'Member';
            }
            
            if (memberId) {
                memberId.textContent = currentMember.member_id || 'KESNNUR Member';
            }
            
            if (welcomeMessage) {
                welcomeMessage.textContent = 
                    `Welcome back, ${currentMember.first_name || 'Member'}`;
            }
            
            if (membershipStatus) {
                let badgeClass = 'badge ';
                let statusText = 'Member';
                
                if (currentMember.status === 'active' && currentMember.payment_status === 'paid') {
                    badgeClass += 'active';
                    statusText = 'Active Member';
                } else if (currentMember.payment_status === 'pending') {
                    badgeClass += 'pending';
                    statusText = 'Payment Pending';
                } else if (currentMember.status === 'inactive') {
                    badgeClass += 'inactive';
                    statusText = 'Inactive';
                } else {
                    badgeClass += 'pending';
                    statusText = 'Payment Required';
                }
                
                membershipStatus.innerHTML = `<span class="${badgeClass}">${statusText}</span>`;
            }
        }
        
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Load section
                    loadSection(section);
                });
            });
        }
        
        async function loadSection(section) {
            const contentArea = document.getElementById('contentArea');
            
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return;
            }
            
            // Update page title
            const pageTitles = {
                'dashboard': 'My Dashboard',
                'profile': 'My Profile',
                'documents': 'My Documents',
                'membership': 'Membership Card',
                'payments': 'Payment History',
                'subscription': 'Subscription Plans',
                'events': 'Events Calendar',
                'my-events': 'My Registrations',
                'resources': 'Resources Library',
                'announcements': 'Announcements',
                'support': 'Help & Support'
            };
            
            document.getElementById('pageTitle').textContent = pageTitles[section] || section;
            
            // Show loading
            contentArea.innerHTML = `
                <div class="flex items-center justify-center h-64">
                    <div class="text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading ${pageTitles[section] || section}...</p>
                    </div>
                </div>
            `;
            
            // Load the appropriate section
            switch(section) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'profile':
                    await loadProfile();
                    break;
                case 'membership':
                    await loadMembershipCard();
                    break;
                case 'payments':
                    await loadPaymentHistory();
                    break;
                case 'subscription':
                    await loadSubscriptionPlans();
                    break;
                case 'events':
                    await loadEventsCalendar();
                    break;
                case 'my-events':
                    await loadMyRegistrations();
                    break;
                case 'resources':
                    await loadResources();
                    break;
                case 'announcements':
                    await loadAnnouncements();
                    break;
                case 'support':
                    await loadSupport();
                    break;
                default:
                    await loadComingSoon(section, pageTitles[section] || section);
            }
        }
        
        // MAIN DASHBOARD
        async function loadDashboard() {
            try {
                const supabase = initSupabase();
                
                // Get upcoming events
                const { data: events } = await supabase
                    .from('events')
                    .select('*')
                    .gte('start_date', new Date().toISOString())
                    .order('start_date', { ascending: true })
                    .limit(3);
                
                // Get member's payments
                const { data: payments } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .order('payment_date', { ascending: false })
                    .limit(3);
                
                // Get announcements
                const { data: announcements } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('published_at', { ascending: false })
                    .limit(3);
                
                const isActive = currentMember.status === 'active' && currentMember.payment_status === 'paid';
                const membershipNumber = currentMember.member_id || currentMember.membership_number || 'Not assigned';
                
                document.getElementById('contentArea').innerHTML = `
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 text-white mb-8">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">Welcome to KESNNUR</h2>
                                <p class="text-blue-100">${isActive ? 'Your membership is active!' : 'Complete payment to activate your membership'}</p>
                            </div>
                            <div class="text-4xl">
                                <i class="fas fa-user-shield"></i>
                            </div>
                        </div>
                    </div>
                    
                    ${!isActive ? `
                        <!-- Payment Required Banner -->
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-6 text-white mb-8">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold mb-2">Membership Activation Required</h3>
                                    <p>Your account is pending payment. Activate your membership to access all features.</p>
                                </div>
                                <button onclick="loadSection('subscription')" class="px-6 py-3 bg-white text-yellow-600 rounded-lg font-bold hover:bg-gray-100">
                                    Activate Now
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Left Column - Profile & Quick Stats -->
                        <div class="lg:col-span-1 space-y-6">
                            <!-- Profile Card -->
                            <div class="profile-card">
                                <div class="flex items-center mb-6">
                                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                                        <i class="fas fa-user text-blue-900 text-2xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">${currentMember.first_name} ${currentMember.last_name}</h3>
                                        <p class="text-gray-600">${membershipNumber}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Membership Status</span>
                                        <span class="badge ${isActive ? 'active' : 'pending'}">
                                            ${isActive ? 'Active' : 'Pending Payment'}
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Membership Type</span>
                                        <span class="font-medium">${currentMember.membership_type || 'Not Assigned'}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Member Since</span>
                                        <span class="font-medium">${currentMember.created_at ? new Date(currentMember.created_at).toLocaleDateString() : 'N/A'}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Email</span>
                                        <span class="font-medium">${currentMember.email || 'N/A'}</span>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-3 mt-6">
                                    <button onclick="loadSection('profile')" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-edit mr-2"></i>Edit Profile
                                    </button>
                                    ${!isActive ? `
                                        <button onclick="loadSection('subscription')" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                            <i class="fas fa-bolt mr-2"></i>Activate
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="profile-card">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Stats</h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Events Attended</span>
                                        <span class="font-bold">0</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Certificates</span>
                                        <span class="font-bold">0</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Resources Downloaded</span>
                                        <span class="font-bold">0</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Payments Made</span>
                                        <span class="font-bold">${payments ? payments.length : 0}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column - Events & Announcements -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Upcoming Events -->
                            <div class="profile-card">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-lg font-bold text-gray-800">Upcoming Events</h3>
                                    <button onclick="loadSection('events')" class="text-blue-600 hover:text-blue-800 text-sm">
                                        View All Events
                                    </button>
                                </div>
                                
                                <div class="space-y-4">
                                    ${events && events.length > 0 ? events.map(event => `
                                        <div class="event-card">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h4 class="font-bold text-gray-800">${event.title}</h4>
                                                    <p class="text-gray-600 text-sm mt-1">
                                                        <i class="fas fa-calendar-day mr-2"></i>
                                                        ${new Date(event.start_date).toLocaleDateString()} 
                                                        at ${event.start_date.includes('T') ? new Date(event.start_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'TBA'}
                                                    </p>
                                                    ${event.location ? `
                                                        <p class="text-gray-600 text-sm mt-1">
                                                            <i class="fas fa-map-marker-alt mr-2"></i>${event.location}
                                                        </p>
                                                    ` : ''}
                                                </div>
                                                ${isActive ? `
                                                    <button onclick="registerForEvent('${event.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                                        Register
                                                    </button>
                                                ` : `
                                                    <button onclick="showToast('Please activate your membership to register for events', 'error')" class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg cursor-not-allowed text-sm">
                                                        Register
                                                    </button>
                                                `}
                                            </div>
                                            ${event.description ? `
                                                <p class="text-gray-700 mt-3">${event.description.substring(0, 120)}${event.description.length > 120 ? '...' : ''}</p>
                                            ` : ''}
                                        </div>
                                    `).join('') : `
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-calendar text-3xl mb-3"></i>
                                            <p>No upcoming events scheduled</p>
                                            <p class="text-sm mt-2">Check back later for new events</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Recent Announcements -->
                            <div class="profile-card">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-lg font-bold text-gray-800">Recent Announcements</h3>
                                    <button onclick="loadSection('announcements')" class="text-blue-600 hover:text-blue-800 text-sm">
                                        View All
                                    </button>
                                </div>
                                
                                <div class="space-y-4">
                                    ${announcements && announcements.length > 0 ? announcements.map(announcement => `
                                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                            <h4 class="font-bold text-gray-800">${announcement.title}</h4>
                                            <p class="text-gray-600 text-sm mt-1">
                                                <i class="fas fa-clock mr-2"></i>
                                                ${new Date(announcement.published_at).toLocaleDateString()}
                                            </p>
                                            <p class="text-gray-700 mt-3">${announcement.content.substring(0, 100)}${announcement.content.length > 100 ? '...' : ''}</p>
                                        </div>
                                    `).join('') : `
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-bullhorn text-3xl mb-3"></i>
                                            <p>No announcements yet</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Error loading dashboard: ' + error.message, 'error');
            }
        }
        
        // SUBSCRIPTION PLANS
        async function loadSubscriptionPlans() {
            const monthlyPlans = [
                {
                    id: 'student',
                    name: 'Student Member',
                    price: 100,
                    period: 'month',
                    description: 'For nursing students',
                    features: [
                        'Access to all workshops',
                        '50% event discounts',
                        'Resource library access',
                        'Student networking',
                        'Certificate of membership',
                        'Monthly newsletter'
                    ],
                    recommended: false
                },
                {
                    id: 'novice',
                    name: 'Novice Nurse',
                    price: 300,
                    period: 'month',
                    description: 'For recently graduated nurses',
                    features: [
                        'All student benefits',
                        'Free conference registration',
                        'Mentorship program access',
                        'Leadership training',
                        'Research opportunities',
                        'Professional development'
                    ],
                    recommended: true
                },
                {
                    id: 'professional',
                    name: 'Professional Nurse',
                    price: 2000,
                    period: 'year',
                    description: 'For experienced nurses',
                    features: [
                        'All novice benefits',
                        'Become a mentor',
                        'Council positions',
                        'Speaker opportunities',
                        'Advanced workshops',
                        'Research grants access'
                    ],
                    recommended: false
                }
            ];
            
            const currentPlan = currentMember.membership_type;
            const isActive = currentMember.status === 'active' && currentMember.payment_status === 'paid';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Subscription Plans</h2>
                        <p class="text-gray-600">Choose a plan that fits your needs. Upgrade or downgrade at any time.</p>
                        
                        ${isActive ? `
                            <div class="inline-block mt-4 px-4 py-2 bg-green-100 text-green-800 rounded-full">
                                <i class="fas fa-check-circle mr-2"></i>
                                Your ${currentPlan} subscription is active
                            </div>
                        ` : `
                            <div class="inline-block mt-4 px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                Activate your membership to access all features
                            </div>
                        `}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                        ${monthlyPlans.map(plan => `
                            <div class="subscription-plan ${plan.recommended ? 'recommended' : ''} ${currentPlan === plan.id ? 'border-green-500 border-2' : ''}">
                                ${plan.recommended ? `
                                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                                        <span class="bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold">
                                            MOST POPULAR
                                        </span>
                                    </div>
                                ` : ''}
                                
                                <div class="text-center mb-6 pt-${plan.recommended ? '4' : '0'}">
                                    <h3 class="text-xl font-bold mb-2">${plan.name}</h3>
                                    <p class="text-gray-600 mb-4">${plan.description}</p>
                                    <div class="mb-2">
                                        <span class="text-4xl font-bold">KSh ${plan.price}</span>
                                        <span class="text-gray-600">/${plan.period}</span>
                                    </div>
                                    ${plan.period === 'year' ? `
                                        <p class="text-sm text-gray-500">â‰ˆ KSh ${Math.round(plan.price / 12)}/month</p>
                                    ` : ''}
                                </div>
                                
                                <ul class="space-y-3 mb-8">
                                    ${plan.features.map(feature => `
                                        <li class="flex items-center">
                                            <i class="fas fa-check ${plan.recommended ? 'text-white' : 'text-green-500'} mr-3"></i>
                                            <span>${feature}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                                
                                ${currentPlan === plan.id && isActive ? `
                                    <button class="w-full px-4 py-3 bg-green-100 text-green-700 rounded-lg font-bold cursor-default">
                                        <i class="fas fa-check-circle mr-2"></i>Current Plan
                                    </button>
                                ` : `
                                    <button onclick="selectPlan('${plan.id}', ${plan.price}, '${plan.name}', '${plan.period}')" 
                                            class="w-full px-4 py-3 ${plan.recommended ? 'bg-white text-blue-900 hover:bg-gray-100' : 'bg-blue-600 text-white hover:bg-blue-700'} rounded-lg font-bold">
                                        ${currentPlan === plan.id && !isActive ? 'Activate Now' : 'Select Plan'}
                                    </button>
                                `}
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Payment Information -->
                    <div class="bg-gray-50 rounded-xl p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Payment Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-medium text-gray-700 mb-4">M-Pesa Payment</h4>
                                <div class="bg-white p-4 rounded-lg border border-gray-200">
                                    <ol class="space-y-2 text-sm">
                                        <li>1. Go to M-Pesa on your phone</li>
                                        <li>2. Select <strong>Lipa na M-Pesa</strong></li>
                                        <li>3. Enter Paybill: <strong>123456</strong></li>
                                        <li>4. Account: <strong>${currentMember.member_id || currentMember.id}</strong></li>
                                        <li>5. Enter the amount for your selected plan</li>
                                        <li>6. Enter your M-Pesa PIN</li>
                                        <li>7. Wait for confirmation message</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-medium text-gray-700 mb-4">Bank Transfer</h4>
                                <div class="bg-white p-4 rounded-lg border border-gray-200">
                                    <div class="space-y-3">
                                        <div>
                                            <p class="font-medium">Bank Details:</p>
                                            <p class="text-sm text-gray-600">Bank: KCB Bank</p>
                                            <p class="text-sm text-gray-600">Account Name: KESNNUR</p>
                                            <p class="text-sm text-gray-600">Account Number: 1234567890</p>
                                            <p class="text-sm text-gray-600">Branch: Nairobi Main</p>
                                        </div>
                                        <div>
                                            <p class="font-medium">Reference:</p>
                                            <p class="text-sm text-gray-600">Use: <strong>${currentMember.member_id || currentMember.id}</strong></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                            <p class="text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                After payment, send your transaction details to payments@kesnnur.org for verification.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Select a subscription plan
        function selectPlan(planId, price, name, period) {
            selectedPlan = { planId, price, name, period };
            
            // Update payment modal
            document.getElementById('selectedPlanName').textContent = name;
            document.getElementById('selectedPlanPrice').textContent = `KSh ${price}/${period}`;
            document.getElementById('paymentAmount').textContent = `KSh ${price}`;
            document.getElementById('mpesaAmount').textContent = `KSh ${price}`;
            document.getElementById('mpesaAccount').textContent = currentMember.member_id || currentMember.id;
            document.getElementById('bankReference').textContent = currentMember.member_id || currentMember.id;
            
            // Show payment modal
            document.getElementById('paymentModal').style.display = 'block';
        }
        
        // Select payment method
        function selectPaymentMethod(method) {
            document.getElementById('mpesa').checked = method === 'mpesa';
            document.getElementById('bank').checked = method === 'bank';
            
            if (method === 'mpesa') {
                document.getElementById('mpesaInstructions').classList.remove('hidden');
                document.getElementById('bankInstructions').classList.add('hidden');
            } else {
                document.getElementById('mpesaInstructions').classList.add('hidden');
                document.getElementById('bankInstructions').classList.remove('hidden');
            }
        }
        
        // Close payment modal
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            selectedPlan = null;
            document.getElementById('transactionCode').value = '';
        }
        
        // Process payment
        async function processPayment() {
            const transactionCode = document.getElementById('transactionCode').value.trim();
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').id;
            
            if (!transactionCode) {
                showToast('Please enter transaction code', 'error');
                return;
            }
            
            if (!selectedPlan) {
                showToast('Please select a plan first', 'error');
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                // Generate membership number if first payment
                let membershipNumber = currentMember.member_id;
                if (!membershipNumber) {
                    const year = new Date().getFullYear();
                    const randomNum = Math.floor(Math.random() * 9000) + 1000;
                    membershipNumber = `KESNNUR-${year}-${randomNum}`;
                }
                
                // 1. Create payment record
                const { data: payment, error: paymentError } = await supabase
                    .from('payments')
                    .insert({
                        member_id: currentMember.id,
                        amount: selectedPlan.price,
                        payment_method: paymentMethod,
                        transaction_code: transactionCode,
                        payment_date: new Date().toISOString(),
                        status: 'pending',
                        description: `${selectedPlan.name} Subscription`,
                        payment_type: 'subscription',
                        period: selectedPlan.period
                    })
                    .select()
                    .single();
                
                if (paymentError) throw paymentError;
                
                // 2. Update member status
                const { error: updateError } = await supabase
                    .from('members')
                    .update({
                        payment_status: 'pending',
                        membership_status: 'pending',
                        member_id: membershipNumber,
                        membership_number: membershipNumber,
                        subscription_fee_paid: false,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentMember.id);
                
                if (updateError) throw updateError;
                
                // 3. Update profile status
                const { error: profileError } = await supabase
                    .from('profiles')
                    .update({
                        status: 'pending',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);
                
                if (profileError) throw profileError;
                
                // Close modal and show success
                closePaymentModal();
                showToast('Payment submitted for verification! We\'ll notify you once approved.', 'success');
                
                // Refresh member data
                await checkAuth();
                await loadDashboard();
                
            } catch (error) {
                console.error('Payment error:', error);
                showToast('Error processing payment: ' + error.message, 'error');
            }
        }
        
        // MEMBERSHIP CARD
        async function loadMembershipCard() {
            const today = new Date();
            const expiryDate = new Date();
            expiryDate.setFullYear(today.getFullYear() + 1);
            
            const isActive = currentMember.status === 'active' && currentMember.payment_status === 'paid';
            const membershipNumber = currentMember.member_id || currentMember.membership_number || 'Not assigned';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-8 text-white mb-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h1 class="text-2xl font-bold mb-2">KESNNUR</h1>
                                <p class="text-blue-200">Kenya Students & Novice Nurses</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-blue-200">Member ID</div>
                                <div class="text-xl font-bold">${membershipNumber}</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center mb-8">
                            <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mr-6">
                                <i class="fas fa-user-nurse text-3xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">${currentMember.first_name} ${currentMember.last_name}</h2>
                                <p class="text-blue-200">${currentMember.membership_type || 'Member'}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <div class="text-sm text-blue-200">Member Since</div>
                                <div class="font-medium">${currentMember.created_at ? new Date(currentMember.created_at).toLocaleDateString() : today.toLocaleDateString()}</div>
                            </div>
                            <div>
                                <div class="text-sm text-blue-200">Status</div>
                                <div class="font-bold">${isActive ? 'ACTIVE' : 'PENDING ACTIVATION'}</div>
                            </div>
                        </div>
                        
                        ${!isActive ? `
                            <div class="mt-6 p-4 bg-white/10 rounded-lg">
                                <p class="text-center">
                                    <i class="fas fa-exclamation-circle mr-2"></i>
                                    Complete payment to activate your membership card
                                </p>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${!isActive ? `
                        <div class="text-center mb-8">
                            <button onclick="loadSection('subscription')" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                                <i class="fas fa-bolt mr-2"></i>Activate Membership
                            </button>
                        </div>
                    ` : `
                        <div class="flex justify-center space-x-4 mb-8">
                            <button onclick="printCard()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-print mr-2"></i>Print Card
                            </button>
                            <button onclick="downloadCard()" class="px-6 py-3 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50">
                                <i class="fas fa-download mr-2"></i>Download
                            </button>
                        </div>
                    `}
                    
                    <!-- Membership Benefits -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Membership Benefits</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                <i class="fas fa-calendar-check text-green-600 mr-3"></i>
                                <div>
                                    <p class="font-medium">Event Access</p>
                                    <p class="text-sm text-gray-600">Access to all KESNNUR events</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                <i class="fas fa-book-medical text-blue-600 mr-3"></i>
                                <div>
                                    <p class="font-medium">Resources</p>
                                    <p class="text-sm text-gray-600">Access to nursing resources</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                <i class="fas fa-handshake text-purple-600 mr-3"></i>
                                <div>
                                    <p class="font-medium">Networking</p>
                                    <p class="text-sm text-gray-600">Connect with other nurses</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                <i class="fas fa-graduation-cap text-orange-600 mr-3"></i>
                                <div>
                                    <p class="font-medium">Training</p>
                                    <p class="text-sm text-gray-600">Professional development</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // MY PROFILE
        async function loadProfile() {
            const isActive = currentMember.status === 'active' && currentMember.payment_status === 'paid';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <h2 class="text-xl font-bold text-gray-800">My Profile</h2>
                        </div>
                        
                        <div class="p-6">
                            <form id="profileForm" class="space-y-6">
                                <!-- Personal Information -->
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">Personal Information</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                            <input type="text" id="firstName" value="${currentMember.first_name || ''}" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                            <input type="text" id="lastName" value="${currentMember.last_name || ''}"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contact Information -->
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">Contact Information</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                            <input type="email" value="${currentMember.email || ''}" disabled
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                            <input type="tel" id="phone" value="${currentMember.phone || ''}"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Membership Information -->
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">Membership Information</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Membership Type</label>
                                            <input type="text" value="${currentMember.membership_type || 'Not assigned'}" disabled
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Membership Number</label>
                                            <input type="text" value="${currentMember.member_id || currentMember.membership_number || 'Pending'}" disabled
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Additional Information -->
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">Additional Information</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Institution/Organization</label>
                                            <input type="text" id="institution" value="${currentMember.institution || ''}"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Student ID</label>
                                            <input type="text" id="studentId" value="${currentMember.student_id || ''}"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-4 pt-6 border-t">
                                    <button type="button" onclick="loadSection('dashboard')" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                        Cancel
                                    </button>
                                    <button type="button" onclick="updateProfile()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-save mr-2"></i>Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    ${!isActive ? `
                        <div class="mt-8 p-6 bg-yellow-50 border border-yellow-200 rounded-xl">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-4"></i>
                                <div>
                                    <h4 class="font-bold text-gray-800">Membership Inactive</h4>
                                    <p class="text-gray-600">Your membership is pending activation. Complete payment to access all features.</p>
                                    <button onclick="loadSection('subscription')" class="mt-3 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                                        Activate Membership
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Update profile
        async function updateProfile() {
            try {
                const supabase = initSupabase();
                
                const profileData = {
                    phone: document.getElementById('phone').value,
                    institution: document.getElementById('institution').value,
                    student_id: document.getElementById('studentId').value,
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabase
                    .from('members')
                    .update(profileData)
                    .eq('id', currentMember.id);
                
                if (error) throw error;
                
                // Also update profiles table
                const { error: profileError } = await supabase
                    .from('profiles')
                    .update({
                        phone: profileData.phone,
                        updated_at: profileData.updated_at
                    })
                    .eq('id', currentUser.id);
                
                if (profileError) throw profileError;
                
                // Update currentMember object
                currentMember = { ...currentMember, ...profileData };
                showToast('Profile updated successfully!', 'success');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Error updating profile: ' + error.message, 'error');
            }
        }
        
        // PAYMENT HISTORY
        async function loadPaymentHistory() {
            try {
                const supabase = initSupabase();
                const { data: payments } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .order('payment_date', { ascending: false });
                
                let totalPaid = 0;
                if (payments) {
                    payments.forEach(payment => {
                        if (payment.status === 'completed') {
                            totalPaid += parseFloat(payment.amount || 0);
                        }
                    });
                }
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-blue-100 text-sm">Total Paid</p>
                                        <h3 class="text-2xl font-bold mt-1">KSh ${totalPaid.toLocaleString()}</h3>
                                    </div>
                                    <i class="fas fa-money-bill-wave text-2xl opacity-80"></i>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-green-100 text-sm">Total Transactions</p>
                                        <h3 class="text-2xl font-bold mt-1">${payments ? payments.length : 0}</h3>
                                    </div>
                                    <i class="fas fa-receipt text-2xl opacity-80"></i>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-purple-100 text-sm">Last Payment</p>
                                        <h3 class="text-2xl font-bold mt-1">
                                            ${payments && payments.length > 0 ? new Date(payments[0].payment_date).toLocaleDateString() : 'N/A'}
                                        </h3>
                                    </div>
                                    <i class="fas fa-calendar-check text-2xl opacity-80"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow">
                            <div class="p-6 border-b">
                                <h3 class="text-lg font-bold text-gray-800">Payment History</h3>
                            </div>
                            
                            <div class="p-6">
                                ${payments && payments.length > 0 ? `
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead>
                                                <tr class="bg-gray-50">
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Description</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Method</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Receipt</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${payments.map(payment => `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="px-4 py-3">${new Date(payment.payment_date).toLocaleDateString()}</td>
                                                        <td class="px-4 py-3">${payment.description || 'Subscription Payment'}</td>
                                                        <td class="px-4 py-3 font-medium">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</td>
                                                        <td class="px-4 py-3">
                                                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                ${payment.payment_method || 'N/A'}
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-3">
                                                            <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.status === 'completed' ? 'bg-green-100 text-green-800' : payment.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                                ${payment.status || 'pending'}
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-3">
                                                            ${payment.transaction_code ? `
                                                                <span class="font-mono text-sm">${payment.transaction_code}</span>
                                                            ` : 'N/A'}
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : `
                                    <div class="text-center py-12">
                                        <i class="fas fa-money-bill-wave text-4xl text-gray-300 mb-4"></i>
                                        <p class="text-gray-500">No payment records found</p>
                                        ${currentMember.payment_status !== 'paid' ? `
                                            <button onclick="loadSection('subscription')" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                Make Your First Payment
                                            </button>
                                        ` : ''}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading payments:', error);
                showToast('Error loading payments: ' + error.message, 'error');
            }
        }
        
        // Other sections (simplified for brevity)
        async function loadEventsCalendar() {
            document.getElementById('contentArea').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Events Calendar</h3>
                    <p class="text-gray-600">Coming soon!</p>
                </div>
            `;
        }
        
        async function loadMyRegistrations() {
            document.getElementById('contentArea').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-clipboard-check text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">My Event Registrations</h3>
                    <p class="text-gray-600">Coming soon!</p>
                </div>
            `;
        }
        
        async function loadResources() {
            document.getElementById('contentArea').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-book-medical text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Resources Library</h3>
                    <p class="text-gray-600">Coming soon!</p>
                </div>
            `;
        }
        
        async function loadAnnouncements() {
            document.getElementById('contentArea').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-bullhorn text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Announcements</h3>
                    <p class="text-gray-600">Coming soon!</p>
                </div>
            `;
        }
        
        async function loadSupport() {
            document.getElementById('contentArea').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-question-circle text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Help & Support</h3>
                    <p class="text-gray-600">Coming soon!</p>
                </div>
            `;
        }
        
        async function loadComingSoon(section, title) {
            document.getElementById('contentArea').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-tools text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                    <p class="text-gray-600">This section is coming soon!</p>
                    <button onclick="loadSection('dashboard')" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Back to Dashboard
                    </button>
                </div>
            `;
        }
        
        // Helper functions
        function printCard() {
            window.print();
            showToast('Preparing membership card for printing...', 'info');
        }
        
        function downloadCard() {
            showToast('Downloading membership card...', 'info');
        }
        
        function toggleNotifications() {
            showToast('Notifications feature coming soon!', 'info');
        }
        
        async function logout() {
            try {
                const supabase = initSupabase();
                const { error } = await supabase.auth.signOut();
                
                if (error) throw error;
                
                showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = 'members.html';
                }, 1000);
                
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Error logging out: ' + error.message, 'error');
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target === modal) {
                closePaymentModal();
            }
        };
        
        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        
    </script>
</body>
</html>
