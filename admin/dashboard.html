<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KESNNUR - Complete Management System</title>
    <!-- Local Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom Toast Styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast-success {
            background: #10b981;
        }
        
        .toast-error {
            background: #ef4444;
        }
        
        .toast-info {
            background: #3b82f6;
        }
        
        .toast-warning {
            background: #f59e0b;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        :root {
            --sidebar-width: 280px;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: #f8fafc;
        }
        .nav-item {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            margin: 50px auto;
            max-height: 90vh;
            overflow-y: auto;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge.active {
            background: #10b98120;
            color: #10b981;
        }
        .badge.pending {
            background: #f59e0b20;
            color: #f59e0b;
        }
        .badge.inactive {
            background: #ef444420;
            color: #ef4444;
        }
        .calendar-day {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
        }
        .calendar-day.event {
            background: #3b82f620;
            color: #1e40af;
        }
        .calendar-day.today {
            background: #10b98120;
            color: #065f46;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-6 border-b border-white/20">
            <div class="flex items-center space-x-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i class="fas fa-users text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg">KESNNUR</h1>
                    <p class="text-white/80 text-xs">Management System</p>
                </div>
            </div>
        </div>
        
        <div class="p-4">
            <!-- DASHBOARD -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4">
                Dashboard
            </div>
            <div class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt mr-3"></i>
                Overview
            </div>
            
            <!-- MEMBERSHIP MANAGEMENT -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Membership
            </div>
            <div class="nav-item" data-section="members">
                <i class="fas fa-users mr-3"></i>
                All Members
            </div>
            <div class="nav-item" data-section="add-member">
                <i class="fas fa-user-plus mr-3"></i>
                Add New Member
            </div>
            
            <!-- CHAPTERS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Chapters
            </div>
            <div class="nav-item" data-section="chapters">
                <i class="fas fa-map-marker-alt mr-3"></i>
                Manage Chapters
            </div>
            
            <!-- EVENTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Events
            </div>
            <div class="nav-item" data-section="events">
                <i class="fas fa-calendar-alt mr-3"></i>
                Events Calendar
            </div>
            <div class="nav-item" data-section="add-event">
                <i class="fas fa-calendar-plus mr-3"></i>
                Add Event
            </div>
            
            <!-- FINANCIAL -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Financial
            </div>
            <div class="nav-item" data-section="payments">
                <i class="fas fa-money-bill-wave mr-3"></i>
                Payments
            </div>
            <div class="nav-item" data-section="add-payment">
                <i class="fas fa-plus-circle mr-3"></i>
                Record Payment
            </div>
            
            <!-- COMMUNICATIONS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Communications
            </div>
            <div class="nav-item" data-section="announcements">
                <i class="fas fa-bullhorn mr-3"></i>
                Announcements
            </div>
            
            <!-- REPORTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Reports
            </div>
            <div class="nav-item" data-section="reports">
                <i class="fas fa-chart-bar mr-3"></i>
                Reports
            </div>
            
            <!-- SYSTEM -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                System
            </div>
            <div class="nav-item" data-section="users">
                <i class="fas fa-user-shield mr-3"></i>
                Admin Users
            </div>
        </div>
        
        <!-- User Info -->
        <div class="p-4 border-t border-white/20 mt-auto">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <p class="font-medium" id="userName">Loading...</p>
                    <p class="text-white/60 text-sm" id="userRole">Loading...</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="p-6 border-b bg-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard Overview</h1>
                    <p class="text-gray-600" id="welcomeMessage">Welcome back</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600" id="lastLogin">
                        Last login: Loading...
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="p-6" id="contentArea">
            <!-- Loading spinner -->
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading dashboard...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for forms -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <!-- Modal content will be loaded here -->
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        const ADMIN_ROLES = ['admin', 'super_admin', 'editor'];
        
        // Initialize Supabase client
        let supabaseClient = null;
        let currentUser = null;
        let currentUserProfile = null;
        
        // Custom Toast Function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Initialize Supabase
        function initSupabase() {
            if (!supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }
        
        // Check authentication state
        async function checkAuth() {
            try {
                // Initialize Supabase
                const supabase = initSupabase();
                
                // Check for existing session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                    showToast('Authentication error', 'error');
                    return false;
                }
                
                if (!session || !session.user) {
                    console.log('No active session found');
                    return false;
                }
                
                currentUser = session.user;
                
                // Get user profile from profiles table
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                if (profileError) {
                    console.error('Profile error:', profileError);
                    
                    // If profile doesn't exist, create one
                    const { data: newProfile, error: createError } = await supabase
                        .from('profiles')
                        .insert([{
                            id: session.user.id,
                            email: session.user.email,
                            role: 'admin',
                            first_name: session.user.email.split('@')[0],
                            last_name: '',
                            status: 'active'
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Create profile error:', createError);
                        const basicProfile = {
                            id: session.user.id,
                            email: session.user.email,
                            role: 'admin',
                            first_name: session.user.email.split('@')[0],
                            last_name: '',
                            status: 'active'
                        };
                        currentUserProfile = basicProfile;
                    } else {
                        currentUserProfile = newProfile;
                    }
                    
                    return true;
                }
                
                if (!profile) {
                    console.log('No profile found for user');
                    return false;
                }
                
                // Check if user has admin role
                if (!ADMIN_ROLES.includes(profile.role)) {
                    console.log('User does not have admin role:', profile.role);
                    showToast('Access denied: Admin privileges required', 'error');
                    return false;
                }
                
                currentUserProfile = profile;
                
                // Update last login
                try {
                    await supabase
                        .from('profiles')
                        .update({ 
                            last_login: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentUser.id);
                } catch (updateError) {
                    console.warn('Could not update last login:', updateError);
                }
                
                return true;
                
            } catch (error) {
                console.error('Auth check error:', error);
                showToast('Authentication error: ' + error.message, 'error');
                return false;
            }
        }
        
        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Show loading state
                document.getElementById('contentArea').innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-600">Initializing system...</p>
                        </div>
                    </div>
                `;
                
                // Check authentication
                const isAuthenticated = await checkAuth();
                
                if (!isAuthenticated) {
                    console.log('User not authenticated, redirecting to login...');
                    showToast('Please login to access admin dashboard', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                    return;
                }
                
                // Update user info
                updateUserInfo();
                
                // Setup event listeners
                setupEventListeners();
                
                // Load dashboard
                await loadDashboard();
                
                // Setup auth state listener
                setupAuthListener();
                
                showToast('KESNNUR Management System loaded!', 'success');
                
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showToast('Error loading dashboard: ' + error.message, 'error');
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 text-4xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">System Error</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="initializeDashboard()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Setup auth state listener
        function setupAuthListener() {
            if (window.authListenerSet) return;
            window.authListenerSet = true;
            
            const supabase = initSupabase();
            
            supabase.auth.onAuthStateChange(async (event, session) => {
                switch(event) {
                    case 'SIGNED_OUT':
                        showToast('You have been logged out', 'info');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1000);
                        break;
                        
                    case 'SIGNED_IN':
                        if (session) {
                            currentUser = session.user;
                            await checkAuth();
                            updateUserInfo();
                            showToast('Welcome back!', 'success');
                        }
                        break;
                }
            });
        }
        
        function updateUserInfo() {
            if (!currentUserProfile) return;
            
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const lastLogin = document.getElementById('lastLogin');
            
            if (userName) {
                userName.textContent = 
                    currentUserProfile.first_name && currentUserProfile.last_name 
                        ? `${currentUserProfile.first_name} ${currentUserProfile.last_name}`
                        : currentUserProfile.email || 'User';
            }
            
            if (userRole) {
                userRole.textContent = 
                    (currentUserProfile.role || 'user').replace('_', ' ').toUpperCase();
            }
            
            if (welcomeMessage) {
                welcomeMessage.textContent = 
                    `Welcome back, ${currentUserProfile.first_name || 'Admin'}`;
            }
            
            if (lastLogin) {
                const lastLoginTime = currentUserProfile.last_login 
                    ? new Date(currentUserProfile.last_login).toLocaleString('en-KE')
                    : 'First login';
                
                lastLogin.textContent = `Last login: ${lastLoginTime}`;
            }
        }
        
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Load section
                    loadSection(section);
                });
            });
        }
        
        async function loadSection(section) {
            const contentArea = document.getElementById('contentArea');
            
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                showToast('Session expired, please login again', 'error');
                window.location.href = 'login.html';
                return;
            }
            
            // Update page title
            const pageTitles = {
                'dashboard': 'Dashboard Overview',
                'members': 'All Members',
                'add-member': 'Add New Member',
                'chapters': 'Manage Chapters',
                'events': 'Events Calendar',
                'add-event': 'Add New Event',
                'payments': 'Payments',
                'add-payment': 'Record Payment',
                'announcements': 'Announcements',
                'reports': 'Reports',
                'users': 'Admin Users'
            };
            
            document.getElementById('pageTitle').textContent = pageTitles[section] || section;
            
            // Show loading
            contentArea.innerHTML = `
                <div class="flex items-center justify-center h-64">
                    <div class="text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading ${pageTitles[section] || section}...</p>
                    </div>
                </div>
            `;
            
            // Load the appropriate section
            switch(section) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'members':
                    await loadMembersManager();
                    break;
                case 'add-member':
                    await loadAddMemberForm();
                    break;
                case 'chapters':
                    await loadChaptersManager();
                    break;
                case 'events':
                    await loadEventsManager();
                    break;
                case 'add-event':
                    await loadAddEventForm();
                    break;
                case 'payments':
                    await loadPaymentsManager();
                    break;
                case 'add-payment':
                    await loadAddPaymentForm();
                    break;
                case 'announcements':
                    await loadAnnouncementsManager();
                    break;
                case 'reports':
                    await loadReportsManager();
                    break;
                case 'users':
                    await loadUsersManager();
                    break;
                default:
                    contentArea.innerHTML = '<div class="text-center py-12">Section not found</div>';
            }
        }
        
        // DASHBOARD - OVERVIEW
        async function loadDashboard() {
            try {
                const stats = await loadStats();
                const recentMembers = await getRecentMembers(5);
                const upcomingEvents = await getUpcomingEvents(5);
                
                document.getElementById('contentArea').innerHTML = `
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 text-white mb-8">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">KESNNUR Management System</h2>
                                <p class="text-blue-100">Complete management solution for your organization</p>
                            </div>
                            <div class="text-4xl">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Members</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.members}</h3>
                                    <p class="text-blue-600 text-sm mt-1">
                                        <i class="fas fa-users mr-1"></i>Registered
                                    </p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-lg">
                                    <i class="fas fa-users text-blue-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Active Chapters</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.chapters}</h3>
                                    <p class="text-purple-600 text-sm mt-1">
                                        <i class="fas fa-map-marker-alt mr-1"></i>Locations
                                    </p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-lg">
                                    <i class="fas fa-map-marker-alt text-purple-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Upcoming Events</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.events}</h3>
                                    <p class="text-green-600 text-sm mt-1">
                                        <i class="fas fa-calendar mr-1"></i>Scheduled
                                    </p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-lg">
                                    <i class="fas fa-calendar-alt text-green-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Revenue</p>
                                    <h3 class="text-2xl font-bold text-gray-800">KSh ${stats.revenue.toLocaleString()}</h3>
                                    <p class="text-orange-600 text-sm mt-1">
                                        <i class="fas fa-money-bill-wave mr-1"></i>This Month
                                    </p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-lg">
                                    <i class="fas fa-money-bill-wave text-orange-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Recent Members -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Recent Members</h2>
                                <button onclick="loadSection('members')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${recentMembers.length > 0 ? recentMembers.map(member => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-blue-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${member.first_name} ${member.last_name}</p>
                                            <p class="text-gray-600 text-sm">${member.email} • ${member.chapter || 'No Chapter'}</p>
                                        </div>
                                        <span class="badge ${member.membership_status === 'active' ? 'active' : member.membership_status === 'pending' ? 'pending' : 'inactive'}">
                                            ${member.membership_status || 'pending'}
                                        </span>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-users text-3xl mb-3"></i>
                                        <p>No members yet</p>
                                        <button onclick="loadSection('add-member')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Add your first member
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Upcoming Events -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Upcoming Events</h2>
                                <button onclick="loadSection('events')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${upcomingEvents.length > 0 ? upcomingEvents.map(event => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-calendar text-green-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${event.title}</p>
                                            <p class="text-gray-600 text-sm">
                                                ${new Date(event.start_date).toLocaleDateString()} • ${event.venue || 'TBA'}
                                            </p>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-calendar text-3xl mb-3"></i>
                                        <p>No upcoming events</p>
                                        <button onclick="loadSection('add-event')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Schedule an event
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-xl shadow p-6 mt-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="loadSection('add-member')" class="p-4 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition-colors">
                                <i class="fas fa-user-plus text-blue-900 text-2xl mb-2"></i>
                                <p class="font-medium">Add Member</p>
                            </button>
                            
                            <button onclick="loadSection('add-event')" class="p-4 bg-green-50 rounded-lg text-center hover:bg-green-100 transition-colors">
                                <i class="fas fa-calendar-plus text-green-900 text-2xl mb-2"></i>
                                <p class="font-medium">Add Event</p>
                            </button>
                            
                            <button onclick="loadSection('add-payment')" class="p-4 bg-orange-50 rounded-lg text-center hover:bg-orange-100 transition-colors">
                                <i class="fas fa-money-bill-wave text-orange-900 text-2xl mb-2"></i>
                                <p class="font-medium">Record Payment</p>
                            </button>
                            
                            <button onclick="loadSection('reports')" class="p-4 bg-purple-50 rounded-lg text-center hover:bg-purple-100 transition-colors">
                                <i class="fas fa-chart-bar text-purple-900 text-2xl mb-2"></i>
                                <p class="font-medium">View Reports</p>
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading dashboard: ${error.message}</p>
                        <button onclick="loadDashboard()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        async function loadStats() {
            try {
                const supabase = initSupabase();
                
                // Get member count
                let memberCount = 0;
                try {
                    const { count } = await supabase
                        .from('members')
                        .select('*', { count: 'exact', head: true });
                    memberCount = count || 0;
                } catch (error) {
                    console.warn('Error counting members:', error);
                }
                
                // Get chapters count
                let chapterCount = 0;
                try {
                    const { count } = await supabase
                        .from('chapters')
                        .select('*', { count: 'exact', head: true });
                    chapterCount = count || 0;
                } catch (error) {
                    console.warn('Error counting chapters:', error);
                }
                
                // Get events count
                let eventCount = 0;
                try {
                    const { count } = await supabase
                        .from('events')
                        .select('*', { count: 'exact', head: true })
                        .gte('start_date', new Date().toISOString());
                    eventCount = count || 0;
                } catch (error) {
                    console.warn('Error counting events:', error);
                }
                
                // Get total revenue (this month)
                let totalRevenue = 0;
                try {
                    const firstDay = new Date();
                    firstDay.setDate(1);
                    
                    const { data: payments } = await supabase
                        .from('payments')
                        .select('amount')
                        .eq('payment_status', 'completed')
                        .gte('paid_at', firstDay.toISOString());
                    
                    if (payments) {
                        payments.forEach(payment => {
                            totalRevenue += parseFloat(payment.amount || 0);
                        });
                    }
                } catch (error) {
                    console.warn('Error calculating revenue:', error);
                }
                
                return {
                    members: memberCount,
                    chapters: chapterCount,
                    events: eventCount,
                    revenue: totalRevenue
                };
                
            } catch (error) {
                console.error('Error loading stats:', error);
                return { members: 0, chapters: 0, events: 0, revenue: 0 };
            }
        }
        
        async function getRecentMembers(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('members')
                    .select('*, profiles(*)')
                    .order('created_at', { ascending: false })
                    .limit(limit);
                
                if (!data) return [];
                
                return data.map(member => ({
                    ...member,
                    first_name: member.profiles?.first_name || '',
                    last_name: member.profiles?.last_name || '',
                    email: member.profiles?.email || '',
                    chapter: member.chapter || 'No Chapter'
                }));
            } catch (error) {
                console.error('Error getting recent members:', error);
                return [];
            }
        }
        
        async function getUpcomingEvents(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('events')
                    .select('*')
                    .eq('status', 'published')
                    .gte('start_date', new Date().toISOString())
                    .order('start_date', { ascending: true })
                    .limit(limit);
                return data || [];
            } catch (error) {
                console.error('Error getting upcoming events:', error);
                return [];
            }
        }
        
        // MEMBERS MANAGER
        async function loadMembersManager() {
            try {
                const supabase = initSupabase();
                const { data: members, error } = await supabase
                    .from('members')
                    .select('*, profiles(*)')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading members:', error);
                    showToast('Error loading members: ' + error.message, 'error');
                    return;
                }
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Members Management</h2>
                                <div class="flex space-x-3">
                                    <button onclick="exportMembers()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                        <i class="fas fa-download mr-2"></i>Export
                                    </button>
                                    <button onclick="loadSection('add-member')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-user-plus mr-2"></i>Add Member
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Search and Filters -->
                            <div class="flex flex-wrap gap-4 mb-6">
                                <input type="text" id="searchMembers" placeholder="Search members..." 
                                       class="px-4 py-2 border border-gray-300 rounded-lg flex-1 min-w-[200px]"
                                       onkeyup="filterTable('membersTable')">
                                <select id="filterStatus" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterTable('membersTable')">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="alumni">Alumni</option>
                                </select>
                            </div>
                            
                            <!-- Members Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Name</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Membership</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Chapter</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Joined</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="membersTable">
                                        ${members && members.length > 0 ? members.map(member => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center">
                                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                            <i class="fas fa-user text-blue-900 text-sm"></i>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">${member.profiles?.first_name || ''} ${member.profiles?.last_name || ''}</p>
                                                            <p class="text-sm text-gray-500">${member.profiles?.email || 'N/A'}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <p class="font-medium">${member.membership_number || 'No ID'}</p>
                                                    <p class="text-sm text-gray-500">${member.membership_type || 'N/A'}</p>
                                                </td>
                                                <td class="px-4 py-3">${member.chapter || 'N/A'}</td>
                                                <td class="px-4 py-3">
                                                    <span class="badge ${member.membership_status === 'active' ? 'active' : member.membership_status === 'pending' ? 'pending' : 'inactive'}">
                                                        ${member.membership_status || 'pending'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">${member.join_date ? new Date(member.join_date).toLocaleDateString() : 'N/A'}</td>
                                                <td class="px-4 py-3">
                                                    <div class="flex space-x-2">
                                                        <button onclick="editMember('${member.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button onclick="deleteMember('${member.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="6" class="px-4 py-12 text-center text-gray-500">
                                                    <i class="fas fa-users text-3xl mb-3"></i>
                                                    <p class="text-lg">No members found</p>
                                                    <button onclick="loadSection('add-member')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                        Add Your First Member
                                                    </button>
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="flex justify-between items-center mt-6">
                                <div class="text-sm text-gray-600">
                                    Showing ${members ? members.length : 0} members
                                </div>
                                <div class="text-sm text-gray-600">
                                    <i class="fas fa-database mr-2"></i>Live Database
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading members manager:', error);
                showToast('Error loading members: ' + error.message, 'error');
            }
        }
        
        function filterTable(tableId) {
            const search = document.getElementById('searchMembers').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            const rows = document.querySelectorAll(`#${tableId} tr`);
            
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const status = row.cells[3]?.textContent.toLowerCase() || '';
                
                const matchesSearch = name.includes(search);
                const matchesStatus = !statusFilter || status.includes(statusFilter.toLowerCase());
                
                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            });
        }
        
        // ADD MEMBER FORM
        async function loadAddMemberForm() {
            const supabase = initSupabase();
            const { data: chapters } = await supabase
                .from('chapters')
                .select('id, name, code')
                .order('name');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Add New Member</h2>
                            <button onclick="loadSection('members')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Members
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addMemberForm" class="space-y-6 max-w-2xl">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                                    <input type="text" name="first_name" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                                    <input type="text" name="last_name" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                                    <input type="email" name="email" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input type="tel" name="phone"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Membership Type *</label>
                                    <select name="membership_type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Type</option>
                                        <option value="student">Student</option>
                                        <option value="professional">Professional</option>
                                        <option value="associate">Associate</option>
                                        <option value="alumni">Alumni</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Membership Number</label>
                                    <input type="text" name="membership_number"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="KESNNUR-${new Date().getFullYear()}-001">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Institution</label>
                                    <input type="text" name="institution"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Student ID</label>
                                    <input type="text" name="student_id"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Chapter</label>
                                    <select name="chapter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Chapter</option>
                                        ${chapters ? chapters.map(chapter => `
                                            <option value="${chapter.name}">${chapter.name} (${chapter.code})</option>
                                        `).join('') : ''}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Membership Status</label>
                                    <select name="membership_status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="active">Active</option>
                                        <option value="pending">Pending Approval</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="alumni">Alumni</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('members')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewMember()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Save Member
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        async function addNewMember() {
            try {
                const form = document.getElementById('addMemberForm');
                const formData = new FormData(form);
                const memberData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                // First create profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .insert([{
                        email: memberData.email,
                        first_name: memberData.first_name,
                        last_name: memberData.last_name,
                        phone: memberData.phone,
                        role: 'member',
                        status: 'active'
                    }])
                    .select()
                    .single();
                
                if (profileError) throw profileError;
                
                // Now create member
                const { data, error } = await supabase
                    .from('members')
                    .insert([{
                        profile_id: profile.id,
                        membership_number: memberData.membership_number,
                        membership_type: memberData.membership_type,
                        institution: memberData.institution,
                        student_id: memberData.student_id,
                        chapter: memberData.chapter,
                        membership_status: memberData.membership_status,
                        join_date: new Date().toISOString().split('T')[0]
                    }])
                    .select();
                
                if (error) throw error;
                
                showToast('Member added successfully', 'success');
                setTimeout(() => {
                    loadSection('members');
                }, 1500);
                
            } catch (error) {
                console.error('Error adding member:', error);
                showToast('Error adding member: ' + error.message, 'error');
            }
        }
        
        // CHAPTERS MANAGER
        async function loadChaptersManager() {
            try {
                const supabase = initSupabase();
                const { data: chapters, error } = await supabase
                    .from('chapters')
                    .select('*')
                    .order('name');
                
                if (error) {
                    console.error('Error loading chapters:', error);
                    showToast('Error loading chapters: ' + error.message, 'error');
                    return;
                }
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Chapters Management</h2>
                                <button onclick="showAddChapterModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus mr-2"></i>Add Chapter
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            ${chapters && chapters.length > 0 ? `
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${chapters.map(chapter => `
                                        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                                            <div class="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 class="text-lg font-bold text-gray-800">${chapter.name}</h3>
                                                    <p class="text-gray-600 text-sm mt-1">${chapter.code} • ${chapter.region}</p>
                                                    <p class="text-gray-500 text-sm">${chapter.location || 'Location not specified'}</p>
                                                </div>
                                                <div class="text-blue-600">
                                                    <i class="fas fa-map-marker-alt text-xl"></i>
                                                </div>
                                            </div>
                                            
                                            <div class="space-y-3">
                                                ${chapter.contact_person ? `
                                                    <div class="flex items-center text-gray-600">
                                                        <i class="fas fa-user mr-3"></i>
                                                        <span class="text-sm">${chapter.contact_person}</span>
                                                    </div>
                                                ` : ''}
                                                
                                                ${chapter.contact_email ? `
                                                    <div class="flex items-center text-gray-600">
                                                        <i class="fas fa-envelope mr-3"></i>
                                                        <span class="text-sm">${chapter.contact_email}</span>
                                                    </div>
                                                ` : ''}
                                                
                                                ${chapter.contact_phone ? `
                                                    <div class="flex items-center text-gray-600">
                                                        <i class="fas fa-phone mr-3"></i>
                                                        <span class="text-sm">${chapter.contact_phone}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                                                <span class="px-3 py-1 rounded-full text-xs font-medium ${chapter.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${chapter.status || 'pending'}
                                                </span>
                                                <div class="flex space-x-2">
                                                    <button onclick="editChapter('${chapter.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">
                                                        <i class="fas fa-edit mr-1"></i>Edit
                                                    </button>
                                                    <button onclick="deleteChapter('${chapter.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                                        <i class="fas fa-trash mr-1"></i>Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <i class="fas fa-map-marker-alt text-gray-400 text-5xl mb-4"></i>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">No Chapters Yet</h3>
                                    <p class="text-gray-600 mb-6">Start by adding your first chapter</p>
                                    <button onclick="showAddChapterModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-plus mr-2"></i>Add First Chapter
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading chapters:', error);
                showToast('Error loading chapters: ' + error.message, 'error');
            }
        }
        
        function showAddChapterModal() {
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Add New Chapter</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addChapterForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Chapter Name *</label>
                                <input type="text" name="name" required class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Chapter Code *</label>
                                <input type="text" name="code" required class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Region *</label>
                            <select name="region" required class="w-full px-3 py-2 border rounded">
                                <option value="">Select Region</option>
                                <option value="Nairobi">Nairobi</option>
                                <option value="Coast">Coast</option>
                                <option value="Central">Central</option>
                                <option value="Rift Valley">Rift Valley</option>
                                <option value="Western">Western</option>
                                <option value="Nyanza">Nyanza</option>
                                <option value="Eastern">Eastern</option>
                                <option value="North Eastern">North Eastern</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Location</label>
                            <input type="text" name="location" class="w-full px-3 py-2 border rounded">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Contact Person</label>
                                <input type="text" name="contact_person" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Contact Phone</label>
                                <input type="tel" name="contact_phone" class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Contact Email</label>
                            <input type="email" name="contact_email" class="w-full px-3 py-2 border rounded">
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewChapter()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Save Chapter
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        async function addNewChapter() {
            try {
                const form = document.getElementById('addChapterForm');
                const formData = new FormData(form);
                const chapterData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('chapters')
                    .insert([{
                        name: chapterData.name,
                        code: chapterData.code,
                        region: chapterData.region,
                        location: chapterData.location,
                        contact_person: chapterData.contact_person,
                        contact_phone: chapterData.contact_phone,
                        contact_email: chapterData.contact_email,
                        status: 'active',
                        established_date: new Date().toISOString().split('T')[0]
                    }])
                    .select();
                
                if (error) throw error;
                
                showToast('Chapter added successfully', 'success');
                closeModal();
                loadSection('chapters');
                
            } catch (error) {
                console.error('Error adding chapter:', error);
                showToast('Error adding chapter: ' + error.message, 'error');
            }
        }
        
        // EVENTS MANAGER
        async function loadEventsManager() {
            try {
                const supabase = initSupabase();
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('start_date', { ascending: true });
                
                if (error) {
                    console.error('Error loading events:', error);
                    showToast('Error loading events: ' + error.message, 'error');
                    return;
                }
                
                // Get current month for calendar
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Generate calendar
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                let calendarHTML = '';
                
                // Calendar header
                calendarHTML += '<div class="grid grid-cols-7 gap-2 mb-4">';
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    calendarHTML += `<div class="text-center text-sm font-medium text-gray-500 py-2">${day}</div>`;
                });
                calendarHTML += '</div>';
                
                // Calendar days
                calendarHTML += '<div class="grid grid-cols-7 gap-2">';
                
                // Empty cells for days before the first day of month
                for (let i = 0; i < startingDay; i++) {
                    calendarHTML += '<div class="calendar-day"></div>';
                }
                
                // Days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(currentYear, currentMonth, day);
                    const isToday = day === now.getDate() && currentMonth === now.getMonth() && currentYear === now.getFullYear();
                    const hasEvent = events ? events.some(event => {
                        const eventDate = new Date(event.start_date);
                        return eventDate.getDate() === day && 
                               eventDate.getMonth() === currentMonth && 
                               eventDate.getFullYear() === currentYear;
                    }) : false;
                    
                    let dayClass = 'calendar-day';
                    if (isToday) dayClass += ' today';
                    if (hasEvent) dayClass += ' event';
                    
                    calendarHTML += `
                        <div class="${dayClass}">
                            ${day}
                        </div>
                    `;
                }
                calendarHTML += '</div>';
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Events Calendar</h2>
                                <div class="flex space-x-3">
                                    <button onclick="loadSection('add-event')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-calendar-plus mr-2"></i>Add Event
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Calendar -->
                                <div class="lg:col-span-2">
                                    <div class="mb-6">
                                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                                            ${now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                        </h3>
                                        ${calendarHTML}
                                    </div>
                                    
                                    <!-- Upcoming Events -->
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800 mb-4">Upcoming Events</h3>
                                        ${events && events.length > 0 ? events.filter(event => 
                                            new Date(event.start_date) >= new Date() && event.status === 'published'
                                        ).slice(0, 5).map(event => `
                                            <div class="border border-gray-200 rounded-lg p-4 mb-3 hover:bg-gray-50">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <h4 class="font-medium text-gray-800">${event.title}</h4>
                                                        <p class="text-sm text-gray-600 mt-1">
                                                            <i class="fas fa-calendar-day mr-2"></i>
                                                            ${new Date(event.start_date).toLocaleDateString()} 
                                                            ${event.start_date.includes('T') ? ' at ' + new Date(event.start_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                                                        </p>
                                                        ${event.venue ? `
                                                            <p class="text-sm text-gray-600 mt-1">
                                                                <i class="fas fa-map-marker-alt mr-2"></i>${event.venue}
                                                            </p>
                                                        ` : ''}
                                                    </div>
                                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                                        ${event.event_type || 'General'}
                                                    </span>
                                                </div>
                                                ${event.description ? `
                                                    <p class="text-gray-700 mt-3 text-sm">${event.description.substring(0, 100)}${event.description.length > 100 ? '...' : ''}</p>
                                                ` : ''}
                                                <div class="flex justify-end space-x-2 mt-4">
                                                    <button onclick="editEvent('${event.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">
                                                        <i class="fas fa-edit mr-1"></i>Edit
                                                    </button>
                                                    <button onclick="deleteEvent('${event.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                                        <i class="fas fa-trash mr-1"></i>Delete
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('') : `
                                            <div class="text-center py-8 text-gray-500">
                                                <i class="fas fa-calendar text-3xl mb-3"></i>
                                                <p>No upcoming events</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                                
                                <!-- Event Stats -->
                                <div>
                                    <div class="bg-gray-50 rounded-xl p-6">
                                        <h3 class="text-lg font-bold text-gray-800 mb-4">Event Statistics</h3>
                                        <div class="space-y-4">
                                            <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200">
                                                <div>
                                                    <p class="text-sm text-gray-600">Total Events</p>
                                                    <p class="text-2xl font-bold">${events ? events.length : 0}</p>
                                                </div>
                                                <i class="fas fa-calendar text-blue-600 text-xl"></i>
                                            </div>
                                            
                                            <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200">
                                                <div>
                                                    <p class="text-sm text-gray-600">Upcoming</p>
                                                    <p class="text-2xl font-bold">${events ? events.filter(e => 
                                                        new Date(e.start_date) >= new Date() && e.status === 'published'
                                                    ).length : 0}</p>
                                                </div>
                                                <i class="fas fa-clock text-green-600 text-xl"></i>
                                            </div>
                                            
                                            <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200">
                                                <div>
                                                    <p class="text-sm text-gray-600">This Month</p>
                                                    <p class="text-2xl font-bold">${events ? events.filter(e => {
                                                        const eventDate = new Date(e.start_date);
                                                        return eventDate.getMonth() === currentMonth && 
                                                               eventDate.getFullYear() === currentYear;
                                                    }).length : 0}</p>
                                                </div>
                                                <i class="fas fa-star text-purple-600 text-xl"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-6 pt-6 border-t border-gray-200">
                                            <h4 class="font-medium text-gray-700 mb-3">Quick Links</h4>
                                            <div class="space-y-2">
                                                <button onclick="loadSection('add-event')" class="w-full text-left px-4 py-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100">
                                                    <i class="fas fa-calendar-plus mr-3"></i>Schedule New Event
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading events:', error);
                showToast('Error loading events: ' + error.message, 'error');
            }
        }
        
        // PAYMENTS MANAGER
        async function loadPaymentsManager() {
            try {
                const supabase = initSupabase();
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading payments:', error);
                    showToast('Error loading payments: ' + error.message, 'error');
                    return;
                }
                
                // Calculate totals
                let totalAmount = 0;
                let monthlyAmount = 0;
                const thisMonth = new Date().getMonth();
                
                if (payments) {
                    payments.forEach(payment => {
                        totalAmount += parseFloat(payment.amount || 0);
                        const paymentDate = new Date(payment.paid_at || payment.created_at);
                        if (paymentDate.getMonth() === thisMonth) {
                            monthlyAmount += parseFloat(payment.amount || 0);
                        }
                    });
                }
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Payments Management</h2>
                                <div class="flex space-x-3">
                                    <button onclick="exportPayments()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                        <i class="fas fa-download mr-2"></i>Export
                                    </button>
                                    <button onclick="loadSection('add-payment')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-plus-circle mr-2"></i>Record Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Payment Stats -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="text-blue-100 text-sm">Total Payments</p>
                                            <h3 class="text-2xl font-bold mt-1">KSh ${totalAmount.toLocaleString()}</h3>
                                        </div>
                                        <i class="fas fa-money-bill-wave text-2xl opacity-80"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="text-green-100 text-sm">This Month</p>
                                            <h3 class="text-2xl font-bold mt-1">KSh ${monthlyAmount.toLocaleString()}</h3>
                                        </div>
                                        <i class="fas fa-calendar-alt text-2xl opacity-80"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="text-purple-100 text-sm">Total Transactions</p>
                                            <h3 class="text-2xl font-bold mt-1">${payments ? payments.length : 0}</h3>
                                        </div>
                                        <i class="fas fa-receipt text-2xl opacity-80"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payments Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Invoice No.</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Description</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Method</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${payments && payments.length > 0 ? payments.map(payment => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-4 py-3">
                                                    ${payment.paid_at ? new Date(payment.paid_at).toLocaleDateString() : new Date(payment.created_at).toLocaleDateString()}
                                                </td>
                                                <td class="px-4 py-3">${payment.invoice_number || 'N/A'}</td>
                                                <td class="px-4 py-3">${payment.payment_for || 'Membership Payment'}</td>
                                                <td class="px-4 py-3 font-medium">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                        ${payment.payment_method || 'M-Pesa'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                        ${payment.payment_status || 'pending'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex space-x-2">
                                                        <button onclick="editPayment('${payment.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button onclick="deletePayment('${payment.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                                    <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                                                    <p class="text-lg">No payments recorded</p>
                                                    <button onclick="loadSection('add-payment')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                        Record First Payment
                                                    </button>
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading payments:', error);
                showToast('Error loading payments: ' + error.message, 'error');
            }
        }
        
        // ADD PAYMENT FORM
        async function loadAddPaymentForm() {
            const supabase = initSupabase();
            const { data: members } = await supabase
                .from('members')
                .select('*, profiles(*)')
                .order('created_at', { ascending: false });
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Record Payment</h2>
                            <button onclick="loadSection('payments')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Payments
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addPaymentForm" class="space-y-6 max-w-2xl">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Member *</label>
                                <select name="member_id" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select Member</option>
                                    ${members ? members.map(member => `
                                        <option value="${member.id}">
                                            ${member.profiles?.first_name || ''} ${member.profiles?.last_name || ''} 
                                            (${member.membership_number || 'No ID'}) - ${member.profiles?.email || ''}
                                        </option>
                                    `).join('') : ''}
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount (KSh) *</label>
                                    <input type="number" name="amount" step="0.01" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="0.00">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment For *</label>
                                    <select name="payment_for" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="membership">Membership Fee</option>
                                        <option value="event">Event Registration</option>
                                        <option value="donation">Donation</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                                    <select name="payment_method" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="mpesa">M-Pesa</option>
                                        <option value="bank">Bank Transfer</option>
                                        <option value="cash">Cash</option>
                                        <option value="card">Credit/Debit Card</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">M-Pesa Receipt Number</label>
                                    <input type="text" name="mpesa_receipt"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date</label>
                                    <input type="date" name="paid_at"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select name="payment_status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="completed">Completed</option>
                                        <option value="pending">Pending</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('payments')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewPayment()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Record Payment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        async function addNewPayment() {
            try {
                const form = document.getElementById('addPaymentForm');
                const formData = new FormData(form);
                const paymentData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                // Generate invoice number if not provided
                if (!paymentData.invoice_number) {
                    const invoicePrefix = 'KESNNUR';
                    const year = new Date().getFullYear();
                    const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
                    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    paymentData.invoice_number = `${invoicePrefix}-${year}${month}-${random}`;
                }
                
                const { data, error } = await supabase
                    .from('payments')
                    .insert([{
                        member_id: paymentData.member_id,
                        invoice_number: paymentData.invoice_number,
                        amount: paymentData.amount,
                        currency: 'KES',
                        payment_for: paymentData.payment_for,
                        payment_method: paymentData.payment_method,
                        mpesa_receipt: paymentData.mpesa_receipt,
                        payment_status: paymentData.payment_status,
                        paid_at: paymentData.paid_at ? new Date(paymentData.paid_at).toISOString() : new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                showToast('Payment recorded successfully', 'success');
                setTimeout(() => {
                    loadSection('payments');
                }, 1500);
                
            } catch (error) {
                console.error('Error adding payment:', error);
                showToast('Error recording payment: ' + error.message, 'error');
            }
        }
        
        // ANNOUNCEMENTS MANAGER
        async function loadAnnouncementsManager() {
            try {
                const supabase = initSupabase();
                const { data: announcements, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('publish_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading announcements:', error);
                    showToast('Error loading announcements: ' + error.message, 'error');
                    return;
                }
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Announcements</h2>
                                <button onclick="showAddAnnouncementModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus mr-2"></i>New Announcement
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            ${announcements && announcements.length > 0 ? announcements.map(announcement => `
                                <div class="border border-gray-200 rounded-xl p-6 mb-6 hover:bg-gray-50">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-800">${announcement.title}</h3>
                                            <p class="text-gray-600 text-sm mt-1">
                                                <i class="fas fa-calendar mr-2"></i>
                                                ${new Date(announcement.publish_at).toLocaleDateString()}
                                                <span class="mx-2">•</span>
                                                <span class="px-2 py-1 rounded-full text-xs ${announcement.priority === 'high' ? 'bg-red-100 text-red-800' : announcement.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                                                    ${announcement.priority || 'medium'}
                                                </span>
                                            </p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="editAnnouncement('${announcement.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteAnnouncement('${announcement.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="prose max-w-none">
                                        <p class="text-gray-700 whitespace-pre-line">${announcement.content}</p>
                                    </div>
                                    
                                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${announcement.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                            ${announcement.status || 'draft'}
                                        </span>
                                        <span class="text-sm text-gray-500">
                                            ${announcement.announcement_type || 'General'}
                                        </span>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="text-center py-12">
                                    <i class="fas fa-bullhorn text-gray-400 text-5xl mb-4"></i>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">No Announcements</h3>
                                    <p class="text-gray-600 mb-6">Create your first announcement to share with members</p>
                                    <button onclick="showAddAnnouncementModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-plus mr-2"></i>Create Announcement
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading announcements:', error);
                showToast('Error loading announcements: ' + error.message, 'error');
            }
        }
        
        function showAddAnnouncementModal() {
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Create Announcement</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addAnnouncementForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Title *</label>
                            <input type="text" name="title" required class="w-full px-3 py-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Content *</label>
                            <textarea name="content" rows="6" required class="w-full px-3 py-2 border rounded"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Type</label>
                                <select name="announcement_type" class="w-full px-3 py-2 border rounded">
                                    <option value="general">General</option>
                                    <option value="event">Event</option>
                                    <option value="news">News</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Priority</label>
                                <select name="priority" class="w-full px-3 py-2 border rounded">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="w-full px-3 py-2 border rounded">
                                    <option value="draft">Draft</option>
                                    <option value="published">Publish Now</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewAnnouncement()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Publish Announcement
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        async function addNewAnnouncement() {
            try {
                const form = document.getElementById('addAnnouncementForm');
                const formData = new FormData(form);
                const announcementData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('announcements')
                    .insert([{
                        title: announcementData.title,
                        content: announcementData.content,
                        announcement_type: announcementData.announcement_type,
                        priority: announcementData.priority,
                        status: announcementData.status,
                        publish_at: new Date().toISOString(),
                        created_by: currentUser.id
                    }])
                    .select();
                
                if (error) throw error;
                
                showToast('Announcement created successfully', 'success');
                closeModal();
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error adding announcement:', error);
                showToast('Error creating announcement: ' + error.message, 'error');
            }
        }
        
        // ADMIN USERS MANAGER
        async function loadUsersManager() {
            try {
                const supabase = initSupabase();
                const { data: profiles, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading users:', error);
                    showToast('Error loading users: ' + error.message, 'error');
                    return;
                }
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Admin Users</h2>
                                <button onclick="showAddUserModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-user-plus mr-2"></i>Add Admin
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">User</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Role</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Last Login</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${profiles && profiles.length > 0 ? profiles.map(profile => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center">
                                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                            <i class="fas fa-user text-blue-900 text-sm"></i>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">${profile.first_name || ''} ${profile.last_name || ''}</p>
                                                            <p class="text-sm text-gray-500">${profile.email}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${profile.role === 'admin' ? 'bg-purple-100 text-purple-800' : profile.role === 'super_admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                                        ${profile.role ? profile.role.replace('_', ' ').toUpperCase() : 'USER'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    ${profile.last_login ? new Date(profile.last_login).toLocaleDateString() : 'Never'}
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${profile.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                        ${profile.status || 'inactive'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex space-x-2">
                                                        ${profile.id !== currentUser.id ? `
                                                            <button onclick="editUserRole('${profile.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button onclick="deleteUser('${profile.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        ` : `
                                                            <span class="px-3 py-1 text-sm text-gray-500">Current User</span>
                                                        `}
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="5" class="px-4 py-12 text-center text-gray-500">
                                                    <i class="fas fa-users text-3xl mb-3"></i>
                                                    <p class="text-lg">No admin users found</p>
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium">Admin Roles:</p>
                                        <ul class="mt-1 space-y-1">
                                            <li><span class="font-medium">Super Admin:</span> Full system access</li>
                                            <li><span class="font-medium">Admin:</span> Full management access</li>
                                            <li><span class="font-medium">Editor:</span> Limited editing access</li>
                                            <li><span class="font-medium">Member:</span> Basic access only</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error loading users: ' + error.message, 'error');
            }
        }
        
        function showAddUserModal() {
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Add Admin User</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addUserForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email Address *</label>
                            <input type="email" name="email" required class="w-full px-3 py-2 border rounded">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">First Name</label>
                                <input type="text" name="first_name" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Last Name</label>
                                <input type="text" name="last_name" class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Role *</label>
                                <select name="role" required class="w-full px-3 py-2 border rounded">
                                    <option value="member">Member</option>
                                    <option value="editor">Editor</option>
                                    <option value="admin">Admin</option>
                                    <option value="super_admin">Super Admin</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="w-full px-3 py-2 border rounded">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewUser()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Add User
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        async function addNewUser() {
            try {
                const form = document.getElementById('addUserForm');
                const formData = new FormData(form);
                const userData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('profiles')
                    .insert([{
                        email: userData.email,
                        first_name: userData.first_name,
                        last_name: userData.last_name,
                        role: userData.role,
                        status: userData.status
                    }])
                    .select();
                
                if (error) throw error;
                
                showToast('User added successfully', 'success');
                closeModal();
                loadSection('users');
                
            } catch (error) {
                console.error('Error adding user:', error);
                showToast('Error adding user: ' + error.message, 'error');
            }
        }
        
        // ADD EVENT FORM
        async function loadAddEventForm() {
            const supabase = initSupabase();
            const { data: chapters } = await supabase
                .from('chapters')
                .select('id, name, code')
                .order('name');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Add New Event</h2>
                            <button onclick="loadSection('events')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Events
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addEventForm" class="space-y-6 max-w-2xl">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Event Title *</label>
                                <input type="text" name="title" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description" rows="4" 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Type *</label>
                                    <select name="event_type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Type</option>
                                        <option value="meeting">Meeting</option>
                                        <option value="workshop">Workshop</option>
                                        <option value="seminar">Seminar</option>
                                        <option value="conference">Conference</option>
                                        <option value="social">Social Event</option>
                                        <option value="training">Training</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                    <select name="category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Category</option>
                                        <option value="academic">Academic</option>
                                        <option value="professional">Professional</option>
                                        <option value="social">Social</option>
                                        <option value="networking">Networking</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date & Time *</label>
                                    <input type="datetime-local" name="start_date" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date & Time *</label>
                                    <input type="datetime-local" name="end_date" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Venue</label>
                                    <input type="text" name="venue"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Attendees</label>
                                    <input type="number" name="max_attendees"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fee Amount (KSh)</label>
                                    <input type="number" name="fee_amount" step="0.01"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select name="status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="draft">Draft</option>
                                        <option value="published">Published</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('events')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewEvent()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Save Event
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        async function addNewEvent() {
            try {
                const form = document.getElementById('addEventForm');
                const formData = new FormData(form);
                const eventData = Object.fromEntries(formData.entries());
                
                // Convert datetime strings to ISO format
                if (eventData.start_date) {
                    eventData.start_date = new Date(eventData.start_date).toISOString();
                }
                if (eventData.end_date) {
                    eventData.end_date = new Date(eventData.end_date).toISOString();
                }
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('events')
                    .insert([{
                        title: eventData.title,
                        description: eventData.description,
                        event_type: eventData.event_type,
                        category: eventData.category,
                        start_date: eventData.start_date,
                        end_date: eventData.end_date,
                        venue: eventData.venue,
                        max_attendees: eventData.max_attendees,
                        fee_amount: eventData.fee_amount || 0,
                        status: eventData.status
                    }])
                    .select();
                
                if (error) throw error;
                
                showToast('Event added successfully', 'success');
                setTimeout(() => {
                    loadSection('events');
                }, 1500);
                
            } catch (error) {
                console.error('Error adding event:', error);
                showToast('Error adding event: ' + error.message, 'error');
            }
        }
        
        // UTILITY FUNCTIONS
        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = content;
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        function refreshData() {
            showToast('Refreshing data...', 'info');
            loadSection(document.querySelector('.nav-item.active').getAttribute('data-section'));
        }
        
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const supabase = initSupabase();
                    await supabase.auth.signOut();
                    showToast('Logged out successfully', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Error logging out: ' + error.message, 'error');
                }
            }
        }
        
        // Export functions
        function exportMembers() {
            showToast('Export feature coming soon!', 'info');
        }
        
        function exportPayments() {
            showToast('Export feature coming soon!', 'info');
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeDashboard, 100);
        });
    </script>
</body>
</html>
