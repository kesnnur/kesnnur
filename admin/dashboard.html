                            <input type="hidden" name="region_id" value="${region.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Region Name *</label>
                                <input type="text" name="name" value="${region.name}" required class="form-input">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Region Code *</label>
                                    <input type="text" name="code" value="${region.code}" required class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Country</label>
                                    <input type="text" name="country" value="${region.country || 'Kenya'}" class="form-input">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <textarea name="description" rows="3" class="form-input">${region.description || ''}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="form-input">
                                    <option value="active" ${region.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${region.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateRegion()" class="btn btn-primary">
                                    Update Region
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit region form:', error);
                showToast('Error loading region data: ' + error.message, 'error');
            }
        }
        
        async function updateRegion() {
            try {
                const form = document.getElementById('editRegionForm');
                const formData = new FormData(form);
                const regionData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                await supabase
                    .from('regions')
                    .update({
                        name: regionData.name,
                        code: regionData.code,
                        country: regionData.country,
                        description: regionData.description,
                        status: regionData.status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', regionData.region_id);
                
                // Clear cache
                dataCache.regions = null;
                
                showToast('Region updated successfully', 'success');
                closeModal();
                loadSection('regions');
                
            } catch (error) {
                console.error('Error updating region:', error);
                showToast('Error updating region: ' + error.message, 'error');
            }
        }
        
        async function deleteRegion(regionId) {
            if (!confirm('Are you sure you want to delete this region? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('regions')
                    .delete()
                    .eq('id', regionId);
                
                // Clear cache
                dataCache.regions = null;
                
                showToast('Region deleted successfully', 'success');
                loadSection('regions');
                
            } catch (error) {
                console.error('Error deleting region:', error);
                showToast('Error deleting region: ' + error.message, 'error');
            }
        }
        
        // ==================== EVENTS MANAGER ====================
        
        async function loadEventsManager() {
            try {
                document.getElementById('contentArea').innerHTML = `
                    <div class="tabs-container">
                        <div class="tabs-header">
                            <div class="tab active" data-tab="calendar-view">Calendar View</div>
                            <div class="tab" data-tab="list-view">List View</div>
                            <div class="tab" data-tab="upcoming-events">Upcoming</div>
                            <div class="tab" data-tab="past-events">Past</div>
                        </div>
                        
                        <div class="tab-content active" id="calendar-view">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Events Calendar</h3>
                                    <p class="text-gray-600 text-sm">View and manage all events in calendar format</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="loadSection('add-event')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-calendar-plus mr-2"></i>Add Event
                                    </button>
                                </div>
                            </div>
                            <div id="calendar" class="bg-white rounded-lg p-4"></div>
                        </div>
                        
                        <div class="tab-content" id="list-view">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">All Events</h3>
                                    <p class="text-gray-600 text-sm">View all events in list format</p>
                                </div>
                            </div>
                            <div id="list-view-content" class="data-loading">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="tab-content" id="upcoming-events">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Upcoming Events</h3>
                                    <p class="text-gray-600 text-sm">Events scheduled for the future</p>
                                </div>
                            </div>
                            <div id="upcoming-events-content" class="data-loading">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="tab-content" id="past-events">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Past Events</h3>
                                    <p class="text-gray-600 text-sm">Events that have already occurred</p>
                                </div>
                            </div>
                            <div id="past-events-content" class="data-loading">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                `;
                
                // Setup tab switching
                setupEventTabs();
                
                // Initialize calendar
                initCalendar();
                
            } catch (error) {
                console.error('Error loading events manager:', error);
                showToast('Error loading events: ' + error.message, 'error');
            }
        }
        
        function setupEventTabs() {
            document.querySelectorAll('.tab[data-tab$="events"], .tab[data-tab$="view"]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load tab content if not loaded
                    if (tabId === 'calendar-view') {
                        initCalendar();
                    } else {
                        loadEventTabContent(tabId);
                    }
                });
            });
        }
        
        async function loadEventTabContent(tabId) {
            switch(tabId) {
                case 'list-view':
                    if (!document.querySelector('#list-view-content').hasAttribute('data-loaded')) {
                        await loadAllEvents();
                    }
                    break;
                case 'upcoming-events':
                    if (!document.querySelector('#upcoming-events-content').hasAttribute('data-loaded')) {
                        await loadUpcomingEvents();
                    }
                    break;
                case 'past-events':
                    if (!document.querySelector('#past-events-content').hasAttribute('data-loaded')) {
                        await loadPastEvents();
                    }
                    break;
            }
        }
        
        async function initCalendar() {
            try {
                const supabase = initSupabase();
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('start_date', { ascending: true });
                
                if (error) throw error;
                
                const calendarEl = document.getElementById('calendar');
                
                // Clear existing calendar
                if (calendarInstance) {
                    calendarInstance.destroy();
                }
                
                calendarInstance = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    events: events.map(event => ({
                        id: event.id,
                        title: event.title,
                        start: event.start_date,
                        end: event.end_date,
                        description: event.description,
                        venue: event.venue,
                        color: getEventColor(event.event_type),
                        textColor: 'white',
                        extendedProps: {
                            type: event.event_type,
                            status: event.status
                        }
                    })),
                    eventClick: function(info) {
                        showEventDetails(info.event.id);
                    },
                    dateClick: function(info) {
                        showAddEventModal(info.dateStr);
                    },
                    height: 650
                });
                
                calendarInstance.render();
                
            } catch (error) {
                console.error('Error initializing calendar:', error);
                document.getElementById('calendar').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading calendar: ${error.message}</p>
                        <button onclick="initCalendar()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function getEventColor(eventType) {
            const colors = {
                meeting: '#3b82f6',
                workshop: '#10b981',
                seminar: '#8b5cf6',
                conference: '#f59e0b',
                social: '#ef4444',
                training: '#ec4899',
                webinar: '#06b6d4',
                fundraiser: '#84cc16'
            };
            return colors[eventType] || '#6b7280';
        }
        
        async function loadAllEvents() {
            try {
                const supabase = initSupabase();
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('start_date', { ascending: false });
                
                if (error) throw error;
                
                renderEventsList('list-view-content', events || []);
                
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('list-view-content').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading events: ${error.message}</p>
                        <button onclick="loadAllEvents()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        async function loadUpcomingEvents() {
            try {
                const supabase = initSupabase();
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .gte('start_date', new Date().toISOString())
                    .order('start_date', { ascending: true });
                
                if (error) throw error;
                
                renderEventsList('upcoming-events-content', events || []);
                
            } catch (error) {
                console.error('Error loading upcoming events:', error);
                document.getElementById('upcoming-events-content').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading upcoming events: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadPastEvents() {
            try {
                const supabase = initSupabase();
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .lt('start_date', new Date().toISOString())
                    .order('start_date', { ascending: false });
                
                if (error) throw error;
                
                renderEventsList('past-events-content', events || []);
                
            } catch (error) {
                console.error('Error loading past events:', error);
                document.getElementById('past-events-content').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading past events: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderEventsList(containerId, events) {
            const container = document.getElementById(containerId);
            
            container.innerHTML = `
                <!-- Search and Filters -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <input type="text" id="search-events" 
                               placeholder="Search events..." 
                               class="w-full form-input"
                               onkeyup="filterEventsTable()">
                    </div>
                    <div>
                        <select onchange="filterEventsByType(this.value)" class="w-full form-input">
                            <option value="">All Event Types</option>
                            ${EVENT_TYPES.map(type => `
                                <option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <select onchange="filterEventsByStatus(this.value)" class="w-full form-input">
                            <option value="">All Statuses</option>
                            <option value="published">Published</option>
                            <option value="draft">Draft</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <button onclick="clearEventFilters()" class="w-full btn btn-secondary">
                            Clear Filters
                        </button>
                    </div>
                </div>
                
                <!-- Events Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${events.length > 0 ? events.map(event => `
                        <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow" 
                             data-type="${event.event_type}" 
                             data-status="${event.status}">
                            <div class="p-5">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h4 class="font-bold text-gray-800 text-lg">${event.title}</h4>
                                        <p class="text-sm text-gray-600 mt-1">${event.event_type.charAt(0).toUpperCase() + event.event_type.slice(1)}</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${event.status === 'published' ? 'bg-green-100 text-green-800' : event.status === 'draft' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                        ${event.status.charAt(0).toUpperCase() + event.status.slice(1)}
                                    </span>
                                </div>
                                
                                <div class="space-y-3 mb-4">
                                    <div class="flex items-center text-sm text-gray-600">
                                        <i class="fas fa-calendar-alt mr-2 w-4"></i>
                                        <span>${formatDate(event.start_date)} ${event.end_date ? `to ${formatDate(event.end_date)}` : ''}</span>
                                    </div>
                                    ${event.venue ? `
                                        <div class="flex items-center text-sm text-gray-600">
                                            <i class="fas fa-map-marker-alt mr-2 w-4"></i>
                                            <span>${event.venue}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <p class="text-gray-700 text-sm line-clamp-2">${event.description || 'No description'}</p>
                                
                                <div class="flex justify-between items-center mt-6 pt-4 border-t">
                                    <div class="text-sm text-gray-500">
                                        ${event.registration_count || 0} registrations
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="viewEvent('${event.id}')" class="action-btn action-btn-view">
                                            View
                                        </button>
                                        <button onclick="editEvent('${event.id}')" class="action-btn action-btn-edit">
                                            Edit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="col-span-3 text-center py-12">
                            <i class="fas fa-calendar-alt text-gray-400 text-5xl mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-800 mb-3">No Events Found</h3>
                            <p class="text-gray-600 mb-6">Get started by adding your first event</p>
                            <button onclick="loadSection('add-event')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-calendar-plus mr-2"></i>Add Event
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            // Mark as loaded
            container.setAttribute('data-loaded', 'true');
        }
        
        // ==================== ADD EVENT FORM ====================
        
        async function loadAddEventForm() {
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Add New Event</h2>
                            <button onclick="loadSection('events')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Events
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addEventForm" class="space-y-6 max-w-3xl">
                            <!-- Event Basic Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Event Information</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Title *</label>
                                    <input type="text" name="title" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="e.g., Annual General Meeting">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Event Type *</label>
                                        <select name="event_type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Select Type</option>
                                            ${EVENT_TYPES.map(type => `
                                                <option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select name="status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="draft">Draft</option>
                                            <option value="published">Published</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                    <textarea name="description" rows="4"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <!-- Event Dates & Times -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Date & Time</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date & Time *</label>
                                        <input type="datetime-local" name="start_date" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date & Time</label>
                                        <input type="datetime-local" name="end_date"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Event Location -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Location</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Venue</label>
                                        <input type="text" name="venue"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="e.g., Nairobi Safari Club">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                        <input type="text" name="address"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="e.g., Langata Road, Nairobi">
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Map Location (Google Maps Link)</label>
                                    <input type="url" name="location_url"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="https://goo.gl/maps/...">
                                </div>
                            </div>
                            
                            <!-- Registration Details -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Registration Details</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Registration Fee (KSh)</label>
                                        <input type="number" name="registration_fee" step="0.01"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="0.00">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Capacity</label>
                                        <input type="number" name="capacity"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="Unlimited">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Registration Deadline</label>
                                        <input type="datetime-local" name="registration_deadline"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Registration Instructions</label>
                                    <textarea name="registration_instructions" rows="3"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <!-- Additional Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Additional Information</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                                    <input type="text" name="contact_person"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                                    <input type="email" name="contact_email"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Phone</label>
                                    <input type="tel" name="contact_phone"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                                    <textarea name="notes" rows="3"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('events')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewEvent()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Save Event
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Set default date/time to now
            const now = new Date();
            const formattedDateTime = now.toISOString().slice(0, 16);
            document.querySelector('input[name="start_date"]').value = formattedDateTime;
            
            // Set end date to 2 hours later by default
            const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            const formattedEndDateTime = twoHoursLater.toISOString().slice(0, 16);
            document.querySelector('input[name="end_date"]').value = formattedEndDateTime;
        }
        
        async function addNewEvent() {
            try {
                const form = document.getElementById('addEventForm');
                const formData = new FormData(form);
                const eventData = Object.fromEntries(formData.entries());
                
                // Validate required fields
                if (!eventData.title || !eventData.event_type || !eventData.start_date) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const supabase = initSupabase();
                
                const insertData = {
                    title: eventData.title,
                    event_type: eventData.event_type,
                    status: eventData.status,
                    description: eventData.description,
                    start_date: eventData.start_date,
                    end_date: eventData.end_date,
                    venue: eventData.venue,
                    address: eventData.address,
                    location_url: eventData.location_url,
                    registration_fee: eventData.registration_fee,
                    capacity: eventData.capacity,
                    registration_deadline: eventData.registration_deadline,
                    registration_instructions: eventData.registration_instructions,
                    contact_person: eventData.contact_person,
                    contact_email: eventData.contact_email,
                    contact_phone: eventData.contact_phone,
                    notes: eventData.notes,
                    created_by: currentUser.id,
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('events')
                    .insert([insertData])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.events = null;
                
                showToast('Event added successfully!', 'success');
                
                // Show success modal
                const successModal = `
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-check text-green-600 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">Event Added Successfully!</h3>
                            <p class="text-gray-600 mt-2">Event has been added to the calendar.</p>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h4 class="font-medium text-gray-800 mb-3">Event Details:</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Event Title:</span>
                                    <span class="font-medium">${eventData.title}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Event Type:</span>
                                    <span class="font-medium">${eventData.event_type.charAt(0).toUpperCase() + eventData.event_type.slice(1)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Date:</span>
                                    <span class="font-medium">${formatDate(eventData.start_date)}</span>
                                </div>
                                ${eventData.venue ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Venue:</span>
                                        <span class="font-medium">${eventData.venue}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex justify-center space-x-4">
                            <button onclick="closeModal(); loadSection('events')" class="btn btn-primary">
                                View Events Calendar
                            </button>
                            <button onclick="closeModal(); loadSection('add-event')" class="btn btn-secondary">
                                Add Another Event
                            </button>
                        </div>
                    </div>
                `;
                
                showModal(successModal);
                
            } catch (error) {
                console.error('Error adding event:', error);
                showToast('Error adding event: ' + error.message, 'error');
            }
        }
        
        // ==================== VIEW EVENT DETAILS ====================
        
        async function viewEvent(eventId) {
            try {
                const supabase = initSupabase();
                
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (error) throw error;
                
                // Get registrations count
                const { count: registrationsCount } = await supabase
                    .from('event_registrations')
                    .select('*', { count: 'exact', head: true })
                    .eq('event_id', eventId);
                
                const modalContent = `
                    <div class="p-6 max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Event Details</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Event Header -->
                            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 text-white">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h2 class="text-2xl font-bold mb-2">${event.title}</h2>
                                        <p class="text-blue-100">${event.event_type.charAt(0).toUpperCase() + event.event_type.slice(1)}</p>
                                    </div>
                                    <span class="px-4 py-2 rounded-full text-sm font-medium ${event.status === 'published' ? 'bg-green-100 text-green-800' : event.status === 'draft' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                        ${event.status.charAt(0).toUpperCase() + event.status.slice(1)}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Event Details Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Date & Time -->
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-calendar-alt mr-2"></i>
                                        Date & Time
                                    </h4>
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-sm text-gray-600">Start</p>
                                            <p class="font-medium">${formatDateTime(event.start_date)}</p>
                                        </div>
                                        ${event.end_date ? `
                                            <div>
                                                <p class="text-sm text-gray-600">End</p>
                                                <p class="font-medium">${formatDateTime(event.end_date)}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <!-- Location -->
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-map-marker-alt mr-2"></i>
                                        Location
                                    </h4>
                                    <div class="space-y-3">
                                        ${event.venue ? `
                                            <div>
                                                <p class="text-sm text-gray-600">Venue</p>
                                                <p class="font-medium">${event.venue}</p>
                                            </div>
                                        ` : ''}
                                        ${event.address ? `
                                            <div>
                                                <p class="text-sm text-gray-600">Address</p>
                                                <p class="font-medium">${event.address}</p>
                                            </div>
                                        ` : ''}
                                        ${event.location_url ? `
                                            <div>
                                                <a href="${event.location_url}" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center">
                                                    <i class="fas fa-map mr-2"></i>
                                                    View on Map
                                                </a>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <!-- Registration Info -->
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-users mr-2"></i>
                                        Registration
                                    </h4>
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-sm text-gray-600">Fee</p>
                                            <p class="font-medium">${event.registration_fee ? 'KSh ' + parseFloat(event.registration_fee).toLocaleString() : 'Free'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Capacity</p>
                                            <p class="font-medium">${event.capacity || 'Unlimited'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Registrations</p>
                                            <p class="font-medium">${registrationsCount || 0} registered</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contact Info -->
                                ${event.contact_person || event.contact_email || event.contact_phone ? `
                                    <div class="card">
                                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                            <i class="fas fa-phone mr-2"></i>
                                            Contact Information
                                        </h4>
                                        <div class="space-y-3">
                                            ${event.contact_person ? `
                                                <div>
                                                    <p class="text-sm text-gray-600">Contact Person</p>
                                                    <p class="font-medium">${event.contact_person}</p>
                                                </div>
                                            ` : ''}
                                            ${event.contact_email ? `
                                                <div>
                                                    <p class="text-sm text-gray-600">Email</p>
                                                    <a href="mailto:${event.contact_email}" class="font-medium text-blue-600 hover:text-blue-800">${event.contact_email}</a>
                                                </div>
                                            ` : ''}
                                            ${event.contact_phone ? `
                                                <div>
                                                    <p class="text-sm text-gray-600">Phone</p>
                                                    <a href="tel:${event.contact_phone}" class="font-medium text-blue-600 hover:text-blue-800">${event.contact_phone}</a>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Description -->
                            ${event.description ? `
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4">Description</h4>
                                    <p class="text-gray-700 whitespace-pre-line">${event.description}</p>
                                </div>
                            ` : ''}
                            
                            <!-- Registration Instructions -->
                            ${event.registration_instructions ? `
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4">Registration Instructions</h4>
                                    <p class="text-gray-700 whitespace-pre-line">${event.registration_instructions}</p>
                                </div>
                            ` : ''}
                            
                            <!-- Additional Notes -->
                            ${event.notes ? `
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4">Additional Notes</h4>
                                    <p class="text-gray-700 whitespace-pre-line">${event.notes}</p>
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button onclick="editEvent('${event.id}')" class="btn btn-primary">
                                    <i class="fas fa-edit mr-2"></i>Edit Event
                                </button>
                                <button onclick="closeModal()" class="btn btn-secondary">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal(modalContent, 'modal-lg');
                
            } catch (error) {
                console.error('Error loading event details:', error);
                showToast('Error loading event details: ' + error.message, 'error');
            }
        }
        
        // ==================== EDIT EVENT ====================
        
        async function editEvent(eventId) {
            try {
                const supabase = initSupabase();
                
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (error) throw error;
                
                // Format dates for datetime-local input
                const formatDateForInput = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().slice(0, 16);
                };
                
                const modalContent = `
                    <div class="p-6 max-w-3xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Event</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editEventForm" class="space-y-6">
                            <input type="hidden" name="event_id" value="${event.id}">
                            
                            <!-- Event Basic Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Event Information</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Title *</label>
                                    <input type="text" name="title" value="${event.title}" required class="form-input">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Event Type *</label>
                                        <select name="event_type" required class="form-input">
                                            ${EVENT_TYPES.map(type => `
                                                <option value="${type}" ${event.event_type === type ? 'selected' : ''}>
                                                    ${type.charAt(0).toUpperCase() + type.slice(1)}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Status</label>
                                        <select name="status" class="form-input">
                                            <option value="draft" ${event.status === 'draft' ? 'selected' : ''}>Draft</option>
                                            <option value="published" ${event.status === 'published' ? 'selected' : ''}>Published</option>
                                            <option value="cancelled" ${event.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Description</label>
                                    <textarea name="description" rows="4" class="form-input">${event.description || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- Event Dates & Times -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Date & Time</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Start Date & Time *</label>
                                        <input type="datetime-local" name="start_date" value="${formatDateForInput(event.start_date)}" required class="form-input">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">End Date & Time</label>
                                        <input type="datetime-local" name="end_date" value="${formatDateForInput(event.end_date)}" class="form-input">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Event Location -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Location</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Venue</label>
                                        <input type="text" name="venue" value="${event.venue || ''}" class="form-input">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Address</label>
                                        <input type="text" name="address" value="${event.address || ''}" class="form-input">
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Map Location (Google Maps Link)</label>
                                    <input type="url" name="location_url" value="${event.location_url || ''}" class="form-input">
                                </div>
                            </div>
                            
                            <!-- Registration Details -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Registration Details</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Registration Fee (KSh)</label>
                                        <input type="number" name="registration_fee" value="${event.registration_fee || ''}" step="0.01" class="form-input">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Max Capacity</label>
                                        <input type="number" name="capacity" value="${event.capacity || ''}" class="form-input">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Registration Deadline</label>
                                        <input type="datetime-local" name="registration_deadline" value="${formatDateForInput(event.registration_deadline)}" class="form-input">
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Registration Instructions</label>
                                    <textarea name="registration_instructions" rows="3" class="form-input">${event.registration_instructions || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- Additional Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Additional Information</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Contact Person</label>
                                    <input type="text" name="contact_person" value="${event.contact_person || ''}" class="form-input">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Contact Email</label>
                                    <input type="email" name="contact_email" value="${event.contact_email || ''}" class="form-input">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Contact Phone</label>
                                    <input type="tel" name="contact_phone" value="${event.contact_phone || ''}" class="form-input">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">Additional Notes</label>
                                    <textarea name="notes" rows="3" class="form-input">${event.notes || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateEvent()" class="btn btn-primary">
                                    Update Event
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent, 'modal-lg');
                
            } catch (error) {
                console.error('Error loading edit event form:', error);
                showToast('Error loading event data: ' + error.message, 'error');
            }
        }
        
        async function updateEvent() {
            try {
                const form = document.getElementById('editEventForm');
                const formData = new FormData(form);
                const eventData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const updateData = {
                    title: eventData.title,
                    event_type: eventData.event_type,
                    status: eventData.status,
                    description: eventData.description,
                    start_date: eventData.start_date,
                    end_date: eventData.end_date,
                    venue: eventData.venue,
                    address: eventData.address,
                    location_url: eventData.location_url,
                    registration_fee: eventData.registration_fee,
                    capacity: eventData.capacity,
                    registration_deadline: eventData.registration_deadline,
                    registration_instructions: eventData.registration_instructions,
                    contact_person: eventData.contact_person,
                    contact_email: eventData.contact_email,
                    contact_phone: eventData.contact_phone,
                    notes: eventData.notes,
                    updated_at: new Date().toISOString()
                };
                
                await supabase
                    .from('events')
                    .update(updateData)
                    .eq('id', eventData.event_id);
                
                // Clear cache
                dataCache.events = null;
                
                showToast('Event updated successfully', 'success');
                closeModal();
                loadSection('events');
                
            } catch (error) {
                console.error('Error updating event:', error);
                showToast('Error updating event: ' + error.message, 'error');
            }
        }
        
        // ==================== ANNOUNCEMENTS MANAGER ====================
        
        async function loadAnnouncementsManager() {
            try {
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Announcements</h2>
                                <button onclick="showAddAnnouncementModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-bullhorn mr-2"></i>Create Announcement
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Active Announcements -->
                            <div class="mb-8">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Active Announcements</h3>
                                <div id="active-announcements" class="data-loading">
                                    <!-- Content will be loaded here -->
                                </div>
                            </div>
                            
                            <!-- Past Announcements -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Past Announcements</h3>
                                <div id="past-announcements" class="data-loading">
                                    <!-- Content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load announcements
                await loadActiveAnnouncements();
                await loadPastAnnouncements();
                
            } catch (error) {
                console.error('Error loading announcements:', error);
                showToast('Error loading announcements: ' + error.message, 'error');
            }
        }
        
        async function loadActiveAnnouncements() {
            try {
                const supabase = initSupabase();
                const { data: announcements, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('active-announcements');
                renderAnnouncements(container, announcements || []);
                
            } catch (error) {
                console.error('Error loading active announcements:', error);
                document.getElementById('active-announcements').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading announcements: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadPastAnnouncements() {
            try {
                const supabase = initSupabase();
                const { data: announcements, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .neq('status', 'active')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('past-announcements');
                renderAnnouncements(container, announcements || []);
                
            } catch (error) {
                console.error('Error loading past announcements:', error);
                document.getElementById('past-announcements').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading announcements: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderAnnouncements(container, announcements) {
            container.innerHTML = `
                <div class="space-y-4">
                    ${announcements.length > 0 ? announcements.map(announcement => `
                        <div class="border border-gray-200 rounded-lg p-5 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg">${announcement.title}</h4>
                                    <div class="flex items-center mt-1 space-x-3">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${announcement.announcement_type === 'urgent' ? 'bg-red-100 text-red-800' : announcement.announcement_type === 'event' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                            ${announcement.announcement_type.charAt(0).toUpperCase() + announcement.announcement_type.slice(1)}
                                        </span>
                                        <span class="text-sm text-gray-600">
                                            <i class="far fa-clock mr-1"></i>
                                            ${formatDate(announcement.created_at)}
                                        </span>
                                        ${announcement.expires_at ? `
                                            <span class="text-sm text-gray-600">
                                                <i class="far fa-calendar-times mr-1"></i>
                                                Expires: ${formatDate(announcement.expires_at)}
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${announcement.status === 'active' ? 'bg-green-100 text-green-800' : announcement.status === 'draft' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                    ${announcement.status.charAt(0).toUpperCase() + announcement.status.slice(1)}
                                </span>
                            </div>
                            
                            <p class="text-gray-700 mb-4">${announcement.content}</p>
                            
                            <div class="flex justify-between items-center pt-4 border-t">
                                <div class="text-sm text-gray-500">
                                    Sent to: ${announcement.audience === 'all' ? 'All Members' : announcement.audience === 'active' ? 'Active Members' : 'Specific Group'}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="viewAnnouncement('${announcement.id}')" class="action-btn action-btn-view">
                                        View
                                    </button>
                                    <button onclick="editAnnouncement('${announcement.id}')" class="action-btn action-btn-edit">
                                        Edit
                                    </button>
                                    <button onclick="deleteAnnouncement('${announcement.id}')" class="action-btn action-btn-delete">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-bullhorn text-3xl mb-3"></i>
                            <p class="text-lg">No announcements found</p>
                            <p class="text-sm">Create your first announcement to communicate with members</p>
                        </div>
                    `}
                </div>
            `;
        }
        
        function showAddAnnouncementModal() {
            const modalContent = `
                <div class="p-6 max-w-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Create Announcement</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addAnnouncementForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Title *</label>
                            <input type="text" name="title" required class="form-input" placeholder="Announcement title">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Type *</label>
                                <select name="announcement_type" required class="form-input">
                                    ${ANNOUNCEMENT_TYPES.map(type => `
                                        <option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="form-input">
                                    <option value="draft">Draft</option>
                                    <option value="active" selected>Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Content *</label>
                            <textarea name="content" rows="6" required class="form-input" placeholder="Enter announcement content here..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Audience *</label>
                                <select name="audience" required class="form-input">
                                    <option value="all">All Members</option>
                                    <option value="active">Active Members Only</option>
                                    <option value="specific">Specific Region/Group</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Expiry Date (Optional)</label>
                                <input type="date" name="expires_at" class="form-input">
                            </div>
                        </div>
                        
                        <!-- Send Options -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="space-y-3">
                                <div class="flex items-start">
                                    <input type="checkbox" name="send_email" id="send_email" checked class="mt-1 mr-3">
                                    <div>
                                        <label for="send_email" class="font-medium text-gray-800">Send as Email</label>
                                        <p class="text-sm text-gray-600 mt-1">Send announcement via email to selected audience</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <input type="checkbox" name="send_sms" id="send_sms" class="mt-1 mr-3">
                                    <div>
                                        <label for="send_sms" class="font-medium text-gray-800">Send as SMS</label>
                                        <p class="text-sm text-gray-600 mt-1">Send announcement via SMS (requires SMS credits)</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <input type="checkbox" name="publish_dashboard" id="publish_dashboard" checked class="mt-1 mr-3">
                                    <div>
                                        <label for="publish_dashboard" class="font-medium text-gray-800">Publish on Dashboard</label>
                                        <p class="text-sm text-gray-600 mt-1">Show announcement on member dashboard</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewAnnouncement()" class="btn btn-primary">
                                Create Announcement
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
            
            // Set expiry date to 7 days from now by default
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.querySelector('input[name="expires_at"]').value = nextWeek.toISOString().split('T')[0];
        }
        
        async function addNewAnnouncement() {
            try {
                const form = document.getElementById('addAnnouncementForm');
                const formData = new FormData(form);
                const announcementData = Object.fromEntries(formData.entries());
                
                // Validate required fields
                if (!announcementData.title || !announcementData.content) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const supabase = initSupabase();
                
                const insertData = {
                    title: announcementData.title,
                    announcement_type: announcementData.announcement_type,
                    content: announcementData.content,
                    audience: announcementData.audience,
                    status: announcementData.status,
                    expires_at: announcementData.expires_at || null,
                    created_by: currentUser.id,
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('announcements')
                    .insert([insertData])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.announcements = null;
                
                // Send notifications if selected
                if (announcementData.send_email === 'on') {
                    // Implement email sending logic here
                    console.log('Would send email announcement');
                }
                
                if (announcementData.send_sms === 'on') {
                    // Implement SMS sending logic here
                    console.log('Would send SMS announcement');
                }
                
                showToast('Announcement created successfully!', 'success');
                closeModal();
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error adding announcement:', error);
                showToast('Error creating announcement: ' + error.message, 'error');
            }
        }
        
        // ==================== REPORTS MANAGER ====================
        
        async function loadReportsManager() {
            try {
                // Get stats for reports
                const stats = await loadStats();
                const recentPayments = await getRecentPayments(10);
                const upcomingEvents = await getUpcomingEvents(5);
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Reports & Analytics</h2>
                                <div class="flex space-x-3">
                                    <button onclick="generateReport('monthly')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                        <i class="fas fa-download mr-2"></i>Export Report
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Report Tabs -->
                            <div class="tabs-container mb-8">
                                <div class="tabs-header">
                                    <div class="tab active" data-tab="overview">Overview</div>
                                    <div class="tab" data-tab="financial">Financial</div>
                                    <div class="tab" data-tab="membership">Membership</div>
                                    <div class="tab" data-tab="events">Events</div>
                                </div>
                                
                                <!-- Overview Tab -->
                                <div class="tab-content active" id="overview">
                                    <div class="p-6">
                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                            <!-- Summary Stats -->
                                            <div>
                                                <h3 class="text-lg font-bold text-gray-800 mb-4">Summary Statistics</h3>
                                                <div class="space-y-4">
                                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                                        <div>
                                                            <p class="text-gray-600">Total Members</p>
                                                            <p class="text-2xl font-bold text-gray-800">${stats.members}</p>
                                                        </div>
                                                        <i class="fas fa-users text-blue-600 text-xl"></i>
                                                    </div>
                                                    
                                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                                        <div>
                                                            <p class="text-gray-600">Total Revenue</p>
                                                            <p class="text-2xl font-bold text-gray-800">KSh ${stats.revenue.toLocaleString()}</p>
                                                        </div>
                                                        <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                                                    </div>
                                                    
                                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                                        <div>
                                                            <p class="text-gray-600">Upcoming Events</p>
                                                            <p class="text-2xl font-bold text-gray-800">${stats.events}</p>
                                                        </div>
                                                        <i class="fas fa-calendar-alt text-purple-600 text-xl"></i>
                                                    </div>
                                                    
                                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                                        <div>
                                                            <p class="text-gray-600">Active Regions</p>
                                                            <p class="text-2xl font-bold text-gray-800">${stats.regions}</p>
                                                        </div>
                                                        <i class="fas fa-map-marker-alt text-orange-600 text-xl"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Recent Activity -->
                                            <div>
                                                <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Activity</h3>
                                                <div class="space-y-4">
                                                    ${recentPayments.length > 0 ? recentPayments.map(payment => `
                                                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                            <div>
                                                                <p class="font-medium">${payment.member_name || 'Anonymous'}</p>
                                                                <p class="text-sm text-gray-600">
                                                                    ${payment.payment_for}  ${formatDate(payment.created_at)}
                                                                </p>
                                                            </div>
                                                            <div class="text-right">
                                                                <p class="font-bold">KSh ${payment.amount.toLocaleString()}</p>
                                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                                    ${payment.payment_status}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    `).join('') : `
                                                        <div class="text-center py-8 text-gray-500">
                                                            <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                                                            <p>No recent activity</p>
                                                        </div>
                                                    `}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Financial Tab -->
                                <div class="tab-content" id="financial">
                                    <div class="p-6">
                                        <div class="mb-6">
                                            <h3 class="text-lg font-bold text-gray-800 mb-4">Financial Overview</h3>
                                            <div class="chart-container">
                                                <canvas id="financialChart"></canvas>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div class="card">
                                                <h4 class="font-bold text-gray-800 mb-3">Payment Methods</h4>
                                                <div class="chart-container">
                                                    <canvas id="paymentMethodsChart"></canvas>
                                                </div>
                                            </div>
                                            
                                            <div class="card">
                                                <h4 class="font-bold text-gray-800 mb-3">Payment Status</h4>
                                                <div class="chart-container">
                                                    <canvas id="paymentStatusChart"></canvas>
                                                </div>
                                            </div>
                                            
                                            <div class="card">
                                                <h4 class="font-bold text-gray-800 mb-3">Revenue by Type</h4>
                                                <div class="chart-container">
                                                    <canvas id="revenueByTypeChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Membership Tab -->
                                <div class="tab-content" id="membership">
                                    <div class="p-6">
                                        <div class="mb-6">
                                            <h3 class="text-lg font-bold text-gray-800 mb-4">Membership Overview</h3>
                                            <div class="chart-container">
                                                <canvas id="membershipChart"></canvas>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="card">
                                                <h4 class="font-bold text-gray-800 mb-3">Members by Region</h4>
                                                <div class="chart-container">
                                                    <canvas id="membersByRegionChart"></canvas>
                                                </div>
                                            </div>
                                            
                                            <div class="card">
                                                <h4 class="font-bold text-gray-800 mb-3">Membership Growth</h4>
                                                <div class="chart-container">
                                                    <canvas id="membershipGrowthChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Events Tab -->
                                <div class="tab-content" id="events">
                                    <div class="p-6">
                                        <div class="mb-6">
                                            <h3 class="text-lg font-bold text-gray-800 mb-4">Events Overview</h3>
                                            <div class="space-y-4">
                                                ${upcomingEvents.length > 0 ? upcomingEvents.map(event => `
                                                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                                        <div>
                                                            <p class="font-medium">${event.title}</p>
                                                            <p class="text-sm text-gray-600">
                                                                ${formatDate(event.start_date)}  ${event.venue || 'TBA'}
                                                            </p>
                                                        </div>
                                                        <div>
                                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${event.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                                ${event.status}
                                                            </span>
                                                        </div>
                                                    </div>
                                                `).join('') : `
                                                    <div class="text-center py-8 text-gray-500">
                                                        <i class="fas fa-calendar-alt text-3xl mb-3"></i>
                                                        <p>No upcoming events</p>
                                                    </div>
                                                `}
                                            </div>
                                        </div>
                                        
                                        <div class="card">
                                            <h4 class="font-bold text-gray-800 mb-4">Event Attendance</h4>
                                            <div class="chart-container">
                                                <canvas id="eventAttendanceChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Reports -->
                            <div class="mt-8">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Reports</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <button onclick="generateReport('members')" class="p-4 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition-colors">
                                        <i class="fas fa-users text-blue-600 text-2xl mb-2"></i>
                                        <p class="font-medium">Members Report</p>
                                    </button>
                                    
                                    <button onclick="generateReport('payments')" class="p-4 bg-green-50 rounded-lg text-center hover:bg-green-100 transition-colors">
                                        <i class="fas fa-money-bill-wave text-green-600 text-2xl mb-2"></i>
                                        <p class="font-medium">Payments Report</p>
                                    </button>
                                    
                                    <button onclick="generateReport('events')" class="p-4 bg-purple-50 rounded-lg text-center hover:bg-purple-100 transition-colors">
                                        <i class="fas fa-calendar-alt text-purple-600 text-2xl mb-2"></i>
                                        <p class="font-medium">Events Report</p>
                                    </button>
                                    
                                    <button onclick="generateReport('financial')" class="p-4 bg-orange-50 rounded-lg text-center hover:bg-orange-100 transition-colors">
                                        <i class="fas fa-chart-line text-orange-600 text-2xl mb-2"></i>
                                        <p class="font-medium">Financial Report</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Setup report tabs
                setupReportTabs();
                
                // Initialize charts after a short delay
                setTimeout(() => {
                    initFinancialCharts();
                    initMembershipCharts();
                    initEventCharts();
                }, 100);
                
            } catch (error) {
                console.error('Error loading reports:', error);
                showToast('Error loading reports: ' + error.message, 'error');
            }
        }
        
        function setupReportTabs() {
            document.querySelectorAll('.tab[data-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Initialize charts for the active tab
                    setTimeout(() => {
                        switch(tabId) {
                            case 'financial':
                                initFinancialCharts();
                                break;
                            case 'membership':
                                initMembershipCharts();
                                break;
                            case 'events':
                                initEventCharts();
                                break;
                        }
                    }, 100);
                });
            });
        }
        
        function initFinancialCharts() {
            // Financial Overview Chart
            const financialCtx = document.getElementById('financialChart')?.getContext('2d');
            if (financialCtx) {
                new Chart(financialCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Revenue (KSh)',
                            data: [150000, 200000, 180000, 250000, 220000, 300000],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
            
            // Payment Methods Chart
            const methodsCtx = document.getElementById('paymentMethodsChart')?.getContext('2d');
            if (methodsCtx) {
                new Chart(methodsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['M-Pesa', 'Bank Transfer', 'Cash', 'Other'],
                        datasets: [{
                            data: [65, 20, 10, 5],
                            backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#6b7280']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }
        
        function initMembershipCharts() {
            // Membership Chart
            const membershipCtx = document.getElementById('membershipChart')?.getContext('2d');
            if (membershipCtx) {
                new Chart(membershipCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'New Members',
                            data: [15, 20, 18, 25, 22, 30],
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 5
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function initEventCharts() {
            // Event Attendance Chart
            const attendanceCtx = document.getElementById('eventAttendanceChart')?.getContext('2d');
            if (attendanceCtx) {
                new Chart(attendanceCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Event 1', 'Event 2', 'Event 3', 'Event 4', 'Event 5'],
                        datasets: [{
                            label: 'Attendance',
                            data: [45, 60, 35, 80, 55],
                            backgroundColor: '#8b5cf6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }
        
        function generateReport(type) {
            showToast(`Generating ${type} report...`, 'info');
            
            // In a real application, this would generate and download a report
            // For now, show a success message
            setTimeout(() => {
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} report generated successfully`, 'success');
            }, 1500);
        }
        
        // ==================== SYSTEM SETTINGS ====================
        
        async function loadSystemSettings() {
            try {
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <h2 class="text-xl font-bold text-gray-800">System Settings</h2>
                            <p class="text-gray-600 text-sm mt-1">Configure system preferences and options</p>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Left Column: Navigation -->
                                <div class="lg:col-span-1">
                                    <div class="space-y-2">
                                        <button onclick="showSettingsTab('general')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-cog mr-3"></i>General Settings
                                        </button>
                                        <button onclick="showSettingsTab('email')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-envelope mr-3"></i>Email Settings
                                        </button>
                                        <button onclick="showSettingsTab('payments')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-money-bill-wave mr-3"></i>Payment Settings
                                        </button>
                                        <button onclick="showSettingsTab('membership')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-users mr-3"></i>Membership Settings
                                        </button>
                                        <button onclick="showSettingsTab('notifications')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-bell mr-3"></i>Notifications
                                        </button>
                                        <button onclick="showSettingsTab('backup')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-database mr-3"></i>Backup & Restore
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Right Column: Settings Content -->
                                <div class="lg:col-span-2">
                                    <div id="settings-content">
                                        <!-- Content will be loaded here -->
                                        <div class="text-center py-12">
                                            <i class="fas fa-cog text-gray-400 text-5xl mb-4"></i>
                                            <p class="text-gray-600">Select a settings category to begin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Error loading settings: ' + error.message, 'error');
            }
        }
        
        function showSettingsTab(tab) {
            let content = '';
            
            switch(tab) {
                case 'general':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">General Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Organization Name</label>
                                <input type="text" class="form-input" value="KESNNUR">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Timezone</label>
                                <select class="form-input">
                                    <option value="Africa/Nairobi" selected>Africa/Nairobi (EAT)</option>
                                    <option value="UTC">UTC</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Date Format</label>
                                <select class="form-input">
                                    <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option>
                                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Currency</label>
                                <select class="form-input">
                                    <option value="KES" selected>Kenyan Shilling (KES)</option>
                                    <option value="USD">US Dollar (USD)</option>
                                    <option value="EUR">Euro (EUR)</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-primary">Save Changes</button>
                        </div>
                    `;
                    break;
                    
                case 'email':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Email Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">SMTP Host</label>
                                <input type="text" class="form-input" placeholder="smtp.gmail.com">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">SMTP Port</label>
                                    <input type="number" class="form-input" placeholder="587">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Encryption</label>
                                    <select class="form-input">
                                        <option value="tls">TLS</option>
                                        <option value="ssl">SSL</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Sender Email</label>
                                <input type="email" class="form-input" placeholder="noreply@kesnnur.com">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Sender Name</label>
                                <input type="text" class="form-input" placeholder="KESNNUR Management">
                            </div>
                            
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                                    <div class="text-sm text-yellow-800">
                                        <p class="font-medium">Test Email Configuration</p>
                                        <p class="mt-1">Test your email settings before saving</p>
                                        <button class="mt-2 btn btn-warning btn-sm">Send Test Email</button>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary">Save Email Settings</button>
                        </div>
                    `;
                    break;
                    
                case 'payments':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Payment Settings</h3>
                        <div class="space-y-6">
                            <!-- M-Pesa Settings -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-mobile-alt mr-2 text-green-600"></i>
                                    M-Pesa Integration
                                </h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Consumer Key</label>
                                        <input type="password" class="form-input" placeholder="Enter Daraja API consumer key">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Consumer Secret</label>
                                        <input type="password" class="form-input" placeholder="Enter Daraja API consumer secret">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Short Code</label>
                                        <input type="text" class="form-input" placeholder="Business number">
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="enable_mpesa" class="mr-3">
                                        <label for="enable_mpesa" class="text-sm font-medium">Enable M-Pesa Payments</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment Gateway Settings -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-4">Payment Gateways</h4>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">M-Pesa</p>
                                            <p class="text-sm text-gray-600">Mobile money payments</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Bank Transfer</p>
                                            <p class="text-sm text-gray-600">Direct bank deposits</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Cash</p>
                                            <p class="text-sm text-gray-600">In-person cash payments</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary">Save Payment Settings</button>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('settings-content').innerHTML = content;
        }
        
        // ==================== MODAL FUNCTIONS ====================
        
        function showModal(content, size = '') {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            
            if (size) {
                modalContent.classList.add('modal-lg');
            } else {
                modalContent.classList.remove('modal-lg');
            }
            
            modalContent.innerHTML = content;
            modal.style.display = 'block';
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
            modal.querySelector('.modal-content').innerHTML = '';
            
            // Restore body scroll
            document.body.style.overflow = '';
        }
        
        // ==================== EXPORT FUNCTIONS ====================
        
        function exportMembers() {
            showToast('Exporting members list...', 'info');
            
            // In a real application, this would generate and download a CSV
            // For now, show a success message
            setTimeout(() => {
                showToast('Members list exported successfully', 'success');
            }, 1500);
        }
        
        function exportPayments() {
            showToast('Exporting payments list...', 'info');
            
            // In a real application, this would generate and download a CSV
            // For now, show a success message
            setTimeout(() => {
                showToast('Payments list exported successfully', 'success');
            }, 1500);
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        
        function refreshData() {
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const section = activeNav.getAttribute('data-section');
                loadSection(section);
                showToast('Data refreshed', 'success');
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                const supabase = initSupabase();
                supabase.auth.signOut().then(() => {
                    window.location.href = 'login.html';
                });
            }
        }
        
        function setupMpesaIntegration() {
            showModal(`
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">M-Pesa API Integration</h3>
                    <p class="text-gray-600 mb-6">Configure Safaricom Daraja API for automatic M-Pesa payment processing.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Daraja API Consumer Key</label>
                            <input type="password" class="form-input" placeholder="Enter your consumer key">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Daraja API Consumer Secret</label>
                            <input type="password" class="form-input" placeholder="Enter your consumer secret">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Business Short Code</label>
                            <input type="text" class="form-input" placeholder="e.g., 174379">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Passkey</label>
                            <input type="password" class="form-input" placeholder="Enter your passkey">
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-800 mb-2">How to get credentials:</h4>
                            <ol class="list-decimal pl-5 text-sm text-gray-600 space-y-1">
                                <li>Register on Safaricom Developer Portal</li>
                                <li>Create an app to get Consumer Key and Secret</li>
                                <li>Use your business number as Short Code</li>
                                <li>Generate Passkey in the Daraja portal</li>
                            </ol>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                            <button onclick="testMpesaIntegration()" class="btn btn-primary">Test Connection</button>
                            <button onclick="saveMpesaIntegration()" class="btn btn-success">Save Configuration</button>
                        </div>
                    </div>
                </div>
            `);
        }
        
        function testMpesaIntegration() {
            showToast('Testing M-Pesa API connection...', 'info');
            setTimeout(() => {
                showToast('M-Pesa API connection successful!', 'success');
            }, 2000);
        }
        
        function saveMpesaIntegration() {
            showToast('M-Pesa API configuration saved', 'success');
            closeModal();
        }
        
        // ==================== INITIALIZATION ====================
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Refresh with F5
            if (e.key === 'F5') {
                e.preventDefault();
                refreshData();
            }
            
            // Close modal with Escape
            if (e.key === 'Escape') {
                closeModal();
            }
            
            // Navigation shortcuts (Ctrl/Cmd + number)
            if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '9') {
                e.preventDefault();
                const navItems = document.querySelectorAll('.nav-item');
                const index = parseInt(e.key) - 1;
                if (navItems[index]) {
                    navItems[index].click();
                }
            }
        });
        
        // ==================== ERROR HANDLING ====================
        
        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error:', { message, source, lineno, colno, error });
            showToast('An error occurred. Please refresh the page.', 'error');
            return true;
        };
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showToast('An error occurred. Please try again.', 'error');
        });
        
        // ==================== END OF SCRIPT ====================
    </script>
</body>
</html>
