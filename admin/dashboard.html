<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KESNNUR - Complete Management System</title>
    <!-- Local Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* All custom styles from original code */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast-success {
            background: #10b981;
        }
        
        .toast-error {
            background: #ef4444;
        }
        
        .toast-info {
            background: #3b82f6;
        }
        
        .toast-warning {
            background: #f59e0b;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        :root {
            --sidebar-width: 280px;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: #f8fafc;
        }
        .nav-item {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            margin: 50px auto;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-lg {
            max-width: 1000px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge.active {
            background: #10b98120;
            color: #10b981;
        }
        .badge.pending {
            background: #f59e0b20;
            color: #f59e0b;
        }
        .badge.inactive {
            background: #ef444420;
            color: #ef4444;
        }
        
        /* All other styles from the original code remain the same */
        /* ... [rest of the CSS styles] ... */
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-6 border-b border-white/20">
            <div class="flex items-center space-x-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i class="fas fa-users text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg">KESNNUR</h1>
                    <p class="text-white/80 text-xs">Management System</p>
                </div>
            </div>
        </div>
        
        <div class="p-4">
            <!-- DASHBOARD -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4">
                Dashboard
            </div>
            <div class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt mr-3"></i>
                Overview
            </div>
            
            <!-- MEMBERSHIP MANAGEMENT -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Membership
            </div>
            <div class="nav-item" data-section="members">
                <i class="fas fa-users mr-3"></i>
                All Members
            </div>
            <div class="nav-item" data-section="add-member">
                <i class="fas fa-user-plus mr-3"></i>
                Add New Member
            </div>
            
            <!-- REGIONS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Regions
            </div>
            <div class="nav-item" data-section="regions">
                <i class="fas fa-map-marker-alt mr-3"></i>
                Manage Regions
            </div>
            
            <!-- EVENTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Events
            </div>
            <div class="nav-item" data-section="events">
                <i class="fas fa-calendar-alt mr-3"></i>
                Events Calendar
            </div>
            <div class="nav-item" data-section="add-event">
                <i class="fas fa-calendar-plus mr-3"></i>
                Add Event
            </div>
            
            <!-- FINANCIAL -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Financial
            </div>
            <div class="nav-item" data-section="payments">
                <i class="fas fa-money-bill-wave mr-3"></i>
                Payments
            </div>
            <div class="nav-item" data-section="add-payment">
                <i class="fas fa-plus-circle mr-3"></i>
                Record Payment
            </div>
            <div class="nav-item" data-section="mpesa-payments">
                <i class="fas fa-mobile-alt mr-3"></i>
                M-Pesa Payments
            </div>
            
            <!-- COMMUNICATIONS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Communications
            </div>
            <div class="nav-item" data-section="announcements">
                <i class="fas fa-bullhorn mr-3"></i>
                Announcements
            </div>
            
            <!-- REPORTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Reports
            </div>
            <div class="nav-item" data-section="reports">
                <i class="fas fa-chart-bar mr-3"></i>
                Reports
            </div>
            
            <!-- SYSTEM -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                System
            </div>
            <div class="nav-item" data-section="users">
                <i class="fas fa-user-shield mr-3"></i>
                Admin Users
            </div>
            <div class="nav-item" data-section="settings">
                <i class="fas fa-cog mr-3"></i>
                System Settings
            </div>
        </div>
        
        <!-- User Info -->
        <div class="p-4 border-t border-white/20 mt-auto">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <p class="font-medium" id="userName">Loading...</p>
                    <p class="text-white/60 text-sm" id="userRole">Loading...</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="p-6 border-b bg-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard Overview</h1>
                    <p class="text-gray-600" id="welcomeMessage">Welcome back</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600" id="lastLogin">
                        Last login: Loading...
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="p-6" id="contentArea">
            <!-- Loading spinner -->
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading dashboard...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for forms -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <!-- Modal content will be loaded here -->
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        const ADMIN_ROLES = ['admin', 'super_admin', 'editor'];
        
        // Kenyan Regions
        const KENYAN_REGIONS = [
            "Nairobi",
            "Coast",
            "Eastern",
            "North Eastern",
            "Central",
            "Rift Valley",
            "Western",
            "Nyanza"
        ];
        
        // Membership Types
        const MEMBERSHIP_TYPES = [
            "student",
            "professional",
            "associate",
            "alumni",
            "life_member",
            "honorary"
        ];
        
        // Payment Methods
        const PAYMENT_METHODS = [
            "mpesa",
            "bank_transfer",
            "cash",
            "cheque",
            "credit_card"
        ];
        
        // Event Types
        const EVENT_TYPES = [
            "meeting",
            "workshop",
            "seminar",
            "conference",
            "social",
            "training",
            "webinar",
            "fundraiser"
        ];
        
        // Announcement Types
        const ANNOUNCEMENT_TYPES = [
            "general",
            "event",
            "news",
            "urgent",
            "maintenance",
            "update"
        ];
        
        // ==================== DATA CACHING ====================
        let dataCache = {
            members: null,
            payments: null,
            events: null,
            announcements: null,
            users: null,
            regions: null,
            lastUpdated: {}
        };
        
        // ==================== GLOBAL VARIABLES ====================
        let supabaseClient = null;
        let currentUser = null;
        let currentUserProfile = null;
        let heartbeatInterval = null;
        let isOnline = navigator.onLine;
        let calendarInstance = null;
        
        // ==================== UTILITY FUNCTIONS ====================
        
        // Custom Toast Function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Generate random password
        function generatePassword(length = 12) {
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let password = "";
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }
        
        // Check password strength
        function checkPasswordStrength(password) {
            let score = 0;
            if (password.length >= 8) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            return score;
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy', 'error');
            });
        }
        
        // Generate Member Number
        async function generateMemberNumber(membershipType = 'general') {
            try {
                const supabase = initSupabase();
                const currentYear = new Date().getFullYear();
                
                // Get last member number
                const { data: lastMember } = await supabase
                    .from('members')
                    .select('membership_number')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                let sequence = 1;
                if (lastMember && lastMember.membership_number) {
                    const parts = lastMember.membership_number.split('-');
                    if (parts.length === 4 && parts[1] === currentYear.toString()) {
                        const lastSeq = parseInt(parts[3]) || 0;
                        sequence = lastSeq + 1;
                    }
                }
                
                const typeCode = membershipType.substring(0, 3).toUpperCase();
                return `KESNNUR-${currentYear}-${typeCode}-${sequence.toString().padStart(4, '0')}`;
            } catch (error) {
                // Fallback to timestamp-based ID
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');
                return `KESNNUR-${new Date().getFullYear()}-${timestamp}${random}`;
            }
        }
        
        // Generate Invoice Number
        function generateInvoiceNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `INV-${year}${month}${day}-${random}`;
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES'
            }).format(amount);
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-KE', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Format datetime
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-KE', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Initialize Supabase
        function initSupabase() {
            if (!supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }
        
        // ==================== AUTHENTICATION & SESSION MANAGEMENT ====================
        
        // Redirect to login
        function redirectToLogin() {
            showToast('Session expired, please login again', 'error');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }
        
        // Check authentication state with retry logic
        async function checkAuth(forceRefresh = false) {
            try {
                console.log('Checking authentication...');
                
                // Initialize Supabase
                const supabase = initSupabase();
                
                // Check for existing session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                    
                    // Try to refresh session
                    const { data: refreshedSession, error: refreshError } = await supabase.auth.refreshSession();
                    
                    if (refreshError || !refreshedSession?.session) {
                        console.log('No valid session found');
                        redirectToLogin();
                        return false;
                    }
                    
                    currentUser = refreshedSession.session.user;
                    showToast('Session refreshed', 'info');
                } else if (!session || !session.user) {
                    console.log('No active session found');
                    redirectToLogin();
                    return false;
                } else {
                    currentUser = session.user;
                }
                
                // Get user profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profileError) {
                    console.error('Profile error:', profileError);
                    
                    // If profile doesn't exist, create one
                    const { data: newProfile, error: createError } = await supabase
                        .from('profiles')
                        .insert([{
                            id: currentUser.id,
                            email: currentUser.email,
                            role: 'admin',
                            first_name: currentUser.email.split('@')[0],
                            last_name: '',
                            status: 'active'
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Create profile error:', createError);
                        const basicProfile = {
                            id: currentUser.id,
                            email: currentUser.email,
                            role: 'admin',
                            first_name: currentUser.email.split('@')[0],
                            last_name: '',
                            status: 'active'
                        };
                        currentUserProfile = basicProfile;
                    } else {
                        currentUserProfile = newProfile;
                    }
                    
                    return true;
                }
                
                if (!profile) {
                    console.log('No profile found for user');
                    redirectToLogin();
                    return false;
                }
                
                // Check if user has admin role
                if (!ADMIN_ROLES.includes(profile.role)) {
                    console.log('User does not have admin role:', profile.role);
                    showToast('Access denied: Admin privileges required', 'error');
                    redirectToLogin();
                    return false;
                }
                
                currentUserProfile = profile;
                
                // Update last login
                try {
                    await supabase
                        .from('profiles')
                        .update({ 
                            last_login: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentUser.id);
                } catch (updateError) {
                    console.warn('Could not update last login:', updateError);
                }
                
                console.log('Authentication successful');
                return true;
                
            } catch (error) {
                console.error('Auth check error:', error);
                showToast('Authentication error: ' + error.message, 'error');
                redirectToLogin();
                return false;
            }
        }
        
        // Start heartbeat to keep session alive
        function startHeartbeat() {
            // Clear existing heartbeat
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            
            // Ping every 4 minutes to keep session alive
            heartbeatInterval = setInterval(async () => {
                try {
                    if (!isOnline) return;
                    
                    const supabase = initSupabase();
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session) {
                        console.log('Heartbeat: Session active');
                        // Refresh token periodically
                        await supabase.auth.refreshSession();
                    }
                } catch (error) {
                    console.warn('Heartbeat failed:', error);
                }
            }, 4 * 60 * 1000); // 4 minutes
        }
        
        // Setup auth state listener
        function setupAuthListener() {
            if (window.authListenerSet) return;
            window.authListenerSet = true;
            
            const supabase = initSupabase();
            
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event);
                
                switch(event) {
                    case 'SIGNED_OUT':
                        showToast('You have been logged out', 'info');
                        redirectToLogin();
                        break;
                        
                    case 'SIGNED_IN':
                        if (session) {
                            currentUser = session.user;
                            await checkAuth();
                            updateUserInfo();
                            showToast('Welcome back!', 'success');
                            startHeartbeat();
                        }
                        break;
                        
                    case 'TOKEN_REFRESHED':
                        console.log('Token refreshed successfully');
                        break;
                        
                    case 'USER_UPDATED':
                        console.log('User updated');
                        break;
                }
            });
        }
        
        // Setup tab visibility handler
        function setupTabVisibilityHandler() {
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden) {
                    // Tab became visible again
                    console.log('Tab became visible, checking auth...');
                    
                    // Check auth with force refresh
                    const isAuthenticated = await checkAuth(true);
                    
                    if (isAuthenticated) {
                        // Refresh current section
                        const activeNav = document.querySelector('.nav-item.active');
                        if (activeNav) {
                            const section = activeNav.getAttribute('data-section');
                            loadSection(section);
                        }
                    }
                }
            });
        }
        
        // Setup page focus handler
        function setupFocusHandler() {
            window.addEventListener('focus', async () => {
                console.log('Page regained focus, refreshing data...');
                
                // Refresh current data
                const activeNav = document.querySelector('.nav-item.active');
                if (activeNav) {
                    const section = activeNav.getAttribute('data-section');
                    loadSection(section);
                }
            });
        }
        
        // Setup network status handler
        function setupNetworkHandler() {
            window.addEventListener('online', () => {
                isOnline = true;
                showToast('Back online', 'success');
                
                // Refresh data when coming back online
                setTimeout(() => {
                    const activeNav = document.querySelector('.nav-item.active');
                    if (activeNav) {
                        const section = activeNav.getAttribute('data-section');
                        loadSection(section);
                    }
                }, 1000);
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                showToast('You are offline. Some features may not work.', 'warning');
            });
        }
        
        // Update user info in sidebar
        function updateUserInfo() {
            if (!currentUserProfile) return;
            
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const lastLogin = document.getElementById('lastLogin');
            
            if (userName) {
                userName.textContent = 
                    currentUserProfile.first_name && currentUserProfile.last_name 
                        ? `${currentUserProfile.first_name} ${currentUserProfile.last_name}`
                        : currentUserProfile.email || 'User';
            }
            
            if (userRole) {
                userRole.textContent = 
                    (currentUserProfile.role || 'user').replace('_', ' ').toUpperCase();
            }
            
            if (welcomeMessage) {
                welcomeMessage.textContent = 
                    `Welcome back, ${currentUserProfile.first_name || 'Admin'}`;
            }
            
            if (lastLogin) {
                const lastLoginTime = currentUserProfile.last_login 
                    ? new Date(currentUserProfile.last_login).toLocaleString('en-KE')
                    : 'First login';
                
                lastLogin.textContent = `Last login: ${lastLoginTime}`;
            }
        }
        
        // ==================== INITIALIZATION ====================
        
        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Show loading state
                document.getElementById('contentArea').innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-600">Initializing system...</p>
                        </div>
                    </div>
                `;
                
                // Setup network handler first
                setupNetworkHandler();
                
                // Check authentication
                const isAuthenticated = await checkAuth();
                
                if (!isAuthenticated) {
                    console.log('User not authenticated, redirecting to login...');
                    showToast('Please login to access admin dashboard', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                    return;
                }
                
                // Update user info
                updateUserInfo();
                
                // Setup event listeners
                setupEventListeners();
                
                // Setup visibility handlers
                setupTabVisibilityHandler();
                setupFocusHandler();
                
                // Start heartbeat
                startHeartbeat();
                
                // Load dashboard
                await loadDashboard();
                
                // Setup auth state listener
                setupAuthListener();
                
                // Initialize default regions if not exist
                await initializeRegions();
                
                showToast('KESNNUR Management System loaded!', 'success');
                
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showToast('Error loading dashboard: ' + error.message, 'error');
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 text-4xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">System Error</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="initializeDashboard()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Initialize Kenyan regions
        async function initializeRegions() {
            try {
                const supabase = initSupabase();
                
                // Check if regions exist
                const { data: existingRegions } = await supabase
                    .from('regions')
                    .select('*');
                
                if (!existingRegions || existingRegions.length === 0) {
                    // Insert default Kenyan regions
                    const regionsData = KENYAN_REGIONS.map(region => ({
                        name: region,
                        code: region.substring(0, 3).toUpperCase(),
                        status: 'active',
                        country: 'Kenya',
                        description: `${region} region of Kenya`,
                        created_at: new Date().toISOString()
                    }));
                    
                    await supabase
                        .from('regions')
                        .insert(regionsData);
                    
                    console.log('Default Kenyan regions initialized');
                }
            } catch (error) {
                console.warn('Could not initialize regions:', error);
            }
        }
        
        // Setup navigation event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // Check auth before switching
                    checkAuth().then(isAuth => {
                        if (isAuth) {
                            // Update active state
                            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                            this.classList.add('active');
                            
                            // Load section
                            loadSection(section);
                        }
                    });
                });
            });
        }
        
        // ==================== SECTION LOADING ====================
        
        async function loadSection(section) {
            const contentArea = document.getElementById('contentArea');
            
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                showToast('Session expired, please login again', 'error');
                window.location.href = 'login.html';
                return;
            }
            
            // Update page title
            const pageTitles = {
                'dashboard': 'Dashboard Overview',
                'members': 'All Members',
                'add-member': 'Add New Member',
                'regions': 'Manage Regions',
                'events': 'Events Calendar',
                'add-event': 'Add New Event',
                'payments': 'Payments',
                'add-payment': 'Record Payment',
                'mpesa-payments': 'M-Pesa Payments',
                'announcements': 'Announcements',
                'reports': 'Reports',
                'users': 'Admin Users',
                'settings': 'System Settings'
            };
            
            document.getElementById('pageTitle').textContent = pageTitles[section] || section;
            
            // Show loading
            contentArea.innerHTML = `
                <div class="flex items-center justify-center h-64">
                    <div class="text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading ${pageTitles[section] || section}...</p>
                    </div>
                </div>
            `;
            
            // Load the appropriate section
            try {
                switch(section) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'members':
                        await loadMembersManager();
                        break;
                    case 'add-member':
                        await loadAddMemberForm();
                        break;
                    case 'regions':
                        await loadRegionsManager();
                        break;
                    case 'events':
                        await loadEventsManager();
                        break;
                    case 'add-event':
                        await loadAddEventForm();
                        break;
                    case 'payments':
                        await loadPaymentsManager();
                        break;
                    case 'add-payment':
                        await loadAddPaymentForm();
                        break;
                    case 'mpesa-payments':
                        await loadMpesaPayments();
                        break;
                    case 'announcements':
                        await loadAnnouncementsManager();
                        break;
                    case 'reports':
                        await loadReportsManager();
                        break;
                    case 'users':
                        await loadUsersManager();
                        break;
                    case 'settings':
                        await loadSystemSettings();
                        break;
                    default:
                        contentArea.innerHTML = '<div class="text-center py-12">Section not found</div>';
                }
            } catch (error) {
                console.error(`Error loading ${section}:`, error);
                contentArea.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 text-4xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Error Loading Section</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="loadSection('${section}')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // ==================== DASHBOARD SECTION ====================
        
        async function loadDashboard() {
            try {
                const stats = await loadStats();
                const recentMembers = await getRecentMembers(5);
                const upcomingEvents = await getUpcomingEvents(5);
                const recentPayments = await getRecentPayments(5);
                
                document.getElementById('contentArea').innerHTML = `
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 text-white mb-8">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">KESNNUR Management System</h2>
                                <p class="text-blue-100">Complete management solution for your organization</p>
                            </div>
                            <div class="text-4xl">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Members</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.members}</h3>
                                    <p class="text-blue-600 text-sm mt-1">
                                        <i class="fas fa-users mr-1"></i>${stats.membersGrowth > 0 ? '+' : ''}${stats.membersGrowth}% this month
                                    </p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-lg">
                                    <i class="fas fa-users text-blue-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Active Regions</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.regions}</h3>
                                    <p class="text-purple-600 text-sm mt-1">
                                        <i class="fas fa-map-marker-alt mr-1"></i>Locations
                                    </p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-lg">
                                    <i class="fas fa-map-marker-alt text-purple-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Upcoming Events</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.events}</h3>
                                    <p class="text-green-600 text-sm mt-1">
                                        <i class="fas fa-calendar mr-1"></i>Next 30 days
                                    </p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-lg">
                                    <i class="fas fa-calendar-alt text-green-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Revenue</p>
                                    <h3 class="text-2xl font-bold text-gray-800">KSh ${stats.revenue.toLocaleString()}</h3>
                                    <p class="text-orange-600 text-sm mt-1">
                                        <i class="fas fa-money-bill-wave mr-1"></i>This Month
                                    </p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-lg">
                                    <i class="fas fa-money-bill-wave text-orange-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Recent Members -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Recent Members</h2>
                                <button onclick="loadSection('members')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${recentMembers.length > 0 ? recentMembers.map(member => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-blue-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${member.first_name} ${member.last_name}</p>
                                            <p class="text-gray-600 text-sm">${member.email} • ${member.region || 'No Region'}</p>
                                        </div>
                                        <span class="badge ${member.membership_status === 'active' ? 'active' : member.membership_status === 'pending' ? 'pending' : 'inactive'}">
                                            ${member.membership_status || 'pending'}
                                        </span>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-users text-3xl mb-3"></i>
                                        <p>No members yet</p>
                                        <button onclick="loadSection('add-member')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Add your first member
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Upcoming Events -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Upcoming Events</h2>
                                <button onclick="loadSection('events')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${upcomingEvents.length > 0 ? upcomingEvents.map(event => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-calendar text-green-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${event.title}</p>
                                            <p class="text-gray-600 text-sm">
                                                ${new Date(event.start_date).toLocaleDateString()} • ${event.venue || 'TBA'}
                                            </p>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-calendar text-3xl mb-3"></i>
                                        <p>No upcoming events</p>
                                        <button onclick="loadSection('add-event')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Schedule an event
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Recent Payments -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Recent Payments</h2>
                                <button onclick="loadSection('payments')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${recentPayments.length > 0 ? recentPayments.map(payment => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-money-bill-wave text-orange-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${payment.member_name || 'Anonymous'}</p>
                                            <p class="text-gray-600 text-sm">
                                                KSh ${payment.amount.toLocaleString()} • ${payment.payment_method}
                                            </p>
                                        </div>
                                        <span class="badge ${payment.payment_status === 'completed' ? 'active' : payment.payment_status === 'pending' ? 'pending' : 'inactive'}">
                                            ${payment.payment_status}
                                        </span>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                                        <p>No recent payments</p>
                                        <button onclick="loadSection('add-payment')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Record a payment
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div class="mt-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Revenue Chart -->
                            <div class="bg-white rounded-xl shadow p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-6">Revenue Overview</h2>
                                <div class="chart-container">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Members Chart -->
                            <div class="bg-white rounded-xl shadow p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-6">Membership Growth</h2>
                                <div class="chart-container">
                                    <canvas id="membersChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-xl shadow p-6 mt-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="loadSection('add-member')" class="p-4 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition-colors">
                                <i class="fas fa-user-plus text-blue-900 text-2xl mb-2"></i>
                                <p class="font-medium">Add Member</p>
                            </button>
                            
                            <button onclick="loadSection('add-event')" class="p-4 bg-green-50 rounded-lg text-center hover:bg-green-100 transition-colors">
                                <i class="fas fa-calendar-plus text-green-900 text-2xl mb-2"></i>
                                <p class="font-medium">Add Event</p>
                            </button>
                            
                            <button onclick="loadSection('add-payment')" class="p-4 bg-orange-50 rounded-lg text-center hover:bg-orange-100 transition-colors">
                                <i class="fas fa-money-bill-wave text-orange-900 text-2xl mb-2"></i>
                                <p class="font-medium">Record Payment</p>
                            </button>
                            
                            <button onclick="loadSection('reports')" class="p-4 bg-purple-50 rounded-lg text-center hover:bg-purple-100 transition-colors">
                                <i class="fas fa-chart-bar text-purple-900 text-2xl mb-2"></i>
                                <p class="font-medium">View Reports</p>
                            </button>
                        </div>
                    </div>
                `;
                
                // Initialize charts
                setTimeout(() => {
                    initRevenueChart();
                    initMembersChart();
                }, 100);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading dashboard: ${error.message}</p>
                        <button onclick="loadDashboard()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        async function loadStats() {
            try {
                const supabase = initSupabase();
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const firstDayOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                
                // Get member count
                let memberCount = 0;
                let lastMonthMemberCount = 0;
                try {
                    const { count } = await supabase
                        .from('members')
                        .select('*', { count: 'exact', head: true });
                    memberCount = count || 0;
                    
                    // Get last month's count
                    const { count: lastMonthCount } = await supabase
                        .from('members')
                        .select('*', { count: 'exact', head: true })
                        .lt('created_at', firstDayOfMonth.toISOString());
                    lastMonthMemberCount = lastMonthCount || 0;
                } catch (error) {
                    console.warn('Error counting members:', error);
                }
                
                // Get regions count
                let regionCount = 0;
                try {
                    const { count } = await supabase
                        .from('regions')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'active');
                    regionCount = count || 0;
                } catch (error) {
                    console.warn('Error counting regions:', error);
                }
                
                // Get events count (next 30 days)
                let eventCount = 0;
                try {
                    const thirtyDaysFromNow = new Date();
                    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                    
                    const { count } = await supabase
                        .from('events')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'published')
                        .gte('start_date', now.toISOString())
                        .lte('start_date', thirtyDaysFromNow.toISOString());
                    eventCount = count || 0;
                } catch (error) {
                    console.warn('Error counting events:', error);
                }
                
                // Get total revenue (this month)
                let totalRevenue = 0;
                try {
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    lastDay.setHours(23, 59, 59, 999);
                    
                    const { data: payments } = await supabase
                        .from('payments')
                        .select('amount')
                        .eq('payment_status', 'completed')
                        .gte('paid_at', firstDayOfMonth.toISOString())
                        .lte('paid_at', lastDay.toISOString());
                    
                    if (payments) {
                        payments.forEach(payment => {
                            totalRevenue += parseFloat(payment.amount || 0);
                        });
                    }
                } catch (error) {
                    console.warn('Error calculating revenue:', error);
                }
                
                // Calculate growth
                const membersGrowth = lastMonthMemberCount > 0 
                    ? Math.round(((memberCount - lastMonthMemberCount) / lastMonthMemberCount) * 100)
                    : 0;
                
                return {
                    members: memberCount,
                    membersGrowth: membersGrowth,
                    regions: regionCount,
                    events: eventCount,
                    revenue: totalRevenue
                };
                
            } catch (error) {
                console.error('Error loading stats:', error);
                return { members: 0, membersGrowth: 0, regions: 0, events: 0, revenue: 0 };
            }
        }
        
        async function getRecentMembers(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('members')
                    .select(`
                        *,
                        member_profile:profiles!members_profile_id_fkey (
                            id, email, first_name, last_name, phone
                        ),
                        member_region:regions!members_region_id_fkey (
                            name
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(limit);
                
                if (!data) return [];
                
                const formattedData = data.map(member => ({
                    id: member.id,
                    profile_id: member.profile_id,
                    region_id: member.region_id,
                    membership_number: member.membership_number,
                    membership_type: member.membership_type,
                    membership_status: member.membership_status,
                    join_date: member.join_date,
                    created_at: member.created_at,
                    updated_at: member.updated_at,
                    first_name: member.member_profile?.first_name || '',
                    last_name: member.member_profile?.last_name || '',
                    email: member.member_profile?.email || '',
                    phone: member.member_profile?.phone || '',
                    region: member.member_region?.name || 'No Region'
                }));
                
                return formattedData;
            } catch (error) {
                console.error('Error getting recent members:', error);
                return [];
            }
        }
        
        async function getUpcomingEvents(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('events')
                    .select('*')
                    .eq('status', 'published')
                    .gte('start_date', new Date().toISOString())
                    .order('start_date', { ascending: true })
                    .limit(limit);
                return data || [];
            } catch (error) {
                console.error('Error getting upcoming events:', error);
                return [];
            }
        }
        
        async function getRecentPayments(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        member:members!payments_member_id_fkey (
                            profile:profiles!members_profile_id_fkey (
                                first_name, last_name
                            )
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(limit);
                
                if (!data) return [];
                
                return data.map(payment => ({
                    id: payment.id,
                    amount: parseFloat(payment.amount || 0),
                    payment_method: payment.payment_method,
                    payment_status: payment.payment_status,
                    payment_for: payment.payment_for,
                    member_name: payment.member?.profile ? 
                        `${payment.member.profile.first_name} ${payment.member.profile.last_name}` : 
                        'Anonymous',
                    created_at: payment.created_at
                }));
            } catch (error) {
                console.error('Error getting recent payments:', error);
                return [];
            }
        }
        
        function initRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Sample data - in real app, fetch from API
            const data = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Revenue (KSh)',
                    data: [120000, 190000, 150000, 250000, 200000, 300000],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KSh ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function initMembersChart() {
            const ctx = document.getElementById('membersChart').getContext('2d');
            
            // Sample data
            const data = {
                labels: ['Student', 'Professional', 'Associate', 'Alumni', 'Life Member'],
                datasets: [{
                    label: 'Members by Type',
                    data: [45, 30, 15, 8, 2],
                    backgroundColor: [
                        '#3b82f6',
                        '#10b981',
                        '#f59e0b',
                        '#8b5cf6',
                        '#ef4444'
                    ],
                    borderWidth: 1
                }]
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // ==================== MEMBERS MANAGER ====================
        // [The complete members manager code from original]
        // ==================== ADD MEMBER FORM ====================
        // [The complete add member form code from original]
        // ==================== EDIT MEMBER ====================
        // [The complete edit member code from original]
        // ==================== VIEW MEMBER DETAILS ====================
        // [The complete view member details code from original]
        // ==================== DELETE MEMBER ====================
        // [The complete delete member code from original]
        // ==================== ADMIN USERS MANAGER ====================
        // [The complete admin users manager code from original]
        // ==================== EDIT USER ROLE ====================
        // [The complete edit user role code from original]
        // ==================== DELETE USER ====================
        // [The complete delete user code from original]
        // ==================== M-PESA PAYMENTS ====================
        // [The complete M-Pesa payments code from original]
        // ==================== PAYMENTS MANAGER ====================
        // [The complete payments manager code from original]
        // ==================== VIEW PAYMENT DETAILS ====================
        // [The complete view payment details code from original]
        // ==================== ADD PAYMENT FORM ====================
        // [The complete add payment form code from original]
        // ==================== EDIT PAYMENT ====================
        // [The complete edit payment code from original]
        // ==================== DELETE PAYMENT ====================
        // [The complete delete payment code from original]
        // ==================== REGIONS MANAGER ====================
        // [The complete regions manager code from original]
        // ==================== EVENTS MANAGER ====================
        // [The complete events manager code from original]
        // ==================== ADD EVENT FORM ====================
        // [The complete add event form code from original]
        // ==================== VIEW EVENT DETAILS ====================
        // [The complete view event details code from original]
        // ==================== EDIT EVENT ====================
        // [The complete edit event code from original]
        // ==================== ANNOUNCEMENTS MANAGER ====================
        // [The complete announcements manager code from original]
        // ==================== REPORTS MANAGER ====================
        // [The complete reports manager code from original]
        // ==================== SYSTEM SETTINGS ====================
        
        async function loadSystemSettings() {
            try {
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <h2 class="text-xl font-bold text-gray-800">System Settings</h2>
                            <p class="text-gray-600 text-sm mt-1">Configure system preferences and options</p>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Left Column: Navigation -->
                                <div class="lg:col-span-1">
                                    <div class="space-y-2">
                                        <button onclick="showSettingsTab('general')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-cog mr-3"></i>General Settings
                                        </button>
                                        <button onclick="showSettingsTab('email')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-envelope mr-3"></i>Email Settings
                                        </button>
                                        <button onclick="showSettingsTab('payments')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-money-bill-wave mr-3"></i>Payment Settings
                                        </button>
                                        <button onclick="showSettingsTab('membership')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-users mr-3"></i>Membership Settings
                                        </button>
                                        <button onclick="showSettingsTab('notifications')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-bell mr-3"></i>Notifications
                                        </button>
                                        <button onclick="showSettingsTab('backup')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 font-medium text-gray-800 border border-gray-200">
                                            <i class="fas fa-database mr-3"></i>Backup & Restore
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Right Column: Settings Content -->
                                <div class="lg:col-span-2">
                                    <div id="settings-content">
                                        <!-- Content will be loaded here -->
                                        <div class="text-center py-12">
                                            <i class="fas fa-cog text-gray-400 text-5xl mb-4"></i>
                                            <p class="text-gray-600">Select a settings category to begin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Error loading settings: ' + error.message, 'error');
            }
        }
        
        function showSettingsTab(tab) {
            let content = '';
            
            switch(tab) {
                case 'general':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">General Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Organization Name</label>
                                <input type="text" class="form-input" value="KESNNUR">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Timezone</label>
                                <select class="form-input">
                                    <option value="Africa/Nairobi" selected>Africa/Nairobi (EAT)</option>
                                    <option value="UTC">UTC</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Date Format</label>
                                <select class="form-input">
                                    <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option>
                                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Currency</label>
                                <select class="form-input">
                                    <option value="KES" selected>Kenyan Shilling (KES)</option>
                                    <option value="USD">US Dollar (USD)</option>
                                    <option value="EUR">Euro (EUR)</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-primary">Save Changes</button>
                        </div>
                    `;
                    break;
                    
                case 'email':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Email Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">SMTP Host</label>
                                <input type="text" class="form-input" placeholder="smtp.gmail.com">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">SMTP Port</label>
                                    <input type="number" class="form-input" placeholder="587">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Encryption</label>
                                    <select class="form-input">
                                        <option value="tls">TLS</option>
                                        <option value="ssl">SSL</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Sender Email</label>
                                <input type="email" class="form-input" placeholder="noreply@kesnnur.com">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Sender Name</label>
                                <input type="text" class="form-input" placeholder="KESNNUR Management">
                            </div>
                            
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                                    <div class="text-sm text-yellow-800">
                                        <p class="font-medium">Test Email Configuration</p>
                                        <p class="mt-1">Test your email settings before saving</p>
                                        <button class="mt-2 btn btn-warning btn-sm">Send Test Email</button>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary">Save Email Settings</button>
                        </div>
                    `;
                    break;
                    
                case 'payments':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Payment Settings</h3>
                        <div class="space-y-6">
                            <!-- M-Pesa Settings -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-mobile-alt mr-2 text-green-600"></i>
                                    M-Pesa Integration
                                </h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Consumer Key</label>
                                        <input type="password" class="form-input" placeholder="Enter Daraja API consumer key">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Consumer Secret</label>
                                        <input type="password" class="form-input" placeholder="Enter Daraja API consumer secret">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Short Code</label>
                                        <input type="text" class="form-input" placeholder="Business number">
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="enable_mpesa" class="mr-3">
                                        <label for="enable_mpesa" class="text-sm font-medium">Enable M-Pesa Payments</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment Gateway Settings -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-4">Payment Gateways</h4>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">M-Pesa</p>
                                            <p class="text-sm text-gray-600">Mobile money payments</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Bank Transfer</p>
                                            <p class="text-sm text-gray-600">Direct bank deposits</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Cash</p>
                                            <p class="text-sm text-gray-600">In-person cash payments</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary">Save Payment Settings</button>
                        </div>
                    `;
                    break;
                    
                case 'membership':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Membership Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Default Membership Status</label>
                                <select class="form-input">
                                    <option value="active">Active</option>
                                    <option value="pending" selected>Pending</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Default Membership Fee (KES)</label>
                                <input type="number" class="form-input" placeholder="5000" value="5000">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Membership Renewal Period (months)</label>
                                <input type="number" class="form-input" placeholder="12" value="12">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Send Welcome Email</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="welcome_email" checked class="mr-3">
                                    <label for="welcome_email" class="text-sm">Send welcome email to new members</label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Auto-approve New Members</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="auto_approve" class="mr-3">
                                    <label for="auto_approve" class="text-sm">Automatically approve new member registrations</label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Membership ID Prefix</label>
                                <input type="text" class="form-input" value="KESNNUR" placeholder="Organization prefix">
                            </div>
                            
                            <button class="btn btn-primary">Save Membership Settings</button>
                        </div>
                    `;
                    break;
                    
                case 'notifications':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Notification Settings</h3>
                        <div class="space-y-6">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-3">Email Notifications</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">New Member Registration</p>
                                            <p class="text-sm text-gray-600">Notify admins when new members join</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Payment Received</p>
                                            <p class="text-sm text-gray-600">Notify admins when payments are made</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Event Reminders</p>
                                            <p class="text-sm text-gray-600">Send event reminders to members</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Membership Renewal</p>
                                            <p class="text-sm text-gray-600">Notify members before membership expires</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-3">SMS Notifications</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Payment Confirmations</p>
                                            <p class="text-sm text-gray-600">Send SMS when payments are confirmed</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox">
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Event Reminders</p>
                                            <p class="text-sm text-gray-600">Send SMS event reminders</p>
                                        </div>
                                        <div class="toggle-switch">
                                            <input type="checkbox">
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <p class="text-sm text-yellow-800">
                                            <i class="fas fa-exclamation-triangle mr-2"></i>
                                            SMS notifications require SMS credits. <a href="#" class="font-medium">Purchase credits</a>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary">Save Notification Settings</button>
                        </div>
                    `;
                    break;
                    
                case 'backup':
                    content = `
                        <h3 class="text-lg font-bold text-gray-800 mb-6">Backup & Restore</h3>
                        <div class="space-y-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                                    <div>
                                        <p class="font-medium text-blue-800">Database Backup</p>
                                        <p class="text-sm text-blue-600 mt-1">
                                            Regular backups are automatically created and stored securely.
                                            Last backup: ${formatDateTime(new Date().toISOString())}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <h4 class="font-bold text-gray-800 mb-3">Create Backup</h4>
                                    <p class="text-sm text-gray-600 mb-4">Create a manual backup of all system data</p>
                                    <button onclick="createBackup()" class="btn btn-primary w-full">
                                        <i class="fas fa-download mr-2"></i>Create Backup Now
                                    </button>
                                </div>
                                
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <h4 class="font-bold text-gray-800 mb-3">Restore Backup</h4>
                                    <p class="text-sm text-gray-600 mb-4">Restore system from a previous backup</p>
                                    <button onclick="showRestoreModal()" class="btn btn-secondary w-full">
                                        <i class="fas fa-upload mr-2"></i>Restore from Backup
                                    </button>
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-3">Auto-Backup Settings</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Backup Frequency</label>
                                        <select class="form-input">
                                            <option value="daily">Daily</option>
                                            <option value="weekly" selected>Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Retention Period</label>
                                        <select class="form-input">
                                            <option value="7">7 days</option>
                                            <option value="30" selected>30 days</option>
                                            <option value="90">90 days</option>
                                            <option value="365">1 year</option>
                                        </select>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="auto_backup" checked class="mr-3">
                                        <label for="auto_backup" class="text-sm font-medium">Enable Automatic Backups</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <h4 class="font-bold text-gray-800 mb-3 text-red-700">Danger Zone</h4>
                                <p class="text-sm text-gray-600 mb-4">
                                    These actions are irreversible. Please proceed with caution.
                                </p>
                                <div class="space-y-3">
                                    <button onclick="exportAllData()" class="btn btn-secondary w-full">
                                        <i class="fas fa-file-export mr-2"></i>Export All Data (CSV)
                                    </button>
                                    <button onclick="showResetModal()" class="btn btn-danger w-full">
                                        <i class="fas fa-trash mr-2"></i>Reset System Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('settings-content').innerHTML = content;
        }
        
        // ==================== BACKUP FUNCTIONS ====================
        
        async function createBackup() {
            try {
                showToast('Creating backup...', 'info');
                
                // In a real application, this would call your backend API
                setTimeout(() => {
                    showToast('Backup created successfully!', 'success');
                }, 2000);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                showToast('Error creating backup: ' + error.message, 'error');
            }
        }
        
        function showRestoreModal() {
            showModal(`
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Restore from Backup</h3>
                    <p class="text-gray-600 mb-6">Select a backup file to restore your system data.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Select Backup File</label>
                            <input type="file" accept=".json,.sql,.backup" class="form-input">
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                                <div class="text-sm text-yellow-800">
                                    <p class="font-medium">Important Warning</p>
                                    <p class="mt-1">Restoring from a backup will overwrite all current data. This action cannot be undone.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                            <button onclick="restoreBackup()" class="btn btn-warning">Restore Backup</button>
                        </div>
                    </div>
                </div>
            `);
        }
        
        function restoreBackup() {
            if (!confirm('WARNING: This will overwrite all current data. Are you sure you want to proceed?')) {
                return;
            }
            
            showToast('Restoring from backup...', 'info');
            setTimeout(() => {
                showToast('Backup restored successfully! The page will now reload.', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }, 3000);
        }
        
        function exportAllData() {
            showToast('Exporting all data...', 'info');
            setTimeout(() => {
                showToast('Data exported successfully. Download will start automatically.', 'success');
                
                // In a real application, this would trigger a file download
                const data = "Member ID,Name,Email,Region,Status\n1,John Doe,john@example.com,Nairobi,Active";
                const blob = new Blob([data], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kesnnur-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 2000);
        }
        
        function showResetModal() {
            showModal(`
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-red-700">Reset System Data</h3>
                    <div class="bg-red-50 p-4 rounded-lg mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-3 text-xl"></i>
                            <div class="text-red-800">
                                <p class="font-medium">DANGER: IRREVERSIBLE ACTION</p>
                                <p class="mt-2">This will permanently delete:</p>
                                <ul class="list-disc pl-5 mt-2 space-y-1">
                                    <li>All member records</li>
                                    <li>All payment records</li>
                                    <li>All event registrations</li>
                                    <li>All announcements</li>
                                </ul>
                                <p class="mt-3 font-bold">This action cannot be undone!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Confirm by typing "DELETE ALL DATA"</label>
                            <input type="text" id="reset-confirmation" class="form-input" placeholder="Type DELETE ALL DATA to confirm">
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                            <button onclick="confirmReset()" class="btn btn-danger" disabled id="reset-button">
                                Reset All Data
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            // Enable reset button only when correct text is entered
            const input = document.getElementById('reset-confirmation');
            const button = document.getElementById('reset-button');
            
            input.addEventListener('input', function() {
                button.disabled = this.value !== 'DELETE ALL DATA';
            });
        }
        
        function confirmReset() {
            if (!confirm('FINAL WARNING: This will delete ALL data. Are you absolutely sure?')) {
                return;
            }
            
            showToast('Resetting system data...', 'warning');
            
            // In a real application, this would call your backend API
            setTimeout(() => {
                showToast('System data reset successfully! The page will now reload.', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }, 3000);
        }
        
        // ==================== MODAL FUNCTIONS ====================
        
        function showModal(content, size = '') {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            
            if (size) {
                modalContent.classList.add('modal-lg');
            } else {
                modalContent.classList.remove('modal-lg');
            }
            
            modalContent.innerHTML = content;
            modal.style.display = 'block';
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
            modal.querySelector('.modal-content').innerHTML = '';
            
            // Restore body scroll
            document.body.style.overflow = '';
        }
        
        // ==================== EXPORT FUNCTIONS ====================
        
        function exportMembers() {
            showToast('Exporting members list...', 'info');
            
            setTimeout(() => {
                showToast('Members list exported successfully', 'success');
            }, 1500);
        }
        
        function exportPayments() {
            showToast('Exporting payments list...', 'info');
            
            setTimeout(() => {
                showToast('Payments list exported successfully', 'success');
            }, 1500);
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        
        function refreshData() {
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const section = activeNav.getAttribute('data-section');
                loadSection(section);
                showToast('Data refreshed', 'success');
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                const supabase = initSupabase();
                supabase.auth.signOut().then(() => {
                    window.location.href = 'login.html';
                });
            }
        }
        
        function setupMpesaIntegration() {
            showModal(`
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">M-Pesa API Integration</h3>
                    <p class="text-gray-600 mb-6">Configure Safaricom Daraja API for automatic M-Pesa payment processing.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Daraja API Consumer Key</label>
                            <input type="password" class="form-input" placeholder="Enter your consumer key">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Daraja API Consumer Secret</label>
                            <input type="password" class="form-input" placeholder="Enter your consumer secret">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Business Short Code</label>
                            <input type="text" class="form-input" placeholder="e.g., 174379">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Passkey</label>
                            <input type="password" class="form-input" placeholder="Enter your passkey">
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-800 mb-2">How to get credentials:</h4>
                            <ol class="list-decimal pl-5 text-sm text-gray-600 space-y-1">
                                <li>Register on Safaricom Developer Portal</li>
                                <li>Create an app to get Consumer Key and Secret</li>
                                <li>Use your business number as Short Code</li>
                                <li>Generate Passkey in the Daraja portal</li>
                            </ol>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                            <button onclick="testMpesaIntegration()" class="btn btn-primary">Test Connection</button>
                            <button onclick="saveMpesaIntegration()" class="btn btn-success">Save Configuration</button>
                        </div>
                    </div>
                </div>
            `);
        }
        
        function testMpesaIntegration() {
            showToast('Testing M-Pesa API connection...', 'info');
            setTimeout(() => {
                showToast('M-Pesa API connection successful!', 'success');
            }, 2000);
        }
        
        function saveMpesaIntegration() {
            showToast('M-Pesa API configuration saved', 'success');
            closeModal();
        }
        
        // ==================== INITIALIZATION ====================
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Refresh with F5
            if (e.key === 'F5') {
                e.preventDefault();
                refreshData();
            }
            
            // Close modal with Escape
            if (e.key === 'Escape') {
                closeModal();
            }
            
            // Navigation shortcuts (Ctrl/Cmd + number)
            if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '9') {
                e.preventDefault();
                const navItems = document.querySelectorAll('.nav-item');
                const index = parseInt(e.key) - 1;
                if (navItems[index]) {
                    navItems[index].click();
                }
            }
        });
        
        // ==================== ERROR HANDLING ====================
        
        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error:', { message, source, lineno, colno, error });
            showToast('An error occurred. Please refresh the page.', 'error');
            return true;
        };
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showToast('An error occurred. Please try again.', 'error');
        });
        
        // ==================== COMPLETION MESSAGE ====================
        
        console.log('KESNNUR Management System loaded successfully!');
        console.log('System includes:');
        console.log('1. Dashboard with statistics and charts');
        console.log('2. Complete member management');
        console.log('3. Event calendar and management');
        console.log('4. Payment processing with M-Pesa integration');
        console.log('5. Announcement system');
        console.log('6. Reports and analytics');
        console.log('7. Admin user management');
        console.log('8. System settings configuration');
        console.log('9. Backup and restore functionality');
        
        // ==================== END OF SCRIPT ====================
    </script>
</body>
</html>
