<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KESNNUR - Complete Management System</title>
    <!-- Production Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kesnnur-blue': '#1e3a8a',
                        'kesnnur-light-blue': '#3b82f6',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Toast Styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast-success {
            background: #10b981;
        }
        
        .toast-error {
            background: #ef4444;
        }
        
        .toast-info {
            background: #3b82f6;
        }
        
        .toast-warning {
            background: #f59e0b;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        :root {
            --sidebar-width: 280px;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: #f8fafc;
        }
        .nav-item {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            margin: 50px auto;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-lg {
            max-width: 1000px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge.active {
            background: #10b98120;
            color: #10b981;
        }
        .badge.pending {
            background: #f59e0b20;
            color: #f59e0b;
        }
        .badge.inactive {
            background: #ef444420;
            color: #ef4444;
        }
        .calendar-day {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
        }
        .calendar-day.event {
            background: #3b82f620;
            color: #1e40af;
        }
        .calendar-day.today {
            background: #10b98120;
            color: #065f46;
            font-weight: 600;
        }
        
        /* Tab Styles */
        .tabs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .tabs-header {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
            overflow-x: auto;
        }
        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #3b82f6;
        }
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            font-weight: 600;
        }
        .tab-content {
            display: none;
            padding: 24px;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Data Table Loading */
        .data-loading {
            position: relative;
            min-height: 200px;
        }
        .data-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        /* Quick Filters */
        .quick-filter {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            margin-right: 8px;
            margin-bottom: 8px;
            border-radius: 20px;
            background: #f3f4f6;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-filter:hover {
            background: #e5e7eb;
        }
        .quick-filter.active {
            background: #3b82f6;
            color: white;
        }
        
        /* Chart Styles */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Password strength indicator */
        .password-strength {
            height: 4px;
            margin-top: 5px;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .strength-0 { width: 0%; background: #ef4444; }
        .strength-1 { width: 25%; background: #ef4444; }
        .strength-2 { width: 50%; background: #f59e0b; }
        .strength-3 { width: 75%; background: #3b82f6; }
        .strength-4 { width: 100%; background: #10b981; }
        
        /* M-Pesa payment styles */
        .mpesa-badge {
            background: linear-gradient(135deg, #00a854 0%, #00a854 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
        }
        
        /* Copy to clipboard */
        .copy-btn {
            cursor: pointer;
            transition: all 0.2s;
        }
        .copy-btn:hover {
            transform: scale(1.1);
        }
        
        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            z-index: 9998;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* FullCalendar Custom */
        .fc {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }
        
        /* Payment status colors */
        .status-completed {
            background: #10b98120;
            color: #10b981;
        }
        .status-pending {
            background: #f59e0b20;
            color: #f59e0b;
        }
        .status-failed {
            background: #ef444420;
            color: #ef4444;
        }
        
        /* Action buttons */
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .action-btn-edit {
            background: #3b82f620;
            color: #1e40af;
        }
        .action-btn-edit:hover {
            background: #3b82f640;
        }
        .action-btn-delete {
            background: #ef444420;
            color: #dc2626;
        }
        .action-btn-delete:hover {
            background: #ef444440;
        }
        .action-btn-view {
            background: #10b98120;
            color: #065f46;
        }
        .action-btn-view:hover {
            background: #10b98140;
        }
        
        /* Data table styles */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .data-table th {
            background: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table tr:hover {
            background: #f9fafb;
        }
        
        /* Form styles */
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        
        /* Button styles */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        
        /* Card styles */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Alert styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .alert-success {
            background: #10b98120;
            color: #065f46;
            border: 1px solid #10b98140;
        }
        .alert-error {
            background: #ef444420;
            color: #dc2626;
            border: 1px solid #ef444440;
        }
        .alert-warning {
            background: #f59e0b20;
            color: #92400e;
            border: 1px solid #f59e0b40;
        }
        .alert-info {
            background: #3b82f620;
            color: #1e40af;
            border: 1px solid #3b82f640;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #374151;
            color: white;
            text-align: center;
            padding: 5px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Progress bar */
        .progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s;
        }
        
        /* Badge variants */
        .badge-sm {
            padding: 2px 8px;
            font-size: 10px;
        }
        .badge-lg {
            padding: 6px 14px;
            font-size: 12px;
        }
        
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-6 border-b border-white/20">
            <div class="flex items-center space-x-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i class="fas fa-users text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg">KESNNUR</h1>
                    <p class="text-white/80 text-xs">Management System</p>
                </div>
            </div>
        </div>
        
        <div class="p-4">
            <!-- DASHBOARD -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4">
                Dashboard
            </div>
            <div class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt mr-3"></i>
                Overview
            </div>
            
            <!-- MEMBERSHIP MANAGEMENT -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Membership
            </div>
            <div class="nav-item" data-section="members">
                <i class="fas fa-users mr-3"></i>
                All Members
            </div>
            <div class="nav-item" data-section="add-member">
                <i class="fas fa-user-plus mr-3"></i>
                Add New Member
            </div>
            
            <!-- REGIONS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Regions
            </div>
            <div class="nav-item" data-section="regions">
                <i class="fas fa-map-marker-alt mr-3"></i>
                Manage Regions
            </div>
            
            <!-- EVENTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Events
            </div>
            <div class="nav-item" data-section="events">
                <i class="fas fa-calendar-alt mr-3"></i>
                Events Calendar
            </div>
            <div class="nav-item" data-section="add-event">
                <i class="fas fa-calendar-plus mr-3"></i>
                Add Event
            </div>
            
            <!-- FINANCIAL -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Financial
            </div>
            <div class="nav-item" data-section="payments">
                <i class="fas fa-money-bill-wave mr-3"></i>
                Payments
            </div>
            <div class="nav-item" data-section="add-payment">
                <i class="fas fa-plus-circle mr-3"></i>
                Record Payment
            </div>
            <div class="nav-item" data-section="mpesa-payments">
                <i class="fas fa-mobile-alt mr-3"></i>
                M-Pesa Payments
            </div>
            
            <!-- COMMUNICATIONS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Communications
            </div>
            <div class="nav-item" data-section="announcements">
                <i class="fas fa-bullhorn mr-3"></i>
                Announcements
            </div>
            
            <!-- REPORTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Reports
            </div>
            <div class="nav-item" data-section="reports">
                <i class="fas fa-chart-bar mr-3"></i>
                Reports
            </div>
            
            <!-- SYSTEM -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                System
            </div>
            <div class="nav-item" data-section="users">
                <i class="fas fa-user-shield mr-3"></i>
                Admin Users
            </div>
            <div class="nav-item" data-section="settings">
                <i class="fas fa-cog mr-3"></i>
                System Settings
            </div>
        </div>
        
        <!-- User Info -->
        <div class="p-4 border-t border-white/20 mt-auto">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <p class="font-medium" id="userName">Loading...</p>
                    <p class="text-white/60 text-sm" id="userRole">Loading...</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="p-6 border-b bg-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard Overview</h1>
                    <p class="text-gray-600" id="welcomeMessage">Welcome back</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600" id="lastLogin">
                        Last login: Loading...
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="p-6" id="contentArea">
            <!-- Loading spinner -->
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading dashboard...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for forms -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <!-- Modal content will be loaded here -->
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        const ADMIN_ROLES = ['admin', 'super_admin', 'editor'];
        
        // Kenyan Regions
        const KENYAN_REGIONS = [
            "Nairobi",
            "Coast",
            "Eastern",
            "North Eastern",
            "Central",
            "Rift Valley",
            "Western",
            "Nyanza"
        ];
        
        // Membership Types
        const MEMBERSHIP_TYPES = [
            "student",
            "professional",
            "associate",
            "alumni",
            "life_member",
            "honorary"
        ];
        
        // Payment Methods
        const PAYMENT_METHODS = [
            "mpesa",
            "bank_transfer",
            "cash",
            "cheque",
            "credit_card"
        ];
        
        // Event Types
        const EVENT_TYPES = [
            "meeting",
            "workshop",
            "seminar",
            "conference",
            "social",
            "training",
            "webinar",
            "fundraiser"
        ];
        
        // Announcement Types
        const ANNOUNCEMENT_TYPES = [
            "general",
            "event",
            "news",
            "urgent",
            "maintenance",
            "update"
        ];
        
        // ==================== DATA CACHING ====================
        let dataCache = {
            members: null,
            payments: null,
            events: null,
            announcements: null,
            users: null,
            regions: null,
            lastUpdated: {}
        };
        
        // ==================== GLOBAL VARIABLES ====================
        let supabaseClient = null;
        let currentUser = null;
        let currentUserProfile = null;
        let heartbeatInterval = null;
        let isOnline = navigator.onLine;
        let calendarInstance = null;
        
        // ==================== UTILITY FUNCTIONS ====================
        
        // Custom Toast Function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Generate random password
        function generatePassword(length = 12) {
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let password = "";
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }
        
        // Check password strength
        function checkPasswordStrength(password) {
            let score = 0;
            if (password.length >= 8) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            return score;
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy', 'error');
            });
        }
        
        // Generate Member Number
        async function generateMemberNumber(membershipType = 'general') {
            try {
                const supabase = initSupabase();
                const currentYear = new Date().getFullYear();
                
                // Get last member number
                const { data: lastMember } = await supabase
                    .from('members')
                    .select('membership_number')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                let sequence = 1;
                if (lastMember && lastMember.membership_number) {
                    const parts = lastMember.membership_number.split('-');
                    if (parts.length === 4 && parts[1] === currentYear.toString()) {
                        const lastSeq = parseInt(parts[3]) || 0;
                        sequence = lastSeq + 1;
                    }
                }
                
                const typeCode = membershipType.substring(0, 3).toUpperCase();
                return `KESNNUR-${currentYear}-${typeCode}-${sequence.toString().padStart(4, '0')}`;
            } catch (error) {
                // Fallback to timestamp-based ID
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');
                return `KESNNUR-${new Date().getFullYear()}-${timestamp}${random}`;
            }
        }
        
        // Generate Invoice Number
        function generateInvoiceNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `INV-${year}${month}${day}-${random}`;
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES'
            }).format(amount);
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-KE', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Format datetime
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-KE', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Initialize Supabase
        function initSupabase() {
            if (!supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }
        
        // Show modal
        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = content;
            modal.style.display = 'block';
        }
        
        // Close modal
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
        }
        
        // Refresh data
        function refreshData() {
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const section = activeNav.getAttribute('data-section');
                loadSection(section);
            }
        }
        
        // ==================== AUTHENTICATION & SESSION MANAGEMENT ====================
        
        // Logout function
        async function logout() {
            try {
                const supabase = initSupabase();
                await supabase.auth.signOut();
                showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Logout failed: ' + error.message, 'error');
            }
        }
        
        // Redirect to login
        function redirectToLogin() {
            showToast('Session expired, please login again', 'error');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }
        
        // Check authentication state with retry logic
        async function checkAuth(forceRefresh = false) {
            try {
                console.log('Checking authentication...');
                
                // Initialize Supabase
                const supabase = initSupabase();
                
                // Check for existing session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                    
                    // Try to refresh session
                    const { data: refreshedSession, error: refreshError } = await supabase.auth.refreshSession();
                    
                    if (refreshError || !refreshedSession?.session) {
                        console.log('No valid session found');
                        redirectToLogin();
                        return false;
                    }
                    
                    currentUser = refreshedSession.session.user;
                    showToast('Session refreshed', 'info');
                } else if (!session || !session.user) {
                    console.log('No active session found');
                    redirectToLogin();
                    return false;
                } else {
                    currentUser = session.user;
                }
                
                // Get user profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profileError) {
                    console.error('Profile error:', profileError);
                    
                    // If profile doesn't exist, create one
                    const { data: newProfile, error: createError } = await supabase
                        .from('profiles')
                        .insert([{
                            id: currentUser.id,
                            email: currentUser.email,
                            role: 'admin',
                            first_name: currentUser.email.split('@')[0],
                            last_name: '',
                            status: 'active'
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Create profile error:', createError);
                        const basicProfile = {
                            id: currentUser.id,
                            email: currentUser.email,
                            role: 'admin',
                            first_name: currentUser.email.split('@')[0],
                            last_name: '',
                            status: 'active'
                        };
                        currentUserProfile = basicProfile;
                    } else {
                        currentUserProfile = newProfile;
                    }
                    
                    return true;
                }
                
                if (!profile) {
                    console.log('No profile found for user');
                    redirectToLogin();
                    return false;
                }
                
                // Check if user has admin role
                if (!ADMIN_ROLES.includes(profile.role)) {
                    console.log('User does not have admin role:', profile.role);
                    showToast('Access denied: Admin privileges required', 'error');
                    redirectToLogin();
                    return false;
                }
                
                currentUserProfile = profile;
                
                // Update last login
                try {
                    await supabase
                        .from('profiles')
                        .update({ 
                            last_login: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentUser.id);
                } catch (updateError) {
                    console.warn('Could not update last login:', updateError);
                }
                
                console.log('Authentication successful');
                return true;
                
            } catch (error) {
                console.error('Auth check error:', error);
                showToast('Authentication error: ' + error.message, 'error');
                redirectToLogin();
                return false;
            }
        }
        
        // Start heartbeat to keep session alive
        function startHeartbeat() {
            // Clear existing heartbeat
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            
            // Ping every 4 minutes to keep session alive
            heartbeatInterval = setInterval(async () => {
                try {
                    if (!isOnline) return;
                    
                    const supabase = initSupabase();
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session) {
                        console.log('Heartbeat: Session active');
                        // Refresh token periodically
                        await supabase.auth.refreshSession();
                    }
                } catch (error) {
                    console.warn('Heartbeat failed:', error);
                }
            }, 4 * 60 * 1000); // 4 minutes
        }
        
        // Setup auth state listener
        function setupAuthListener() {
            if (window.authListenerSet) return;
            window.authListenerSet = true;
            
            const supabase = initSupabase();
            
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event);
                
                switch(event) {
                    case 'SIGNED_OUT':
                        showToast('You have been logged out', 'info');
                        redirectToLogin();
                        break;
                        
                    case 'SIGNED_IN':
                        if (session) {
                            currentUser = session.user;
                            await checkAuth();
                            updateUserInfo();
                            showToast('Welcome back!', 'success');
                            startHeartbeat();
                        }
                        break;
                        
                    case 'TOKEN_REFRESHED':
                        console.log('Token refreshed successfully');
                        break;
                        
                    case 'USER_UPDATED':
                        console.log('User updated');
                        break;
                }
            });
        }
        
        // Setup tab visibility handler
        function setupTabVisibilityHandler() {
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden) {
                    // Tab became visible again
                    console.log('Tab became visible, checking auth...');
                    
                    // Check auth with force refresh
                    const isAuthenticated = await checkAuth(true);
                    
                    if (isAuthenticated) {
                        // Refresh current section
                        const activeNav = document.querySelector('.nav-item.active');
                        if (activeNav) {
                            const section = activeNav.getAttribute('data-section');
                            loadSection(section);
                        }
                    }
                }
            });
        }
        
        // Setup page focus handler
        function setupFocusHandler() {
            window.addEventListener('focus', async () => {
                console.log('Page regained focus, refreshing data...');
                
                // Refresh current data
                const activeNav = document.querySelector('.nav-item.active');
                if (activeNav) {
                    const section = activeNav.getAttribute('data-section');
                    loadSection(section);
                }
            });
        }
        
        // Setup network status handler
        function setupNetworkHandler() {
            window.addEventListener('online', () => {
                isOnline = true;
                showToast('Back online', 'success');
                
                // Refresh data when coming back online
                setTimeout(() => {
                    const activeNav = document.querySelector('.nav-item.active');
                    if (activeNav) {
                        const section = activeNav.getAttribute('data-section');
                        loadSection(section);
                    }
                }, 1000);
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                showToast('You are offline. Some features may not work.', 'warning');
            });
        }
        
        // Update user info in sidebar
        function updateUserInfo() {
            if (!currentUserProfile) return;
            
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const lastLogin = document.getElementById('lastLogin');
            
            if (userName) {
                userName.textContent = 
                    currentUserProfile.first_name && currentUserProfile.last_name 
                        ? `${currentUserProfile.first_name} ${currentUserProfile.last_name}`
                        : currentUserProfile.email || 'User';
            }
            
            if (userRole) {
                userRole.textContent = 
                    (currentUserProfile.role || 'user').replace('_', ' ').toUpperCase();
            }
            
            if (welcomeMessage) {
                welcomeMessage.textContent = 
                    `Welcome back, ${currentUserProfile.first_name || 'Admin'}`;
            }
            
            if (lastLogin) {
                const lastLoginTime = currentUserProfile.last_login 
                    ? new Date(currentUserProfile.last_login).toLocaleString('en-KE')
                    : 'First login';
                
                lastLogin.textContent = `Last login: ${lastLoginTime}`;
            }
        }
        
        // ==================== INITIALIZATION ====================
        
        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Show loading state
                document.getElementById('contentArea').innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-600">Initializing system...</p>
                        </div>
                    </div>
                `;
                
                // Setup network handler first
                setupNetworkHandler();
                
                // Check authentication
                const isAuthenticated = await checkAuth();
                
                if (!isAuthenticated) {
                    console.log('User not authenticated, redirecting to login...');
                    showToast('Please login to access admin dashboard', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                    return;
                }
                
                // Update user info
                updateUserInfo();
                
                // Setup event listeners
                setupEventListeners();
                
                // Setup visibility handlers
                setupTabVisibilityHandler();
                setupFocusHandler();
                
                // Start heartbeat
                startHeartbeat();
                
                // Load dashboard
                await loadDashboard();
                
                // Setup auth state listener
                setupAuthListener();
                
                // Initialize default regions if not exist
                await initializeRegions();
                
                showToast('KESNNUR Management System loaded!', 'success');
                
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showToast('Error loading dashboard: ' + error.message, 'error');
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 text-4xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">System Error</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="initializeDashboard()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Initialize Kenyan regions
        async function initializeRegions() {
            try {
                const supabase = initSupabase();
                
                // Check if regions exist
                const { data: existingRegions } = await supabase
                    .from('regions')
                    .select('*');
                
                if (!existingRegions || existingRegions.length === 0) {
                    // Insert default Kenyan regions
                    const regionsData = KENYAN_REGIONS.map(region => ({
                        name: region,
                        code: region.substring(0, 3).toUpperCase(),
                        status: 'active',
                        country: 'Kenya',
                        description: `${region} region of Kenya`,
                        created_at: new Date().toISOString()
                    }));
                    
                    await supabase
                        .from('regions')
                        .insert(regionsData);
                    
                    console.log('Default Kenyan regions initialized');
                }
            } catch (error) {
                console.warn('Could not initialize regions:', error);
            }
        }
        
        // Setup navigation event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // Check auth before switching
                    checkAuth().then(isAuth => {
                        if (isAuth) {
                            // Update active state
                            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                            this.classList.add('active');
                            
                            // Load section
                            loadSection(section);
                        }
                    });
                });
            });
            
            // Close modal when clicking outside
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }
        
        // ==================== SECTION LOADING ====================
        
        async function loadSection(section) {
            const contentArea = document.getElementById('contentArea');
            
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                showToast('Session expired, please login again', 'error');
                window.location.href = 'login.html';
                return;
            }
            
            // Update page title
            const pageTitles = {
                'dashboard': 'Dashboard Overview',
                'members': 'All Members',
                'add-member': 'Add New Member',
                'regions': 'Manage Regions',
                'events': 'Events Calendar',
                'add-event': 'Add New Event',
                'payments': 'Payments',
                'add-payment': 'Record Payment',
                'mpesa-payments': 'M-Pesa Payments',
                'announcements': 'Announcements',
                'reports': 'Reports',
                'users': 'Admin Users',
                'settings': 'System Settings'
            };
            
            document.getElementById('pageTitle').textContent = pageTitles[section] || section;
            
            // Show loading
            contentArea.innerHTML = `
                <div class="flex items-center justify-center h-64">
                    <div class="text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading ${pageTitles[section] || section}...</p>
                    </div>
                </div>
            `;
            
            // Load the appropriate section
            try {
                switch(section) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'members':
                        await loadMembersManager();
                        break;
                    case 'add-member':
                        await loadAddMemberForm();
                        break;
                    case 'regions':
                        await loadRegionsManager();
                        break;
                    case 'events':
                        await loadEventsManager();
                        break;
                    case 'add-event':
                        await loadAddEventForm();
                        break;
                    case 'payments':
                        await loadPaymentsManager();
                        break;
                    case 'add-payment':
                        await loadAddPaymentForm();
                        break;
                    case 'mpesa-payments':
                        await loadMpesaPayments();
                        break;
                    case 'announcements':
                        await loadAnnouncementsManager();
                        break;
                    case 'reports':
                        await loadReportsManager();
                        break;
                    case 'users':
                        await loadUsersManager();
                        break;
                    case 'settings':
                        await loadSystemSettings();
                        break;
                    default:
                        contentArea.innerHTML = '<div class="text-center py-12">Section not found</div>';
                }
            } catch (error) {
                console.error(`Error loading ${section}:`, error);
                contentArea.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 text-4xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Error Loading Section</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="loadSection('${section}')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // ==================== DASHBOARD SECTION ====================
        
        async function loadDashboard() {
            try {
                const stats = await loadStats();
                const recentMembers = await getRecentMembers(5);
                const upcomingEvents = await getUpcomingEvents(5);
                const recentPayments = await getRecentPayments(5);
                
                document.getElementById('contentArea').innerHTML = `
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 text-white mb-8">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">KESNNUR Management System</h2>
                                <p class="text-blue-100">Complete management solution for your organization</p>
                            </div>
                            <div class="text-4xl">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Members</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.members}</h3>
                                    <p class="text-blue-600 text-sm mt-1">
                                        <i class="fas fa-users mr-1"></i>${stats.membersGrowth > 0 ? '+' : ''}${stats.membersGrowth}% this month
                                    </p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-lg">
                                    <i class="fas fa-users text-blue-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Active Regions</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.regions}</h3>
                                    <p class="text-purple-600 text-sm mt-1">
                                        <i class="fas fa-map-marker-alt mr-1"></i>Locations
                                    </p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-lg">
                                    <i class="fas fa-map-marker-alt text-purple-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Upcoming Events</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.events}</h3>
                                    <p class="text-green-600 text-sm mt-1">
                                        <i class="fas fa-calendar mr-1"></i>Next 30 days
                                    </p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-lg">
                                    <i class="fas fa-calendar-alt text-green-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Revenue</p>
                                    <h3 class="text-2xl font-bold text-gray-800">KSh ${stats.revenue.toLocaleString()}</h3>
                                    <p class="text-orange-600 text-sm mt-1">
                                        <i class="fas fa-money-bill-wave mr-1"></i>This Month
                                    </p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-lg">
                                    <i class="fas fa-money-bill-wave text-orange-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Recent Members -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Recent Members</h2>
                                <button onclick="loadSection('members')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${recentMembers.length > 0 ? recentMembers.map(member => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-blue-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${member.first_name} ${member.last_name}</p>
                                            <p class="text-gray-600 text-sm">${member.email}  ${member.region || 'No Region'}</p>
                                        </div>
                                        <span class="badge ${member.membership_status === 'active' ? 'active' : member.membership_status === 'pending' ? 'pending' : 'inactive'}">
                                            ${member.membership_status || 'pending'}
                                        </span>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-users text-3xl mb-3"></i>
                                        <p>No members yet</p>
                                        <button onclick="loadSection('add-member')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Add your first member
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Upcoming Events -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Upcoming Events</h2>
                                <button onclick="loadSection('events')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${upcomingEvents.length > 0 ? upcomingEvents.map(event => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-calendar text-green-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${event.title}</p>
                                            <p class="text-gray-600 text-sm">
                                                ${new Date(event.start_date).toLocaleDateString()}  ${event.venue || 'TBA'}
                                            </p>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-calendar text-3xl mb-3"></i>
                                        <p>No upcoming events</p>
                                        <button onclick="loadSection('add-event')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Schedule an event
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Recent Payments -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Recent Payments</h2>
                                <button onclick="loadSection('payments')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${recentPayments.length > 0 ? recentPayments.map(payment => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-money-bill-wave text-orange-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${payment.member_name || 'Anonymous'}</p>
                                            <p class="text-gray-600 text-sm">
                                                KSh ${payment.amount.toLocaleString()}  ${payment.payment_method}
                                            </p>
                                        </div>
                                        <span class="badge ${payment.payment_status === 'completed' ? 'active' : payment.payment_status === 'pending' ? 'pending' : 'inactive'}">
                                            ${payment.payment_status}
                                        </span>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                                        <p>No recent payments</p>
                                        <button onclick="loadSection('add-payment')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Record a payment
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div class="mt-8">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Revenue Chart -->
                            <div class="bg-white rounded-xl shadow p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-6">Revenue Overview</h2>
                                <div class="chart-container">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Members Chart -->
                            <div class="bg-white rounded-xl shadow p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-6">Membership Growth</h2>
                                <div class="chart-container">
                                    <canvas id="membersChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-xl shadow p-6 mt-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="loadSection('add-member')" class="p-4 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition-colors">
                                <i class="fas fa-user-plus text-blue-900 text-2xl mb-2"></i>
                                <p class="font-medium">Add Member</p>
                            </button>
                            
                            <button onclick="loadSection('add-event')" class="p-4 bg-green-50 rounded-lg text-center hover:bg-green-100 transition-colors">
                                <i class="fas fa-calendar-plus text-green-900 text-2xl mb-2"></i>
                                <p class="font-medium">Add Event</p>
                            </button>
                            
                            <button onclick="loadSection('add-payment')" class="p-4 bg-orange-50 rounded-lg text-center hover:bg-orange-100 transition-colors">
                                <i class="fas fa-money-bill-wave text-orange-900 text-2xl mb-2"></i>
                                <p class="font-medium">Record Payment</p>
                            </button>
                            
                            <button onclick="loadSection('reports')" class="p-4 bg-purple-50 rounded-lg text-center hover:bg-purple-100 transition-colors">
                                <i class="fas fa-chart-bar text-purple-900 text-2xl mb-2"></i>
                                <p class="font-medium">View Reports</p>
                            </button>
                        </div>
                    </div>
                `;
                
                // Initialize charts
                setTimeout(() => {
                    initRevenueChart();
                    initMembersChart();
                }, 100);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading dashboard: ${error.message}</p>
                        <button onclick="loadDashboard()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        async function loadStats() {
            try {
                const supabase = initSupabase();
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const firstDayOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                
                // Get member count
                let memberCount = 0;
                let lastMonthMemberCount = 0;
                try {
                    const { count } = await supabase
                        .from('members')
                        .select('*', { count: 'exact', head: true });
                    memberCount = count || 0;
                    
                    // Get last month's count
                    const { count: lastMonthCount } = await supabase
                        .from('members')
                        .select('*', { count: 'exact', head: true })
                        .lt('created_at', firstDayOfMonth.toISOString());
                    lastMonthMemberCount = lastMonthCount || 0;
                } catch (error) {
                    console.warn('Error counting members:', error);
                }
                
                // Get regions count
                let regionCount = 0;
                try {
                    const { count } = await supabase
                        .from('regions')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'active');
                    regionCount = count || 0;
                } catch (error) {
                    console.warn('Error counting regions:', error);
                }
                
                // Get events count (next 30 days)
                let eventCount = 0;
                try {
                    const thirtyDaysFromNow = new Date();
                    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                    
                    const { count } = await supabase
                        .from('events')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'published')
                        .gte('start_date', now.toISOString())
                        .lte('start_date', thirtyDaysFromNow.toISOString());
                    eventCount = count || 0;
                } catch (error) {
                    console.warn('Error counting events:', error);
                }
                
                // Get total revenue (this month)
                let totalRevenue = 0;
                try {
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    lastDay.setHours(23, 59, 59, 999);
                    
                    const { data: payments } = await supabase
                        .from('payments')
                        .select('amount')
                        .eq('payment_status', 'completed')
                        .gte('paid_at', firstDayOfMonth.toISOString())
                        .lte('paid_at', lastDay.toISOString());
                    
                    if (payments) {
                        payments.forEach(payment => {
                            totalRevenue += parseFloat(payment.amount || 0);
                        });
                    }
                } catch (error) {
                    console.warn('Error calculating revenue:', error);
                }
                
                // Calculate growth
                const membersGrowth = lastMonthMemberCount > 0 
                    ? Math.round(((memberCount - lastMonthMemberCount) / lastMonthMemberCount) * 100)
                    : 0;
                
                return {
                    members: memberCount,
                    membersGrowth: membersGrowth,
                    regions: regionCount,
                    events: eventCount,
                    revenue: totalRevenue
                };
                
            } catch (error) {
                console.error('Error loading stats:', error);
                return { members: 0, membersGrowth: 0, regions: 0, events: 0, revenue: 0 };
            }
        }
        
        async function getRecentMembers(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('members')
                    .select(`
                        *,
                        member_profile:profiles!members_profile_id_fkey (
                            id, email, first_name, last_name, phone
                        ),
                        member_region:regions!members_region_id_fkey (
                            name
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(limit);
                
                if (!data) return [];
                
                const formattedData = data.map(member => ({
                    id: member.id,
                    profile_id: member.profile_id,
                    region_id: member.region_id,
                    membership_number: member.membership_number,
                    membership_type: member.membership_type,
                    membership_status: member.membership_status,
                    join_date: member.join_date,
                    created_at: member.created_at,
                    updated_at: member.updated_at,
                    first_name: member.member_profile?.first_name || '',
                    last_name: member.member_profile?.last_name || '',
                    email: member.member_profile?.email || '',
                    phone: member.member_profile?.phone || '',
                    region: member.member_region?.name || 'No Region'
                }));
                
                return formattedData;
            } catch (error) {
                console.error('Error getting recent members:', error);
                return [];
            }
        }
        
        async function getUpcomingEvents(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('events')
                    .select('*')
                    .eq('status', 'published')
                    .gte('start_date', new Date().toISOString())
                    .order('start_date', { ascending: true })
                    .limit(limit);
                return data || [];
            } catch (error) {
                console.error('Error getting upcoming events:', error);
                return [];
            }
        }
        
        async function getRecentPayments(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        member:members!payments_member_id_fkey (
                            profile:profiles!members_profile_id_fkey (
                                first_name, last_name
                            )
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(limit);
                
                if (!data) return [];
                
                return data.map(payment => ({
                    id: payment.id,
                    amount: parseFloat(payment.amount || 0),
                    payment_method: payment.payment_method,
                    payment_status: payment.payment_status,
                    payment_for: payment.payment_for,
                    member_name: payment.member?.profile ? 
                        `${payment.member.profile.first_name} ${payment.member.profile.last_name}` : 
                        'Anonymous',
                    created_at: payment.created_at
                }));
            } catch (error) {
                console.error('Error getting recent payments:', error);
                return [];
            }
        }
        
        function initRevenueChart() {
            const ctx = document.getElementById('revenueChart')?.getContext('2d');
            if (!ctx) return;
            
            const data = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Revenue (KSh)',
                    data: [120000, 190000, 150000, 250000, 200000, 300000],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KSh ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function initMembersChart() {
            const ctx = document.getElementById('membersChart')?.getContext('2d');
            if (!ctx) return;
            
            const data = {
                labels: ['Student', 'Professional', 'Associate', 'Alumni', 'Life Member'],
                datasets: [{
                    label: 'Members by Type',
                    data: [45, 30, 15, 8, 2],
                    backgroundColor: [
                        '#3b82f6',
                        '#10b981',
                        '#f59e0b',
                        '#8b5cf6',
                        '#ef4444'
                    ],
                    borderWidth: 1
                }]
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // ==================== MEMBERS MANAGER ====================
        
        async function loadMembersManager() {
            try {
                const supabase = initSupabase();
                const { data: members, error } = await supabase
                    .from('members')
                    .select(`
                        *,
                        member_profile:profiles!members_profile_id_fkey (
                            id, email, first_name, last_name, phone, id_number, 
                            date_of_birth, address, status
                        ),
                        member_region:regions!members_region_id_fkey (
                            name, code
                        )
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">All Members</h2>
                                <p class="text-gray-600 text-sm">Manage all registered members</p>
                            </div>
                            <button onclick="loadSection('add-member')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-user-plus mr-2"></i>Add New Member
                            </button>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <input type="text" id="search-members" 
                                       placeholder="Search by name, email, or member number..." 
                                       class="w-full form-input">
                            </div>
                            <div>
                                <select id="filter-type" class="w-full form-input">
                                    <option value="">All Membership Types</option>
                                    ${MEMBERSHIP_TYPES.map(type => `
                                        <option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ')}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <select id="filter-status" class="w-full form-input">
                                    <option value="">All Statuses</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="alumni">Alumni</option>
                                </select>
                            </div>
                            <div>
                                <button onclick="clearMemberFilters()" class="w-full btn btn-secondary">
                                    Clear Filters
                                </button>
                            </div>
                        </div>
                        
                        <!-- Members Table -->
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Name</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Member ID</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Region</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Type</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Joined</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="members-table-body">
                                    ${members && members.length > 0 ? members.map(member => `
                                        <tr class="border-b hover:bg-gray-50" 
                                            data-type="${member.membership_type || ''}"
                                            data-status="${member.membership_status || ''}">
                                            <td class="px-4 py-3">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                        <i class="fas fa-user text-blue-900 text-sm"></i>
                                                    </div>
                                                    <div>
                                                        <p class="font-medium">${member.member_profile?.first_name || ''} ${member.member_profile?.last_name || ''}</p>
                                                        <p class="text-sm text-gray-500">${member.member_profile?.email || 'N/A'}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3">
                                                <p class="font-medium">${member.membership_number || 'No ID'}</p>
                                                <p class="text-sm text-gray-500">${member.member_profile?.phone || 'No phone'}</p>
                                            </td>
                                            <td class="px-4 py-3">${member.member_region?.name || 'N/A'}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    ${member.membership_type ? member.membership_type.charAt(0).toUpperCase() + member.membership_type.slice(1).replace('_', ' ') : 'General'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3">${member.join_date ? formatDate(member.join_date) : 'N/A'}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${member.membership_status === 'active' ? 'bg-green-100 text-green-800' : member.membership_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                    ${member.membership_status ? member.membership_status.charAt(0).toUpperCase() + member.membership_status.slice(1) : 'Pending'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex space-x-2">
                                                    <button onclick="editMember('${member.id}')" class="action-btn action-btn-edit">
                                                        <i class="fas fa-edit mr-1"></i>Edit
                                                    </button>
                                                    <button onclick="viewMemberDetails('${member.id}')" class="action-btn action-btn-view">
                                                        <i class="fas fa-eye mr-1"></i>View
                                                    </button>
                                                    <button onclick="deleteMember('${member.id}')" class="action-btn action-btn-delete">
                                                        <i class="fas fa-trash mr-1"></i>Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                                <i class="fas fa-users text-3xl mb-3"></i>
                                                <p class="text-lg">No members found</p>
                                                <button onclick="loadSection('add-member')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                    Add Your First Member
                                                </button>
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Setup search and filter functionality
                document.getElementById('search-members').addEventListener('input', filterMembersTable);
                document.getElementById('filter-type').addEventListener('change', filterMembersTable);
                document.getElementById('filter-status').addEventListener('change', filterMembersTable);
                
            } catch (error) {
                console.error('Error loading members:', error);
                showToast('Error loading members: ' + error.message, 'error');
            }
        }
        
        function filterMembersTable() {
            const searchTerm = document.getElementById('search-members').value.toLowerCase();
            const filterType = document.getElementById('filter-type').value;
            const filterStatus = document.getElementById('filter-status').value;
            
            const rows = document.querySelectorAll('#members-table-body tr');
            
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const memberId = row.cells[1]?.textContent.toLowerCase() || '';
                const email = row.querySelector('p.text-gray-500')?.textContent.toLowerCase() || '';
                const type = row.getAttribute('data-type');
                const status = row.getAttribute('data-status');
                
                const matchesSearch = searchTerm === '' || 
                    name.includes(searchTerm) || 
                    memberId.includes(searchTerm) || 
                    email.includes(searchTerm);
                
                const matchesType = filterType === '' || type === filterType;
                const matchesStatus = filterStatus === '' || status === filterStatus;
                
                row.style.display = matchesSearch && matchesType && matchesStatus ? '' : 'none';
            });
        }
        
        function clearMemberFilters() {
            document.getElementById('search-members').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-status').value = '';
            filterMembersTable();
        }
        
        // ==================== ADD MEMBER FORM ====================
        
        async function loadAddMemberForm() {
            const supabase = initSupabase();
            const { data: regions } = await supabase
                .from('regions')
                .select('id, name, code')
                .eq('status', 'active')
                .order('name');
            
            // Generate initial member number
            const memberNumber = await generateMemberNumber();
            // Generate initial password
            const initialPassword = generatePassword(10);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Add New Member</h2>
                            <button onclick="loadSection('members')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Members
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addMemberForm" class="space-y-6 max-w-2xl">
                            <!-- Personal Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Personal Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                                        <input type="text" name="first_name" required 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                                        <input type="text" name="last_name" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                                        <input type="email" name="email" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                                        <input type="tel" name="phone" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="2547XXXXXXXX">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ID/Passport Number</label>
                                        <input type="text" name="id_number"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                                        <input type="date" name="date_of_birth"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                    <textarea name="address" rows="2"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <!-- Membership Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Membership Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Membership Type *</label>
                                        <select name="membership_type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateMemberNumber()">
                                            <option value="">Select Type</option>
                                            ${MEMBERSHIP_TYPES.map(type => `
                                                <option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ')}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Membership Number *</label>
                                        <div class="flex items-center space-x-2">
                                            <input type="text" name="membership_number" required readonly
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
                                                   value="${memberNumber}">
                                            <button type="button" onclick="refreshMemberNumber()" class="px-3 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Auto-generated. Click refresh to generate new</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Region *</label>
                                        <select name="region_id" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Select Region</option>
                                            ${regions ? regions.map(region => `
                                                <option value="${region.id}">${region.name}</option>
                                            `).join('') : ''}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Membership Status</label>
                                        <select name="membership_status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="active">Active</option>
                                            <option value="pending">Pending Approval</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="alumni">Alumni</option>
                                            <option value="suspended">Suspended</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Join Date</label>
                                    <input type="date" name="join_date" value="${new Date().toISOString().split('T')[0]}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <!-- Login Credentials -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Login Credentials</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Initial Password *</label>
                                        <div class="flex items-center space-x-2">
                                            <input type="text" name="initial_password" required readonly
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
                                                   value="${initialPassword}">
                                            <button type="button" onclick="regeneratePassword()" class="px-3 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <button type="button" onclick="copyPassword()" class="px-3 py-3 bg-green-100 text-green-700 rounded-lg hover:bg-green-200">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Member will use this to login for the first time</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password *</label>
                                        <input type="text" name="confirm_password" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                               value="${initialPassword}">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Additional Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Occupation</label>
                                        <input type="text" name="occupation"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Employer/Institution</label>
                                        <input type="text" name="employer"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                                    <textarea name="notes" rows="3"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <!-- Send Credentials Option -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex items-start">
                                    <input type="checkbox" name="send_credentials" id="send_credentials" checked class="mt-1 mr-3">
                                    <div>
                                        <label for="send_credentials" class="font-medium text-gray-800">Send Login Credentials via Email</label>
                                        <p class="text-sm text-gray-600 mt-1">Member will receive an email with their login details</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('members')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewMember()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Save Member
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        // Password regeneration
        function regeneratePassword() {
            const newPassword = generatePassword(10);
            document.querySelector('input[name="initial_password"]').value = newPassword;
            document.querySelector('input[name="confirm_password"]').value = newPassword;
            showToast('New password generated', 'info');
        }
        
        // Copy password
        function copyPassword() {
            const password = document.querySelector('input[name="initial_password"]').value;
            copyToClipboard(password);
        }
        
        async function updateMemberNumber() {
            const membershipType = document.querySelector('select[name="membership_type"]').value;
            if (membershipType) {
                const newMemberNumber = await generateMemberNumber(membershipType);
                document.querySelector('input[name="membership_number"]').value = newMemberNumber;
            }
        }
        
        async function refreshMemberNumber() {
            const membershipType = document.querySelector('select[name="membership_type"]').value || 'general';
            const newMemberNumber = await generateMemberNumber(membershipType);
            document.querySelector('input[name="membership_number"]').value = newMemberNumber;
            showToast('New member number generated', 'info');
        }
        
        async function addNewMember() {
            try {
                const form = document.getElementById('addMemberForm');
                const formData = new FormData(form);
                const memberData = Object.fromEntries(formData.entries());
                
                // Validate required fields
                if (!memberData.first_name || !memberData.last_name || !memberData.email || !memberData.phone || !memberData.membership_type) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                // Validate password match
                if (memberData.initial_password !== memberData.confirm_password) {
                    showToast('Passwords do not match', 'error');
                    return;
                }
                
                const supabase = initSupabase();
                
                // Create profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .insert([{
                        email: memberData.email,
                        first_name: memberData.first_name,
                        last_name: memberData.last_name,
                        phone: memberData.phone,
                        id_number: memberData.id_number,
                        date_of_birth: memberData.date_of_birth,
                        address: memberData.address,
                        occupation: memberData.occupation,
                        employer: memberData.employer,
                        notes: memberData.notes,
                        role: 'member',
                        status: 'active'
                    }])
                    .select()
                    .single();
                
                if (profileError) {
                    if (profileError.code === '23505') { // Unique violation
                        showToast('Email already exists in the system', 'error');
                        return;
                    }
                    throw profileError;
                }
                
                // Create member record
                const { data: member, error: memberError } = await supabase
                    .from('members')
                    .insert([{
                        profile_id: profile.id,
                        region_id: memberData.region_id,
                        membership_number: memberData.membership_number,
                        membership_type: memberData.membership_type,
                        membership_status: memberData.membership_status || 'pending',
                        join_date: memberData.join_date || new Date().toISOString().split('T')[0],
                        created_by: currentUser.id
                    }])
                    .select();
                
                if (memberError) throw memberError;
                
                // Clear cache
                dataCache.members = null;
                
                showToast('Member added successfully!', 'success');
                loadSection('members');
                
            } catch (error) {
                console.error('Error adding member:', error);
                showToast('Error adding member: ' + error.message, 'error');
            }
        }
        
        // ==================== EDIT MEMBER ====================
        
        async function editMember(memberId) {
            try {
                const supabase = initSupabase();
                
                // Get member data
                const { data: member, error } = await supabase
                    .from('members')
                    .select(`
                        *,
                        member_profile:profiles!members_profile_id_fkey (*),
                        member_region:regions!members_region_id_fkey (*)
                    `)
                    .eq('id', memberId)
                    .single();
                
                if (error) throw error;
                
                // Get regions for dropdown
                const { data: regions } = await supabase
                    .from('regions')
                    .select('id, name')
                    .eq('status', 'active')
                    .order('name');
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Member</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editMemberForm" class="space-y-4">
                            <input type="hidden" name="member_id" value="${member.id}">
                            <input type="hidden" name="profile_id" value="${member.profile_id}">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">First Name *</label>
                                    <input type="text" name="first_name" value="${member.member_profile?.first_name || ''}" required class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Last Name *</label>
                                    <input type="text" name="last_name" value="${member.member_profile?.last_name || ''}" required class="form-input">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email *</label>
                                    <input type="email" name="email" value="${member.member_profile?.email || ''}" required class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Phone</label>
                                    <input type="tel" name="phone" value="${member.member_profile?.phone || ''}" class="form-input">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">ID Number</label>
                                    <input type="text" name="id_number" value="${member.member_profile?.id_number || ''}" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Date of Birth</label>
                                    <input type="date" name="date_of_birth" value="${member.member_profile?.date_of_birth || ''}" class="form-input">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Address</label>
                                <textarea name="address" rows="2" class="form-input">${member.member_profile?.address || ''}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Membership Type</label>
                                    <select name="membership_type" class="form-input">
                                        ${MEMBERSHIP_TYPES.map(type => `
                                            <option value="${type}" ${member.membership_type === type ? 'selected' : ''}>
                                                ${type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ')}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Region</label>
                                    <select name="region_id" class="form-input">
                                        <option value="">Select Region</option>
                                        ${regions ? regions.map(region => `
                                            <option value="${region.id}" ${member.region_id === region.id ? 'selected' : ''}>
                                                ${region.name}
                                            </option>
                                        `).join('') : ''}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Membership Status</label>
                                    <select name="membership_status" class="form-input">
                                        <option value="active" ${member.membership_status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="pending" ${member.membership_status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="inactive" ${member.membership_status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                        <option value="alumni" ${member.membership_status === 'alumni' ? 'selected' : ''}>Alumni</option>
                                        <option value="suspended" ${member.membership_status === 'suspended' ? 'selected' : ''}>Suspended</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Join Date</label>
                                    <input type="date" name="join_date" value="${member.join_date || ''}" class="form-input">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Notes</label>
                                <textarea name="notes" rows="3" class="form-input">${member.member_profile?.notes || ''}</textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateMember()" class="btn btn-primary">
                                    Update Member
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit member form:', error);
                showToast('Error loading member data: ' + error.message, 'error');
            }
        }
        
        async function updateMember() {
            try {
                const form = document.getElementById('editMemberForm');
                const formData = new FormData(form);
                const memberData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                // Update profile
                await supabase
                    .from('profiles')
                    .update({
                        first_name: memberData.first_name,
                        last_name: memberData.last_name,
                        email: memberData.email,
                        phone: memberData.phone,
                        id_number: memberData.id_number,
                        date_of_birth: memberData.date_of_birth,
                        address: memberData.address,
                        notes: memberData.notes,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', memberData.profile_id);
                
                // Update member
                await supabase
                    .from('members')
                    .update({
                        region_id: memberData.region_id,
                        membership_type: memberData.membership_type,
                        membership_status: memberData.membership_status,
                        join_date: memberData.join_date,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', memberData.member_id);
                
                // Clear cache
                dataCache.members = null;
                
                showToast('Member updated successfully', 'success');
                closeModal();
                loadSection('members');
                
            } catch (error) {
                console.error('Error updating member:', error);
                showToast('Error updating member: ' + error.message, 'error');
            }
        }
        
        // ==================== VIEW MEMBER DETAILS ====================
        
        async function viewMemberDetails(memberId) {
            try {
                const supabase = initSupabase();
                
                // Get member with all related data
                const { data: member, error } = await supabase
                    .from('members')
                    .select(`
                        *,
                        member_profile:profiles!members_profile_id_fkey (*),
                        member_region:regions!members_region_id_fkey (*),
                        payments (*)
                    `)
                    .eq('id', memberId)
                    .single();
                
                if (error) throw error;
                
                // Calculate total payments
                let totalPaid = 0;
                let lastPaymentDate = null;
                if (member.payments && member.payments.length > 0) {
                    member.payments.forEach(payment => {
                        if (payment.payment_status === 'completed') {
                            totalPaid += parseFloat(payment.amount || 0);
                            if (!lastPaymentDate || new Date(payment.paid_at) > new Date(lastPaymentDate)) {
                                lastPaymentDate = payment.paid_at;
                            }
                        }
                    });
                }
                
                const modalContent = `
                    <div class="p-6 max-w-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Member Details</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Personal Info -->
                            <div class="card">
                                <h4 class="font-bold text-gray-800 mb-4">Personal Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Full Name</p>
                                        <p class="font-medium">${member.member_profile?.first_name || ''} ${member.member_profile?.last_name || ''}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Email</p>
                                        <p class="font-medium">${member.member_profile?.email || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Phone</p>
                                        <p class="font-medium">${member.member_profile?.phone || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">ID Number</p>
                                        <p class="font-medium">${member.member_profile?.id_number || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Date of Birth</p>
                                        <p class="font-medium">${member.member_profile?.date_of_birth ? formatDate(member.member_profile.date_of_birth) : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Address</p>
                                        <p class="font-medium">${member.member_profile?.address || 'N/A'}</p>
                                    </div>
                                    ${member.member_profile?.occupation ? `
                                        <div>
                                            <p class="text-sm text-gray-600">Occupation</p>
                                            <p class="font-medium">${member.member_profile.occupation}</p>
                                        </div>
                                    ` : ''}
                                    ${member.member_profile?.employer ? `
                                        <div>
                                            <p class="text-sm text-gray-600">Employer/Institution</p>
                                            <p class="font-medium">${member.member_profile.employer}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Membership Info -->
                            <div class="card">
                                <h4 class="font-bold text-gray-800 mb-4">Membership Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Member ID</p>
                                        <p class="font-medium">${member.membership_number || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Membership Type</p>
                                        <p class="font-medium">${member.membership_type ? member.membership_type.charAt(0).toUpperCase() + member.membership_type.slice(1).replace('_', ' ') : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Region</p>
                                        <p class="font-medium">${member.member_region?.name || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Status</p>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${member.membership_status === 'active' ? 'bg-green-100 text-green-800' : member.membership_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                            ${member.membership_status ? member.membership_status.charAt(0).toUpperCase() + member.membership_status.slice(1) : 'N/A'}
                                        </span>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Join Date</p>
                                        <p class="font-medium">${member.join_date ? formatDate(member.join_date) : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Total Paid</p>
                                        <p class="font-medium">KSh ${totalPaid.toLocaleString()}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Payments -->
                            ${member.payments && member.payments.length > 0 ? `
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4">Recent Payments</h4>
                                    <div class="space-y-3">
                                        ${member.payments.slice(0, 5).map(payment => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="font-medium">${payment.payment_for ? payment.payment_for.charAt(0).toUpperCase() + payment.payment_for.slice(1) : 'Payment'}</p>
                                                    <p class="text-sm text-gray-600">
                                                        ${formatDateTime(payment.paid_at || payment.created_at)}  
                                                        ${payment.payment_method ? payment.payment_method.charAt(0).toUpperCase() + payment.payment_method.slice(1).replace('_', ' ') : 'Unknown'}
                                                    </p>
                                                    ${payment.mpesa_code ? `<p class="text-xs text-gray-500">M-Pesa: ${payment.mpesa_code}</p>` : ''}
                                                </div>
                                                <div class="text-right">
                                                    <p class="font-bold">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</p>
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                        ${payment.payment_status ? payment.payment_status.charAt(0).toUpperCase() + payment.payment_status.slice(1) : 'Pending'}
                                                    </span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Member Notes -->
                            ${member.member_profile?.notes ? `
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4">Notes</h4>
                                    <p class="text-gray-700 whitespace-pre-line">${member.member_profile.notes}</p>
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button onclick="editMember('${member.id}')" class="btn btn-primary">
                                    <i class="fas fa-edit mr-2"></i>Edit Member
                                </button>
                                <button onclick="closeModal()" class="btn btn-secondary">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading member details:', error);
                showToast('Error loading member details: ' + error.message, 'error');
            }
        }
        
        // ==================== DELETE MEMBER ====================
        
        async function deleteMember(memberId) {
            if (!confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                // First get member to delete profile too
                const { data: member } = await supabase
                    .from('members')
                    .select('profile_id')
                    .eq('id', memberId)
                    .single();
                
                if (member) {
                    // Delete member record
                    await supabase
                        .from('members')
                        .delete()
                        .eq('id', memberId);
                    
                    // Delete profile
                    await supabase
                        .from('profiles')
                        .delete()
                        .eq('id', member.profile_id);
                }
                
                // Clear cache
                dataCache.members = null;
                
                showToast('Member deleted successfully', 'success');
                loadSection('members');
                
            } catch (error) {
                console.error('Error deleting member:', error);
                showToast('Error deleting member: ' + error.message, 'error');
            }
        }
        
        // ==================== REGIONS MANAGER ====================
        
        async function loadRegionsManager() {
            try {
                const supabase = initSupabase();
                const { data: regions, error } = await supabase
                    .from('regions')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Manage Regions</h2>
                                <button onclick="showAddRegionModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus-circle mr-2"></i>Add Region
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${regions && regions.length > 0 ? regions.map(region => `
                                    <div class="border rounded-lg p-6 hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 class="font-bold text-lg text-gray-800">${region.name}</h3>
                                                <p class="text-sm text-gray-500">${region.code}</p>
                                            </div>
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${region.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${region.status}
                                            </span>
                                        </div>
                                        
                                        <p class="text-gray-600 text-sm mb-4">${region.description || 'No description'}</p>
                                        
                                        <div class="flex justify-between text-sm text-gray-500">
                                            <div>
                                                <i class="fas fa-map-marker-alt mr-1"></i>
                                                ${region.country || 'Kenya'}
                                            </div>
                                            <div>
                                                <i class="fas fa-calendar-alt mr-1"></i>
                                                ${formatDate(region.created_at)}
                                            </div>
                                        </div>
                                        
                                        <div class="flex space-x-2 mt-4">
                                            <button onclick="editRegion('${region.id}')" class="flex-1 action-btn action-btn-edit">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </button>
                                            <button onclick="deleteRegion('${region.id}')" class="flex-1 action-btn action-btn-delete">
                                                <i class="fas fa-trash mr-1"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="col-span-3 text-center py-12 text-gray-500">
                                        <i class="fas fa-map-marker-alt text-3xl mb-3"></i>
                                        <p class="text-lg">No regions found</p>
                                        <button onclick="showAddRegionModal()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                            Add Your First Region
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading regions:', error);
                showToast('Error loading regions: ' + error.message, 'error');
            }
        }
        
        function showAddRegionModal() {
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Add New Region</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addRegionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Region Name *</label>
                            <input type="text" name="name" required class="form-input">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Region Code *</label>
                                <input type="text" name="code" required class="form-input" placeholder="e.g., NBO">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Country</label>
                                <input type="text" name="country" class="form-input" value="Kenya">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3" class="form-input"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Status</label>
                            <select name="status" class="form-input">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewRegion()" class="btn btn-primary">
                                Add Region
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        async function addNewRegion() {
            try {
                const form = document.getElementById('addRegionForm');
                const formData = new FormData(form);
                const regionData = Object.fromEntries(formData.entries());
                
                if (!regionData.name || !regionData.code) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const supabase = initSupabase();
                
                const { error } = await supabase
                    .from('regions')
                    .insert([{
                        name: regionData.name,
                        code: regionData.code.toUpperCase(),
                        country: regionData.country || 'Kenya',
                        description: regionData.description,
                        status: regionData.status || 'active'
                    }]);
                
                if (error) throw error;
                
                // Clear cache
                dataCache.regions = null;
                
                showToast('Region added successfully', 'success');
                closeModal();
                loadSection('regions');
                
            } catch (error) {
                console.error('Error adding region:', error);
                showToast('Error adding region: ' + error.message, 'error');
            }
        }
        
        async function editRegion(regionId) {
            try {
                const supabase = initSupabase();
                const { data: region, error } = await supabase
                    .from('regions')
                    .select('*')
                    .eq('id', regionId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Region</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editRegionForm" class="space-y-4">
                            <input type="hidden" name="region_id" value="${region.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Region Name *</label>
                                <input type="text" name="name" value="${region.name}" required class="form-input">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Region Code *</label>
                                    <input type="text" name="code" value="${region.code}" required class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Country</label>
                                    <input type="text" name="country" value="${region.country || 'Kenya'}" class="form-input">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <textarea name="description" rows="3" class="form-input">${region.description || ''}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="form-input">
                                    <option value="active" ${region.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${region.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateRegion()" class="btn btn-primary">
                                    Update Region
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit region form:', error);
                showToast('Error loading region data: ' + error.message, 'error');
            }
        }
        
        async function updateRegion() {
            try {
                const form = document.getElementById('editRegionForm');
                const formData = new FormData(form);
                const regionData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                await supabase
                    .from('regions')
                    .update({
                        name: regionData.name,
                        code: regionData.code.toUpperCase(),
                        country: regionData.country,
                        description: regionData.description,
                        status: regionData.status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', regionData.region_id);
                
                // Clear cache
                dataCache.regions = null;
                
                showToast('Region updated successfully', 'success');
                closeModal();
                loadSection('regions');
                
            } catch (error) {
                console.error('Error updating region:', error);
                showToast('Error updating region: ' + error.message, 'error');
            }
        }
        
        async function deleteRegion(regionId) {
            if (!confirm('Are you sure you want to delete this region? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('regions')
                    .delete()
                    .eq('id', regionId);
                
                // Clear cache
                dataCache.regions = null;
                
                showToast('Region deleted successfully', 'success');
                loadSection('regions');
                
            } catch (error) {
                console.error('Error deleting region:', error);
                showToast('Error deleting region: ' + error.message, 'error');
            }
        }
        
        // ==================== EVENTS CALENDAR ====================
        
        async function loadEventsManager() {
            try {
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Events Calendar</h2>
                                <p class="text-gray-600 text-sm">View and manage upcoming events</p>
                            </div>
                            <button onclick="loadSection('add-event')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-calendar-plus mr-2"></i>Add Event
                            </button>
                        </div>
                        
                        <div class="mb-6">
                            <div id="calendar"></div>
                        </div>
                        
                        <!-- Upcoming Events List -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Upcoming Events</h3>
                            <div id="upcoming-events-list" class="space-y-4">
                                <div class="text-center py-8 text-gray-500">
                                    <div class="loading mx-auto mb-4"></div>
                                    <p>Loading events...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize calendar
                initCalendar();
                // Load upcoming events
                loadUpcomingEventsList();
                
            } catch (error) {
                console.error('Error loading events manager:', error);
                showToast('Error loading events: ' + error.message, 'error');
            }
        }
        
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: async function(fetchInfo, successCallback, failureCallback) {
                    try {
                        const supabase = initSupabase();
                        const { data: events, error } = await supabase
                            .from('events')
                            .select('*')
                            .eq('status', 'published')
                            .gte('start_date', fetchInfo.startStr)
                            .lte('end_date', fetchInfo.endStr);
                        
                        if (error) throw error;
                        
                        const calendarEvents = events.map(event => ({
                            id: event.id,
                            title: event.title,
                            start: event.start_date,
                            end: event.end_date,
                            description: event.description,
                            venue: event.venue,
                            color: getEventColor(event.event_type),
                            textColor: 'white'
                        }));
                        
                        successCallback(calendarEvents);
                    } catch (error) {
                        console.error('Error loading calendar events:', error);
                        failureCallback(error);
                    }
                },
                eventClick: function(info) {
                    viewEventDetails(info.event.id);
                },
                eventContent: function(info) {
                    return {
                        html: `<div class="fc-event-title">${info.event.title}</div>`
                    };
                }
            });
            
            calendarInstance.render();
        }
        
        function getEventColor(eventType) {
            const colors = {
                'meeting': '#3b82f6',
                'workshop': '#10b981',
                'seminar': '#f59e0b',
                'conference': '#8b5cf6',
                'social': '#ef4444',
                'training': '#6366f1',
                'webinar': '#ec4899',
                'fundraiser': '#84cc16'
            };
            
            return colors[eventType] || '#6b7280';
        }
        
        async function loadUpcomingEventsList() {
            try {
                const supabase = initSupabase();
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('status', 'published')
                    .gte('start_date', new Date().toISOString())
                    .order('start_date', { ascending: true })
                    .limit(10);
                
                if (error) throw error;
                
                const eventsList = document.getElementById('upcoming-events-list');
                
                if (events && events.length > 0) {
                    eventsList.innerHTML = events.map(event => `
                        <div class="flex items-center p-4 border rounded-lg hover:bg-gray-50">
                            <div class="w-12 h-12 rounded-lg ${getEventBgColor(event.event_type)} flex items-center justify-center mr-4">
                                <i class="fas fa-calendar text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800">${event.title}</h4>
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-map-marker-alt mr-1"></i>${event.venue || 'TBA'}  
                                    <i class="fas fa-calendar-alt ml-2 mr-1"></i>${formatDate(event.start_date)}
                                    ${event.end_date ? ` to ${formatDate(event.end_date)}` : ''}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">${event.description?.substring(0, 100)}${event.description?.length > 100 ? '...' : ''}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editEvent('${event.id}')" class="action-btn action-btn-edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="viewEventDetails('${event.id}')" class="action-btn action-btn-view">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="deleteEvent('${event.id}')" class="action-btn action-btn-delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    eventsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-calendar-times text-3xl mb-3"></i>
                            <p>No upcoming events</p>
                            <button onclick="loadSection('add-event')" class="mt-3 text-blue-600 hover:text-blue-800">
                                Schedule an event
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading upcoming events:', error);
                document.getElementById('upcoming-events-list').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-3"></i>
                        <p>Error loading events</p>
                    </div>
                `;
            }
        }
        
        function getEventBgColor(eventType) {
            const colors = {
                'meeting': 'bg-blue-500',
                'workshop': 'bg-green-500',
                'seminar': 'bg-yellow-500',
                'conference': 'bg-purple-500',
                'social': 'bg-red-500',
                'training': 'bg-indigo-500',
                'webinar': 'bg-pink-500',
                'fundraiser': 'bg-lime-500'
            };
            
            return colors[eventType] || 'bg-gray-500';
        }
        
        // ==================== ADD EVENT FORM ====================
        
        async function loadAddEventForm() {
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Add New Event</h2>
                            <button onclick="loadSection('events')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Calendar
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addEventForm" class="space-y-6 max-w-2xl">
                            <!-- Basic Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Basic Information</h3>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Title *</label>
                                    <input type="text" name="title" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Event Type</label>
                                        <select name="event_type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            ${EVENT_TYPES.map(type => `
                                                <option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select name="status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="published">Published</option>
                                            <option value="draft">Draft</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Date and Time -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Date and Time</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date *</label>
                                        <input type="datetime-local" name="start_date" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                        <input type="datetime-local" name="end_date"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Location -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Location</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Venue</label>
                                        <input type="text" name="venue"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="e.g., Conference Hall, Nairobi">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Attendees</label>
                                        <input type="number" name="max_attendees"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                    <textarea name="address" rows="2"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <!-- Event Details -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Event Details</h3>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                    <textarea name="description" rows="4"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Registration Fee (KSh)</label>
                                        <input type="number" name="registration_fee" step="0.01"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                                        <input type="text" name="contact_person"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email/Phone</label>
                                    <input type="text" name="contact_info"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Information</label>
                                    <textarea name="additional_info" rows="3"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('events')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewEvent()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-calendar-plus mr-2"></i>Create Event
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Set default date/time
            const now = new Date();
            const formattedDate = now.toISOString().slice(0, 16);
            document.querySelector('input[name="start_date"]').value = formattedDate;
            
            // Set end date to 2 hours later
            const endDate = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            document.querySelector('input[name="end_date"]').value = endDate.toISOString().slice(0, 16);
        }
        
        async function addNewEvent() {
            try {
                const form = document.getElementById('addEventForm');
                const formData = new FormData(form);
                const eventData = Object.fromEntries(formData.entries());
                
                // Validate required fields
                if (!eventData.title || !eventData.start_date) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('events')
                    .insert([{
                        title: eventData.title,
                        event_type: eventData.event_type,
                        status: eventData.status || 'draft',
                        start_date: eventData.start_date,
                        end_date: eventData.end_date || eventData.start_date,
                        venue: eventData.venue,
                        address: eventData.address,
                        description: eventData.description,
                        registration_fee: eventData.registration_fee || 0,
                        max_attendees: eventData.max_attendees,
                        contact_person: eventData.contact_person,
                        contact_info: eventData.contact_info,
                        additional_info: eventData.additional_info,
                        created_by: currentUser.id
                    }])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.events = null;
                
                showToast('Event created successfully!', 'success');
                loadSection('events');
                
            } catch (error) {
                console.error('Error adding event:', error);
                showToast('Error creating event: ' + error.message, 'error');
            }
        }
        
        async function editEvent(eventId) {
            try {
                const supabase = initSupabase();
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Event</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editEventForm" class="space-y-4">
                            <input type="hidden" name="event_id" value="${event.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Event Title *</label>
                                <input type="text" name="title" value="${event.title}" required class="form-input">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Event Type</label>
                                    <select name="event_type" class="form-input">
                                        ${EVENT_TYPES.map(type => `
                                            <option value="${type}" ${event.event_type === type ? 'selected' : ''}>
                                                ${type.charAt(0).toUpperCase() + type.slice(1)}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Status</label>
                                    <select name="status" class="form-input">
                                        <option value="published" ${event.status === 'published' ? 'selected' : ''}>Published</option>
                                        <option value="draft" ${event.status === 'draft' ? 'selected' : ''}>Draft</option>
                                        <option value="cancelled" ${event.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Start Date *</label>
                                    <input type="datetime-local" name="start_date" value="${event.start_date ? event.start_date.slice(0, 16) : ''}" required class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">End Date</label>
                                    <input type="datetime-local" name="end_date" value="${event.end_date ? event.end_date.slice(0, 16) : ''}" class="form-input">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Venue</label>
                                <input type="text" name="venue" value="${event.venue || ''}" class="form-input">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <textarea name="description" rows="3" class="form-input">${event.description || ''}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Registration Fee (KSh)</label>
                                    <input type="number" name="registration_fee" value="${event.registration_fee || 0}" step="0.01" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Max Attendees</label>
                                    <input type="number" name="max_attendees" value="${event.max_attendees || ''}" class="form-input">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateEvent()" class="btn btn-primary">
                                    Update Event
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit event form:', error);
                showToast('Error loading event data: ' + error.message, 'error');
            }
        }
        
        async function updateEvent() {
            try {
                const form = document.getElementById('editEventForm');
                const formData = new FormData(form);
                const eventData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                await supabase
                    .from('events')
                    .update({
                        title: eventData.title,
                        event_type: eventData.event_type,
                        status: eventData.status,
                        start_date: eventData.start_date,
                        end_date: eventData.end_date || eventData.start_date,
                        venue: eventData.venue,
                        description: eventData.description,
                        registration_fee: eventData.registration_fee || 0,
                        max_attendees: eventData.max_attendees,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', eventData.event_id);
                
                // Clear cache
                dataCache.events = null;
                
                showToast('Event updated successfully', 'success');
                closeModal();
                loadSection('events');
                
            } catch (error) {
                console.error('Error updating event:', error);
                showToast('Error updating event: ' + error.message, 'error');
            }
        }
        
        async function viewEventDetails(eventId) {
            try {
                const supabase = initSupabase();
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6 max-w-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Event Details</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Event Info -->
                            <div class="card">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h4 class="font-bold text-gray-800 text-lg">${event.title}</h4>
                                        <div class="flex items-center space-x-2 mt-2">
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${getEventStatusColor(event.status)}">
                                                ${event.status.charAt(0).toUpperCase() + event.status.slice(1)}
                                            </span>
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${getEventTypeColor(event.event_type)}">
                                                ${event.event_type ? event.event_type.charAt(0).toUpperCase() + event.event_type.slice(1) : 'Event'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-600">Registration Fee</p>
                                        <p class="font-bold">KSh ${parseFloat(event.registration_fee || 0).toLocaleString()}</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Date & Time</p>
                                        <p class="font-medium">
                                            ${formatDateTime(event.start_date)}
                                            ${event.end_date ? ` to ${formatDateTime(event.end_date)}` : ''}
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Venue</p>
                                        <p class="font-medium">${event.venue || 'TBA'}</p>
                                    </div>
                                    ${event.max_attendees ? `
                                        <div>
                                            <p class="text-sm text-gray-600">Maximum Attendees</p>
                                            <p class="font-medium">${event.max_attendees}</p>
                                        </div>
                                    ` : ''}
                                    ${event.contact_person ? `
                                        <div>
                                            <p class="text-sm text-gray-600">Contact Person</p>
                                            <p class="font-medium">${event.contact_person}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="card">
                                <h4 class="font-bold text-gray-800 mb-4">Description</h4>
                                <p class="text-gray-700 whitespace-pre-line">${event.description || 'No description provided.'}</p>
                            </div>
                            
                            <!-- Additional Info -->
                            ${event.additional_info || event.address || event.contact_info ? `
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4">Additional Information</h4>
                                    <div class="space-y-3">
                                        ${event.address ? `
                                            <div>
                                                <p class="text-sm text-gray-600">Address</p>
                                                <p class="font-medium">${event.address}</p>
                                            </div>
                                        ` : ''}
                                        ${event.contact_info ? `
                                            <div>
                                                <p class="text-sm text-gray-600">Contact Information</p>
                                                <p class="font-medium">${event.contact_info}</p>
                                            </div>
                                        ` : ''}
                                        ${event.additional_info ? `
                                            <div>
                                                <p class="text-sm text-gray-600">Notes</p>
                                                <p class="text-gray-700 whitespace-pre-line">${event.additional_info}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button onclick="editEvent('${event.id}')" class="btn btn-primary">
                                    <i class="fas fa-edit mr-2"></i>Edit Event
                                </button>
                                <button onclick="closeModal()" class="btn btn-secondary">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading event details:', error);
                showToast('Error loading event details: ' + error.message, 'error');
            }
        }
        
        function getEventStatusColor(status) {
            const colors = {
                'published': 'bg-green-100 text-green-800',
                'draft': 'bg-yellow-100 text-yellow-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }
        
        function getEventTypeColor(type) {
            const colors = {
                'meeting': 'bg-blue-100 text-blue-800',
                'workshop': 'bg-green-100 text-green-800',
                'seminar': 'bg-yellow-100 text-yellow-800',
                'conference': 'bg-purple-100 text-purple-800',
                'social': 'bg-red-100 text-red-800',
                'training': 'bg-indigo-100 text-indigo-800',
                'webinar': 'bg-pink-100 text-pink-800',
                'fundraiser': 'bg-lime-100 text-lime-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }
        
        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);
                
                // Clear cache
                dataCache.events = null;
                
                showToast('Event deleted successfully', 'success');
                loadSection('events');
                
            } catch (error) {
                console.error('Error deleting event:', error);
                showToast('Error deleting event: ' + error.message, 'error');
            }
        }
        
        // ==================== PAYMENTS MANAGER ====================
        
        async function loadPaymentsManager() {
            try {
                const supabase = initSupabase();
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        member:members!payments_member_id_fkey (
                            profile:profiles!members_profile_id_fkey (
                                first_name, last_name, email
                            )
                        )
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Payments</h2>
                                <p class="text-gray-600 text-sm">View all payment transactions</p>
                            </div>
                            <button onclick="loadSection('add-payment')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus-circle mr-2"></i>Record Payment
                            </button>
                        </div>
                        
                        <!-- Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Total Amount</p>
                                <p class="text-xl font-bold text-gray-800">KSh ${payments ? payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0).toLocaleString() : 0}</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Completed</p>
                                <p class="text-xl font-bold text-gray-800">${payments ? payments.filter(p => p.payment_status === 'completed').length : 0}</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Total Transactions</p>
                                <p class="text-xl font-bold text-gray-800">${payments?.length || 0}</p>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Pending</p>
                                <p class="text-xl font-bold text-gray-800">${payments ? payments.filter(p => p.payment_status === 'pending').length : 0}</p>
                            </div>
                        </div>
                        
                        <!-- Payments Table -->
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Member</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Invoice No.</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Method</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments && payments.length > 0 ? payments.map(payment => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-3">
                                                ${formatDate(payment.paid_at || payment.created_at)}
                                            </td>
                                            <td class="px-4 py-3">
                                                ${payment.member?.profile?.first_name || ''} ${payment.member?.profile?.last_name || ''}
                                                <p class="text-sm text-gray-500">${payment.member?.profile?.email || ''}</p>
                                            </td>
                                            <td class="px-4 py-3">
                                                <code class="text-sm font-mono">${payment.invoice_number || 'N/A'}</code>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="font-medium">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</div>
                                                <div class="text-sm text-gray-500">${payment.payment_for ? payment.payment_for.charAt(0).toUpperCase() + payment.payment_for.slice(1) : 'Payment'}</div>
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                                    payment.payment_method === 'mpesa' ? 'bg-green-100 text-green-800' :
                                                    payment.payment_method === 'bank_transfer' ? 'bg-blue-100 text-blue-800' :
                                                    payment.payment_method === 'cash' ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }">
                                                    ${payment.payment_method ? payment.payment_method.charAt(0).toUpperCase() + payment.payment_method.slice(1).replace('_', ' ') : 'Unknown'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                    ${payment.payment_status ? payment.payment_status.charAt(0).toUpperCase() + payment.payment_status.slice(1) : 'Pending'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex space-x-2">
                                                    <button onclick="viewPayment('${payment.id}')" class="action-btn action-btn-view">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="deletePayment('${payment.id}')" class="action-btn action-btn-delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                                <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                                                <p class="text-lg">No payments found</p>
                                                <button onclick="loadSection('add-payment')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                    Record First Payment
                                                </button>
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading payments:', error);
                showToast('Error loading payments: ' + error.message, 'error');
            }
        }
        
        // ==================== ADD PAYMENT FORM ====================
        
        async function loadAddPaymentForm() {
            const supabase = initSupabase();
            const { data: members } = await supabase
                .from('members')
                .select(`
                    *,
                    profile:profiles!members_profile_id_fkey (*)
                `)
                .order('created_at', { ascending: false });
            
            // Generate invoice number
            const invoiceNumber = generateInvoiceNumber();
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Record Payment</h2>
                            <button onclick="loadSection('payments')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Payments
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addPaymentForm" class="space-y-6 max-w-2xl">
                            <!-- Member Selection -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Member Information</h3>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Member *</label>
                                    <select name="member_id" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Member</option>
                                        ${members ? members.map(member => `
                                            <option value="${member.id}">
                                                ${member.profile?.first_name || ''} ${member.profile?.last_name || ''} 
                                                (${member.membership_number || 'No ID'})
                                            </option>
                                        `).join('') : ''}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Payment Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Payment Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Number</label>
                                        <input type="text" name="invoice_number" readonly
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
                                               value="${invoiceNumber}">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount (KSh) *</label>
                                        <input type="number" name="amount" step="0.01" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment For *</label>
                                        <select name="payment_for" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="membership">Membership Fee</option>
                                            <option value="event">Event Registration</option>
                                            <option value="donation">Donation</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                                        <select name="payment_method" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            ${PAYMENT_METHODS.map(method => `
                                                <option value="${method}">${method.charAt(0).toUpperCase() + method.slice(1).replace('_', ' ')}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- M-Pesa Fields -->
                                <div id="mpesa-fields" class="mt-4 hidden">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">M-Pesa Transaction Code</label>
                                            <input type="text" name="mpesa_code"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                            <input type="text" name="phone_number"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                   placeholder="2547XXXXXXXX">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date</label>
                                        <input type="datetime-local" name="paid_at" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               value="${new Date().toISOString().slice(0, 16)}">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select name="payment_status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="completed">Completed</option>
                                            <option value="pending">Pending</option>
                                            <option value="failed">Failed</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional Information -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Additional Information</h3>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                                    <textarea name="notes" rows="3"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('payments')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewPayment()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Record Payment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Show/hide M-Pesa fields based on payment method
            const paymentMethodSelect = document.querySelector('select[name="payment_method"]');
            const mpesaFields = document.getElementById('mpesa-fields');
            
            paymentMethodSelect.addEventListener('change', function() {
                if (this.value === 'mpesa') {
                    mpesaFields.classList.remove('hidden');
                } else {
                    mpesaFields.classList.add('hidden');
                }
            });
        }
        
        async function addNewPayment() {
            try {
                const form = document.getElementById('addPaymentForm');
                const formData = new FormData(form);
                const paymentData = Object.fromEntries(formData.entries());
                
                // Validate required fields
                if (!paymentData.member_id || !paymentData.amount || !paymentData.payment_for) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const supabase = initSupabase();
                
                const insertData = {
                    member_id: paymentData.member_id,
                    invoice_number: paymentData.invoice_number,
                    amount: paymentData.amount,
                    payment_for: paymentData.payment_for,
                    payment_method: paymentData.payment_method,
                    payment_status: paymentData.payment_status,
                    notes: paymentData.notes,
                    paid_at: paymentData.paid_at,
                    created_by: currentUser.id
                };
                
                if (paymentData.payment_method === 'mpesa') {
                    insertData.mpesa_code = paymentData.mpesa_code;
                    insertData.phone_number = paymentData.phone_number;
                }
                
                const { data, error } = await supabase
                    .from('payments')
                    .insert([insertData])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.payments = null;
                
                showToast('Payment recorded successfully!', 'success');
                loadSection('payments');
                
            } catch (error) {
                console.error('Error adding payment:', error);
                showToast('Error recording payment: ' + error.message, 'error');
            }
        }
        
        // ==================== VIEW PAYMENT DETAILS ====================
        
        async function viewPayment(paymentId) {
            try {
                const supabase = initSupabase();
                
                const { data: payment, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        member:members!payments_member_id_fkey (
                            profile:profiles!members_profile_id_fkey (
                                first_name, last_name, email, phone
                            )
                        )
                    `)
                    .eq('id', paymentId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Payment Details</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Payment Information -->
                            <div class="card">
                                <h4 class="font-bold text-gray-800 mb-4">Payment Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Invoice Number</p>
                                        <p class="font-medium">${payment.invoice_number || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Amount</p>
                                        <p class="font-medium">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Payment For</p>
                                        <p class="font-medium">${payment.payment_for ? payment.payment_for.charAt(0).toUpperCase() + payment.payment_for.slice(1) : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Payment Method</p>
                                        <p class="font-medium">${payment.payment_method ? payment.payment_method.charAt(0).toUpperCase() + payment.payment_method.slice(1).replace('_', ' ') : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Status</p>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                            ${payment.payment_status ? payment.payment_status.charAt(0).toUpperCase() + payment.payment_status.slice(1) : 'N/A'}
                                        </span>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Date</p>
                                        <p class="font-medium">${formatDateTime(payment.paid_at || payment.created_at)}</p>
                                    </div>
                                </div>
                                
                                ${payment.mpesa_code ? `
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-600">M-Pesa Details</p>
                                        <div class="grid grid-cols-2 gap-4 mt-2">
                                            <div>
                                                <p class="text-xs text-gray-500">Transaction Code</p>
                                                <p class="font-medium">${payment.mpesa_code}</p>
                                            </div>
                                            ${payment.phone_number ? `
                                                <div>
                                                    <p class="text-xs text-gray-500">Phone Number</p>
                                                    <p class="font-medium">${payment.phone_number}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Member Information -->
                            <div class="card">
                                <h4 class="font-bold text-gray-800 mb-4">Member Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Member Name</p>
                                        <p class="font-medium">${payment.member?.profile?.first_name || ''} ${payment.member?.profile?.last_name || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Email</p>
                                        <p class="font-medium">${payment.member?.profile?.email || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Phone</p>
                                        <p class="font-medium">${payment.member?.profile?.phone || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Payment Date</p>
                                        <p class="font-medium">${formatDate(payment.paid_at || payment.created_at)}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            ${payment.notes ? `
                                <div class="card">
                                    <h4 class="font-bold text-gray-800 mb-4">Notes</h4>
                                    <p class="text-gray-700 whitespace-pre-line">${payment.notes}</p>
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button onclick="closeModal()" class="btn btn-secondary">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading payment details:', error);
                showToast('Error loading payment details: ' + error.message, 'error');
            }
        }
        
        // ==================== DELETE PAYMENT ====================
        
        async function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment record? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('payments')
                    .delete()
                    .eq('id', paymentId);
                
                // Clear cache
                dataCache.payments = null;
                
                showToast('Payment deleted successfully', 'success');
                loadSection('payments');
                
            } catch (error) {
                console.error('Error deleting payment:', error);
                showToast('Error deleting payment: ' + error.message, 'error');
            }
        }
        
        // ==================== M-PESA PAYMENTS ====================
        
        async function loadMpesaPayments() {
            try {
                const supabase = initSupabase();
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        member:members!payments_member_id_fkey (
                            profile:profiles!members_profile_id_fkey (
                                first_name, last_name, phone
                            )
                        )
                    `)
                    .eq('payment_method', 'mpesa')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Calculate M-Pesa specific stats
                let totalMpesaAmount = 0;
                let completedMpesa = 0;
                let pendingMpesa = 0;
                
                if (payments) {
                    payments.forEach(payment => {
                        totalMpesaAmount += parseFloat(payment.amount || 0);
                        if (payment.payment_status === 'completed') {
                            completedMpesa++;
                        } else if (payment.payment_status === 'pending') {
                            pendingMpesa++;
                        }
                    });
                }
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">M-Pesa Payments</h2>
                                <p class="text-gray-600 text-sm">View all M-Pesa transactions</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="loadSection('add-payment')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus-circle mr-2"></i>Record M-Pesa
                                </button>
                            </div>
                        </div>
                        
                        <!-- M-Pesa Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-green-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Total M-Pesa Amount</p>
                                <p class="text-xl font-bold text-gray-800">KSh ${totalMpesaAmount.toLocaleString()}</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Total M-Pesa Transactions</p>
                                <p class="text-xl font-bold text-gray-800">${payments?.length || 0}</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Completed</p>
                                <p class="text-xl font-bold text-gray-800">${completedMpesa}</p>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Pending</p>
                                <p class="text-xl font-bold text-gray-800">${pendingMpesa}</p>
                            </div>
                        </div>
                        
                        <!-- M-Pesa Payments Table -->
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Member</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">M-Pesa Code</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Phone</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments && payments.length > 0 ? payments.map(payment => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-3">
                                                ${formatDate(payment.paid_at || payment.created_at)}
                                            </td>
                                            <td class="px-4 py-3">
                                                ${payment.member?.profile?.first_name || ''} ${payment.member?.profile?.last_name || ''}
                                                <p class="text-sm text-gray-500">${payment.member?.profile?.email || ''}</p>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex items-center">
                                                    <span class="mpesa-badge mr-2">M-Pesa</span>
                                                    <code class="text-sm font-mono">${payment.mpesa_code || 'N/A'}</code>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="font-medium">${payment.phone_number || payment.member?.profile?.phone || 'N/A'}</div>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="font-medium">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</div>
                                                <div class="text-sm text-gray-500">${payment.payment_for ? payment.payment_for.charAt(0).toUpperCase() + payment.payment_for.slice(1) : 'Payment'}</div>
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                    ${payment.payment_status ? payment.payment_status.charAt(0).toUpperCase() + payment.payment_status.slice(1) : 'Pending'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex space-x-2">
                                                    <button onclick="viewPayment('${payment.id}')" class="action-btn action-btn-view">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="verifyMpesaPayment('${payment.id}')" class="action-btn action-btn-edit">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                                <div class="flex flex-col items-center">
                                                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-3">
                                                        <i class="fas fa-mobile-alt text-green-900 text-2xl"></i>
                                                    </div>
                                                    <p class="text-lg">No M-Pesa payments found</p>
                                                    <p class="text-sm text-gray-500 mt-1">M-Pesa payments will appear here</p>
                                                    <button onclick="loadSection('add-payment')" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                                        <i class="fas fa-mobile-alt mr-2"></i>Record M-Pesa Payment
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading M-Pesa payments:', error);
                showToast('Error loading M-Pesa payments: ' + error.message, 'error');
            }
        }
        
        async function verifyMpesaPayment(paymentId) {
            if (!confirm('Mark this M-Pesa payment as verified?')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('payments')
                    .update({
                        payment_status: 'completed',
                        verified_at: new Date().toISOString(),
                        verified_by: currentUser.id,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', paymentId);
                
                showToast('M-Pesa payment verified successfully', 'success');
                loadSection('mpesa-payments');
                
            } catch (error) {
                console.error('Error verifying M-Pesa payment:', error);
                showToast('Error verifying payment: ' + error.message, 'error');
            }
        }
        
        // ==================== ANNOUNCEMENTS MANAGER ====================
        
        async function loadAnnouncementsManager() {
            try {
                const supabase = initSupabase();
                const { data: announcements, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Announcements</h2>
                                <button onclick="showAddAnnouncementModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-bullhorn mr-2"></i>New Announcement
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            ${announcements && announcements.length > 0 ? announcements.map(announcement => `
                                <div class="border rounded-lg p-6 mb-6 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="font-bold text-lg text-gray-800">${announcement.title}</h3>
                                            <div class="flex items-center space-x-2 mt-2">
                                                <span class="px-3 py-1 rounded-full text-xs font-medium ${getAnnouncementTypeColor(announcement.announcement_type)}">
                                                    ${announcement.announcement_type ? announcement.announcement_type.charAt(0).toUpperCase() + announcement.announcement_type.slice(1) : 'General'}
                                                </span>
                                                <span class="px-3 py-1 rounded-full text-xs font-medium ${announcement.status === 'published' ? 'bg-green-100 text-green-800' : announcement.status === 'draft' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                                    ${announcement.status ? announcement.status.charAt(0).toUpperCase() + announcement.status.slice(1) : 'Draft'}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm text-gray-600">${formatDate(announcement.created_at)}</p>
                                            ${announcement.expires_at ? `
                                                <p class="text-xs text-gray-500">Expires: ${formatDate(announcement.expires_at)}</p>
                                            ` : ''}
                                        </div>
                                    </div>
                                    
                                    <div class="prose max-w-none mb-4">
                                        ${announcement.content}
                                    </div>
                                    
                                    <div class="flex justify-between items-center">
                                        <div class="text-sm text-gray-500">
                                            ${announcement.audience ? `
                                                <span>Audience: ${announcement.audience}</span>
                                            ` : ''}
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="editAnnouncement('${announcement.id}')" class="action-btn action-btn-edit">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </button>
                                            <button onclick="deleteAnnouncement('${announcement.id}')" class="action-btn action-btn-delete">
                                                <i class="fas fa-trash mr-1"></i>Delete
                                            </button>
                                            ${announcement.status !== 'published' ? `
                                                <button onclick="publishAnnouncement('${announcement.id}')" class="action-btn action-btn-view">
                                                    <i class="fas fa-paper-plane mr-1"></i>Publish
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="text-center py-12 text-gray-500">
                                    <i class="fas fa-bullhorn text-3xl mb-3"></i>
                                    <p class="text-lg">No announcements found</p>
                                    <p class="text-sm mb-4">Create announcements to communicate with members</p>
                                    <button onclick="showAddAnnouncementModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Create First Announcement
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading announcements:', error);
                showToast('Error loading announcements: ' + error.message, 'error');
            }
        }
        
        function getAnnouncementTypeColor(type) {
            const colors = {
                'general': 'bg-blue-100 text-blue-800',
                'event': 'bg-green-100 text-green-800',
                'news': 'bg-purple-100 text-purple-800',
                'urgent': 'bg-red-100 text-red-800',
                'maintenance': 'bg-yellow-100 text-yellow-800',
                'update': 'bg-indigo-100 text-indigo-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }
        
        function showAddAnnouncementModal() {
            const modalContent = `
                <div class="p-6 max-w-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Create New Announcement</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addAnnouncementForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Title *</label>
                            <input type="text" name="title" required class="form-input">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Type</label>
                                <select name="announcement_type" class="form-input">
                                    ${ANNOUNCEMENT_TYPES.map(type => `
                                        <option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="form-input">
                                    <option value="draft">Draft</option>
                                    <option value="published">Published</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Content *</label>
                            <textarea name="content" rows="6" required class="form-input"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Audience</label>
                                <select name="audience" class="form-input">
                                    <option value="all">All Members</option>
                                    <option value="active">Active Members Only</option>
                                    <option value="regional">Regional Members</option>
                                    <option value="specific">Specific Groups</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Expiry Date</label>
                                <input type="date" name="expires_at" class="form-input">
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewAnnouncement()" class="btn btn-primary">
                                Create Announcement
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        async function addNewAnnouncement() {
            try {
                const form = document.getElementById('addAnnouncementForm');
                const formData = new FormData(form);
                const announcementData = Object.fromEntries(formData.entries());
                
                if (!announcementData.title || !announcementData.content) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const supabase = initSupabase();
                
                const { error } = await supabase
                    .from('announcements')
                    .insert([{
                        title: announcementData.title,
                        announcement_type: announcementData.announcement_type,
                        status: announcementData.status || 'draft',
                        content: announcementData.content,
                        audience: announcementData.audience || 'all',
                        expires_at: announcementData.expires_at,
                        created_by: currentUser.id
                    }]);
                
                if (error) throw error;
                
                // Clear cache
                dataCache.announcements = null;
                
                showToast('Announcement created successfully!', 'success');
                closeModal();
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error adding announcement:', error);
                showToast('Error creating announcement: ' + error.message, 'error');
            }
        }
        
        async function editAnnouncement(announcementId) {
            try {
                const supabase = initSupabase();
                const { data: announcement, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .eq('id', announcementId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6 max-w-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Announcement</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editAnnouncementForm" class="space-y-4">
                            <input type="hidden" name="announcement_id" value="${announcement.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Title *</label>
                                <input type="text" name="title" value="${announcement.title}" required class="form-input">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Type</label>
                                    <select name="announcement_type" class="form-input">
                                        ${ANNOUNCEMENT_TYPES.map(type => `
                                            <option value="${type}" ${announcement.announcement_type === type ? 'selected' : ''}>
                                                ${type.charAt(0).toUpperCase() + type.slice(1)}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Status</label>
                                    <select name="status" class="form-input">
                                        <option value="draft" ${announcement.status === 'draft' ? 'selected' : ''}>Draft</option>
                                        <option value="published" ${announcement.status === 'published' ? 'selected' : ''}>Published</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Content *</label>
                                <textarea name="content" rows="6" required class="form-input">${announcement.content || ''}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Audience</label>
                                    <select name="audience" class="form-input">
                                        <option value="all" ${announcement.audience === 'all' ? 'selected' : ''}>All Members</option>
                                        <option value="active" ${announcement.audience === 'active' ? 'selected' : ''}>Active Members Only</option>
                                        <option value="regional" ${announcement.audience === 'regional' ? 'selected' : ''}>Regional Members</option>
                                        <option value="specific" ${announcement.audience === 'specific' ? 'selected' : ''}>Specific Groups</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Expiry Date</label>
                                    <input type="date" name="expires_at" value="${announcement.expires_at || ''}" class="form-input">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateAnnouncement()" class="btn btn-primary">
                                    Update Announcement
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit announcement form:', error);
                showToast('Error loading announcement data: ' + error.message, 'error');
            }
        }
        
        async function updateAnnouncement() {
            try {
                const form = document.getElementById('editAnnouncementForm');
                const formData = new FormData(form);
                const announcementData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                await supabase
                    .from('announcements')
                    .update({
                        title: announcementData.title,
                        announcement_type: announcementData.announcement_type,
                        status: announcementData.status,
                        content: announcementData.content,
                        audience: announcementData.audience,
                        expires_at: announcementData.expires_at,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', announcementData.announcement_id);
                
                // Clear cache
                dataCache.announcements = null;
                
                showToast('Announcement updated successfully', 'success');
                closeModal();
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error updating announcement:', error);
                showToast('Error updating announcement: ' + error.message, 'error');
            }
        }
        
        async function publishAnnouncement(announcementId) {
            if (!confirm('Publish this announcement to all members?')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('announcements')
                    .update({
                        status: 'published',
                        published_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', announcementId);
                
                showToast('Announcement published successfully', 'success');
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error publishing announcement:', error);
                showToast('Error publishing announcement: ' + error.message, 'error');
            }
        }
        
        async function deleteAnnouncement(announcementId) {
            if (!confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('announcements')
                    .delete()
                    .eq('id', announcementId);
                
                // Clear cache
                dataCache.announcements = null;
                
                showToast('Announcement deleted successfully', 'success');
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error deleting announcement:', error);
                showToast('Error deleting announcement: ' + error.message, 'error');
            }
        }
        
        // ==================== REPORTS MANAGER ====================
        
        async function loadReportsManager() {
            try {
                const stats = await loadStats();
                const recentMembers = await getRecentMembers(10);
                const recentPayments = await getRecentPayments(10);
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <h2 class="text-xl font-bold text-gray-800">Reports</h2>
                            <p class="text-gray-600 text-sm">System reports and analytics</p>
                        </div>
                        
                        <div class="p-6">
                            <!-- Quick Stats -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                <div class="card">
                                    <p class="text-sm text-gray-600">Total Members</p>
                                    <p class="text-2xl font-bold text-gray-800">${stats.members}</p>
                                </div>
                                <div class="card">
                                    <p class="text-sm text-gray-600">Total Revenue</p>
                                    <p class="text-2xl font-bold text-gray-800">KSh ${stats.revenue.toLocaleString()}</p>
                                </div>
                                <div class="card">
                                    <p class="text-sm text-gray-600">Active Regions</p>
                                    <p class="text-2xl font-bold text-gray-800">${stats.regions}</p>
                                </div>
                                <div class="card">
                                    <p class="text-sm text-gray-600">Upcoming Events</p>
                                    <p class="text-2xl font-bold text-gray-800">${stats.events}</p>
                                </div>
                            </div>
                            
                            <!-- Report Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                <div class="card hover:shadow-md transition-shadow cursor-pointer" onclick="generateMembersReport()">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                            <i class="fas fa-users text-blue-900"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Members Report</h3>
                                            <p class="text-sm text-gray-600">All member details</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card hover:shadow-md transition-shadow cursor-pointer" onclick="generatePaymentsReport()">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                                            <i class="fas fa-money-bill-wave text-green-900"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Payments Report</h3>
                                            <p class="text-sm text-gray-600">Financial transactions</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card hover:shadow-md transition-shadow cursor-pointer" onclick="generateEventsReport()">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                                            <i class="fas fa-calendar-alt text-purple-900"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Events Report</h3>
                                            <p class="text-sm text-gray-600">Event attendance</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card hover:shadow-md transition-shadow cursor-pointer" onclick="generateFinancialReport()">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
                                            <i class="fas fa-chart-line text-yellow-900"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Financial Report</h3>
                                            <p class="text-sm text-gray-600">Revenue analysis</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card hover:shadow-md transition-shadow cursor-pointer" onclick="generateMembershipReport()">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mr-4">
                                            <i class="fas fa-chart-pie text-red-900"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Membership Report</h3>
                                            <p class="text-sm text-gray-600">Membership statistics</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card hover:shadow-md transition-shadow cursor-pointer" onclick="generateCustomReport()">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mr-4">
                                            <i class="fas fa-file-alt text-indigo-900"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Custom Report</h3>
                                            <p class="text-sm text-gray-600">Create custom report</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Data Preview -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- Recent Members -->
                                <div class="card">
                                    <h3 class="font-bold text-gray-800 mb-4">Recent Members</h3>
                                    <div class="space-y-3">
                                        ${recentMembers.length > 0 ? recentMembers.map(member => `
                                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                    <i class="fas fa-user text-blue-900 text-sm"></i>
                                                </div>
                                                <div class="flex-1">
                                                    <p class="font-medium text-sm">${member.first_name} ${member.last_name}</p>
                                                    <p class="text-xs text-gray-500">${member.email}</p>
                                                </div>
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${member.membership_status === 'active' ? 'bg-green-100 text-green-800' : member.membership_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                    ${member.membership_status || 'pending'}
                                                </span>
                                            </div>
                                        `).join('') : `
                                            <div class="text-center py-4 text-gray-500">
                                                <p>No recent members</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                                
                                <!-- Recent Payments -->
                                <div class="card">
                                    <h3 class="font-bold text-gray-800 mb-4">Recent Payments</h3>
                                    <div class="space-y-3">
                                        ${recentPayments.length > 0 ? recentPayments.map(payment => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="font-medium text-sm">${payment.member_name || 'Anonymous'}</p>
                                                    <p class="text-xs text-gray-500">${payment.payment_for ? payment.payment_for.charAt(0).toUpperCase() + payment.payment_for.slice(1) : 'Payment'}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="font-bold text-sm">KSh ${payment.amount.toLocaleString()}</p>
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                        ${payment.payment_status}
                                                    </span>
                                                </div>
                                            </div>
                                        `).join('') : `
                                            <div class="text-center py-4 text-gray-500">
                                                <p>No recent payments</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading reports:', error);
                showToast('Error loading reports: ' + error.message, 'error');
            }
        }
        
        async function generateMembersReport() {
            try {
                const supabase = initSupabase();
                const { data: members, error } = await supabase
                    .from('members')
                    .select(`
                        *,
                        member_profile:profiles!members_profile_id_fkey (*),
                        member_region:regions!members_region_id_fkey (*)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Generate CSV content
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Member ID,Name,Email,Phone,Region,Type,Status,Join Date\n";
                
                members.forEach(member => {
                    const row = [
                        `"${member.membership_number || ''}"`,
                        `"${member.member_profile?.first_name || ''} ${member.member_profile?.last_name || ''}"`,
                        `"${member.member_profile?.email || ''}"`,
                        `"${member.member_profile?.phone || ''}"`,
                        `"${member.member_region?.name || ''}"`,
                        `"${member.membership_type || ''}"`,
                        `"${member.membership_status || ''}"`,
                        `"${member.join_date || ''}"`
                    ].join(',');
                    csvContent += row + "\n";
                });
                
                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `members_report_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Members report generated successfully', 'success');
                
            } catch (error) {
                console.error('Error generating members report:', error);
                showToast('Error generating report: ' + error.message, 'error');
            }
        }
        
        async function generatePaymentsReport() {
            try {
                const supabase = initSupabase();
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        member:members!payments_member_id_fkey (
                            profile:profiles!members_profile_id_fkey (
                                first_name, last_name
                            )
                        )
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Generate CSV content
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Invoice No,Date,Member Name,Amount,Payment For,Method,Status,Transaction Code\n";
                
                payments.forEach(payment => {
                    const row = [
                        `"${payment.invoice_number || ''}"`,
                        `"${formatDate(payment.paid_at || payment.created_at)}"`,
                        `"${payment.member?.profile?.first_name || ''} ${payment.member?.profile?.last_name || 'Anonymous'}"`,
                        `"${payment.amount || 0}"`,
                        `"${payment.payment_for || ''}"`,
                        `"${payment.payment_method || ''}"`,
                        `"${payment.payment_status || ''}"`,
                        `"${payment.mpesa_code || ''}"`
                    ].join(',');
                    csvContent += row + "\n";
                });
                
                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `payments_report_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Payments report generated successfully', 'success');
                
            } catch (error) {
                console.error('Error generating payments report:', error);
                showToast('Error generating report: ' + error.message, 'error');
            }
        }
        
        async function generateEventsReport() {
            try {
                const supabase = initSupabase();
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('start_date', { ascending: false });
                
                if (error) throw error;
                
                // Generate CSV content
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Event Title,Type,Start Date,End Date,Venue,Status,Registration Fee,Max Attendees\n";
                
                events.forEach(event => {
                    const row = [
                        `"${event.title || ''}"`,
                        `"${event.event_type || ''}"`,
                        `"${event.start_date || ''}"`,
                        `"${event.end_date || ''}"`,
                        `"${event.venue || ''}"`,
                        `"${event.status || ''}"`,
                        `"${event.registration_fee || 0}"`,
                        `"${event.max_attendees || ''}"`
                    ].join(',');
                    csvContent += row + "\n";
                });
                
                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `events_report_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Events report generated successfully', 'success');
                
            } catch (error) {
                console.error('Error generating events report:', error);
                showToast('Error generating report: ' + error.message, 'error');
            }
        }
        
        function generateFinancialReport() {
            showModal(`
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Financial Report</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Report Period</label>
                            <select id="reportPeriod" class="form-input">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div id="customDateRange" class="hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Start Date</label>
                                    <input type="date" id="startDate" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">End Date</label>
                                    <input type="date" id="endDate" class="form-input">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Report Format</label>
                            <select id="reportFormat" class="form-input">
                                <option value="csv">CSV (Excel)</option>
                                <option value="pdf">PDF</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button onclick="closeModal()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button onclick="downloadFinancialReport()" class="btn btn-primary">
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            // Show/hide custom date range
            document.getElementById('reportPeriod').addEventListener('change', function() {
                const customRangeDiv = document.getElementById('customDateRange');
                customRangeDiv.classList.toggle('hidden', this.value !== 'custom');
            });
        }
        
        async function downloadFinancialReport() {
            try {
                const period = document.getElementById('reportPeriod').value;
                const format = document.getElementById('reportFormat').value;
                
                let startDate, endDate;
                
                if (period === 'custom') {
                    startDate = document.getElementById('startDate').value;
                    endDate = document.getElementById('endDate').value;
                    
                    if (!startDate || !endDate) {
                        showToast('Please select both start and end dates', 'error');
                        return;
                    }
                } else {
                    const now = new Date();
                    if (period === 'monthly') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    } else if (period === 'quarterly') {
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
                    } else { // yearly
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31);
                    }
                    
                    startDate = startDate.toISOString().split('T')[0];
                    endDate = endDate.toISOString().split('T')[0];
                }
                
                const supabase = initSupabase();
                
                // Get payments data
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        member:members!payments_member_id_fkey (
                            profile:profiles!members_profile_id_fkey (
                                first_name, last_name
                            )
                        )
                    `)
                    .gte('paid_at', startDate + 'T00:00:00')
                    .lte('paid_at', endDate + 'T23:59:59')
                    .order('paid_at', { ascending: false });
                
                if (error) throw error;
                
                // Calculate totals
                let totalAmount = 0;
                let completedPayments = 0;
                let pendingPayments = 0;
                
                if (payments) {
                    payments.forEach(payment => {
                        totalAmount += parseFloat(payment.amount || 0);
                        if (payment.payment_status === 'completed') {
                            completedPayments++;
                        } else if (payment.payment_status === 'pending') {
                            pendingPayments++;
                        }
                    });
                }
                
                // Generate report content based on format
                if (format === 'csv') {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Financial Report Summary\n\n";
                    csvContent += `Report Period: ${period}\n`;
                    csvContent += `Date Range: ${startDate} to ${endDate}\n`;
                    csvContent += `Total Revenue: KSh ${totalAmount.toLocaleString()}\n`;
                    csvContent += `Total Transactions: ${payments?.length || 0}\n`;
                    csvContent += `Completed Payments: ${completedPayments}\n`;
                    csvContent += `Pending Payments: ${pendingPayments}\n\n`;
                    
                    csvContent += "Transaction Details\n";
                    csvContent += "Date,Invoice No,Member,Amount,Payment For,Method,Status\n";
                    
                    if (payments) {
                        payments.forEach(payment => {
                            const row = [
                                `"${formatDate(payment.paid_at || payment.created_at)}"`,
                                `"${payment.invoice_number || ''}"`,
                                `"${payment.member?.profile?.first_name || ''} ${payment.member?.profile?.last_name || 'Anonymous'}"`,
                                `"${payment.amount || 0}"`,
                                `"${payment.payment_for || ''}"`,
                                `"${payment.payment_method || ''}"`,
                                `"${payment.payment_status || ''}"`
                            ].join(',');
                            csvContent += row + "\n";
                        });
                    }
                    
                    // Create download link
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `financial_report_${startDate}_to_${endDate}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else if (format === 'html') {
                    // Generate HTML report
                    const htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Financial Report - ${startDate} to ${endDate}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; }
                                h1 { color: #333; }
                                .summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                                .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
                                .stat-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                                .stat-value { font-size: 24px; font-weight: bold; color: #3b82f6; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                                th { background: #f8f9fa; }
                            </style>
                        </head>
                        <body>
                            <h1>KESNNUR Financial Report</h1>
                            <div class="summary">
                                <h2>Report Summary</h2>
                                <p><strong>Period:</strong> ${period}</p>
                                <p><strong>Date Range:</strong> ${startDate} to ${endDate}</p>
                                <div class="stats">
                                    <div class="stat-card">
                                        <p>Total Revenue</p>
                                        <div class="stat-value">KSh ${totalAmount.toLocaleString()}</div>
                                    </div>
                                    <div class="stat-card">
                                        <p>Total Transactions</p>
                                        <div class="stat-value">${payments?.length || 0}</div>
                                    </div>
                                    <div class="stat-card">
                                        <p>Completed</p>
                                        <div class="stat-value">${completedPayments}</div>
                                    </div>
                                    <div class="stat-card">
                                        <p>Pending</p>
                                        <div class="stat-value">${pendingPayments}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <h2>Transaction Details</h2>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Invoice No</th>
                                        <th>Member</th>
                                        <th>Amount</th>
                                        <th>Payment For</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments ? payments.map(payment => `
                                        <tr>
                                            <td>${formatDate(payment.paid_at || payment.created_at)}</td>
                                            <td>${payment.invoice_number || ''}</td>
                                            <td>${payment.member?.profile?.first_name || ''} ${payment.member?.profile?.last_name || 'Anonymous'}</td>
                                            <td>KSh ${parseFloat(payment.amount || 0).toLocaleString()}</td>
                                            <td>${payment.payment_for || ''}</td>
                                            <td>${payment.payment_method || ''}</td>
                                            <td>${payment.payment_status || ''}</td>
                                        </tr>
                                    `).join('') : ''}
                                </tbody>
                            </table>
                            
                            <p style="margin-top: 30px; text-align: right; color: #666;">
                                Generated on ${new Date().toLocaleString()}
                            </p>
                        </body>
                        </html>
                    `;
                    
                    // Open HTML in new window for printing/downloading
                    const newWindow = window.open();
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();
                    
                } else {
                    showToast('PDF format not implemented in demo', 'info');
                    // Note: For PDF generation, you would need a library like jsPDF or a server-side solution
                }
                
                showToast('Financial report generated successfully', 'success');
                closeModal();
                
            } catch (error) {
                console.error('Error generating financial report:', error);
                showToast('Error generating report: ' + error.message, 'error');
            }
        }
        
        function generateMembershipReport() {
            showToast('Membership report feature coming soon', 'info');
        }
        
        function generateCustomReport() {
            showToast('Custom report feature coming soon', 'info');
        }
        
        // ==================== ADMIN USERS MANAGER ====================
        
        async function loadUsersManager() {
            try {
                const supabase = initSupabase();
                const { data: profiles, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Admin Users</h2>
                                <button onclick="showAddUserModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-user-plus mr-2"></i>Add Admin User
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">User</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Role</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Last Login</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${profiles && profiles.length > 0 ? profiles.map(profile => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center">
                                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                            <i class="fas fa-user text-blue-900 text-sm"></i>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">${profile.first_name || ''} ${profile.last_name || ''}</p>
                                                            <p class="text-sm text-gray-500">${profile.email}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${profile.role === 'admin' ? 'bg-purple-100 text-purple-800' : profile.role === 'super_admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                                        ${profile.role ? profile.role.replace('_', ' ').toUpperCase() : 'USER'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    ${profile.last_login ? formatDateTime(profile.last_login) : 'Never'}
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${profile.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                        ${profile.status || 'inactive'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex space-x-2">
                                                        ${profile.id !== currentUser?.id ? `
                                                            <button onclick="editUserRole('${profile.id}')" class="action-btn action-btn-edit">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button onclick="deleteUser('${profile.id}')" class="action-btn action-btn-delete">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        ` : `
                                                            <span class="px-3 py-1 text-sm text-gray-500">Current User</span>
                                                        `}
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="5" class="px-4 py-12 text-center text-gray-500">
                                                    <i class="fas fa-users text-3xl mb-3"></i>
                                                    <p class="text-lg">No admin users found</p>
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error loading users: ' + error.message, 'error');
            }
        }
        
        function showAddUserModal() {
            const initialPassword = generatePassword(10);
            
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Add Admin User</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addUserForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email Address *</label>
                            <input type="email" name="email" required class="form-input">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">First Name</label>
                                <input type="text" name="first_name" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Last Name</label>
                                <input type="text" name="last_name" class="form-input">
                            </div>
                        </div>
                        
                        <!-- Password Section -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Initial Password *</label>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="text" name="password" value="${initialPassword}" required 
                                       class="flex-1 form-input">
                                <button type="button" onclick="regenerateUserPassword()" class="px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button type="button" onclick="copyUserPassword()" class="px-3 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div id="password-strength" class="password-strength strength-${checkPasswordStrength(initialPassword)}"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Role *</label>
                                <select name="role" required class="form-input">
                                    <option value="member">Member</option>
                                    <option value="editor">Editor</option>
                                    <option value="admin" selected>Admin</option>
                                    <option value="super_admin">Super Admin</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="form-input">
                                    <option value="active" selected>Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewUser()" class="btn btn-primary">
                                Add User
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
            
            // Add password strength checker
            const passwordInput = document.querySelector('input[name="password"]');
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    const strength = checkPasswordStrength(this.value);
                    const strengthBar = document.getElementById('password-strength');
                    strengthBar.className = `password-strength strength-${strength}`;
                });
            }
        }
        
        function regenerateUserPassword() {
            const newPassword = generatePassword(10);
            const passwordInput = document.querySelector('input[name="password"]');
            passwordInput.value = newPassword;
            
            // Update strength indicator
            const strength = checkPasswordStrength(newPassword);
            const strengthBar = document.getElementById('password-strength');
            strengthBar.className = `password-strength strength-${strength}`;
            
            showToast('New password generated', 'info');
        }
        
        function copyUserPassword() {
            const password = document.querySelector('input[name="password"]').value;
            copyToClipboard(password);
        }
        
        async function addNewUser() {
            try {
                const form = document.getElementById('addUserForm');
                const formData = new FormData(form);
                const userData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                // Create profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .insert([{
                        email: userData.email,
                        first_name: userData.first_name,
                        last_name: userData.last_name,
                        role: userData.role,
                        status: userData.status
                    }])
                    .select()
                    .single();
                
                if (profileError) {
                    if (profileError.code === '23505') {
                        showToast('User already exists with this email', 'error');
                        return;
                    }
                    throw profileError;
                }
                
                // Clear cache
                dataCache.users = null;
                
                showToast('Admin user added successfully!', 'success');
                closeModal();
                loadSection('users');
                
            } catch (error) {
                console.error('Error adding user:', error);
                showToast('Error adding user: ' + error.message, 'error');
            }
        }
        
        async function editUserRole(userId) {
            try {
                const supabase = initSupabase();
                
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit User Role</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editUserForm" class="space-y-4">
                            <input type="hidden" name="user_id" value="${profile.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Current User</label>
                                <input type="text" value="${profile.first_name || ''} ${profile.last_name || ''} (${profile.email})" readonly class="form-input bg-gray-50">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Role *</label>
                                    <select name="role" required class="form-input">
                                        <option value="member" ${profile.role === 'member' ? 'selected' : ''}>Member</option>
                                        <option value="editor" ${profile.role === 'editor' ? 'selected' : ''}>Editor</option>
                                        <option value="admin" ${profile.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        <option value="super_admin" ${profile.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Status</label>
                                    <select name="status" class="form-input">
                                        <option value="active" ${profile.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="inactive" ${profile.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                        <option value="pending" ${profile.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateUserRole()" class="btn btn-primary">
                                    Update User
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit user form:', error);
                showToast('Error loading user data: ' + error.message, 'error');
            }
        }
        
        async function updateUserRole() {
            try {
                const form = document.getElementById('editUserForm');
                const formData = new FormData(form);
                const userData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                // Update user role and status
                await supabase
                    .from('profiles')
                    .update({
                        role: userData.role,
                        status: userData.status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userData.user_id);
                
                // Clear cache
                dataCache.users = null;
                
                showToast('User updated successfully', 'success');
                closeModal();
                loadSection('users');
                
            } catch (error) {
                console.error('Error updating user:', error);
                showToast('Error updating user: ' + error.message, 'error');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                // Don't allow deleting yourself
                if (userId === currentUser.id) {
                    showToast('You cannot delete your own account', 'error');
                    return;
                }
                
                await supabase
                    .from('profiles')
                    .delete()
                    .eq('id', userId);
                
                // Clear cache
                dataCache.users = null;
                
                showToast('User deleted successfully', 'success');
                loadSection('users');
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error deleting user: ' + error.message, 'error');
            }
        }
        
        // ==================== SYSTEM SETTINGS ====================
        
        async function loadSystemSettings() {
            try {
                // Load settings from localStorage or use defaults
                const settings = JSON.parse(localStorage.getItem('kesnnur_settings') || '{}');
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <h2 class="text-xl font-bold text-gray-800">System Settings</h2>
                            <p class="text-gray-600 text-sm">Configure system preferences</p>
                        </div>
                        
                        <div class="p-6">
                            <form id="systemSettingsForm" class="space-y-8">
                                <!-- General Settings -->
                                <div>
                                    <h3 class="text-lg font-medium text-gray-800 mb-4">General Settings</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Organization Name</label>
                                            <input type="text" name="organization_name" value="${settings.organization_name || 'KESNNUR'}" 
                                                   class="form-input">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">System Email</label>
                                            <input type="email" name="system_email" value="${settings.system_email || 'info@kesnnur.org'}" 
                                                   class="form-input">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Phone</label>
                                            <input type="tel" name="contact_phone" value="${settings.contact_phone || '+254 700 000 000'}" 
                                                   class="form-input">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Currency</label>
                                            <select name="currency" class="form-input">
                                                <option value="KES" ${settings.currency === 'KES' ? 'selected' : ''}>Kenyan Shilling (KES)</option>
                                                <option value="USD" ${settings.currency === 'USD' ? 'selected' : ''}>US Dollar (USD)</option>
                                                <option value="EUR" ${settings.currency === 'EUR' ? 'selected' : ''}>Euro (EUR)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Membership Settings -->
                                <div>
                                    <h3 class="text-lg font-medium text-gray-800 mb-4">Membership Settings</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Membership Fee (KSh)</label>
                                            <input type="number" name="membership_fee" value="${settings.membership_fee || 1000}" 
                                                   class="form-input">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Membership Duration (Months)</label>
                                            <input type="number" name="membership_duration" value="${settings.membership_duration || 12}" 
                                                   class="form-input">
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" name="auto_approve_members" id="auto_approve_members" 
                                                   ${settings.auto_approve_members ? 'checked' : ''} class="mr-3">
                                            <label for="auto_approve_members" class="text-sm font-medium text-gray-700">
                                                Automatically approve new members
                                            </label>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" name="require_id_verification" id="require_id_verification" 
                                                   ${settings.require_id_verification ? 'checked' : ''} class="mr-3">
                                            <label for="require_id_verification" class="text-sm font-medium text-gray-700">
                                                Require ID verification for membership
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payment Settings -->
                                <div>
                                    <h3 class="text-lg font-medium text-gray-800 mb-4">Payment Settings</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">M-Pesa Paybill Number</label>
                                            <input type="text" name="mpesa_paybill" value="${settings.mpesa_paybill || ''}" 
                                                   class="form-input" placeholder="e.g., 123456">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Account Number</label>
                                            <input type="text" name="mpesa_account" value="${settings.mpesa_account || ''}" 
                                                   class="form-input" placeholder="e.g., KESNNUR">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Bank Account Details</label>
                                            <textarea name="bank_details" rows="3" class="form-input">${settings.bank_details || ''}</textarea>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" name="enable_online_payments" id="enable_online_payments" 
                                                   ${settings.enable_online_payments ? 'checked' : ''} class="mr-3">
                                            <label for="enable_online_payments" class="text-sm font-medium text-gray-700">
                                                Enable online payment processing
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Notification Settings -->
                                <div>
                                    <h3 class="text-lg font-medium text-gray-800 mb-4">Notification Settings</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center">
                                            <input type="checkbox" name="email_notifications" id="email_notifications" 
                                                   ${settings.email_notifications !== false ? 'checked' : ''} class="mr-3">
                                            <label for="email_notifications" class="text-sm font-medium text-gray-700">
                                                Enable email notifications
                                            </label>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" name="sms_notifications" id="sms_notifications" 
                                                   ${settings.sms_notifications ? 'checked' : ''} class="mr-3">
                                            <label for="sms_notifications" class="text-sm font-medium text-gray-700">
                                                Enable SMS notifications
                                            </label>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" name="notify_new_members" id="notify_new_members" 
                                                   ${settings.notify_new_members !== false ? 'checked' : ''} class="mr-3">
                                            <label for="notify_new_members" class="text-sm font-medium text-gray-700">
                                                Notify admins of new members
                                            </label>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" name="notify_new_payments" id="notify_new_payments" 
                                                   ${settings.notify_new_payments !== false ? 'checked' : ''} class="mr-3">
                                            <label for="notify_new_payments" class="text-sm font-medium text-gray-700">
                                                Notify admins of new payments
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- System Maintenance -->
                                <div>
                                    <h3 class="text-lg font-medium text-gray-800 mb-4">System Maintenance</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Auto-backup Interval</label>
                                            <select name="backup_interval" class="form-input">
                                                <option value="daily" ${settings.backup_interval === 'daily' ? 'selected' : ''}>Daily</option>
                                                <option value="weekly" ${settings.backup_interval === 'weekly' ? 'selected' : ''}>Weekly</option>
                                                <option value="monthly" ${settings.backup_interval === 'monthly' ? 'selected' : ''}>Monthly</option>
                                                <option value="never" ${settings.backup_interval === 'never' ? 'selected' : ''}>Never</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Session Timeout (Minutes)</label>
                                            <input type="number" name="session_timeout" value="${settings.session_timeout || 30}" 
                                                   class="form-input" min="5" max="480">
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" name="maintenance_mode" id="maintenance_mode" 
                                                   ${settings.maintenance_mode ? 'checked' : ''} class="mr-3">
                                            <label for="maintenance_mode" class="text-sm font-medium text-gray-700">
                                                Maintenance Mode (Restricts member access)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-4 pt-6 border-t">
                                    <button type="button" onclick="resetSettings()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                        Reset to Defaults
                                    </button>
                                    <button type="button" onclick="saveSystemSettings()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Save Settings
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Error loading settings: ' + error.message, 'error');
            }
        }
        
        function resetSettings() {
            if (confirm('Reset all settings to default values? This action cannot be undone.')) {
                localStorage.removeItem('kesnnur_settings');
                showToast('Settings reset to defaults', 'success');
                loadSystemSettings();
            }
        }
        
        function saveSystemSettings() {
            try {
                const form = document.getElementById('systemSettingsForm');
                const formData = new FormData(form);
                const settings = {};
                
                // Convert form data to object
                for (const [key, value] of formData.entries()) {
                    // Handle checkboxes
                    if (form.querySelector(`[name="${key}"]`).type === 'checkbox') {
                        settings[key] = form.querySelector(`[name="${key}"]`).checked;
                    } else if (key === 'membership_fee' || key === 'membership_duration' || key === 'session_timeout') {
                        settings[key] = parseInt(value) || 0;
                    } else {
                        settings[key] = value;
                    }
                }
                
                // Save to localStorage
                localStorage.setItem('kesnnur_settings', JSON.stringify(settings));
                
                showToast('Settings saved successfully', 'success');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Error saving settings: ' + error.message, 'error');
            }
        }
        
        // ==================== PAGE INITIALIZATION ====================
        
        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        // ==================== MISC FUNCTIONS ====================
        
        // Debounce function for search inputs
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Format numbers with commas
        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // Get initials from name
        function getInitials(name) {
            return name
                .split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase();
        }
        
        // Calculate age from date of birth
        function calculateAge(dateOfBirth) {
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // Generate QR Code (for membership cards, etc.)
        function generateQRCode(text, elementId) {
            // Note: In a real implementation, you would use a QR code library
            console.log('Generating QR code for:', text);
            // For demo purposes, just show the text
            document.getElementById(elementId).innerHTML = `
                <div class="text-center p-4 bg-gray-100 rounded-lg">
                    <p class="text-sm text-gray-600">QR Code for:</p>
                    <p class="font-mono text-xs break-all">${text}</p>
                </div>
            `;
        }
        
        // Export data to various formats
        function exportData(data, filename, format = 'csv') {
            let content, mimeType, extension;
            
            if (format === 'csv') {
                content = convertToCSV(data);
                mimeType = 'text/csv';
                extension = 'csv';
            } else if (format === 'json') {
                content = JSON.stringify(data, null, 2);
                mimeType = 'application/json';
                extension = 'json';
            } else if (format === 'excel') {
                // For Excel, we'll create CSV but with .xls extension
                content = convertToCSV(data);
                mimeType = 'application/vnd.ms-excel';
                extension = 'xls';
            } else {
                throw new Error('Unsupported format');
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.${extension}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Convert array of objects to CSV
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const rows = data.map(obj => 
                headers.map(header => {
                    const value = obj[header];
                    // Handle values that might contain commas or quotes
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            );
            
            return [headers.join(','), ...rows].join('\n');
        }
        
        // Check if user has permission for specific action
        function hasPermission(requiredRole) {
            if (!currentUserProfile) return false;
            
            const roleHierarchy = {
                'member': 0,
                'editor': 1,
                'admin': 2,
                'super_admin': 3
            };
            
            const userRoleLevel = roleHierarchy[currentUserProfile.role] || 0;
            const requiredRoleLevel = roleHierarchy[requiredRole] || 0;
            
            return userRoleLevel >= requiredRoleLevel;
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Get random color for avatars
        function getRandomColor() {
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                '#8b5cf6', '#ec4899', '#6366f1', '#84cc16'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Validate email format
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Validate phone number (Kenyan format)
        function validatePhone(phone) {
            const re = /^(\+?254|0)[17]\d{8}$/;
            return re.test(phone.replace(/\s/g, ''));
        }
        
        // Format phone number to Kenyan format
        function formatPhone(phone) {
            phone = phone.replace(/\D/g, '');
            
            if (phone.startsWith('0')) {
                phone = '254' + phone.substring(1);
            } else if (phone.startsWith('+254')) {
                phone = phone.substring(1);
            }
            
            return phone;
        }
        
        // Get greeting based on time of day
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good morning';
            if (hour < 18) return 'Good afternoon';
            return 'Good evening';
        }
        
        // Generate random ID
        function generateRandomId(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Deep clone object
        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }
        
        // Merge objects
        function mergeObjects(...objects) {
            return objects.reduce((result, obj) => {
                return { ...result, ...obj };
            }, {});
        }
        
        // Sort array of objects by property
        function sortByProperty(array, property, ascending = true) {
            return array.sort((a, b) => {
                const aValue = a[property];
                const bValue = b[property];
                
                if (aValue < bValue) return ascending ? -1 : 1;
                if (aValue > bValue) return ascending ? 1 : -1;
                return 0;
            });
        }
        
        // Filter array by search term
        function filterBySearch(array, searchTerm, properties) {
            if (!searchTerm) return array;
            
            const term = searchTerm.toLowerCase();
            return array.filter(item => {
                return properties.some(prop => {
                    const value = item[prop];
                    return value && value.toString().toLowerCase().includes(term);
                });
            });
        }
        
        // Group array by property
        function groupBy(array, property) {
            return array.reduce((groups, item) => {
                const key = item[property];
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(item);
                return groups;
            }, {});
        }
        
        // Paginate array
        function paginate(array, page, pageSize) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            return array.slice(start, end);
        }
        
        // Calculate total pages for pagination
        function calculateTotalPages(totalItems, pageSize) {
            return Math.ceil(totalItems / pageSize);
        }
        
        // Generate pagination array
        function generatePagination(currentPage, totalPages, maxVisible = 5) {
            const pages = [];
            let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalPages, start + maxVisible - 1);
            
            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }
            
            for (let i = start; i <= end; i++) {
                pages.push(i);
            }
            
            return pages;
        }
        
        // Calculate percentage
        function calculatePercentage(part, total) {
            if (total === 0) return 0;
            return Math.round((part / total) * 100);
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + ' years ago';
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + ' months ago';
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + ' days ago';
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + ' hours ago';
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + ' minutes ago';
            
            return Math.floor(seconds) + ' seconds ago';
        }
        
        // Truncate text with ellipsis
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        // Capitalize first letter
        function capitalize(text) {
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }
        
        // Generate slug from text
        function generateSlug(text) {
            return text
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/--+/g, '-')
                .trim();
        }
        
        // Parse query parameters
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
        
        // Set query parameters
        function setQueryParam(param, value) {
            const url = new URL(window.location);
            url.searchParams.set(param, value);
            window.history.pushState({}, '', url);
        }
        
        // Remove query parameters
        function removeQueryParam(param) {
            const url = new URL(window.location);
            url.searchParams.delete(param);
            window.history.pushState({}, '', url);
        }
        
        // Get all query parameters as object
        function getAllQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            for (const [key, value] of urlParams) {
                params[key] = value;
            }
            return params;
        }
        
        // Check if running on mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Check if running on touch device
        function isTouchDevice() {
            return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        }
        
        // Get browser information
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            
            if (ua.includes('Chrome') && !ua.includes('Edg')) browser = 'Chrome';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
            else if (ua.includes('Edg')) browser = 'Edge';
            else if (ua.includes('MSIE') || ua.includes('Trident')) browser = 'IE';
            
            return browser;
        }
        
        // Get operating system
        function getOS() {
            const ua = navigator.userAgent;
            let os = 'Unknown';
            
            if (ua.includes('Windows')) os = 'Windows';
            else if (ua.includes('Mac')) os = 'MacOS';
            else if (ua.includes('Linux')) os = 'Linux';
            else if (ua.includes('Android')) os = 'Android';
            else if (ua.includes('iOS') || ua.includes('iPhone') || ua.includes('iPad')) os = 'iOS';
            
            return os;
        }
        
        // Get screen resolution
        function getScreenResolution() {
            return {
                width: window.screen.width,
                height: window.screen.height
            };
        }
        
        // Get current viewport size
        function getViewportSize() {
            return {
                width: window.innerWidth,
                height: window.innerHeight
            };
        }
        
        // Check if element is in viewport
        function isInViewport(element) {
            const rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }
        
        // Scroll to element with smooth animation
        function scrollToElement(elementId, offset = 0) {
            const element = document.getElementById(elementId);
            if (element) {
                const elementPosition = element.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        }
        
        // Scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Scroll to bottom
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // Add event listener with delegation
        function addDelegateEvent(parentSelector, eventType, childSelector, handler) {
            document.querySelector(parentSelector).addEventListener(eventType, function(event) {
                if (event.target.matches(childSelector)) {
                    handler.call(event.target, event);
                }
            });
        }
        
        // Remove event listener
        function removeEvent(element, eventType, handler) {
            element.removeEventListener(eventType, handler);
        }
        
        // Add class to element
        function addClass(element, className) {
            if (element) {
                element.classList.add(className);
            }
        }
        
        // Remove class from element
        function removeClass(element, className) {
            if (element) {
                element.classList.remove(className);
            }
        }
        
        // Toggle class on element
        function toggleClass(element, className) {
            if (element) {
                element.classList.toggle(className);
            }
        }
        
        // Check if element has class
        function hasClass(element, className) {
            return element && element.classList.contains(className);
        }
        
        // Set element style
        function setStyle(element, styles) {
            if (element) {
                Object.assign(element.style, styles);
            }
        }
        
        // Get element style
        function getStyle(element, property) {
            if (element) {
                return window.getComputedStyle(element).getPropertyValue(property);
            }
            return null;
        }
        
        // Show element
        function showElement(element) {
            if (element) {
                element.style.display = '';
            }
        }
        
        // Hide element
        function hideElement(element) {
            if (element) {
                element.style.display = 'none';
            }
        }
        
        // Toggle element visibility
        function toggleElement(element) {
            if (element) {
                element.style.display = element.style.display === 'none' ? '' : 'none';
            }
        }
        
        // Create element with attributes
        function createElement(tag, attributes = {}, children = []) {
            const element = document.createElement(tag);
            
            // Set attributes
            for (const [key, value] of Object.entries(attributes)) {
                if (key === 'className') {
                    element.className = value;
                } else if (key === 'textContent') {
                    element.textContent = value;
                } else if (key === 'innerHTML') {
                    element.innerHTML = value;
                } else {
                    element.setAttribute(key, value);
                }
            }
            
            // Append children
            children.forEach(child => {
                if (typeof child === 'string') {
                    element.appendChild(document.createTextNode(child));
                } else {
                    element.appendChild(child);
                }
            });
            
            return element;
        }
        
        // Remove element
        function removeElement(element) {
            if (element && element.parentNode) {
                element.parentNode.removeChild(element);
            }
        }
        
        // Replace element
        function replaceElement(oldElement, newElement) {
            if (oldElement && oldElement.parentNode && newElement) {
                oldElement.parentNode.replaceChild(newElement, oldElement);
            }
        }
        
        // Insert element after reference
        function insertAfter(newElement, referenceElement) {
            if (referenceElement && referenceElement.parentNode && newElement) {
                referenceElement.parentNode.insertBefore(newElement, referenceElement.nextSibling);
            }
        }
        
        // Insert element before reference
        function insertBefore(newElement, referenceElement) {
            if (referenceElement && referenceElement.parentNode && newElement) {
                referenceElement.parentNode.insertBefore(newElement, referenceElement);
            }
        }
        
        // Get parent element by selector
        function getParentBySelector(element, selector) {
            while (element && element !== document) {
                if (element.matches(selector)) {
                    return element;
                }
                element = element.parentNode;
            }
            return null;
        }
        
        // Get siblings of element
        function getSiblings(element) {
            if (!element || !element.parentNode) return [];
            
            const siblings = [];
            let sibling = element.parentNode.firstChild;
            
            while (sibling) {
                if (sibling.nodeType === 1 && sibling !== element) {
                    siblings.push(sibling);
                }
                sibling = sibling.nextSibling;
            }
            
            return siblings;
        }
        
        // Get next sibling element
        function getNextSibling(element) {
            if (!element) return null;
            
            let sibling = element.nextSibling;
            while (sibling && sibling.nodeType !== 1) {
                sibling = sibling.nextSibling;
            }
            
            return sibling;
        }
        
        // Get previous sibling element
        function getPreviousSibling(element) {
            if (!element) return null;
            
            let sibling = element.previousSibling;
            while (sibling && sibling.nodeType !== 1) {
                sibling = sibling.previousSibling;
            }
            
            return sibling;
        }
        
        // Get all child elements
        function getChildren(element) {
            if (!element) return [];
            
            const children = [];
            let child = element.firstChild;
            
            while (child) {
                if (child.nodeType === 1) {
                    children.push(child);
                }
                child = child.nextSibling;
            }
            
            return children;
        }
        
        // Get first child element
        function getFirstChild(element) {
            if (!element) return null;
            
            let child = element.firstChild;
            while (child && child.nodeType !== 1) {
                child = child.nextSibling;
            }
            
            return child;
        }
        
        // Get last child element
        function getLastChild(element) {
            if (!element) return null;
            
            let child = element.lastChild;
            while (child && child.nodeType !== 1) {
                child = child.previousSibling;
            }
            
            return child;
        }
        
        // Find element by selector within context
        function findElement(selector, context = document) {
            return context.querySelector(selector);
        }
        
        // Find all elements by selector within context
        function findElements(selector, context = document) {
            return Array.from(context.querySelectorAll(selector));
        }
        
        // Wait for element to exist
        function waitForElement(selector, timeout = 3000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                function check() {
                    const element = document.querySelector(selector);
                    if (element) {
                        resolve(element);
                    } else if (Date.now() - startTime > timeout) {
                        reject(new Error(`Element ${selector} not found within ${timeout}ms`));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                
                check();
            });
        }
        
        // Wait for function to return true
        function waitFor(condition, timeout = 3000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                function check() {
                    if (condition()) {
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        reject(new Error('Condition not met within timeout'));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                
                check();
            });
        }
        
        // Delay execution
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Execute function on DOM ready
        function onReady(callback) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                callback();
            }
        }
        
        // Execute function on window load
        function onLoad(callback) {
            if (document.readyState === 'complete') {
                callback();
            } else {
                window.addEventListener('load', callback);
            }
        }
        
        // Throttle function
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        // Memoize function
        function memoize(func) {
            const cache = new Map();
            return function(...args) {
                const key = JSON.stringify(args);
                if (cache.has(key)) {
                    return cache.get(key);
                }
                const result = func.apply(this, args);
                cache.set(key, result);
                return result;
            };
        }
        
        // Pipe functions
        function pipe(...funcs) {
            return function(value) {
                return funcs.reduce((acc, func) => func(acc), value);
            };
        }
        
        // Compose functions
        function compose(...funcs) {
            return function(value) {
                return funcs.reduceRight((acc, func) => func(acc), value);
            };
        }
        
        // Curry function
        function curry(func) {
            return function curried(...args) {
                if (args.length >= func.length) {
                    return func.apply(this, args);
                } else {
                    return function(...args2) {
                        return curried.apply(this, args.concat(args2));
                    };
                }
            };
        }
        
        // Partial application
        function partial(func, ...args) {
            return function(...moreArgs) {
                return func.apply(this, args.concat(moreArgs));
            };
        }
        
        // Bind function with context
        function bind(func, context, ...args) {
            return function(...moreArgs) {
                return func.apply(context, args.concat(moreArgs));
            };
        }
        
        // Create singleton
        function createSingleton(className) {
            let instance;
            return function(...args) {
                if (!instance) {
                    instance = new className(...args);
                }
                return instance;
            };
        }
        
        // Create factory
        function createFactory(className) {
            return function(...args) {
                return new className(...args);
            };
        }
        
        // Create mixin
        function createMixin(...mixins) {
            return function(baseClass) {
                return mixins.reduce((currentClass, mixin) => {
                    return mixin(currentClass);
                }, baseClass);
            };
        }
        
        // Create decorator
        function createDecorator(wrapper) {
            return function(target, key, descriptor) {
                descriptor.value = wrapper(descriptor.value);
                return descriptor;
            };
        }
        
        // Create observer
        function createObserver() {
            const observers = new Map();
            
            return {
                subscribe(event, callback) {
                    if (!observers.has(event)) {
                        observers.set(event, []);
                    }
                    observers.get(event).push(callback);
                    
                    return () => {
                        const callbacks = observers.get(event);
                        const index = callbacks.indexOf(callback);
                        if (index > -1) {
                            callbacks.splice(index, 1);
                        }
                    };
                },
                
                emit(event, data) {
                    if (observers.has(event)) {
                        observers.get(event).forEach(callback => callback(data));
                    }
                },
                
                unsubscribeAll(event) {
                    if (event) {
                        observers.delete(event);
                    } else {
                        observers.clear();
                    }
                }
            };
        }
        
        // Create state manager
        function createStateManager(initialState) {
            let state = initialState;
            const observers = new Set();
            
            return {
                getState() {
                    return state;
                },
                
                setState(newState) {
                    const oldState = state;
                    state = typeof newState === 'function' ? newState(oldState) : newState;
                    observers.forEach(observer => observer(state, oldState));
                },
                
                subscribe(observer) {
                    observers.add(observer);
                    return () => observers.delete(observer);
                },
                
                unsubscribe(observer) {
                    observers.delete(observer);
                }
            };
        }
        
        // Create promise with timeout
        function createPromiseWithTimeout(promise, timeout, timeoutMessage = 'Operation timed out') {
            return Promise.race([
                promise,
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(timeoutMessage)), timeout)
                )
            ]);
        }
        
        // Create retry function
        function createRetry(func, maxRetries = 3, delayMs = 1000) {
            return async function(...args) {
                let lastError;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        return await func(...args);
                    } catch (error) {
                        lastError = error;
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delayMs * Math.pow(2, i)));
                        }
                    }
                }
                
                throw lastError;
            };
        }
        
        // Create cache
        function createCache(options = {}) {
            const { maxSize = 100, ttl = 60000 } = options;
            const cache = new Map();
            const timestamps = new Map();
            
            return {
                set(key, value) {
                    if (cache.size >= maxSize) {
                        const oldestKey = timestamps.keys().next().value;
                        this.delete(oldestKey);
                    }
                    
                    cache.set(key, value);
                    timestamps.set(key, Date.now());
                },
                
                get(key) {
                    const value = cache.get(key);
                    const timestamp = timestamps.get(key);
                    
                    if (value && timestamp) {
                        if (Date.now() - timestamp > ttl) {
                            this.delete(key);
                            return null;
                        }
                    }
                    
                    return value;
                },
                
                delete(key) {
                    cache.delete(key);
                    timestamps.delete(key);
                },
                
                clear() {
                    cache.clear();
                    timestamps.clear();
                },
                
                size() {
                    return cache.size;
                },
                
                keys() {
                    return Array.from(cache.keys());
                },
                
                values() {
                    return Array.from(cache.values());
                },
                
                entries() {
                    return Array.from(cache.entries());
                }
            };
        }
        
        // Create queue
        function createQueue() {
            const queue = [];
            
            return {
                enqueue(item) {
                    queue.push(item);
                },
                
                dequeue() {
                    return queue.shift();
                },
                
                peek() {
                    return queue[0];
                },
                
                isEmpty() {
                    return queue.length === 0;
                },
                
                size() {
                    return queue.length;
                },
                
                clear() {
                    queue.length = 0;
                },
                
                toArray() {
                    return [...queue];
                }
            };
        }
        
        // Create stack
        function createStack() {
            const stack = [];
            
            return {
                push(item) {
                    stack.push(item);
                },
                
                pop() {
                    return stack.pop();
                },
                
                peek() {
                    return stack[stack.length - 1];
                },
                
                isEmpty() {
                    return stack.length === 0;
                },
                
                size() {
                    return stack.length;
                },
                
                clear() {
                    stack.length = 0;
                },
                
                toArray() {
                    return [...stack];
                }
            };
        }
        
        // Create linked list
        function createLinkedList() {
            class Node {
                constructor(value) {
                    this.value = value;
                    this.next = null;
                }
            }
            
            let head = null;
            let tail = null;
            let length = 0;
            
            return {
                append(value) {
                    const node = new Node(value);
                    
                    if (!head) {
                        head = node;
                        tail = node;
                    } else {
                        tail.next = node;
                        tail = node;
                    }
                    
                    length++;
                },
                
                prepend(value) {
                    const node = new Node(value);
                    
                    if (!head) {
                        head = node;
                        tail = node;
                    } else {
                        node.next = head;
                        head = node;
                    }
                    
                    length++;
                },
                
                remove(value) {
                    if (!head) return false;
                    
                    if (head.value === value) {
                        head = head.next;
                        if (!head) tail = null;
                        length--;
                        return true;
                    }
                    
                    let current = head;
                    while (current.next) {
                        if (current.next.value === value) {
                            current.next = current.next.next;
                            if (!current.next) tail = current;
                            length--;
                            return true;
                        }
                        current = current.next;
                    }
                    
                    return false;
                },
                
                find(value) {
                    let current = head;
                    while (current) {
                        if (current.value === value) return current;
                        current = current.next;
                    }
                    return null;
                },
                
                toArray() {
                    const array = [];
                    let current = head;
                    while (current) {
                        array.push(current.value);
                        current = current.next;
                    }
                    return array;
                },
                
                get size() {
                    return length;
                },
                
                get head() {
                    return head?.value;
                },
                
                get tail() {
                    return tail?.value;
                },
                
                clear() {
                    head = null;
                    tail = null;
                    length = 0;
                }
            };
        }
        
        // Create binary search tree
        function createBinarySearchTree() {
            class Node {
                constructor(value) {
                    this.value = value;
                    this.left = null;
                    this.right = null;
                }
            }
            
            let root = null;
            
            function insert(node, value) {
                if (!node) return new Node(value);
                
                if (value < node.value) {
                    node.left = insert(node.left, value);
                } else if (value > node.value) {
                    node.right = insert(node.right, value);
                }
                
                return node;
            }
            
            function search(node, value) {
                if (!node) return false;
                
                if (value === node.value) return true;
                if (value < node.value) return search(node.left, value);
                return search(node.right, value);
            }
            
            function inOrder(node, callback) {
                if (node) {
                    inOrder(node.left, callback);
                    callback(node.value);
                    inOrder(node.right, callback);
                }
            }
            
            function preOrder(node, callback) {
                if (node) {
                    callback(node.value);
                    preOrder(node.left, callback);
                    preOrder(node.right, callback);
                }
            }
            
            function postOrder(node, callback) {
                if (node) {
                    postOrder(node.left, callback);
                    postOrder(node.right, callback);
                    callback(node.value);
                }
            }
            
            return {
                insert(value) {
                    root = insert(root, value);
                },
                
                contains(value) {
                    return search(root, value);
                },
                
                inOrder(callback) {
                    inOrder(root, callback);
                },
                
                preOrder(callback) {
                    preOrder(root, callback);
                },
                
                postOrder(callback) {
                    postOrder(root, callback);
                },
                
                toArray() {
                    const array = [];
                    this.inOrder(value => array.push(value));
                    return array;
                },
                
                clear() {
                    root = null;
                }
            };
        }
        
        // Create priority queue
        function createPriorityQueue() {
            const heap = [];
            
            function heapifyUp(index) {
                while (index > 0) {
                    const parentIndex = Math.floor((index - 1) / 2);
                    if (heap[index].priority >= heap[parentIndex].priority) break;
                    
                    [heap[index], heap[parentIndex]] = [heap[parentIndex], heap[index]];
                    index = parentIndex;
                }
            }
            
            function heapifyDown(index) {
                const length = heap.length;
                while (true) {
                    let leftChildIndex = 2 * index + 1;
                    let rightChildIndex = 2 * index + 2;
                    let smallest = index;
                    
                    if (leftChildIndex < length && heap[leftChildIndex].priority < heap[smallest].priority) {
                        smallest = leftChildIndex;
                    }
                    
                    if (rightChildIndex < length && heap[rightChildIndex].priority < heap[smallest].priority) {
                        smallest = rightChildIndex;
                    }
                    
                    if (smallest === index) break;
                    
                    [heap[index], heap[smallest]] = [heap[smallest], heap[index]];
                    index = smallest;
                }
            }
            
            return {
                enqueue(value, priority) {
                    heap.push({ value, priority });
                    heapifyUp(heap.length - 1);
                },
                
                dequeue() {
                    if (heap.length === 0) return null;
                    
                    const min = heap[0];
                    const last = heap.pop();
                    
                    if (heap.length > 0) {
                        heap[0] = last;
                        heapifyDown(0);
                    }
                    
                    return min.value;
                },
                
                peek() {
                    return heap.length > 0 ? heap[0].value : null;
                },
                
                isEmpty() {
                    return heap.length === 0;
                },
                
                size() {
                    return heap.length;
                },
                
                clear() {
                    heap.length = 0;
                },
                
                toArray() {
                    return heap.map(item => item.value);
                }
            };
        }
        
        // Create graph
        function createGraph() {
            const adjacencyList = new Map();
            
            return {
                addVertex(vertex) {
                    if (!adjacencyList.has(vertex)) {
                        adjacencyList.set(vertex, []);
                    }
                },
                
                addEdge(vertex1, vertex2) {
                    this.addVertex(vertex1);
                    this.addVertex(vertex2);
                    adjacencyList.get(vertex1).push(vertex2);
                    adjacencyList.get(vertex2).push(vertex1);
                },
                
                removeVertex(vertex) {
                    if (adjacencyList.has(vertex)) {
                        const neighbors = adjacencyList.get(vertex);
                        for (const neighbor of neighbors) {
                            const neighborEdges = adjacencyList.get(neighbor);
                            const index = neighborEdges.indexOf(vertex);
                            if (index > -1) {
                                neighborEdges.splice(index, 1);
                            }
                        }
                        adjacencyList.delete(vertex);
                    }
                },
                
                removeEdge(vertex1, vertex2) {
                    if (adjacencyList.has(vertex1) && adjacencyList.has(vertex2)) {
                        const edges1 = adjacencyList.get(vertex1);
                        const index1 = edges1.indexOf(vertex2);
                        if (index1 > -1) edges1.splice(index1, 1);
                        
                        const edges2 = adjacencyList.get(vertex2);
                        const index2 = edges2.indexOf(vertex1);
                        if (index2 > -1) edges2.splice(index2, 1);
                    }
                },
                
                hasVertex(vertex) {
                    return adjacencyList.has(vertex);
                },
                
                hasEdge(vertex1, vertex2) {
                    return adjacencyList.has(vertex1) && 
                           adjacencyList.get(vertex1).includes(vertex2);
                },
                
                getNeighbors(vertex) {
                    return adjacencyList.has(vertex) ? [...adjacencyList.get(vertex)] : [];
                },
                
                dfs(startVertex, callback) {
                    const visited = new Set();
                    
                    function traverse(vertex) {
                        if (visited.has(vertex)) return;
                        
                        visited.add(vertex);
                        callback(vertex);
                        
                        const neighbors = adjacencyList.get(vertex) || [];
                        for (const neighbor of neighbors) {
                            traverse(neighbor);
                        }
                    }
                    
                    traverse(startVertex);
                },
                
                bfs(startVertex, callback) {
                    const visited = new Set();
                    const queue = [startVertex];
                    visited.add(startVertex);
                    
                    while (queue.length > 0) {
                        const vertex = queue.shift();
                        callback(vertex);
                        
                        const neighbors = adjacencyList.get(vertex) || [];
                        for (const neighbor of neighbors) {
                            if (!visited.has(neighbor)) {
                                visited.add(neighbor);
                                queue.push(neighbor);
                            }
                        }
                    }
                },
                
                toArray() {
                    const vertices = Array.from(adjacencyList.keys());
                    const edges = [];
                    
                    for (const [vertex, neighbors] of adjacencyList.entries()) {
                        for (const neighbor of neighbors) {
                            if (vertex < neighbor) { // To avoid duplicate edges
                                edges.push([vertex, neighbor]);
                            }
                        }
                    }
                    
                    return { vertices, edges };
                },
                
                clear() {
                    adjacencyList.clear();
                }
            };
        }
        
        // Create trie
        function createTrie() {
            class TrieNode {
                constructor() {
                    this.children = new Map();
                    this.isEndOfWord = false;
                }
            }
            
            let root = new TrieNode();
            
            return {
                insert(word) {
                    let node = root;
                    for (const char of word) {
                        if (!node.children.has(char)) {
                            node.children.set(char, new TrieNode());
                        }
                        node = node.children.get(char);
                    }
                    node.isEndOfWord = true;
                },
                
                search(word) {
                    let node = root;
                    for (const char of word) {
                        if (!node.children.has(char)) {
                            return false;
                        }
                        node = node.children.get(char);
                    }
                    return node.isEndOfWord;
                },
                
                startsWith(prefix) {
                    let node = root;
                    for (const char of prefix) {
                        if (!node.children.has(char)) {
                            return false;
                        }
                        node = node.children.get(char);
                    }
                    return true;
                },
                
                getAllWords() {
                    const words = [];
                    
                    function dfs(node, word) {
                        if (node.isEndOfWord) {
                            words.push(word);
                        }
                        
                        for (const [char, childNode] of node.children) {
                            dfs(childNode, word + char);
                        }
                    }
                    
                    dfs(root, '');
                    return words;
                },
                
                clear() {
                    root = new TrieNode();
                }
            };
        }
        
        // Create bloom filter
        function createBloomFilter(size, hashFunctions) {
            const bitArray = new Array(size).fill(false);
            
            return {
                add(item) {
                    for (let i = 0; i < hashFunctions; i++) {
                        const hash = this._hash(item + i) % size;
                        bitArray[hash] = true;
                    }
                },
                
                mightContain(item) {
                    for (let i = 0; i < hashFunctions; i++) {
                        const hash = this._hash(item + i) % size;
                        if (!bitArray[hash]) {
                            return false;
                        }
                    }
                    return true;
                },
                
                _hash(str) {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        hash = (hash << 5) - hash + str.charCodeAt(i);
                        hash |= 0;
                    }
                    return Math.abs(hash);
                },
                
                clear() {
                    bitArray.fill(false);
                }
            };
        }
        
        // Create LRU cache
        function createLRUCache(capacity) {
            class Node {
                constructor(key, value) {
                    this.key = key;
                    this.value = value;
                    this.prev = null;
                    this.next = null;
                }
            }
            
            const map = new Map();
            let head = null;
            let tail = null;
            
            function moveToFront(node) {
                if (node === head) return;
                
                // Remove node from current position
                if (node.prev) node.prev.next = node.next;
                if (node.next) node.next.prev = node.prev;
                if (node === tail) tail = node.prev;
                
                // Add to front
                node.prev = null;
                node.next = head;
                if (head) head.prev = node;
                head = node;
                if (!tail) tail = node;
            }
            
            function removeLast() {
                if (!tail) return;
                
                const key = tail.key;
                map.delete(key);
                
                if (tail.prev) {
                    tail.prev.next = null;
                    tail = tail.prev;
                } else {
                    head = null;
                    tail = null;
                }
            }
            
            return {
                get(key) {
                    if (!map.has(key)) return null;
                    
                    const node = map.get(key);
                    moveToFront(node);
                    return node.value;
                },
                
                put(key, value) {
                    if (map.has(key)) {
                        const node = map.get(key);
                        node.value = value;
                        moveToFront(node);
                    } else {
                        if (map.size >= capacity) {
                            removeLast();
                        }
                        
                        const node = new Node(key, value);
                        map.set(key, node);
                        
                        if (!head) {
                            head = node;
                            tail = node;
                        } else {
                            moveToFront(node);
                        }
                    }
                },
                
                delete(key) {
                    if (!map.has(key)) return false;
                    
                    const node = map.get(key);
                    map.delete(key);
                    
                    if (node.prev) node.prev.next = node.next;
                    if (node.next) node.next.prev = node.prev;
                    if (node === head) head = node.next;
                    if (node === tail) tail = node.prev;
                    
                    return true;
                },
                
                clear() {
                    map.clear();
                    head = null;
                    tail = null;
                },
                
                size() {
                    return map.size;
                },
                
                keys() {
                    return Array.from(map.keys());
                },
                
                values() {
                    return Array.from(map.values()).map(node => node.value);
                },
                
                entries() {
                    return Array.from(map.entries()).map(([key, node]) => [key, node.value]);
                }
            };
        }
        
        // Create event emitter
        function createEventEmitter() {
            const events = new Map();
            
            return {
                on(event, listener) {
                    if (!events.has(event)) {
                        events.set(event, []);
                    }
                    events.get(event).push(listener);
                    
                    return () => {
                        this.off(event, listener);
                    };
                },
                
                off(event, listener) {
                    if (!events.has(event)) return;
                    
                    const listeners = events.get(event);
                    const index = listeners.indexOf(listener);
                    if (index > -1) {
                        listeners.splice(index, 1);
                    }
                },
                
                emit(event, ...args) {
                    if (!events.has(event)) return;
                    
                    const listeners = events.get(event).slice();
                    for (const listener of listeners) {
                        try {
                            listener.apply(this, args);
                        } catch (error) {
                            console.error(`Error in event listener for "${event}":`, error);
                        }
                    }
                },
                
                once(event, listener) {
                    const onceListener = (...args) => {
                        this.off(event, onceListener);
                        listener.apply(this, args);
                    };
                    this.on(event, onceListener);
                },
                
                removeAllListeners(event) {
                    if (event) {
                        events.delete(event);
                    } else {
                        events.clear();
                    }
                },
                
                listenerCount(event) {
                    return events.has(event) ? events.get(event).length : 0;
                }
            };
        }
        
        // Create finite state machine
        function createFiniteStateMachine(initialState, transitions) {
            let currentState = initialState;
            const listeners = new Set();
            
            return {
                getState() {
                    return currentState;
                },
                
                transition(event) {
                    const nextState = transitions[currentState]?.[event];
                    if (!nextState) {
                        throw new Error(`Invalid transition: ${currentState} -> ${event}`);
                    }
                    
                    const previousState = currentState;
                    currentState = nextState;
                    
                    listeners.forEach(listener => listener(currentState, previousState, event));
                },
                
                subscribe(listener) {
                    listeners.add(listener);
                    return () => listeners.delete(listener);
                },
                
                unsubscribe(listener) {
                    listeners.delete(listener);
                },
                
                canTransition(event) {
                    return Boolean(transitions[currentState]?.[event]);
                },
                
                getPossibleTransitions() {
                    return Object.keys(transitions[currentState] || {});
                }
            };
        }
        
        // Create pub/sub system
        function createPubSub() {
            const channels = new Map();
            
            return {
                subscribe(channel, callback) {
                    if (!channels.has(channel)) {
                        channels.set(channel, []);
                    }
                    channels.get(channel).push(callback);
                    
                    return () => {
                        this.unsubscribe(channel, callback);
                    };
                },
                
                unsubscribe(channel, callback) {
                    if (!channels.has(channel)) return;
                    
                    const callbacks = channels.get(channel);
                    const index = callbacks.indexOf(callback);
                    if (index > -1) {
                        callbacks.splice(index, 1);
                    }
                },
                
                publish(channel, message) {
                    if (!channels.has(channel)) return;
                    
                    const callbacks = channels.get(channel).slice();
                    for (const callback of callbacks) {
                        try {
                            callback(message);
                        } catch (error) {
                            console.error(`Error in pub/sub callback for channel "${channel}":`, error);
                        }
                    }
                },
                
                unsubscribeAll(channel) {
                    if (channel) {
                        channels.delete(channel);
                    } else {
                        channels.clear();
                    }
                }
            };
        }
        
        // Create middleware system
        function createMiddleware() {
            const middleware = [];
            
            return {
                use(fn) {
                    middleware.push(fn);
                },
                
                execute(context, done) {
                    let index = -1;
                    
                    function next(i) {
                        if (i <= index) {
                            throw new Error('next() called multiple times');
                        }
                        
                        index = i;
                        const fn = middleware[i] || done;
                        
                        if (!fn) return Promise.resolve();
                        
                        try {
                            return Promise.resolve(fn(context, next.bind(null, i + 1)));
                        } catch (error) {
                            return Promise.reject(error);
                        }
                    }
                    
                    return next(0);
                },
                
                clear() {
                    middleware.length = 0;
                },
                
                count() {
                    return middleware.length;
                }
            };
        }
        
        // Create plugin system
        function createPluginSystem() {
            const plugins = new Map();
            
            return {
                register(name, plugin) {
                    if (plugins.has(name)) {
                        throw new Error(`Plugin "${name}" already registered`);
                    }
                    plugins.set(name, plugin);
                },
                
                unregister(name) {
                    plugins.delete(name);
                },
                
                get(name) {
                    return plugins.get(name);
                },
                
                has(name) {
                    return plugins.has(name);
                },
                
                list() {
                    return Array.from(plugins.keys());
                },
                
                clear() {
                    plugins.clear();
                },
                
                execute(name, ...args) {
                    const plugin = plugins.get(name);
                    if (!plugin) {
                        throw new Error(`Plugin "${name}" not found`);
                    }
                    return plugin(...args);
                },
                
                executeAll(...args) {
                    const results = new Map();
                    for (const [name, plugin] of plugins) {
                        results.set(name, plugin(...args));
                    }
                    return results;
                }
            };
        }
        
        // Create validation system
        function createValidationSystem(rules) {
            return {
                validate(data) {
                    const errors = {};
                    
                    for (const [field, fieldRules] of Object.entries(rules)) {
                        const value = data[field];
                        
                        for (const rule of fieldRules) {
                            const { validator, message } = rule;
                            
                            if (!validator(value, data)) {
                                if (!errors[field]) {
                                    errors[field] = [];
                                }
                                errors[field].push(message);
                                break; // Stop at first error for this field
                            }
                        }
                    }
                    
                    return {
                        isValid: Object.keys(errors).length === 0,
                        errors
                    };
                },
                
                addRule(field, validator, message) {
                    if (!rules[field]) {
                        rules[field] = [];
                    }
                    rules[field].push({ validator, message });
                },
                
                removeRule(field, validator) {
                    if (!rules[field]) return;
                    
                    const index = rules[field].findIndex(rule => rule.validator === validator);
                    if (index > -1) {
                        rules[field].splice(index, 1);
                    }
                },
                
                clearRules(field) {
                    if (field) {
                        delete rules[field];
                    } else {
                        Object.keys(rules).forEach(key => delete rules[key]);
                    }
                }
            };
        }
        
        // Create formatter
        function createFormatter(formats) {
            return {
                format(type, value, options = {}) {
                    const formatter = formats[type];
                    if (!formatter) {
                        throw new Error(`Formatter for type "${type}" not found`);
                    }
                    return formatter(value, options);
                },
                
                addFormatter(type, formatter) {
                    formats[type] = formatter;
                },
                
                removeFormatter(type) {
                    delete formats[type];
                },
                
                hasFormatter(type) {
                    return Boolean(formats[type]);
                }
            };
        }
        
        // Create logger
        function createLogger(options = {}) {
            const { level = 'info', prefix = '' } = options;
            const levels = {
                error: 0,
                warn: 1,
                info: 2,
                debug: 3
            };
            
            function log(levelName, ...args) {
                if (levels[levelName] > levels[level]) return;
                
                const timestamp = new Date().toISOString();
                const message = `${prefix}${args.join(' ')}`;
                
                console.log(`[${timestamp}] [${levelName.toUpperCase()}] ${message}`);
            }
            
            return {
                error: (...args) => log('error', ...args),
                warn: (...args) => log('warn', ...args),
                info: (...args) => log('info', ...args),
                debug: (...args) => log('debug', ...args),
                
                setLevel(newLevel) {
                    if (!levels.hasOwnProperty(newLevel)) {
                        throw new Error(`Invalid log level: ${newLevel}`);
                    }
                    level = newLevel;
                },
                
                getLevel() {
                    return level;
                },
                
                setPrefix(newPrefix) {
                    prefix = newPrefix;
                },
                
                getPrefix() {
                    return prefix;
                }
            };
        }
        
        // Create profiler
        function createProfiler() {
            const measurements = new Map();
            
            return {
                start(name) {
                    measurements.set(name, {
                        start: performance.now(),
                        end: null,
                        duration: null
                    });
                },
                
                end(name) {
                    const measurement = measurements.get(name);
                    if (!measurement) {
                        throw new Error(`Measurement "${name}" not found`);
                    }
                    
                    measurement.end = performance.now();
                    measurement.duration = measurement.end - measurement.start;
                },
                
                measure(name, fn) {
                    this.start(name);
                    try {
                        const result = fn();
                        this.end(name);
                        return result;
                    } catch (error) {
                        this.end(name);
                        throw error;
                    }
                },
                
                async measureAsync(name, asyncFn) {
                    this.start(name);
                    try {
                        const result = await asyncFn();
                        this.end(name);
                        return result;
                    } catch (error) {
                        this.end(name);
                        throw error;
                    }
                },
                
                getMeasurement(name) {
                    return measurements.get(name);
                },
                
                getAllMeasurements() {
                    return Array.from(measurements.entries());
                },
                
                clear() {
                    measurements.clear();
                },
                
                print() {
                    console.table(
                        Array.from(measurements.entries()).map(([name, measurement]) => ({
                            Name: name,
                            Duration: measurement.duration ? `${measurement.duration.toFixed(2)}ms` : 'Running'
                        }))
                    );
                }
            };
        }
        
        // Create scheduler
        function createScheduler() {
            const jobs = new Map();
            let nextJobId = 1;
            
            return {
                schedule(fn, delay, ...args) {
                    const id = nextJobId++;
                    const timeoutId = setTimeout(() => {
                        fn(...args);
                        jobs.delete(id);
                    }, delay);
                    
                    jobs.set(id, timeoutId);
                    return id;
                },
                
                scheduleRecurring(fn, interval, ...args) {
                    const id = nextJobId++;
                    const intervalId = setInterval(() => fn(...args), interval);
                    
                    jobs.set(id, intervalId);
                    return id;
                },
                
                cancel(id) {
                    const job = jobs.get(id);
                    if (!job) return false;
                    
                    if (typeof job === 'number') {
                        clearTimeout(job);
                    } else {
                        clearInterval(job);
                    }
                    
                    jobs.delete(id);
                    return true;
                },
                
                cancelAll() {
                    for (const job of jobs.values()) {
                        if (typeof job === 'number') {
                            clearTimeout(job);
                        } else {
                            clearInterval(job);
                        }
                    }
                    jobs.clear();
                },
                
                hasJob(id) {
                    return jobs.has(id);
                },
                
                count() {
                    return jobs.size;
                }
            };
        }
        
        // Create worker pool
        function createWorkerPool(workerCount = navigator.hardwareConcurrency || 4) {
            const workers = [];
            const tasks = new Map();
            let nextTaskId = 1;
            
            for (let i = 0; i < workerCount; i++) {
                const worker = new Worker(URL.createObjectURL(
                    new Blob([`
                        self.onmessage = function(e) {
                            const { taskId, fn, args } = e.data;
                            try {
                                const result = eval('(' + fn + ')')(...args);
                                self.postMessage({ taskId, result });
                            } catch (error) {
                                self.postMessage({ taskId, error: error.message });
                            }
                        };
                    `], { type: 'application/javascript' })
                ));
                
                worker.onmessage = function(e) {
                    const { taskId, result, error } = e.data;
                    const { resolve, reject } = tasks.get(taskId);
                    
                    tasks.delete(taskId);
                    
                    if (error) {
                        reject(new Error(error));
                    } else {
                        resolve(result);
                    }
                };
                
                workers.push({ worker, busy: false });
            }
            
            async function executeTask(fn, args) {
                const availableWorker = workers.find(w => !w.busy);
                if (!availableWorker) {
                    throw new Error('No available workers');
                }
                
                availableWorker.busy = true;
                const taskId = nextTaskId++;
                
                try {
                    const result = await new Promise((resolve, reject) => {
                        tasks.set(taskId, { resolve, reject });
                        availableWorker.worker.postMessage({
                            taskId,
                            fn: fn.toString(),
                            args
                        });
                    });
                    
                    return result;
                } finally {
                    availableWorker.busy = false;
                }
            }
            
            return {
                execute(fn, ...args) {
                    return executeTask(fn, args);
                },
                
                async executeAll(tasks) {
                    const results = [];
                    for (const task of tasks) {
                        results.push(await this.execute(task.fn, ...task.args));
                    }
                    return results;
                },
                
                terminate() {
                    for (const { worker } of workers) {
                        worker.terminate();
                    }
                    workers.length = 0;
                    tasks.clear();
                },
                
                getWorkerCount() {
                    return workers.length;
                },
                
                getBusyWorkerCount() {
                    return workers.filter(w => w.busy).length;
                },
                
                getIdleWorkerCount() {
                    return workers.filter(w => !w.busy).length;
                }
            };
        }
        
        // Create data processor
        function createDataProcessor() {
            const processors = new Map();
            
            return {
                register(name, processor) {
                    processors.set(name, processor);
                },
                
                process(name, data, options = {}) {
                    const processor = processors.get(name);
                    if (!processor) {
                        throw new Error(`Processor "${name}" not found`);
                    }
                    return processor(data, options);
                },
                
                unregister(name) {
                    processors.delete(name);
                },
                
                has(name) {
                    return processors.has(name);
                },
                
                list() {
                    return Array.from(processors.keys());
                },
                
                clear() {
                    processors.clear();
                },
                
                pipe(data, ...processorNames) {
                    let result = data;
                    for (const name of processorNames) {
                        result = this.process(name, result);
                    }
                    return result;
                }
            };
        }
        
        // Create API client
        function createAPIClient(baseURL, options = {}) {
            const { timeout = 30000, headers = {} } = options;
            
            async function request(endpoint, config = {}) {
                const url = `${baseURL}${endpoint}`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, {
                        ...config,
                        headers: {
                            'Content-Type': 'application/json',
                            ...headers,
                            ...config.headers
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return await response.json();
                    }
                    
                    return await response.text();
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }
            
            return {
                get(endpoint, config = {}) {
                    return request(endpoint, { ...config, method: 'GET' });
                },
                
                post(endpoint, data, config = {}) {
                    return request(endpoint, {
                        ...config,
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                },
                
                put(endpoint, data, config = {}) {
                    return request(endpoint, {
                        ...config,
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                },
                
                patch(endpoint, data, config = {}) {
                    return request(endpoint, {
                        ...config,
                        method: 'PATCH',
                        body: JSON.stringify(data)
                    });
                },
                
                delete(endpoint, config = {}) {
                    return request(endpoint, { ...config, method: 'DELETE' });
                },
                
                setHeader(name, value) {
                    headers[name] = value;
                },
                
                removeHeader(name) {
                    delete headers[name];
                },
                
                setBaseURL(newBaseURL) {
                    baseURL = newBaseURL;
                },
                
                setTimeout(newTimeout) {
                    timeout = newTimeout;
                }
            };
        }
        
        // Create storage
        function createStorage(storage = localStorage) {
            return {
                set(key, value) {
                    try {
                        storage.setItem(key, JSON.stringify(value));
                    } catch (error) {
                        console.error('Error saving to storage:', error);
                    }
                },
                
                get(key, defaultValue = null) {
                    try {
                        const value = storage.getItem(key);
                        return value ? JSON.parse(value) : defaultValue;
                    } catch (error) {
                        console.error('Error reading from storage:', error);
                        return defaultValue;
                    }
                },
                
                remove(key) {
                    storage.removeItem(key);
                },
                
                clear() {
                    storage.clear();
                },
                
                has(key) {
                    return storage.getItem(key) !== null;
                },
                
                keys() {
                    return Object.keys(storage);
                },
                
                size() {
                    return storage.length;
                }
            };
        }
        
        // Create cookie manager
        function createCookieManager() {
            return {
                set(name, value, options = {}) {
                    const { expires, path = '/', domain, secure, sameSite = 'Lax' } = options;
                    
                    let cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}`;
                    
                    if (expires) {
                        if (typeof expires === 'number') {
                            const date = new Date();
                            date.setTime(date.getTime() + (expires * 24 * 60 * 60 * 1000));
                            cookie += `; expires=${date.toUTCString()}`;
                        } else {
                            cookie += `; expires=${expires.toUTCString()}`;
                        }
                    }
                    
                    if (path) cookie += `; path=${path}`;
                    if (domain) cookie += `; domain=${domain}`;
                    if (secure) cookie += `; secure`;
                    if (sameSite) cookie += `; sameSite=${sameSite}`;
                    
                    document.cookie = cookie;
                },
                
                get(name) {
                    const cookies = document.cookie.split('; ');
                    for (const cookie of cookies) {
                        const [cookieName, cookieValue] = cookie.split('=');
                        if (decodeURIComponent(cookieName) === name) {
                            return decodeURIComponent(cookieValue);
                        }
                    }
                    return null;
                },
                
                remove(name, options = {}) {
                    this.set(name, '', { ...options, expires: new Date(0) });
                },
                
                getAll() {
                    const cookies = {};
                    document.cookie.split('; ').forEach(cookie => {
                        const [name, value] = cookie.split('=');
                        cookies[decodeURIComponent(name)] = decodeURIComponent(value);
                    });
                    return cookies;
                },
                
                has(name) {
                    return this.get(name) !== null;
                }
            };
        }
        
        // Create session manager
        function createSessionManager() {
            const storage = createStorage(sessionStorage);
            
            return {
                ...storage,
                setSession(data) {
                    this.set('session', data);
                },
                
                getSession() {
                    return this.get('session');
                },
                
                clearSession() {
                    this.remove('session');
                },
                
                isAuthenticated() {
                    const session = this.getSession();
                    return session && session.user && !this.isExpired();
                },
                
                isExpired() {
                    const session = this.getSession();
                    if (!session || !session.expires) return true;
                    
                    return new Date(session.expires) < new Date();
                },
                
                setExpiry(seconds) {
                    const session = this.getSession();
                    if (session) {
                        const expires = new Date();
                        expires.setSeconds(expires.getSeconds() + seconds);
                        session.expires = expires.toISOString();
                        this.setSession(session);
                    }
                }
            };
        }
        
        // Create authentication manager
        function createAuthManager() {
            const session = createSessionManager();
            const listeners = new Set();
            
            return {
                login(userData) {
                    session.setSession({
                        user: userData,
                        loggedInAt: new Date().toISOString()
                    });
                    
                    listeners.forEach(listener => listener('login', userData));
                },
                
                logout() {
                    const user = session.getSession()?.user;
                    session.clearSession();
                    
                    listeners.forEach(listener => listener('logout', user));
                },
                
                getCurrentUser() {
                    return session.getSession()?.user;
                },
                
                isLoggedIn() {
                    return session.isAuthenticated();
                },
                
                subscribe(listener) {
                    listeners.add(listener);
                    return () => listeners.delete(listener);
                },
                
                unsubscribe(listener) {
                    listeners.delete(listener);
                }
            };
        }
        
        // Create permission manager
        function createPermissionManager() {
            const permissions = new Set();
            const roles = new Map();
            
            return {
                addPermission(permission) {
                    permissions.add(permission);
                },
                
                removePermission(permission) {
                    permissions.delete(permission);
                },
                
                hasPermission(permission) {
                    return permissions.has(permission);
                },
                
                addRole(role, rolePermissions) {
                    roles.set(role, new Set(rolePermissions));
                },
                
                removeRole(role) {
                    roles.delete(role);
                },
                
                hasRole(role) {
                    return roles.has(role);
                },
                
                getRolePermissions(role) {
                    return roles.get(role) || new Set();
                },
                
                checkUserPermissions(user, requiredPermissions) {
                    const userPermissions = new Set();
                    
                    // Add direct permissions
                    if (user.permissions) {
                        user.permissions.forEach(permission => userPermissions.add(permission));
                    }
                    
                    // Add role permissions
                    if (user.roles) {
                        user.roles.forEach(role => {
                            const rolePermissions = this.getRolePermissions(role);
                            rolePermissions.forEach(permission => userPermissions.add(permission));
                        });
                    }
                    
                    // Check if user has all required permissions
                    return requiredPermissions.every(permission => 
                        userPermissions.has(permission)
                    );
                },
                
                clear() {
                    permissions.clear();
                    roles.clear();
                }
            };
        }
        
        // Create rate limiter
        function createRateLimiter(limit, windowMs) {
            const requests = new Map();
            
            return {
                check(key) {
                    const now = Date.now();
                    const windowStart = now - windowMs;
                    
                    // Clean up old requests
                    if (requests.has(key)) {
                        const timestamps = requests.get(key).filter(timestamp => timestamp > windowStart);
                        if (timestamps.length === 0) {
                            requests.delete(key);
                        } else {
                            requests.set(key, timestamps);
                        }
                    }
                    
                    // Get current requests for this key
                    const timestamps = requests.get(key) || [];
                    
                    // Check if limit is exceeded
                    if (timestamps.length >= limit) {
                        return {
                            allowed: false,
                            remaining: 0,
                            reset: Math.ceil((timestamps[0] + windowMs - now) / 1000)
                        };
                    }
                    
                    // Add new request
                    timestamps.push(now);
                    requests.set(key, timestamps);
                    
                    return {
                        allowed: true,
                        remaining: limit - timestamps.length,
                        reset: Math.ceil(windowMs / 1000)
                    };
                },
                
                clear() {
                    requests.clear();
                },
                
                getRequests(key) {
                    return requests.get(key) || [];
                }
            };
        }
        
        // Create feature flag manager
        function createFeatureFlagManager() {
            const flags = new Map();
            const listeners = new Map();
            
            return {
                setFlag(name, enabled) {
                    const oldValue = flags.get(name);
                    flags.set(name, enabled);
                    
                    if (listeners.has(name)) {
                        listeners.get(name).forEach(listener => listener(enabled, oldValue));
                    }
                },
                
                getFlag(name, defaultValue = false) {
                    return flags.get(name) ?? defaultValue;
                },
                
                removeFlag(name) {
                    flags.delete(name);
                },
                
                isEnabled(name) {
                    return this.getFlag(name);
                },
                
                subscribe(name, listener) {
                    if (!listeners.has(name)) {
                        listeners.set(name, []);
                    }
                    listeners.get(name).push(listener);
                    
                    return () => {
                        const callbacks = listeners.get(name);
                        const index = callbacks.indexOf(listener);
                        if (index > -1) {
                            callbacks.splice(index, 1);
                        }
                    };
                },
                
                unsubscribe(name, listener) {
                    if (!listeners.has(name)) return;
                    
                    const callbacks = listeners.get(name);
                    const index = callbacks.indexOf(listener);
                    if (index > -1) {
                        callbacks.splice(index, 1);
                    }
                },
                
                clear() {
                    flags.clear();
                    listeners.clear();
                }
            };
        }
        
        // Create configuration manager
        function createConfigManager(defaultConfig = {}) {
            let config = { ...defaultConfig };
            const listeners = new Set();
            
            return {
                get(key, defaultValue) {
                    if (key === undefined) {
                        return { ...config };
                    }
                    
                    const keys = key.split('.');
                    let value = config;
                    
                    for (const k of keys) {
                        if (value && typeof value === 'object' && k in value) {
                            value = value[k];
                        } else {
                            return defaultValue;
                        }
                    }
                    
                    return value;
                },
                
                set(key, value) {
                    const keys = key.split('.');
                    let current = config;
                    
                    for (let i = 0; i < keys.length - 1; i++) {
                        const k = keys[i];
                        if (!current[k] || typeof current[k] !== 'object') {
                            current[k] = {};
                        }
                        current = current[k];
                    }
                    
                    const lastKey = keys[keys.length - 1];
                    const oldValue = current[lastKey];
                    current[lastKey] = value;
                    
                    listeners.forEach(listener => listener(key, value, oldValue));
                },
                
                delete(key) {
                    const keys = key.split('.');
                    let current = config;
                    
                    for (let i = 0; i < keys.length - 1; i++) {
                        const k = keys[i];
                        if (!current[k] || typeof current[k] !== 'object') {
                            return false;
                        }
                        current = current[k];
                    }
                    
                    const lastKey = keys[keys.length - 1];
                    if (lastKey in current) {
                        const oldValue = current[lastKey];
                        delete current[lastKey];
                        
                        listeners.forEach(listener => listener(key, undefined, oldValue));
                        return true;
                    }
                    
                    return false;
                },
                
                subscribe(listener) {
                    listeners.add(listener);
                    return () => listeners.delete(listener);
                },
                
                unsubscribe(listener) {
                    listeners.delete(listener);
                },
                
                reset() {
                    const oldConfig = config;
                    config = { ...defaultConfig };
                    
                    Object.keys(oldConfig).forEach(key => {
                        listeners.forEach(listener => listener(key, config[key], oldConfig[key]));
                    });
                },
                
                merge(newConfig) {
                    const oldConfig = { ...config };
                    config = { ...config, ...newConfig };
                    
                    Object.keys(newConfig).forEach(key => {
                        listeners.forEach(listener => listener(key, config[key], oldConfig[key]));
                    });
                }
            };
        }
        
        // Create error handler
        function createErrorHandler(options = {}) {
            const { 
                onError = console.error,
                shouldRethrow = false,
                shouldLog = true
            } = options;
            
            return {
                handle(error, context = {}) {
                    const errorInfo = {
                        error: error.message || String(error),
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        context
                    };
                    
                    if (shouldLog) {
                        onError(errorInfo);
                    }
                    
                    if (shouldRethrow) {
                        throw error;
                    }
                    
                    return errorInfo;
                },
                
                wrap(fn, context = {}) {
                    return async function(...args) {
                        try {
                            return await fn(...args);
                        } catch (error) {
                            return this.handle(error, { ...context, function: fn.name });
                        }
                    }.bind(this);
                },
                
                createMiddleware() {
                    return async (ctx, next) => {
                        try {
                            await next();
                        } catch (error) {
                            this.handle(error, { context: ctx });
                        }
                    };
                }
            };
        }
        
        // Create performance monitor
        function createPerformanceMonitor() {
            const metrics = {
                startTime: Date.now(),
                pageLoadTime: null,
                domReadyTime: null,
                resources: [],
                navigation: []
            };
            
            function measurePageLoad() {
                window.addEventListener('load', () => {
                    metrics.pageLoadTime = Date.now() - metrics.startTime;
                });
            }
            
            function measureDOMReady() {
                document.addEventListener('DOMContentLoaded', () => {
                    metrics.domReadyTime = Date.now() - metrics.startTime;
                });
            }
            
            function measureResources() {
                if ('PerformanceObserver' in window) {
                    const observer = new PerformanceObserver((list) => {
                        for (const entry of list.getEntries()) {
                            metrics.resources.push({
                                name: entry.name,
                                duration: entry.duration,
                                type: entry.initiatorType,
                                size: entry.transferSize
                            });
                        }
                    });
                    
                    observer.observe({ entryTypes: ['resource'] });
                }
            }
            
            function measureNavigation() {
                if ('PerformanceObserver' in window) {
                    const observer = new PerformanceObserver((list) => {
                        for (const entry of list.getEntries()) {
                            metrics.navigation.push({
                                type: entry.type,
                                duration: entry.duration,
                                startTime: entry.startTime
                            });
                        }
                    });
                    
                    observer.observe({ entryTypes: ['navigation'] });
                }
            }
            
            measurePageLoad();
            measureDOMReady();
            measureResources();
            measureNavigation();
            
            return {
                getMetrics() {
                    return {
                        ...metrics,
                        currentTime: Date.now(),
                        uptime: Date.now() - metrics.startTime
                    };
                },
                
                getAverageResourceLoadTime() {
                    if (metrics.resources.length === 0) return 0;
                    
                    const total = metrics.resources.reduce((sum, resource) => sum + resource.duration, 0);
                    return total / metrics.resources.length;
                },
                
                getSlowestResource() {
                    if (metrics.resources.length === 0) return null;
                    
                    return metrics.resources.reduce((slowest, resource) => {
                        return resource.duration > slowest.duration ? resource : slowest;
                    });
                },
                
                clear() {
                    metrics.resources = [];
                    metrics.navigation = [];
                }
            };
        }
        
        // Create analytics tracker
        function createAnalyticsTracker(options = {}) {
            const { 
                enabled = true,
                endpoint = '/api/analytics',
                autoTrack = true
            } = options;
            
            const events = [];
            
            function track(event, data = {}) {
                if (!enabled) return;
                
                const eventData = {
                    event,
                    data,
                    timestamp: new Date().toISOString(),
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    screen: {
                        width: window.screen.width,
                        height: window.screen.height
                    }
                };
                
                events.push(eventData);
                
                // Send to endpoint if configured
                if (endpoint) {
                    fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(eventData)
                    }).catch(error => {
                        console.error('Analytics tracking failed:', error);
                    });
                }
                
                return eventData;
            }
            
            function autoTrackEvents() {
                if (!autoTrack) return;
                
                // Track page views
                track('pageview');
                
                // Track clicks
                document.addEventListener('click', (event) => {
                    const target = event.target;
                    const text = target.textContent?.trim();
                    const id = target.id;
                    const className = target.className;
                    
                    if (text || id || className) {
                        track('click', {
                            text,
                            id,
                            className,
                            tagName: target.tagName
                        });
                    }
                }, { capture: true });
                
                // Track form submissions
                document.addEventListener('submit', (event) => {
                    const form = event.target;
                    track('form_submit', {
                        formId: form.id,
                        formClass: form.className,
                        action: form.action,
                        method: form.method
                    });
                });
            }
            
            autoTrackEvents();
            
            return {
                track,
                trackPageView() {
                    return track('pageview');
                },
                trackEvent(name, data = {}) {
                    return track('event', { name, ...data });
                },
                trackError(error, context = {}) {
                    return track('error', {
                        message: error.message,
                        stack: error.stack,
                        ...context
                    });
                },
                getEvents() {
                    return [...events];
                },
                clearEvents() {
                    events.length = 0;
                },
                enable() {
                    enabled = true;
                },
                disable() {
                    enabled = false;
                },
                setEndpoint(newEndpoint) {
                    endpoint = newEndpoint;
                }
            };
        }
        
        // Create internationalization (i18n) system
        function createI18n(translations = {}) {
            let currentLocale = 'en';
            let fallbackLocale = 'en';
            const listeners = new Set();
            
            function t(key, params = {}) {
                let translation = translations[currentLocale]?.[key] || 
                                translations[fallbackLocale]?.[key] || 
                                key;
                
                // Replace parameters
                Object.entries(params).forEach(([param, value]) => {
                    translation = translation.replace(`{{${param}}}`, value);
                });
                
                return translation;
            }
            
            return {
                t,
                setLocale(locale) {
                    const oldLocale = currentLocale;
                    currentLocale = locale;
                    
                    listeners.forEach(listener => listener(locale, oldLocale));
                },
                getLocale() {
                    return currentLocale;
                },
                setFallbackLocale(locale) {
                    fallbackLocale = locale;
                },
                addTranslations(locale, newTranslations) {
                    if (!translations[locale]) {
                        translations[locale] = {};
                    }
                    Object.assign(translations[locale], newTranslations);
                },
                subscribe(listener) {
                    listeners.add(listener);
                    return () => listeners.delete(listener);
                },
                unsubscribe(listener) {
                    listeners.delete(listener);
                },
                getSupportedLocales() {
                    return Object.keys(translations);
                }
            };
        }
        
        // Create accessibility manager
        function createAccessibilityManager() {
            let fontSize = 100; // percentage
            let highContrast = false;
            let reducedMotion = false;
            const listeners = new Set();
            
            function updateFontSize() {
                document.documentElement.style.fontSize = `${fontSize}%`;
            }
            
            function updateHighContrast() {
                if (highContrast) {
                    document.body.classList.add('high-contrast');
                } else {
                    document.body.classList.remove('high-contrast');
                }
            }
            
            function updateReducedMotion() {
                if (reducedMotion) {
                    document.body.classList.add('reduced-motion');
                } else {
                    document.body.classList.remove('reduced-motion');
                }
            }
            
            function notifyListeners() {
                listeners.forEach(listener => listener({
                    fontSize,
                    highContrast,
                    reducedMotion
                }));
            }
            
            return {
                increaseFontSize() {
                    fontSize = Math.min(fontSize + 10, 200);
                    updateFontSize();
                    notifyListeners();
                },
                decreaseFontSize() {
                    fontSize = Math.max(fontSize - 10, 50);
                    updateFontSize();
                    notifyListeners();
                },
                resetFontSize() {
                    fontSize = 100;
                    updateFontSize();
                    notifyListeners();
                },
                toggleHighContrast() {
                    highContrast = !highContrast;
                    updateHighContrast();
                    notifyListeners();
                },
                toggleReducedMotion() {
                    reducedMotion = !reducedMotion;
                    updateReducedMotion();
                    notifyListeners();
                },
                getSettings() {
                    return {
                        fontSize,
                        highContrast,
                        reducedMotion
                    };
                },
                subscribe(listener) {
                    listeners.add(listener);
                    return () => listeners.delete(listener);
                },
                unsubscribe(listener) {
                    listeners.delete(listener);
                },
                init() {
                    updateFontSize();
                    updateHighContrast();
                    updateReducedMotion();
                }
            };
        }
        
        // Create theme manager
        function createThemeManager() {
            let theme = 'light';
            const themes = new Set(['light', 'dark']);
            const listeners = new Set();
            
            function applyTheme() {
                document.documentElement.setAttribute('data-theme', theme);
                document.documentElement.classList.remove('light-theme', 'dark-theme');
                document.documentElement.classList.add(`${theme}-theme`);
            }
            
            return {
                setTheme(newTheme) {
                    if (!themes.has(newTheme)) {
                        throw new Error(`Theme "${newTheme}" not supported`);
                    }
                    
                    const oldTheme = theme;
                    theme = newTheme;
                    applyTheme();
                    
                    listeners.forEach(listener => listener(theme, oldTheme));
                },
                getTheme() {
                    return theme;
                },
                toggleTheme() {
                    this.setTheme(theme === 'light' ? 'dark' : 'light');
                },
                addTheme(newTheme) {
                    themes.add(newTheme);
                },
                getAvailableThemes() {
                    return Array.from(themes);
                },
                subscribe(listener) {
                    listeners.add(listener);
                    return () => listeners.delete(listener);
                },
                unsubscribe(listener) {
                    listeners.delete(listener);
                },
                init() {
                    // Check for saved theme or system preference
                    const savedTheme = localStorage.getItem('theme');
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    
                    if (savedTheme && themes.has(savedTheme)) {
                        this.setTheme(savedTheme);
                    } else if (systemPrefersDark) {
                        this.setTheme('dark');
                    } else {
                        this.setTheme('light');
                    }
                    
                    // Save theme changes
                    this.subscribe((newTheme) => {
                        localStorage.setItem('theme', newTheme);
                    });
                }
            };
        }
        
        // Create animation manager
        function createAnimationManager() {
            const animations = new Map();
            
            return {
                animate(element, keyframes, options = {}) {
                    const animation = element.animate(keyframes, options);
                    
                    animations.set(element, animation);
                    
                    animation.finished.then(() => {
                        animations.delete(element);
                    }).catch(() => {
                        animations.delete(element);
                    });
                    
                    return animation;
                },
                stop(element) {
                    const animation = animations.get(element);
                    if (animation) {
                        animation.cancel();
                        animations.delete(element);
                    }
                },
                stopAll() {
                    animations.forEach(animation => animation.cancel());
                    animations.clear();
                },
                pause(element) {
                    const animation = animations.get(element);
                    if (animation) {
                        animation.pause();
                    }
                },
                resume(element) {
                    const animation = animations.get(element);
                    if (animation) {
                        animation.play();
                    }
                },
                isAnimating(element) {
                    return animations.has(element);
                },
                getAnimation(element) {
                    return animations.get(element);
                }
            };
        }
        
        // Create drag and drop manager
        function createDragDropManager() {
            let dragSource = null;
            let dropTarget = null;
            const listeners = {
                dragstart: new Set(),
                dragend: new Set(),
                dragover: new Set(),
                dragenter: new Set(),
                dragleave: new Set(),
                drop: new Set()
            };
            
            function handleDragStart(event) {
                dragSource = event.target;
                listeners.dragstart.forEach(listener => listener(event, dragSource));
            }
            
            function handleDragEnd(event) {
                listeners.dragend.forEach(listener => listener(event, dragSource, dropTarget));
                dragSource = null;
                dropTarget = null;
            }
            
            function handleDragOver(event) {
                event.preventDefault();
                listeners.dragover.forEach(listener => listener(event, dragSource));
            }
            
            function handleDragEnter(event) {
                dropTarget = event.target;
                listeners.dragenter.forEach(listener => listener(event, dragSource, dropTarget));
            }
            
            function handleDragLeave(event) {
                listeners.dragleave.forEach(listener => listener(event, dragSource, dropTarget));
                dropTarget = null;
            }
            
            function handleDrop(event) {
                event.preventDefault();
                listeners.drop.forEach(listener => listener(event, dragSource, dropTarget));
                dragSource = null;
                dropTarget = null;
            }
            
            return {
                enable(element) {
                    element.setAttribute('draggable', 'true');
                    element.addEventListener('dragstart', handleDragStart);
                    element.addEventListener('dragend', handleDragEnd);
                    element.addEventListener('dragover', handleDragOver);
                    element.addEventListener('dragenter', handleDragEnter);
                    element.addEventListener('dragleave', handleDragLeave);
                    element.addEventListener('drop', handleDrop);
                },
                disable(element) {
                    element.removeAttribute('draggable');
                    element.removeEventListener('dragstart', handleDragStart);
                    element.removeEventListener('dragend', handleDragEnd);
                    element.removeEventListener('dragover', handleDragOver);
                    element.removeEventListener('dragenter', handleDragEnter);
                    element.removeEventListener('dragleave', handleDragLeave);
                    element.removeEventListener('drop', handleDrop);
                },
                on(event, listener) {
                    if (listeners[event]) {
                        listeners[event].add(listener);
                    }
                },
                off(event, listener) {
                    if (listeners[event]) {
                        listeners[event].delete(listener);
                    }
                },
                getDragSource() {
                    return dragSource;
                },
                getDropTarget() {
                    return dropTarget;
                }
            };
        }
        
        // Create clipboard manager
        function createClipboardManager() {
            return {
                async copy(text) {
                    try {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } catch (error) {
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        
                        try {
                            const successful = document.execCommand('copy');
                            document.body.removeChild(textarea);
                            return successful;
                        } catch (err) {
                            document.body.removeChild(textarea);
                            return false;
                        }
                    }
                },
                async paste() {
                    try {
                        const text = await navigator.clipboard.readText();
                        return text;
                    } catch (error) {
                        console.error('Failed to paste:', error);
                        return '';
                    }
                },
                async read() {
                    try {
                        const items = await navigator.clipboard.read();
                        const results = [];
                        
                        for (const item of items) {
                            for (const type of item.types) {
                                const blob = await item.getType(type);
                                results.push({
                                    type,
                                    blob,
                                    text: type.startsWith('text/') ? await blob.text() : null
                                });
                            }
                        }
                        
                        return results;
                    } catch (error) {
                        console.error('Failed to read clipboard:', error);
                        return [];
                    }
                },
                write(items) {
                    try {
                        return navigator.clipboard.write(items);
                    } catch (error) {
                        console.error('Failed to write to clipboard:', error);
                        return Promise.reject(error);
                    }
                }
            };
        }
        
        // Create file manager
        function createFileManager() {
            return {
                readAsText(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsText(file);
                    });
                },
                readAsDataURL(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsDataURL(file);
                    });
                },
                readAsArrayBuffer(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsArrayBuffer(file);
                    });
                },
                download(content, filename, type = 'text/plain') {
                    const blob = new Blob([content], { type });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                },
                parseCSV(text, delimiter = ',') {
                    const lines = text.split('\n');
                    const headers = lines[0].split(delimiter);
                    const data = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        const values = lines[i].split(delimiter);
                        const row = {};
                        
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index]?.trim() || '';
                        });
                        
                        data.push(row);
                    }
                    
                    return data;
                },
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                isValidFileType(file, allowedTypes) {
                    if (!allowedTypes || allowedTypes.length === 0) return true;
                    
                    const fileType = file.type;
                    const fileName = file.name;
                    
                    return allowedTypes.some(type => {
                        if (type.startsWith('.')) {
                            // Check file extension
                            return fileName.toLowerCase().endsWith(type.toLowerCase());
                        } else {
                            // Check MIME type
                            return fileType === type || 
                                  (type.endsWith('/*') && fileType.startsWith(type.slice(0, -2)));
                        }
                    });
                },
                isFileSizeValid(file, maxSizeBytes) {
                    return file.size <= maxSizeBytes;
                }
            };
        }
        
        // Create image processor
        function createImageProcessor() {
            return {
                resize(image, maxWidth, maxHeight) {
                    return new Promise((resolve) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = image.width;
                        let height = image.height;
                        
                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.drawImage(image, 0, 0, width, height);
                        
                        canvas.toBlob(resolve, image.type || 'image/jpeg', 0.9);
                    });
                },
                compress(image, quality = 0.8) {
                    return new Promise((resolve) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = image.width;
                        canvas.height = image.height;
                        
                        ctx.drawImage(image, 0, 0);
                        
                        canvas.toBlob(resolve, image.type || 'image/jpeg', quality);
                    });
                },
                crop(image, x, y, width, height) {
                    return new Promise((resolve) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.drawImage(image, x, y, width, height, 0, 0, width, height);
                        
                        canvas.toBlob(resolve, image.type || 'image/jpeg', 0.9);
                    });
                },
                convertToBase64(image) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsDataURL(image);
                    });
                },
                loadImage(src) {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = () => reject(new Error('Failed to load image'));
                        img.src = src;
                    });
                }
            };
        }
        
        // Create video processor
        function createVideoProcessor() {
            return {
                getVideoInfo(file) {
                    return new Promise((resolve, reject) => {
                        const video = document.createElement('video');
                        video.preload = 'metadata';
                        
                        video.onloadedmetadata = () => {
                            resolve({
                                duration: video.duration,
                                width: video.videoWidth,
                                height: video.videoHeight,
                                size: file.size,
                                type: file.type
                            });
                        };
                        
                        video.onerror = () => {
                            reject(new Error('Failed to load video metadata'));
                        };
                        
                        video.src = URL.createObjectURL(file);
                    });
                },
                takeThumbnail(videoFile, time = 0) {
                    return new Promise((resolve, reject) => {
                        const video = document.createElement('video');
                        video.preload = 'metadata';
                        
                        video.onseeked = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            
                            canvas.toBlob(resolve, 'image/jpeg', 0.9);
                            URL.revokeObjectURL(video.src);
                        };
                        
                        video.onerror = () => {
                            reject(new Error('Failed to take video thumbnail'));
                            URL.revokeObjectURL(video.src);
                        };
                        
                        video.src = URL.createObjectURL(videoFile);
                        video.currentTime = time;
                    });
                },
                compress(videoFile, options = {}) {
                    // Note: This is a simplified version. Real video compression
                    // would require more complex implementation with WebCodecs or FFmpeg
                    return Promise.resolve(videoFile);
                }
            };
        }
        
        // Create audio processor
        function createAudioProcessor() {
            return {
                getAudioInfo(file) {
                    return new Promise((resolve, reject) => {
                        const audio = document.createElement('audio');
                        audio.preload = 'metadata';
                        
                        audio.onloadedmetadata = () => {
                            resolve({
                                duration: audio.duration,
                                size: file.size,
                                type: file.type
                            });
                        };
                        
                        audio.onerror = () => {
                            reject(new Error('Failed to load audio metadata'));
                        };
                        
                        audio.src = URL.createObjectURL(file);
                    });
                },
                convertToBase64(audioFile) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsDataURL(audioFile);
                    });
                },
                compress(audioFile, quality = 0.8) {
                    // Note: This is a simplified version. Real audio compression
                    // would require more complex implementation
                    return Promise.resolve(audioFile);
                }
            };
        }
        
        // Create document processor
        function createDocumentProcessor() {
            return {
                readPDF(file) {
                    // Note: PDF reading would require a library like pdf.js
                    return Promise.resolve({
                        pages: 0,
                        text: '',
                        metadata: {}
                    });
                },
                readExcel(file) {
                    // Note: Excel reading would require a library like SheetJS
                    return Promise.resolve([]);
                },
                readWord(file) {
                    // Note: Word document reading would require a specialized library
                    return Promise.resolve('');
                },
                convertToPDF(content, filename) {
                    // Note: PDF generation would require a library like jsPDF
                    return Promise.resolve(new Blob([content], { type: 'application/pdf' }));
                }
            };
        }
        
        // Create QR code generator
        function createQRCodeGenerator() {
            return {
                generate(text, options = {}) {
                    const {
                        width = 256,
                        height = 256,
                        color = '#000000',
                        backgroundColor = '#ffffff',
                        margin = 10
                    } = options;
                    
                    // Note: In a real implementation, you would use a QR code library
                    // This is a placeholder that creates a simple visual representation
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Draw placeholder QR code (simple pattern)
                    ctx.fillStyle = color;
                    
                    // Draw squares in a grid pattern
                    const size = 10;
                    const cols = Math.floor((width - margin * 2) / size);
                    const rows = Math.floor((height - margin * 2) / size);
                    
                    for (let row = 0; row < rows; row++) {
                        for (let col = 0; col < cols; col++) {
                            // Simple pattern based on text hash
                            const hash = this._hash(text + row + col);
                            if (hash % 3 === 0) {
                                const x = margin + col * size;
                                const y = margin + row * size;
                                ctx.fillRect(x, y, size - 1, size - 1);
                            }
                        }
                    }
                    
                    return canvas.toDataURL('image/png');
                },
                
                _hash(str) {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        hash = ((hash << 5) - hash) + str.charCodeAt(i);
                        hash |= 0;
                    }
                    return Math.abs(hash);
                },
                
                parseFromImage(image) {
                    // Note: QR code parsing would require a library
                    return Promise.resolve('');
                }
            };
        }
        
        // Create barcode generator
        function createBarcodeGenerator() {
            return {
                generate(type, data, options = {}) {
                    const {
                        width = 300,
                        height = 100,
                        color = '#000000',
                        backgroundColor = '#ffffff'
                    } = options;
                    
                    // Note: In a real implementation, you would use a barcode library
                    // This is a placeholder that creates a simple visual representation
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Draw placeholder barcode (simple bars)
                    ctx.fillStyle = color;
                    
                    const barWidth = 3;
                    const barHeight = height * 0.7;
                    const startY = (height - barHeight) / 2;
                    
                    // Create pattern based on data hash
                    const hash = this._hash(data);
                    const bars = (hash % 30) + 20;
                    
                    for (let i = 0; i < bars; i++) {
                        const x = (width / bars) * i;
                        const barWidth = (hash % (i + 1)) % 4 + 1;
                        ctx.fillRect(x, startY, barWidth, barHeight);
                    }
                    
                    // Add data text at bottom
                    ctx.fillStyle = color;
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(data, width / 2, height - 5);
                    
                    return canvas.toDataURL('image/png');
                },
                
                _hash(str) {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        hash = ((hash << 5) - hash) + str.charCodeAt(i);
                        hash |= 0;
                    }
                    return Math.abs(hash);
                },
                
                parseFromImage(image) {
                    // Note: Barcode parsing would require a library
                    return Promise.resolve('');
                }
            };
        }
        
        // Create chart generator
        function createChartGenerator() {
            return {
                createBarChart(data, options = {}) {
                    const {
                        width = 400,
                        height = 300,
                        backgroundColor = '#ffffff',
                        barColor = '#3b82f6'
                    } = options;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Calculate chart dimensions
                    const margin = { top: 20, right: 20, bottom: 40, left: 40 };
                    const chartWidth = width - margin.left - margin.right;
                    const chartHeight = height - margin.top - margin.bottom;
                    
                    // Find max value for scaling
                    const maxValue = Math.max(...data.map(d => d.value));
                    const scale = chartHeight / maxValue;
                    
                    // Draw bars
                    const barWidth = chartWidth / data.length * 0.8;
                    const barSpacing = chartWidth / data.length * 0.2;
                    
                    ctx.fillStyle = barColor;
                    
                    data.forEach((item, index) => {
                        const x = margin.left + index * (barWidth + barSpacing) + barSpacing / 2;
                        const barHeight = item.value * scale;
                        const y = margin.top + chartHeight - barHeight;
                        
                        ctx.fillRect(x, y, barWidth, barHeight);
                        
                        // Draw label
                        ctx.fillStyle = '#666666';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(item.label, x + barWidth / 2, margin.top + chartHeight + 20);
                        
                        // Draw value
                        ctx.fillStyle = '#333333';
                        ctx.fillText(item.value.toString(), x + barWidth / 2, y - 5);
                        
                        ctx.fillStyle = barColor;
                    });
                    
                    // Draw axes
                    ctx.strokeStyle = '#cccccc';
                    ctx.lineWidth = 1;
                    
                    // Y-axis
                    ctx.beginPath();
                    ctx.moveTo(margin.left, margin.top);
                    ctx.lineTo(margin.left, margin.top + chartHeight);
                    ctx.stroke();
                    
                    // X-axis
                    ctx.beginPath();
                    ctx.moveTo(margin.left, margin.top + chartHeight);
                    ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
                    ctx.stroke();
                    
                    return canvas.toDataURL('image/png');
                },
                
                createLineChart(data, options = {}) {
                    const {
                        width = 400,
                        height = 300,
                        backgroundColor = '#ffffff',
                        lineColor = '#3b82f6',
                        fill = true
                    } = options;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Calculate chart dimensions
                    const margin = { top: 20, right: 20, bottom: 40, left: 40 };
                    const chartWidth = width - margin.left - margin.right;
                    const chartHeight = height - margin.top - margin.bottom;
                    
                    // Find max value for scaling
                    const maxValue = Math.max(...data.map(d => d.value));
                    const scale = chartHeight / maxValue;
                    
                    // Calculate points
                    const points = data.map((item, index) => {
                        const x = margin.left + (index / (data.length - 1)) * chartWidth;
                        const y = margin.top + chartHeight - (item.value * scale);
                        return { x, y };
                    });
                    
                    // Draw filled area
                    if (fill) {
                        ctx.fillStyle = lineColor + '20';
                        ctx.beginPath();
                        ctx.moveTo(points[0].x, margin.top + chartHeight);
                        points.forEach(point => ctx.lineTo(point.x, point.y));
                        ctx.lineTo(points[points.length - 1].x, margin.top + chartHeight);
                        ctx.closePath();
                        ctx.fill();
                    }
                    
                    // Draw line
                    ctx.strokeStyle = lineColor;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    points.forEach((point, index) => {
                        if (index === 0) {
                            ctx.moveTo(point.x, point.y);
                        } else {
                            ctx.lineTo(point.x, point.y);
                        }
                    });
                    ctx.stroke();
                    
                    // Draw points
                    ctx.fillStyle = lineColor;
                    points.forEach(point => {
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 4, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    
                    // Draw labels
                    ctx.fillStyle = '#666666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    
                    data.forEach((item, index) => {
                        const x = margin.left + (index / (data.length - 1)) * chartWidth;
                        ctx.fillText(item.label, x, margin.top + chartHeight + 20);
                    });
                    
                    return canvas.toDataURL('image/png');
                },
                
                createPieChart(data, options = {}) {
                    const {
                        width = 300,
                        height = 300,
                        backgroundColor = '#ffffff'
                    } = options;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Calculate total
                    const total = data.reduce((sum, item) => sum + item.value, 0);
                    
                    // Draw pie chart
                    const centerX = width / 2;
                    const centerY = height / 2;
                    const radius = Math.min(width, height) * 0.4;
                    
                    let startAngle = 0;
                    
                    data.forEach((item, index) => {
                        const sliceAngle = (item.value / total) * 2 * Math.PI;
                        const endAngle = startAngle + sliceAngle;
                        
                        // Draw slice
                        ctx.fillStyle = this._getColor(index);
                        ctx.beginPath();
                        ctx.moveTo(centerX, centerY);
                        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                        ctx.closePath();
                        ctx.fill();
                        
                        // Draw label
                        const labelAngle = startAngle + sliceAngle / 2;
                        const labelRadius = radius * 1.2;
                        const labelX = centerX + Math.cos(labelAngle) * labelRadius;
                        const labelY = centerY + Math.sin(labelAngle) * labelRadius;
                        
                        ctx.fillStyle = '#333333';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(item.label, labelX, labelY);
                        
                        startAngle = endAngle;
                    });
                    
                    return canvas.toDataURL('image/png');
                },
                
                _getColor(index) {
                    const colors = [
                        '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                        '#8b5cf6', '#ec4899', '#6366f1', '#84cc16'
                    ];
                    return colors[index % colors.length];
                }
            };
        }
        
        // Create map renderer
        function createMapRenderer() {
            return {
                createMap(container, options = {}) {
                    const {
                        center = [0, 0],
                        zoom = 2,
                        width = 400,
                        height = 300,
                        backgroundColor = '#f8fafc'
                    } = options;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Note: This is a simple placeholder.
                    // A real map would require a mapping library like Leaflet or Google Maps
                    
                    // Draw placeholder text
                    ctx.fillStyle = '#666666';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Map Preview', width / 2, height / 2);
                    ctx.fillText(`Center: ${center[0]}, ${center[1]}`, width / 2, height / 2 + 20);
                    ctx.fillText(`Zoom: ${zoom}`, width / 2, height / 2 + 40);
                    
                    return canvas;
                },
                
                addMarker(mapCanvas, lat, lng, options = {}) {
                    const {
                        color = '#ef4444',
                        radius = 5,
                        label = ''
                    } = options;
                    
                    const ctx = mapCanvas.getContext('2d');
                    
                    // Simple projection (placeholder)
                    const x = (lng + 180) * (mapCanvas.width / 360);
                    const y = (90 - lat) * (mapCanvas.height / 180);
                    
                    // Draw marker
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw label
                    if (label) {
                        ctx.fillStyle = '#333333';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, x, y - radius - 5);
                    }
                    
                    return mapCanvas;
                }
            };
        }
        
        // Create calendar renderer
        function createCalendarRenderer() {
            return {
                createMonthCalendar(year, month, options = {}) {
                    const {
                        width = 400,
                        height = 300,
                        backgroundColor = '#ffffff',
                        textColor = '#333333',
                        weekendColor = '#ef4444',
                        todayColor = '#3b82f6'
                    } = options;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Calculate calendar
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
                    
                    // Draw month title
                    const monthNames = [
                        'January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'
                    ];
                    
                    ctx.fillStyle = textColor;
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${monthNames[month]} ${year}`, width / 2, 30);
                    
                    // Draw day headers
                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const cellWidth = width / 7;
                    const cellHeight = (height - 50) / 6;
                    
                    dayNames.forEach((day, index) => {
                        const x = index * cellWidth + cellWidth / 2;
                        const y = 50;
                        
                        ctx.fillStyle = index === 0 || index === 6 ? weekendColor : textColor;
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(day, x, y);
                    });
                    
                    // Draw days
                    const today = new Date();
                    const isToday = (day) => 
                        day === today.getDate() && 
                        month === today.getMonth() && 
                        year === today.getFullYear();
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dayOfWeek = date.getDay();
                        
                        const row = Math.floor((day + startDay - 1) / 7);
                        const col = dayOfWeek;
                        
                        const x = col * cellWidth + cellWidth / 2;
                        const y = 70 + row * cellHeight + cellHeight / 2;
                        
                        // Draw day cell
                        if (isToday(day)) {
                            ctx.fillStyle = todayColor + '20';
                            ctx.beginPath();
                            ctx.arc(x, y, Math.min(cellWidth, cellHeight) * 0.4, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        
                        // Draw day number
                        ctx.fillStyle = dayOfWeek === 0 || dayOfWeek === 6 ? weekendColor : textColor;
                        ctx.font = isToday(day) ? 'bold 14px Arial' : '14px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(day.toString(), x, y);
                    }
                    
                    return canvas.toDataURL('image/png');
                }
            };
        }
        
        // Create data visualizer
        function createDataVisualizer() {
            return {
                createTable(data, options = {}) {
                    const {
                        headers = Object.keys(data[0] || {}),
                        width = 600,
                        maxHeight = 400,
                        backgroundColor = '#ffffff',
                        headerColor = '#f8fafc',
                        borderColor = '#e5e7eb',
                        textColor = '#333333'
                    } = options;
                    
                    // Calculate required height
                    const rowHeight = 40;
                    const headerHeight = 50;
                    const totalHeight = Math.min(
                        headerHeight + data.length * rowHeight,
                        maxHeight
                    );
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = totalHeight;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, totalHeight);
                    
                    // Calculate column widths
                    const columnWidth = width / headers.length;
                    
                    // Draw headers
                    ctx.fillStyle = headerColor;
                    ctx.fillRect(0, 0, width, headerHeight);
                    
                    ctx.fillStyle = textColor;
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    
                    headers.forEach((header, index) => {
                        const x = index * columnWidth + columnWidth / 2;
                        ctx.fillText(header, x, headerHeight / 2 + 5);
                        
                        // Draw vertical line
                        ctx.strokeStyle = borderColor;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo((index + 1) * columnWidth, 0);
                        ctx.lineTo((index + 1) * columnWidth, totalHeight);
                        ctx.stroke();
                    });
                    
                    // Draw horizontal line after header
                    ctx.beginPath();
                    ctx.moveTo(0, headerHeight);
                    ctx.lineTo(width, headerHeight);
                    ctx.stroke();
                    
                    // Draw rows
                    ctx.font = '12px Arial';
                    
                    data.forEach((row, rowIndex) => {
                        const y = headerHeight + rowIndex * rowHeight;
                        
                        // Alternate row background
                        if (rowIndex % 2 === 1) {
                            ctx.fillStyle = '#f9fafb';
                            ctx.fillRect(0, y, width, rowHeight);
                        }
                        
                        // Draw cell values
                        ctx.fillStyle = textColor;
                        
                        headers.forEach((header, colIndex) => {
                            const x = colIndex * columnWidth + columnWidth / 2;
                            const value = row[header]?.toString() || '';
                            ctx.fillText(value, x, y + rowHeight / 2 + 5);
                        });
                        
                        // Draw horizontal line
                        if (rowIndex < data.length - 1) {
                            ctx.strokeStyle = borderColor;
                            ctx.beginPath();
                            ctx.moveTo(0, y + rowHeight);
                            ctx.lineTo(width, y + rowHeight);
                            ctx.stroke();
                        }
                    });
                    
                    // Draw border
                    ctx.strokeStyle = borderColor;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(0, 0, width, totalHeight);
                    
                    return canvas.toDataURL('image/png');
                },
                
                createCard(data, options = {}) {
                    const {
                        width = 300,
                        height = 200,
                        backgroundColor = '#ffffff',
                        titleColor = '#333333',
                        textColor = '#666666',
                        accentColor = '#3b82f6',
                        shadow = true
                    } = options;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Draw shadow
                    if (shadow) {
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                        ctx.fillRect(4, 4, width, height);
                    }
                    
                    // Draw card background
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Draw accent bar
                    ctx.fillStyle = accentColor;
                    ctx.fillRect(0, 0, 5, height);
                    
                    // Draw title
                    if (data.title) {
                        ctx.fillStyle = titleColor;
                        ctx.font = 'bold 18px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText(data.title, 20, 40);
                    }
                    
                    // Draw subtitle
                    if (data.subtitle) {
                        ctx.fillStyle = textColor;
                        ctx.font = '14px Arial';
                        ctx.fillText(data.subtitle, 20, 70);
                    }
                    
                    // Draw content
                    if (data.content) {
                        ctx.fillStyle = textColor;
                        ctx.font = '12px Arial';
                        const lines = this._wrapText(data.content, width - 40, ctx);
                        lines.forEach((line, index) => {
                            ctx.fillText(line, 20, 100 + index * 20);
                        });
                    }
                    
                    // Draw footer
                    if (data.footer) {
                        ctx.fillStyle = textColor;
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'right';
                        ctx.fillText(data.footer, width - 20, height - 20);
                    }
                    
                    // Draw border
                    ctx.strokeStyle = '#e5e7eb';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(0, 0, width, height);
                    
                    return canvas.toDataURL('image/png');
                },
                
                _wrapText(text, maxWidth, ctx) {
                    const words = text.split(' ');
                    const lines = [];
                    let currentLine = words[0];
                    
                    for (let i = 1; i < words.length; i++) {
                        const word = words[i];
                        const width = ctx.measureText(currentLine + ' ' + word).width;
                        
                        if (width < maxWidth) {
                            currentLine += ' ' + word;
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    }
                    
                    lines.push(currentLine);
                    return lines;
                }
            };
        }
        
        // Create report generator
        function createReportGenerator() {
            return {
                async generateReport(type, data, options = {}) {
                    const visualizer = createDataVisualizer();
                    
                    switch (type) {
                        case 'table':
                            return visualizer.createTable(data, options);
                        case 'card':
                            return visualizer.createCard(data, options);
                        case 'chart':
                            const chartGenerator = createChartGenerator();
                            if (options.chartType === 'pie') {
                                return chartGenerator.createPieChart(data, options);
                            } else if (options.chartType === 'line') {
                                return chartGenerator.createLineChart(data, options);
                            } else {
                                return chartGenerator.createBarChart(data, options);
                            }
                        case 'calendar':
                            const calendarRenderer = createCalendarRenderer();
                            return calendarRenderer.createMonthCalendar(
                                options.year || new Date().getFullYear(),
                                options.month || new Date().getMonth(),
                                options
                            );
                        default:
                            throw new Error(`Unsupported report type: ${type}`);
                    }
                },
                
                generatePDFReport(data, options = {}) {
                    // Note: PDF generation would require a library like jsPDF
                    return Promise.resolve(new Blob([JSON.stringify(data)], { type: 'application/pdf' }));
                },
                
                generateExcelReport(data, options = {}) {
                    // Note: Excel generation would require a library like SheetJS
                    return Promise.resolve(new Blob([JSON.stringify(data)], { type: 'application/vnd.ms-excel' }));
                }
            };
        }
        
        // ==================== FINAL INITIALIZATION ====================
        
        // Start the application
        initializeDashboard();
        
    </script>
</body>
</html>
