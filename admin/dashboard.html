<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KESNNUR - Complete Management System</title>
    <!-- Local Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom Toast Styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast-success {
            background: #10b981;
        }
        
        .toast-error {
            background: #ef4444;
        }
        
        .toast-info {
            background: #3b82f6;
        }
        
        .toast-warning {
            background: #f59e0b;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        :root {
            --sidebar-width: 280px;
        }
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: #f8fafc;
        }
        .nav-item {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            margin: 50px auto;
            max-height: 90vh;
            overflow-y: auto;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge.active {
            background: #10b98120;
            color: #10b981;
        }
        .badge.pending {
            background: #f59e0b20;
            color: #f59e0b;
        }
        .badge.inactive {
            background: #ef444420;
            color: #ef4444;
        }
        .calendar-day {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
        }
        .calendar-day.event {
            background: #3b82f620;
            color: #1e40af;
        }
        .calendar-day.today {
            background: #10b98120;
            color: #065f46;
            font-weight: 600;
        }
        
        /* Tab Styles */
        .tabs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .tabs-header {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
            overflow-x: auto;
        }
        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #3b82f6;
        }
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            font-weight: 600;
        }
        .tab-content {
            display: none;
            padding: 24px;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Data Table Loading */
        .data-loading {
            position: relative;
            min-height: 200px;
        }
        .data-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        /* Quick Filters */
        .quick-filter {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            margin-right: 8px;
            margin-bottom: 8px;
            border-radius: 20px;
            background: #f3f4f6;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-filter:hover {
            background: #e5e7eb;
        }
        .quick-filter.active {
            background: #3b82f6;
            color: white;
        }
        
        /* Chart Styles */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-6 border-b border-white/20">
            <div class="flex items-center space-x-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i class="fas fa-users text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg">KESNNUR</h1>
                    <p class="text-white/80 text-xs">Management System</p>
                </div>
            </div>
        </div>
        
        <div class="p-4">
            <!-- DASHBOARD -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4">
                Dashboard
            </div>
            <div class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt mr-3"></i>
                Overview
            </div>
            
            <!-- MEMBERSHIP MANAGEMENT -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Membership
            </div>
            <div class="nav-item" data-section="members">
                <i class="fas fa-users mr-3"></i>
                All Members
            </div>
            <div class="nav-item" data-section="add-member">
                <i class="fas fa-user-plus mr-3"></i>
                Add New Member
            </div>
            
            <!-- REGIONS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Regions
            </div>
            <div class="nav-item" data-section="regions">
                <i class="fas fa-map-marker-alt mr-3"></i>
                Manage Regions
            </div>
            
            <!-- EVENTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Events
            </div>
            <div class="nav-item" data-section="events">
                <i class="fas fa-calendar-alt mr-3"></i>
                Events Calendar
            </div>
            <div class="nav-item" data-section="add-event">
                <i class="fas fa-calendar-plus mr-3"></i>
                Add Event
            </div>
            
            <!-- FINANCIAL -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Financial
            </div>
            <div class="nav-item" data-section="payments">
                <i class="fas fa-money-bill-wave mr-3"></i>
                Payments
            </div>
            <div class="nav-item" data-section="add-payment">
                <i class="fas fa-plus-circle mr-3"></i>
                Record Payment
            </div>
            
            <!-- COMMUNICATIONS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Communications
            </div>
            <div class="nav-item" data-section="announcements">
                <i class="fas fa-bullhorn mr-3"></i>
                Announcements
            </div>
            
            <!-- REPORTS -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                Reports
            </div>
            <div class="nav-item" data-section="reports">
                <i class="fas fa-chart-bar mr-3"></i>
                Reports
            </div>
            
            <!-- SYSTEM -->
            <div class="text-white/60 text-xs font-semibold uppercase tracking-wider mb-2 px-4 mt-6">
                System
            </div>
            <div class="nav-item" data-section="users">
                <i class="fas fa-user-shield mr-3"></i>
                Admin Users
            </div>
        </div>
        
        <!-- User Info -->
        <div class="p-4 border-t border-white/20 mt-auto">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <p class="font-medium" id="userName">Loading...</p>
                    <p class="text-white/60 text-sm" id="userRole">Loading...</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="p-6 border-b bg-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard Overview</h1>
                    <p class="text-gray-600" id="welcomeMessage">Welcome back</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600" id="lastLogin">
                        Last login: Loading...
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="p-6" id="contentArea">
            <!-- Loading spinner -->
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading dashboard...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for forms -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <!-- Modal content will be loaded here -->
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        const ADMIN_ROLES = ['admin', 'super_admin', 'editor'];
        
        // Kenyan Regions
        const KENYAN_REGIONS = [
            "Nairobi",
            "Coast",
            "Eastern",
            "North Eastern",
            "Central",
            "Rift Valley",
            "Western",
            "Nyanza"
        ];
        
        // Data Caching
        let dataCache = {
            members: null,
            payments: null,
            events: null,
            announcements: null,
            users: null,
            regions: null,
            lastUpdated: {}
        };
        
        // Initialize Supabase client
        let supabaseClient = null;
        let currentUser = null;
        let currentUserProfile = null;
        
        // Custom Toast Function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Initialize Supabase
        function initSupabase() {
            if (!supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }
        
        // Generate Member Number
        async function generateMemberNumber(membershipType = 'general') {
            try {
                const supabase = initSupabase();
                const currentYear = new Date().getFullYear();
                
                // Get last member number
                const { data: lastMember } = await supabase
                    .from('members')
                    .select('membership_number')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                let sequence = 1;
                if (lastMember && lastMember.membership_number) {
                    const parts = lastMember.membership_number.split('-');
                    if (parts.length === 4 && parts[1] === currentYear.toString()) {
                        const lastSeq = parseInt(parts[3]) || 0;
                        sequence = lastSeq + 1;
                    }
                }
                
                const typeCode = membershipType.substring(0, 3).toUpperCase();
                return `KESNNUR-${currentYear}-${typeCode}-${sequence.toString().padStart(4, '0')}`;
            } catch (error) {
                // Fallback to timestamp-based ID
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');
                return `KESNNUR-${new Date().getFullYear()}-${timestamp}${random}`;
            }
        }
        
        // Check authentication state
        async function checkAuth() {
            try {
                // Initialize Supabase
                const supabase = initSupabase();
                
                // Check for existing session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                    showToast('Authentication error', 'error');
                    return false;
                }
                
                if (!session || !session.user) {
                    console.log('No active session found');
                    return false;
                }
                
                currentUser = session.user;
                
                // Get user profile from profiles table
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                if (profileError) {
                    console.error('Profile error:', profileError);
                    
                    // If profile doesn't exist, create one
                    const { data: newProfile, error: createError } = await supabase
                        .from('profiles')
                        .insert([{
                            id: session.user.id,
                            email: session.user.email,
                            role: 'admin',
                            first_name: session.user.email.split('@')[0],
                            last_name: '',
                            status: 'active'
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Create profile error:', createError);
                        const basicProfile = {
                            id: session.user.id,
                            email: session.user.email,
                            role: 'admin',
                            first_name: session.user.email.split('@')[0],
                            last_name: '',
                            status: 'active'
                        };
                        currentUserProfile = basicProfile;
                    } else {
                        currentUserProfile = newProfile;
                    }
                    
                    return true;
                }
                
                if (!profile) {
                    console.log('No profile found for user');
                    return false;
                }
                
                // Check if user has admin role
                if (!ADMIN_ROLES.includes(profile.role)) {
                    console.log('User does not have admin role:', profile.role);
                    showToast('Access denied: Admin privileges required', 'error');
                    return false;
                }
                
                currentUserProfile = profile;
                
                // Update last login
                try {
                    await supabase
                        .from('profiles')
                        .update({ 
                            last_login: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentUser.id);
                } catch (updateError) {
                    console.warn('Could not update last login:', updateError);
                }
                
                return true;
                
            } catch (error) {
                console.error('Auth check error:', error);
                showToast('Authentication error: ' + error.message, 'error');
                return false;
            }
        }
        
        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Show loading state
                document.getElementById('contentArea').innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-600">Initializing system...</p>
                        </div>
                    </div>
                `;
                
                // Check authentication
                const isAuthenticated = await checkAuth();
                
                if (!isAuthenticated) {
                    console.log('User not authenticated, redirecting to login...');
                    showToast('Please login to access admin dashboard', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                    return;
                }
                
                // Update user info
                updateUserInfo();
                
                // Setup event listeners
                setupEventListeners();
                
                // Load dashboard
                await loadDashboard();
                
                // Setup auth state listener
                setupAuthListener();
                
                // Initialize default regions if not exist
                await initializeRegions();
                
                showToast('KESNNUR Management System loaded!', 'success');
                
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showToast('Error loading dashboard: ' + error.message, 'error');
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 text-4xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">System Error</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="initializeDashboard()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Initialize Kenyan regions
        async function initializeRegions() {
            try {
                const supabase = initSupabase();
                
                // Check if regions exist
                const { data: existingRegions } = await supabase
                    .from('regions')
                    .select('*');
                
                if (!existingRegions || existingRegions.length === 0) {
                    // Insert default Kenyan regions
                    const regionsData = KENYAN_REGIONS.map(region => ({
                        name: region,
                        code: region.substring(0, 3).toUpperCase(),
                        status: 'active',
                        country: 'Kenya',
                        description: `${region} region of Kenya`,
                        created_at: new Date().toISOString()
                    }));
                    
                    await supabase
                        .from('regions')
                        .insert(regionsData);
                    
                    console.log('Default Kenyan regions initialized');
                }
            } catch (error) {
                console.warn('Could not initialize regions:', error);
            }
        }
        
        // Setup auth state listener
        function setupAuthListener() {
            if (window.authListenerSet) return;
            window.authListenerSet = true;
            
            const supabase = initSupabase();
            
            supabase.auth.onAuthStateChange(async (event, session) => {
                switch(event) {
                    case 'SIGNED_OUT':
                        showToast('You have been logged out', 'info');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1000);
                        break;
                        
                    case 'SIGNED_IN':
                        if (session) {
                            currentUser = session.user;
                            await checkAuth();
                            updateUserInfo();
                            showToast('Welcome back!', 'success');
                        }
                        break;
                }
            });
        }
        
        function updateUserInfo() {
            if (!currentUserProfile) return;
            
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const lastLogin = document.getElementById('lastLogin');
            
            if (userName) {
                userName.textContent = 
                    currentUserProfile.first_name && currentUserProfile.last_name 
                        ? `${currentUserProfile.first_name} ${currentUserProfile.last_name}`
                        : currentUserProfile.email || 'User';
            }
            
            if (userRole) {
                userRole.textContent = 
                    (currentUserProfile.role || 'user').replace('_', ' ').toUpperCase();
            }
            
            if (welcomeMessage) {
                welcomeMessage.textContent = 
                    `Welcome back, ${currentUserProfile.first_name || 'Admin'}`;
            }
            
            if (lastLogin) {
                const lastLoginTime = currentUserProfile.last_login 
                    ? new Date(currentUserProfile.last_login).toLocaleString('en-KE')
                    : 'First login';
                
                lastLogin.textContent = `Last login: ${lastLoginTime}`;
            }
        }
        
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Load section
                    loadSection(section);
                });
            });
        }
        
        async function loadSection(section) {
            const contentArea = document.getElementById('contentArea');
            
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                showToast('Session expired, please login again', 'error');
                window.location.href = 'login.html';
                return;
            }
            
            // Update page title
            const pageTitles = {
                'dashboard': 'Dashboard Overview',
                'members': 'All Members',
                'add-member': 'Add New Member',
                'regions': 'Manage Regions',
                'events': 'Events Calendar',
                'add-event': 'Add New Event',
                'payments': 'Payments',
                'add-payment': 'Record Payment',
                'announcements': 'Announcements',
                'reports': 'Reports',
                'users': 'Admin Users'
            };
            
            document.getElementById('pageTitle').textContent = pageTitles[section] || section;
            
            // Show loading
            contentArea.innerHTML = `
                <div class="flex items-center justify-center h-64">
                    <div class="text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading ${pageTitles[section] || section}...</p>
                    </div>
                </div>
            `;
            
            // Load the appropriate section
            switch(section) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'members':
                    await loadMembersManager();
                    break;
                case 'add-member':
                    await loadAddMemberForm();
                    break;
                case 'regions':
                    await loadRegionsManager();
                    break;
                case 'events':
                    await loadEventsManager();
                    break;
                case 'add-event':
                    await loadAddEventForm();
                    break;
                case 'payments':
                    await loadPaymentsManager();
                    break;
                case 'add-payment':
                    await loadAddPaymentForm();
                    break;
                case 'announcements':
                    await loadAnnouncementsManager();
                    break;
                case 'reports':
                    await loadReportsManager();
                    break;
                case 'users':
                    await loadUsersManager();
                    break;
                default:
                    contentArea.innerHTML = '<div class="text-center py-12">Section not found</div>';
            }
        }
        
        // DASHBOARD - OVERVIEW
        async function loadDashboard() {
            try {
                const stats = await loadStats();
                const recentMembers = await getRecentMembers(5);
                const upcomingEvents = await getUpcomingEvents(5);
                
                document.getElementById('contentArea').innerHTML = `
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 text-white mb-8">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">KESNNUR Management System</h2>
                                <p class="text-blue-100">Complete management solution for your organization</p>
                            </div>
                            <div class="text-4xl">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Members</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.members}</h3>
                                    <p class="text-blue-600 text-sm mt-1">
                                        <i class="fas fa-users mr-1"></i>Registered
                                    </p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-lg">
                                    <i class="fas fa-users text-blue-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Active Regions</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.regions}</h3>
                                    <p class="text-purple-600 text-sm mt-1">
                                        <i class="fas fa-map-marker-alt mr-1"></i>Locations
                                    </p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-lg">
                                    <i class="fas fa-map-marker-alt text-purple-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Upcoming Events</p>
                                    <h3 class="text-2xl font-bold text-gray-800">${stats.events}</h3>
                                    <p class="text-green-600 text-sm mt-1">
                                        <i class="fas fa-calendar mr-1"></i>Scheduled
                                    </p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-lg">
                                    <i class="fas fa-calendar-alt text-green-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Revenue</p>
                                    <h3 class="text-2xl font-bold text-gray-800">KSh ${stats.revenue.toLocaleString()}</h3>
                                    <p class="text-orange-600 text-sm mt-1">
                                        <i class="fas fa-money-bill-wave mr-1"></i>This Month
                                    </p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-lg">
                                    <i class="fas fa-money-bill-wave text-orange-900 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Recent Members -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Recent Members</h2>
                                <button onclick="loadSection('members')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${recentMembers.length > 0 ? recentMembers.map(member => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-blue-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${member.first_name} ${member.last_name}</p>
                                            <p class="text-gray-600 text-sm">${member.email} • ${member.region || 'No Region'}</p>
                                        </div>
                                        <span class="badge ${member.membership_status === 'active' ? 'active' : member.membership_status === 'pending' ? 'pending' : 'inactive'}">
                                            ${member.membership_status || 'pending'}
                                        </span>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-users text-3xl mb-3"></i>
                                        <p>No members yet</p>
                                        <button onclick="loadSection('add-member')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Add your first member
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Upcoming Events -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">Upcoming Events</h2>
                                <button onclick="loadSection('events')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View All
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${upcomingEvents.length > 0 ? upcomingEvents.map(event => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-calendar text-green-900"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium">${event.title}</p>
                                            <p class="text-gray-600 text-sm">
                                                ${new Date(event.start_date).toLocaleDateString()} • ${event.venue || 'TBA'}
                                            </p>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-calendar text-3xl mb-3"></i>
                                        <p>No upcoming events</p>
                                        <button onclick="loadSection('add-event')" class="mt-3 text-blue-600 hover:text-blue-800">
                                            Schedule an event
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-xl shadow p-6 mt-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="loadSection('add-member')" class="p-4 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition-colors">
                                <i class="fas fa-user-plus text-blue-900 text-2xl mb-2"></i>
                                <p class="font-medium">Add Member</p>
                            </button>
                            
                            <button onclick="loadSection('add-event')" class="p-4 bg-green-50 rounded-lg text-center hover:bg-green-100 transition-colors">
                                <i class="fas fa-calendar-plus text-green-900 text-2xl mb-2"></i>
                                <p class="font-medium">Add Event</p>
                            </button>
                            
                            <button onclick="loadSection('add-payment')" class="p-4 bg-orange-50 rounded-lg text-center hover:bg-orange-100 transition-colors">
                                <i class="fas fa-money-bill-wave text-orange-900 text-2xl mb-2"></i>
                                <p class="font-medium">Record Payment</p>
                            </button>
                            
                            <button onclick="loadSection('reports')" class="p-4 bg-purple-50 rounded-lg text-center hover:bg-purple-100 transition-colors">
                                <i class="fas fa-chart-bar text-purple-900 text-2xl mb-2"></i>
                                <p class="font-medium">View Reports</p>
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading dashboard: ${error.message}</p>
                        <button onclick="loadDashboard()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        async function loadStats() {
            try {
                const supabase = initSupabase();
                
                // Get member count
                let memberCount = 0;
                try {
                    const { count } = await supabase
                        .from('members')
                        .select('*', { count: 'exact', head: true });
                    memberCount = count || 0;
                } catch (error) {
                    console.warn('Error counting members:', error);
                }
                
                // Get regions count
                let regionCount = 0;
                try {
                    const { count } = await supabase
                        .from('regions')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'active');
                    regionCount = count || 0;
                } catch (error) {
                    console.warn('Error counting regions:', error);
                }
                
                // Get events count
                let eventCount = 0;
                try {
                    const { count } = await supabase
                        .from('events')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'published')
                        .gte('start_date', new Date().toISOString());
                    eventCount = count || 0;
                } catch (error) {
                    console.warn('Error counting events:', error);
                }
                
                // Get total revenue (this month)
                let totalRevenue = 0;
                try {
                    const firstDay = new Date();
                    firstDay.setDate(1);
                    firstDay.setHours(0, 0, 0, 0);
                    
                    const lastDay = new Date();
                    lastDay.setMonth(lastDay.getMonth() + 1);
                    lastDay.setDate(0);
                    lastDay.setHours(23, 59, 59, 999);
                    
                    const { data: payments } = await supabase
                        .from('payments')
                        .select('amount')
                        .eq('payment_status', 'completed')
                        .gte('paid_at', firstDay.toISOString())
                        .lte('paid_at', lastDay.toISOString());
                    
                    if (payments) {
                        payments.forEach(payment => {
                            totalRevenue += parseFloat(payment.amount || 0);
                        });
                    }
                } catch (error) {
                    console.warn('Error calculating revenue:', error);
                }
                
                return {
                    members: memberCount,
                    regions: regionCount,
                    events: eventCount,
                    revenue: totalRevenue
                };
                
            } catch (error) {
                console.error('Error loading stats:', error);
                return { members: 0, regions: 0, events: 0, revenue: 0 };
            }
        }
        
        async function getRecentMembers(limit = 5) {
    try {
        // Check cache first
        if (dataCache.members && dataCache.lastUpdated.members > Date.now() - 30000) {
            return dataCache.members.slice(0, limit);
        }
        
        const supabase = initSupabase();
        const { data } = await supabase
            .from('members')
            .select(`
                *,
                member_profile:profiles!members_profile_id_fkey (
                    id, email, first_name, last_name, phone
                ),
                member_region:regions!members_region_id_fkey (
                    name
                )
            `)
            .order('created_at', { ascending: false })
            .limit(limit);
        
        if (!data) return [];
        
        const formattedData = data.map(member => ({
            ...member,
            first_name: member.member_profile?.first_name || '',
            last_name: member.member_profile?.last_name || '',
            email: member.member_profile?.email || '',
            region: member.member_region?.name || 'No Region'
        }));
        
        // Cache the results
        dataCache.members = formattedData;
        dataCache.lastUpdated.members = Date.now();
        
        return formattedData;
    } catch (error) {
        console.error('Error getting recent members:', error);
        return [];
    }
}
        
        async function getUpcomingEvents(limit = 5) {
            try {
                const supabase = initSupabase();
                const { data } = await supabase
                    .from('events')
                    .select('*')
                    .eq('status', 'published')
                    .gte('start_date', new Date().toISOString())
                    .order('start_date', { ascending: true })
                    .limit(limit);
                return data || [];
            } catch (error) {
                console.error('Error getting upcoming events:', error);
                return [];
            }
        }
        
        // MEMBERS MANAGER with TABS for faster loading
        async function loadMembersManager() {
            try {
                // Initialize tabs structure
                document.getElementById('contentArea').innerHTML = `
                    <div class="tabs-container">
                        <div class="tabs-header">
                            <div class="tab active" data-tab="all-members">All Members</div>
                            <div class="tab" data-tab="active-members">Active</div>
                            <div class="tab" data-tab="pending-members">Pending</div>
                            <div class="tab" data-tab="alumni-members">Alumni</div>
                        </div>
                        
                        <div class="tab-content active" id="all-members">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">All Members</h3>
                                    <p class="text-gray-600 text-sm">Manage all registered members</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button onclick="exportMembers()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                        <i class="fas fa-download mr-2"></i>Export
                                    </button>
                                    <button onclick="loadSection('add-member')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-user-plus mr-2"></i>Add Member
                                    </button>
                                </div>
                            </div>
                            <div id="all-members-content" class="data-loading">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="tab-content" id="active-members">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Active Members</h3>
                                    <p class="text-gray-600 text-sm">Members with active status</p>
                                </div>
                            </div>
                            <div id="active-members-content" class="data-loading">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="tab-content" id="pending-members">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Pending Members</h3>
                                    <p class="text-gray-600 text-sm">Members awaiting approval</p>
                                </div>
                            </div>
                            <div id="pending-members-content" class="data-loading">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="tab-content" id="alumni-members">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Alumni Members</h3>
                                    <p class="text-gray-600 text-sm">Graduated members</p>
                                </div>
                            </div>
                            <div id="alumni-members-content" class="data-loading">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                `;
                
                // Setup tab switching
                setupTabs();
                
                // Load initial tab data
                await loadAllMembers();
                
            } catch (error) {
                console.error('Error loading members manager:', error);
                showToast('Error loading members: ' + error.message, 'error');
            }
        }
        
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load tab content if not loaded
                    loadTabContent(tabId);
                });
            });
        }
        
        async function loadTabContent(tabId) {
            switch(tabId) {
                case 'all-members':
                    if (!document.querySelector('#all-members-content').hasAttribute('data-loaded')) {
                        await loadAllMembers();
                    }
                    break;
                case 'active-members':
                    if (!document.querySelector('#active-members-content').hasAttribute('data-loaded')) {
                        await loadMembersByStatus('active');
                    }
                    break;
                case 'pending-members':
                    if (!document.querySelector('#pending-members-content').hasAttribute('data-loaded')) {
                        await loadMembersByStatus('pending');
                    }
                    break;
                case 'alumni-members':
                    if (!document.querySelector('#alumni-members-content').hasAttribute('data-loaded')) {
                        await loadMembersByStatus('alumni');
                    }
                    break;
            }
        }
        
       async function loadAllMembers() {
    try {
        const supabase = initSupabase();
        const { data: members, error } = await supabase
            .from('members')
            .select(`
                *,
                member_profile:profiles!members_profile_id_fkey (
                    id, email, first_name, last_name, phone, id_number, 
                    date_of_birth, address, status
                ),
                member_region:regions!members_region_id_fkey (
                    name, code
                )
            `)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        // Cache the data
        dataCache.members = members || [];
        dataCache.lastUpdated.members = Date.now();
        
        renderMembersTable('all-members-content', members || []);
        
    } catch (error) {
        console.error('Error loading all members:', error);
        document.getElementById('all-members-content').innerHTML = `
            <div class="text-center py-12 text-red-600">
                <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                <p>Error loading members: ${error.message}</p>
                <button onclick="loadAllMembers()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                    Retry
                </button>
            </div>
        `;
    }
}

async function loadMembersByStatus(status) {
    try {
        const supabase = initSupabase();
        const { data: members, error } = await supabase
            .from('members')
            .select(`
                *,
                member_profile:profiles!members_profile_id_fkey (
                    id, email, first_name, last_name, phone, id_number, 
                    date_of_birth, address, status
                ),
                member_region:regions!members_region_id_fkey (
                    name, code
                )
            `)
            .eq('membership_status', status)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const contentId = `${status}-members-content`;
        renderMembersTable(contentId, members || []);
        
    } catch (error) {
        console.error(`Error loading ${status} members:`, error);
        document.getElementById(`${status}-members-content`).innerHTML = `
            <div class="text-center py-12 text-red-600">
                <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                <p>Error loading ${status} members: ${error.message}</p>
            </div>
        `;
    }
}
        
        function renderMembersTable(containerId, members) {
    const container = document.getElementById(containerId);
    const status = containerId.split('-')[0];
    
    container.innerHTML = `
        <!-- Quick Filters -->
        <div class="mb-6">
            <p class="text-sm text-gray-600 mb-2">Quick filter by region:</p>
            <div>
                ${KENYAN_REGIONS.map(region => `
                    <span class="quick-filter" onclick="filterMembersByRegion('${status}', '${region}')">
                        ${region}
                    </span>
                `).join('')}
                <span class="quick-filter active" onclick="filterMembersByRegion('${status}', '')">
                    All Regions
                </span>
            </div>
        </div>
        
        <!-- Search -->
        <div class="mb-6">
            <input type="text" id="search-${status}" 
                   placeholder="Search by name, email, or member number..." 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                   onkeyup="filterMembersTable('${status}')">
        </div>
        
        <!-- Members Table -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Name</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Member ID</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Region</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Type</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Joined</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody id="members-table-${status}">
                    ${members.length > 0 ? members.map(member => `
                        <tr class="border-b hover:bg-gray-50" data-region="${member.member_region?.name || ''}">
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-blue-900 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium">${member.member_profile?.first_name || ''} ${member.member_profile?.last_name || ''}</p>
                                        <p class="text-sm text-gray-500">${member.member_profile?.email || 'N/A'}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <p class="font-medium">${member.membership_number || 'No ID'}</p>
                                <p class="text-sm text-gray-500">${member.membership_type || 'N/A'}</p>
                            </td>
                            <td class="px-4 py-3">${member.member_region?.name || 'N/A'}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${member.membership_type || 'general'}
                                </span>
                            </td>
                            <td class="px-4 py-3">${member.join_date ? new Date(member.join_date).toLocaleDateString() : 'N/A'}</td>
                            <td class="px-4 py-3">
                                <div class="flex space-x-2">
                                    <button onclick="editMember('${member.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteMember('${member.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button onclick="viewMemberDetails('${member.id}')" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('') : `
                        <tr>
                            <td colspan="6" class="px-4 py-12 text-center text-gray-500">
                                <i class="fas fa-users text-3xl mb-3"></i>
                                <p class="text-lg">No members found</p>
                                ${status === 'all' ? `
                                    <button onclick="loadSection('add-member')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Add Your First Member
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `}
                </tbody>
            </table>
        </div>
        
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-600">
                Showing ${members.length} members
            </div>
            <div class="text-sm text-gray-600">
                <i class="fas fa-database mr-2"></i>Live Database
            </div>
        </div>
    `;
    
    // Mark as loaded
    container.setAttribute('data-loaded', 'true');
}
        function filterMembersTable(status) {
            const searchTerm = document.getElementById(`search-${status}`).value.toLowerCase();
            const rows = document.querySelectorAll(`#members-table-${status} tr`);
            
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const memberId = row.cells[1]?.textContent.toLowerCase() || '';
                
                const matchesSearch = name.includes(searchTerm) || memberId.includes(searchTerm);
                row.style.display = matchesSearch ? '' : 'none';
            });
        }
        
        function filterMembersByRegion(status, region) {
            const rows = document.querySelectorAll(`#members-table-${status} tr`);
            const quickFilters = document.querySelectorAll(`#${status}-members-content .quick-filter`);
            
            // Update active quick filter
            quickFilters.forEach(filter => {
                filter.classList.remove('active');
                if (filter.textContent === (region || 'All Regions')) {
                    filter.classList.add('active');
                }
            });
            
            rows.forEach(row => {
                if (!region) {
                    row.style.display = '';
                    return;
                }
                
                const rowRegion = row.getAttribute('data-region');
                row.style.display = rowRegion === region ? '' : 'none';
            });
        }
        
        // ADD MEMBER FORM with Auto-generated Member Number
        async function loadAddMemberForm() {
            const supabase = initSupabase();
            const { data: regions } = await supabase
                .from('regions')
                .select('id, name, code')
                .eq('status', 'active')
                .order('name');
            
            // Generate initial member number
            const memberNumber = await generateMemberNumber();
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Add New Member</h2>
                            <button onclick="loadSection('members')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Members
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addMemberForm" class="space-y-6 max-w-2xl">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                                    <input type="text" name="first_name" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                                    <input type="text" name="last_name" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                                    <input type="email" name="email" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                                    <input type="tel" name="phone" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="2547XXXXXXXX">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Membership Type *</label>
                                    <select name="membership_type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateMemberNumber()">
                                        <option value="">Select Type</option>
                                        <option value="student">Student</option>
                                        <option value="professional">Professional</option>
                                        <option value="associate">Associate</option>
                                        <option value="alumni">Alumni</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Membership Number *</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" name="membership_number" required readonly
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
                                               value="${memberNumber}">
                                        <button type="button" onclick="refreshMemberNumber()" class="px-3 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Auto-generated. Click refresh to generate new</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ID/Passport Number</label>
                                    <input type="text" name="id_number"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                                    <input type="date" name="date_of_birth"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Region *</label>
                                    <select name="region_id" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Region</option>
                                        ${regions ? regions.map(region => `
                                            <option value="${region.id}">${region.name}</option>
                                        `).join('') : ''}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Membership Status</label>
                                    <select name="membership_status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="active">Active</option>
                                        <option value="pending">Pending Approval</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="alumni">Alumni</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                <textarea name="address" rows="2"
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('members')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewMember()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Save Member
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        async function updateMemberNumber() {
            const membershipType = document.querySelector('select[name="membership_type"]').value;
            if (membershipType) {
                const newMemberNumber = await generateMemberNumber(membershipType);
                document.querySelector('input[name="membership_number"]').value = newMemberNumber;
            }
        }
        
        async function refreshMemberNumber() {
            const membershipType = document.querySelector('select[name="membership_type"]').value || 'general';
            const newMemberNumber = await generateMemberNumber(membershipType);
            document.querySelector('input[name="membership_number"]').value = newMemberNumber;
            showToast('New member number generated', 'info');
        }
        
        async function addNewMember() {
            try {
                const form = document.getElementById('addMemberForm');
                const formData = new FormData(form);
                const memberData = Object.fromEntries(formData.entries());
                
                // Validate required fields
                if (!memberData.first_name || !memberData.last_name || !memberData.email || !memberData.phone || !memberData.membership_type) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const supabase = initSupabase();
                
                // First create profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .insert([{
                        email: memberData.email,
                        first_name: memberData.first_name,
                        last_name: memberData.last_name,
                        phone: memberData.phone,
                        id_number: memberData.id_number,
                        date_of_birth: memberData.date_of_birth,
                        address: memberData.address,
                        role: 'member',
                        status: 'active'
                    }])
                    .select()
                    .single();
                
                if (profileError) {
                    if (profileError.code === '23505') { // Duplicate email
                        showToast('Email already exists in system', 'error');
                        return;
                    }
                    throw profileError;
                }
                
                // Now create member
                const { data, error } = await supabase
                    .from('members')
                    .insert([{
                        profile_id: profile.id,
                        region_id: memberData.region_id,
                        membership_number: memberData.membership_number,
                        membership_type: memberData.membership_type,
                        membership_status: memberData.membership_status || 'pending',
                        join_date: new Date().toISOString().split('T')[0],
                        created_by: currentUser.id
                    }])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.members = null;
                
                showToast('Member added successfully', 'success');
                setTimeout(() => {
                    loadSection('members');
                }, 1500);
                
            } catch (error) {
                console.error('Error adding member:', error);
                showToast('Error adding member: ' + error.message, 'error');
            }
        }
        
        // EDIT MEMBER
       async function editMember(memberId) {
    try {
        const supabase = initSupabase();
        
        // Get member data with correct joins
        const { data: member, error } = await supabase
            .from('members')
            .select(`
                *,
                member_profile:profiles!members_profile_id_fkey (*),
                member_region:regions!members_region_id_fkey (*)
            `)
            .eq('id', memberId)
            .single();
        
        if (error) throw error;
        
        // Get regions for dropdown
        const { data: regions } = await supabase
            .from('regions')
            .select('id, name')
            .eq('status', 'active')
            .order('name');
        
        const modalContent = `
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Edit Member</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="editMemberForm" class="space-y-4">
                    <input type="hidden" name="member_id" value="${member.id}">
                    <input type="hidden" name="profile_id" value="${member.profile_id}">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">First Name *</label>
                            <input type="text" name="first_name" value="${member.member_profile?.first_name || ''}" required class="w-full px-3 py-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Last Name *</label>
                            <input type="text" name="last_name" value="${member.member_profile?.last_name || ''}" required class="w-full px-3 py-2 border rounded">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email *</label>
                            <input type="email" name="email" value="${member.member_profile?.email || ''}" required class="w-full px-3 py-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Phone</label>
                            <input type="tel" name="phone" value="${member.member_profile?.phone || ''}" class="w-full px-3 py-2 border rounded">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Membership Type</label>
                            <select name="membership_type" class="w-full px-3 py-2 border rounded">
                                <option value="student" ${member.membership_type === 'student' ? 'selected' : ''}>Student</option>
                                <option value="professional" ${member.membership_type === 'professional' ? 'selected' : ''}>Professional</option>
                                <option value="associate" ${member.membership_type === 'associate' ? 'selected' : ''}>Associate</option>
                                <option value="alumni" ${member.membership_type === 'alumni' ? 'selected' : ''}>Alumni</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Region</label>
                            <select name="region_id" class="w-full px-3 py-2 border rounded">
                                <option value="">Select Region</option>
                                ${regions ? regions.map(region => `
                                    <option value="${region.id}" ${member.region_id === region.id ? 'selected' : ''}>${region.name}</option>
                                `).join('') : ''}
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Membership Status</label>
                        <select name="membership_status" class="w-full px-3 py-2 border rounded">
                            <option value="active" ${member.membership_status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="pending" ${member.membership_status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="inactive" ${member.membership_status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            <option value="alumni" ${member.membership_status === 'alumni' ? 'selected' : ''}>Alumni</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="button" onclick="updateMember()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Update Member
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        showModal(modalContent);
        
    } catch (error) {
        console.error('Error loading edit member form:', error);
        showToast('Error loading member data: ' + error.message, 'error');
    }
}
        async function updateMember() {
            try {
                const form = document.getElementById('editMemberForm');
                const formData = new FormData(form);
                const memberData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                // Update profile
                await supabase
                    .from('profiles')
                    .update({
                        first_name: memberData.first_name,
                        last_name: memberData.last_name,
                        email: memberData.email,
                        phone: memberData.phone,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', memberData.profile_id);
                
                // Update member
                await supabase
                    .from('members')
                    .update({
                        region_id: memberData.region_id,
                        membership_type: memberData.membership_type,
                        membership_status: memberData.membership_status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', memberData.member_id);
                
                // Clear cache
                dataCache.members = null;
                
                showToast('Member updated successfully', 'success');
                closeModal();
                loadSection('members');
                
            } catch (error) {
                console.error('Error updating member:', error);
                showToast('Error updating member: ' + error.message, 'error');
            }
        }
        
        // DELETE MEMBER
        async function deleteMember(memberId) {
            if (!confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                // First get member to delete profile too
                const { data: member } = await supabase
                    .from('members')
                    .select('profile_id')
                    .eq('id', memberId)
                    .single();
                
                if (member) {
                    // Delete member record
                    await supabase
                        .from('members')
                        .delete()
                        .eq('id', memberId);
                    
                    // Delete profile (optional - you might want to keep profile for audit)
                    await supabase
                        .from('profiles')
                        .delete()
                        .eq('id', member.profile_id);
                }
                
                // Clear cache
                dataCache.members = null;
                
                showToast('Member deleted successfully', 'success');
                loadSection('members');
                
            } catch (error) {
                console.error('Error deleting member:', error);
                showToast('Error deleting member: ' + error.message, 'error');
            }
        }
        
        // VIEW MEMBER DETAILS
       async function viewMemberDetails(memberId) {
    try {
        const supabase = initSupabase();
        
        // Get member with all related data using correct joins
        const { data: member, error } = await supabase
            .from('members')
            .select(`
                *,
                member_profile:profiles!members_profile_id_fkey (*),
                member_region:regions!members_region_id_fkey (*),
                payments (*)
            `)
            .eq('id', memberId)
            .single();
        
        if (error) throw error;
        
        // Calculate total payments
        let totalPaid = 0;
        if (member.payments && member.payments.length > 0) {
            member.payments.forEach(payment => {
                if (payment.payment_status === 'completed') {
                    totalPaid += parseFloat(payment.amount || 0);
                }
            });
        }
        
        const modalContent = `
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Member Details</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Personal Info -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-800 mb-3">Personal Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Full Name</p>
                                <p class="font-medium">${member.member_profile?.first_name || ''} ${member.member_profile?.last_name || ''}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Email</p>
                                <p class="font-medium">${member.member_profile?.email || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Phone</p>
                                <p class="font-medium">${member.member_profile?.phone || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ID Number</p>
                                <p class="font-medium">${member.member_profile?.id_number || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Membership Info -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-800 mb-3">Membership Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Member ID</p>
                                <p class="font-medium">${member.membership_number || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Membership Type</p>
                                <p class="font-medium">${member.membership_type || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Region</p>
                                <p class="font-medium">${member.member_region?.name || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Status</p>
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${member.membership_status === 'active' ? 'bg-green-100 text-green-800' : member.membership_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                    ${member.membership_status || 'N/A'}
                                </span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Join Date</p>
                                <p class="font-medium">${member.join_date ? new Date(member.join_date).toLocaleDateString() : 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Total Paid</p>
                                <p class="font-medium">KSh ${totalPaid.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Payments -->
                    ${member.payments && member.payments.length > 0 ? `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-3">Recent Payments</h4>
                            <div class="space-y-2">
                                ${member.payments.slice(0, 3).map(payment => `
                                    <div class="flex justify-between items-center bg-white p-3 rounded border">
                                        <div>
                                            <p class="font-medium">${payment.payment_for || 'Payment'}</p>
                                            <p class="text-sm text-gray-600">${new Date(payment.paid_at || payment.created_at).toLocaleDateString()}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</p>
                                            <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                ${payment.payment_status || 'pending'}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button onclick="editMember('${member.id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <i class="fas fa-edit mr-2"></i>Edit Member
                        </button>
                        <button onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        showModal(modalContent);
        
    } catch (error) {
        console.error('Error loading member details:', error);
        showToast('Error loading member details: ' + error.message, 'error');
    }
}
        
        // REGIONS MANAGER
        async function loadRegionsManager() {
            try {
                const supabase = initSupabase();
                const { data: regions, error } = await supabase
                    .from('regions')
                    .select('*, members(count)')
                    .order('name');
                
                if (error) throw error;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Regions Management</h2>
                                <button onclick="showAddRegionModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus mr-2"></i>Add Region
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Kenyan Regions Overview -->
                            <div class="mb-8">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Kenyan Regions Overview</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    ${KENYAN_REGIONS.map(region => {
                                        const regionData = regions?.find(r => r.name === region);
                                        const memberCount = regionData?.members?.[0]?.count || 0;
                                        return `
                                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h4 class="font-medium text-gray-800">${region}</h4>
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${regionData?.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                        ${regionData ? 'Configured' : 'Pending'}
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-2">${regionData?.description || 'No description set'}</p>
                                                <div class="text-sm text-gray-500">
                                                    <i class="fas fa-users mr-1"></i>
                                                    ${memberCount} members
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Configured Regions -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Configured Regions</h3>
                                ${regions && regions.length > 0 ? `
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead>
                                                <tr class="bg-gray-50">
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Region</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Code</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Members</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${regions.map(region => {
                                                    const memberCount = region.members?.[0]?.count || 0;
                                                    return `
                                                        <tr class="border-b hover:bg-gray-50">
                                                            <td class="px-4 py-3">
                                                                <div class="font-medium">${region.name}</div>
                                                                <div class="text-sm text-gray-600">${region.country}</div>
                                                            </td>
                                                            <td class="px-4 py-3">
                                                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium">
                                                                    ${region.code}
                                                                </span>
                                                            </td>
                                                            <td class="px-4 py-3">
                                                                <div class="flex items-center">
                                                                    <i class="fas fa-users text-gray-400 mr-2"></i>
                                                                    <span class="font-medium">${memberCount}</span>
                                                                </div>
                                                            </td>
                                                            <td class="px-4 py-3">
                                                                <span class="px-3 py-1 rounded-full text-xs font-medium ${region.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                                    ${region.status || 'inactive'}
                                                                </span>
                                                            </td>
                                                            <td class="px-4 py-3">
                                                                <div class="flex space-x-2">
                                                                    <button onclick="editRegion('${region.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                    ${memberCount === 0 ? `
                                                                        <button onclick="deleteRegion('${region.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    ` : ''}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : `
                                    <div class="text-center py-12">
                                        <i class="fas fa-map-marker-alt text-gray-400 text-5xl mb-4"></i>
                                        <h3 class="text-xl font-bold text-gray-800 mb-3">No Regions Configured</h3>
                                        <p class="text-gray-600 mb-6">Configure the 8 Kenyan regions for member management</p>
                                        <button onclick="initializeDefaultRegions()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                            <i class="fas fa-plus mr-2"></i>Initialize Default Regions
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading regions:', error);
                showToast('Error loading regions: ' + error.message, 'error');
            }
        }
        
        async function initializeDefaultRegions() {
            try {
                const supabase = initSupabase();
                
                // Check if regions already exist
                const { data: existingRegions } = await supabase
                    .from('regions')
                    .select('name');
                
                const existingNames = existingRegions?.map(r => r.name) || [];
                const regionsToAdd = KENYAN_REGIONS.filter(name => !existingNames.includes(name));
                
                if (regionsToAdd.length === 0) {
                    showToast('All regions already configured', 'info');
                    return;
                }
                
                const regionsData = regionsToAdd.map(region => ({
                    name: region,
                    code: region.substring(0, 3).toUpperCase(),
                    country: 'Kenya',
                    status: 'active',
                    description: `${region} region of Kenya`,
                    created_at: new Date().toISOString()
                }));
                
                const { error } = await supabase
                    .from('regions')
                    .insert(regionsData);
                
                if (error) throw error;
                
                // Clear cache
                dataCache.regions = null;
                
                showToast(`${regionsToAdd.length} regions initialized successfully`, 'success');
                loadSection('regions');
                
            } catch (error) {
                console.error('Error initializing regions:', error);
                showToast('Error initializing regions: ' + error.message, 'error');
            }
        }
        
        function showAddRegionModal() {
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Add New Region</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addRegionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Region Name *</label>
                            <select name="name" required class="w-full px-3 py-2 border rounded">
                                <option value="">Select Region</option>
                                ${KENYAN_REGIONS.map(region => `
                                    <option value="${region}">${region}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Region Code *</label>
                                <input type="text" name="code" required class="w-full px-3 py-2 border rounded" placeholder="e.g., NAI">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Country</label>
                                <input type="text" name="country" value="Kenya" readonly class="w-full px-3 py-2 border rounded bg-gray-50">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Description</label>
                            <textarea name="description" rows="3" class="w-full px-3 py-2 border rounded"></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewRegion()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Save Region
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        async function addNewRegion() {
            try {
                const form = document.getElementById('addRegionForm');
                const formData = new FormData(form);
                const regionData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('regions')
                    .insert([{
                        name: regionData.name,
                        code: regionData.code,
                        country: regionData.country,
                        description: regionData.description,
                        status: 'active',
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.regions = null;
                
                showToast('Region added successfully', 'success');
                closeModal();
                loadSection('regions');
                
            } catch (error) {
                console.error('Error adding region:', error);
                showToast('Error adding region: ' + error.message, 'error');
            }
        }
        
        async function editRegion(regionId) {
            try {
                const supabase = initSupabase();
                
                const { data: region, error } = await supabase
                    .from('regions')
                    .select('*')
                    .eq('id', regionId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Region</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editRegionForm" class="space-y-4">
                            <input type="hidden" name="region_id" value="${region.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Region Name *</label>
                                <input type="text" name="name" value="${region.name}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Region Code *</label>
                                    <input type="text" name="code" value="${region.code}" required class="w-full px-3 py-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Country</label>
                                    <input type="text" name="country" value="${region.country || 'Kenya'}" class="w-full px-3 py-2 border rounded">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <textarea name="description" rows="3" class="w-full px-3 py-2 border rounded">${region.description || ''}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="w-full px-3 py-2 border rounded">
                                    <option value="active" ${region.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${region.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateRegion()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Update Region
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit region form:', error);
                showToast('Error loading region data: ' + error.message, 'error');
            }
        }
        
        async function updateRegion() {
            try {
                const form = document.getElementById('editRegionForm');
                const formData = new FormData(form);
                const regionData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                await supabase
                    .from('regions')
                    .update({
                        name: regionData.name,
                        code: regionData.code,
                        country: regionData.country,
                        description: regionData.description,
                        status: regionData.status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', regionData.region_id);
                
                // Clear cache
                dataCache.regions = null;
                
                showToast('Region updated successfully', 'success');
                closeModal();
                loadSection('regions');
                
            } catch (error) {
                console.error('Error updating region:', error);
                showToast('Error updating region: ' + error.message, 'error');
            }
        }
        
        async function deleteRegion(regionId) {
            if (!confirm('Are you sure you want to delete this region? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                // Check if region has members
                const { data: members } = await supabase
                    .from('members')
                    .select('id')
                    .eq('region_id', regionId)
                    .limit(1);
                
                if (members && members.length > 0) {
                    showToast('Cannot delete region with members. Reassign members first.', 'error');
                    return;
                }
                
                await supabase
                    .from('regions')
                    .delete()
                    .eq('id', regionId);
                
                // Clear cache
                dataCache.regions = null;
                
                showToast('Region deleted successfully', 'success');
                loadSection('regions');
                
            } catch (error) {
                console.error('Error deleting region:', error);
                showToast('Error deleting region: ' + error.message, 'error');
            }
        }
        
        // EVENTS MANAGER
        async function loadEventsManager() {
            try {
                const supabase = initSupabase();
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('start_date', { ascending: true });
                
                if (error) throw error;
                
                // Get current month for calendar
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Generate calendar
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                let calendarHTML = '';
                
                // Calendar header
                calendarHTML += '<div class="grid grid-cols-7 gap-2 mb-4">';
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    calendarHTML += `<div class="text-center text-sm font-medium text-gray-500 py-2">${day}</div>`;
                });
                calendarHTML += '</div>';
                
                // Calendar days
                calendarHTML += '<div class="grid grid-cols-7 gap-2">';
                
                // Empty cells for days before the first day of month
                for (let i = 0; i < startingDay; i++) {
                    calendarHTML += '<div class="calendar-day"></div>';
                }
                
                // Days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(currentYear, currentMonth, day);
                    const isToday = day === now.getDate() && currentMonth === now.getMonth() && currentYear === now.getFullYear();
                    const hasEvent = events ? events.some(event => {
                        const eventDate = new Date(event.start_date);
                        return eventDate.getDate() === day && 
                               eventDate.getMonth() === currentMonth && 
                               eventDate.getFullYear() === currentYear;
                    }) : false;
                    
                    let dayClass = 'calendar-day';
                    if (isToday) dayClass += ' today';
                    if (hasEvent) dayClass += ' event';
                    
                    calendarHTML += `
                        <div class="${dayClass}">
                            ${day}
                        </div>
                    `;
                }
                calendarHTML += '</div>';
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Events Calendar</h2>
                                <div class="flex space-x-3">
                                    <button onclick="loadSection('add-event')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-calendar-plus mr-2"></i>Add Event
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Calendar -->
                                <div class="lg:col-span-2">
                                    <div class="mb-6">
                                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                                            ${now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                        </h3>
                                        ${calendarHTML}
                                    </div>
                                    
                                    <!-- Upcoming Events -->
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800 mb-4">Upcoming Events</h3>
                                        ${events && events.length > 0 ? events.filter(event => 
                                            new Date(event.start_date) >= new Date() && event.status === 'published'
                                        ).slice(0, 5).map(event => `
                                            <div class="border border-gray-200 rounded-lg p-4 mb-3 hover:bg-gray-50">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <h4 class="font-medium text-gray-800">${event.title}</h4>
                                                        <p class="text-sm text-gray-600 mt-1">
                                                            <i class="fas fa-calendar-day mr-2"></i>
                                                            ${new Date(event.start_date).toLocaleDateString()} 
                                                            ${event.start_date.includes('T') ? ' at ' + new Date(event.start_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                                                        </p>
                                                        ${event.venue ? `
                                                            <p class="text-sm text-gray-600 mt-1">
                                                                <i class="fas fa-map-marker-alt mr-2"></i>${event.venue}
                                                            </p>
                                                        ` : ''}
                                                    </div>
                                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                                        ${event.event_type || 'General'}
                                                    </span>
                                                </div>
                                                ${event.description ? `
                                                    <p class="text-gray-700 mt-3 text-sm">${event.description.substring(0, 100)}${event.description.length > 100 ? '...' : ''}</p>
                                                ` : ''}
                                                <div class="flex justify-end space-x-2 mt-4">
                                                    <button onclick="editEvent('${event.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">
                                                        <i class="fas fa-edit mr-1"></i>Edit
                                                    </button>
                                                    <button onclick="deleteEvent('${event.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                                        <i class="fas fa-trash mr-1"></i>Delete
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('') : `
                                            <div class="text-center py-8 text-gray-500">
                                                <i class="fas fa-calendar text-3xl mb-3"></i>
                                                <p>No upcoming events</p>
                                            </div>
                                        `}
                                    </div>
                                </div>
                                
                                <!-- Event Stats -->
                                <div>
                                    <div class="bg-gray-50 rounded-xl p-6">
                                        <h3 class="text-lg font-bold text-gray-800 mb-4">Event Statistics</h3>
                                        <div class="space-y-4">
                                            <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200">
                                                <div>
                                                    <p class="text-sm text-gray-600">Total Events</p>
                                                    <p class="text-2xl font-bold">${events ? events.length : 0}</p>
                                                </div>
                                                <i class="fas fa-calendar text-blue-600 text-xl"></i>
                                            </div>
                                            
                                            <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200">
                                                <div>
                                                    <p class="text-sm text-gray-600">Upcoming</p>
                                                    <p class="text-2xl font-bold">${events ? events.filter(e => 
                                                        new Date(e.start_date) >= new Date() && e.status === 'published'
                                                    ).length : 0}</p>
                                                </div>
                                                <i class="fas fa-clock text-green-600 text-xl"></i>
                                            </div>
                                            
                                            <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200">
                                                <div>
                                                    <p class="text-sm text-gray-600">This Month</p>
                                                    <p class="text-2xl font-bold">${events ? events.filter(e => {
                                                        const eventDate = new Date(e.start_date);
                                                        return eventDate.getMonth() === currentMonth && 
                                                               eventDate.getFullYear() === currentYear;
                                                    }).length : 0}</p>
                                                </div>
                                                <i class="fas fa-star text-purple-600 text-xl"></i>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-6 pt-6 border-t border-gray-200">
                                            <h4 class="font-medium text-gray-700 mb-3">Quick Links</h4>
                                            <div class="space-y-2">
                                                <button onclick="loadSection('add-event')" class="w-full text-left px-4 py-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100">
                                                    <i class="fas fa-calendar-plus mr-3"></i>Schedule New Event
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading events:', error);
                showToast('Error loading events: ' + error.message, 'error');
            }
        }
        
        // ADD EVENT FORM
        async function loadAddEventForm() {
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Add New Event</h2>
                            <button onclick="loadSection('events')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Events
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addEventForm" class="space-y-6 max-w-2xl">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Event Title *</label>
                                <input type="text" name="title" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description" rows="4" 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Type *</label>
                                    <select name="event_type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Type</option>
                                        <option value="meeting">Meeting</option>
                                        <option value="workshop">Workshop</option>
                                        <option value="seminar">Seminar</option>
                                        <option value="conference">Conference</option>
                                        <option value="social">Social Event</option>
                                        <option value="training">Training</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Target Region</label>
                                    <select name="region" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">All Regions</option>
                                        ${KENYAN_REGIONS.map(region => `
                                            <option value="${region}">${region}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date & Time *</label>
                                    <input type="datetime-local" name="start_date" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date & Time *</label>
                                    <input type="datetime-local" name="end_date" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Venue/Location</label>
                                <input type="text" name="venue"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Registration Fee (KSh)</label>
                                    <input type="number" name="fee_amount" step="0.01"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select name="status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="draft">Draft</option>
                                        <option value="published">Published</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('events')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewEvent()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Save Event
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        async function addNewEvent() {
            try {
                const form = document.getElementById('addEventForm');
                const formData = new FormData(form);
                const eventData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('events')
                    .insert([{
                        title: eventData.title,
                        description: eventData.description,
                        event_type: eventData.event_type,
                        region: eventData.region,
                        start_date: eventData.start_date,
                        end_date: eventData.end_date,
                        venue: eventData.venue,
                        fee_amount: eventData.fee_amount || 0,
                        status: eventData.status,
                        created_by: currentUser.id
                    }])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.events = null;
                
                showToast('Event added successfully', 'success');
                setTimeout(() => {
                    loadSection('events');
                }, 1500);
                
            } catch (error) {
                console.error('Error adding event:', error);
                showToast('Error adding event: ' + error.message, 'error');
            }
        }
        
        async function editEvent(eventId) {
            try {
                const supabase = initSupabase();
                
                const { data: event, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (error) throw error;
                
                // Format dates for datetime-local input
                const formatDateForInput = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().slice(0, 16);
                };
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Event</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editEventForm" class="space-y-4">
                            <input type="hidden" name="event_id" value="${event.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Event Title *</label>
                                <input type="text" name="title" value="${event.title}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <textarea name="description" rows="3" class="w-full px-3 py-2 border rounded">${event.description || ''}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Event Type</label>
                                    <select name="event_type" class="w-full px-3 py-2 border rounded">
                                        <option value="meeting" ${event.event_type === 'meeting' ? 'selected' : ''}>Meeting</option>
                                        <option value="workshop" ${event.event_type === 'workshop' ? 'selected' : ''}>Workshop</option>
                                        <option value="seminar" ${event.event_type === 'seminar' ? 'selected' : ''}>Seminar</option>
                                        <option value="conference" ${event.event_type === 'conference' ? 'selected' : ''}>Conference</option>
                                        <option value="social" ${event.event_type === 'social' ? 'selected' : ''}>Social Event</option>
                                        <option value="training" ${event.event_type === 'training' ? 'selected' : ''}>Training</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Region</label>
                                    <select name="region" class="w-full px-3 py-2 border rounded">
                                        <option value="">All Regions</option>
                                        ${KENYAN_REGIONS.map(region => `
                                            <option value="${region}" ${event.region === region ? 'selected' : ''}>${region}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Start Date & Time</label>
                                    <input type="datetime-local" name="start_date" value="${formatDateForInput(event.start_date)}" class="w-full px-3 py-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">End Date & Time</label>
                                    <input type="datetime-local" name="end_date" value="${formatDateForInput(event.end_date)}" class="w-full px-3 py-2 border rounded">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Venue</label>
                                <input type="text" name="venue" value="${event.venue || ''}" class="w-full px-3 py-2 border rounded">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Fee Amount (KSh)</label>
                                    <input type="number" name="fee_amount" step="0.01" value="${event.fee_amount || 0}" class="w-full px-3 py-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Status</label>
                                    <select name="status" class="w-full px-3 py-2 border rounded">
                                        <option value="draft" ${event.status === 'draft' ? 'selected' : ''}>Draft</option>
                                        <option value="published" ${event.status === 'published' ? 'selected' : ''}>Published</option>
                                        <option value="cancelled" ${event.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateEvent()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Update Event
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit event form:', error);
                showToast('Error loading event data: ' + error.message, 'error');
            }
        }
        
        async function updateEvent() {
            try {
                const form = document.getElementById('editEventForm');
                const formData = new FormData(form);
                const eventData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                await supabase
                    .from('events')
                    .update({
                        title: eventData.title,
                        description: eventData.description,
                        event_type: eventData.event_type,
                        region: eventData.region,
                        start_date: eventData.start_date,
                        end_date: eventData.end_date,
                        venue: eventData.venue,
                        fee_amount: eventData.fee_amount || 0,
                        status: eventData.status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', eventData.event_id);
                
                // Clear cache
                dataCache.events = null;
                
                showToast('Event updated successfully', 'success');
                closeModal();
                loadSection('events');
                
            } catch (error) {
                console.error('Error updating event:', error);
                showToast('Error updating event: ' + error.message, 'error');
            }
        }
        
        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);
                
                // Clear cache
                dataCache.events = null;
                
                showToast('Event deleted successfully', 'success');
                loadSection('events');
                
            } catch (error) {
                console.error('Error deleting event:', error);
                showToast('Error deleting event: ' + error.message, 'error');
            }
        }
        
        // PAYMENTS MANAGER with Tabs
        async function loadPaymentsManager() {
            document.getElementById('contentArea').innerHTML = `
                <div class="tabs-container">
                    <div class="tabs-header">
                        <div class="tab active" data-tab="all-payments">All Payments</div>
                        <div class="tab" data-tab="completed-payments">Completed</div>
                        <div class="tab" data-tab="pending-payments">Pending</div>
                        <div class="tab" data-tab="failed-payments">Failed</div>
                    </div>
                    
                    <div class="tab-content active" id="all-payments">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">All Payments</h3>
                                <p class="text-gray-600 text-sm">View all payment transactions</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="exportPayments()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-download mr-2"></i>Export
                                </button>
                                <button onclick="loadSection('add-payment')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus-circle mr-2"></i>Record Payment
                                </button>
                            </div>
                        </div>
                        <div id="all-payments-content" class="data-loading">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="completed-payments">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Completed Payments</h3>
                                <p class="text-gray-600 text-sm">Successfully processed payments</p>
                            </div>
                        </div>
                        <div id="completed-payments-content" class="data-loading">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="pending-payments">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Pending Payments</h3>
                                <p class="text-gray-600 text-sm">Payments awaiting confirmation</p>
                            </div>
                        </div>
                        <div id="pending-payments-content" class="data-loading">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="failed-payments">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Failed Payments</h3>
                                <p class="text-gray-600 text-sm">Payments that failed processing</p>
                            </div>
                        </div>
                        <div id="failed-payments-content" class="data-loading">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Setup tab switching
            setupPaymentTabs();
            
            // Load initial tab data
            await loadAllPayments();
        }
        
        function setupPaymentTabs() {
            document.querySelectorAll('.tab[data-tab$="payments"]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load tab content if not loaded
                    loadPaymentTabContent(tabId);
                });
            });
        }
        
        async function loadPaymentTabContent(tabId) {
            const status = tabId.split('-')[0];
            
            if (status === 'all') {
                if (!document.querySelector('#all-payments-content').hasAttribute('data-loaded')) {
                    await loadAllPayments();
                }
            } else {
                const contentId = `${tabId}-content`;
                if (!document.querySelector(`#${contentId}`).hasAttribute('data-loaded')) {
                    await loadPaymentsByStatus(status);
                }
            }
        }
        
        async function loadAllPayments() {
            try {
                const supabase = initSupabase();
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select('*, members(profiles(*))')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Cache the data
                dataCache.payments = payments || [];
                dataCache.lastUpdated.payments = Date.now();
                
                renderPaymentsTable('all-payments-content', payments || []);
                
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('all-payments-content').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading payments: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadPaymentsByStatus(status) {
            try {
                const supabase = initSupabase();
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select('*, members(profiles(*))')
                    .eq('payment_status', status)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const contentId = `${status}-payments-content`;
                renderPaymentsTable(contentId, payments || []);
                
            } catch (error) {
                console.error(`Error loading ${status} payments:`, error);
                document.getElementById(`${status}-payments-content`).innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading ${status} payments: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderPaymentsTable(containerId, payments) {
            const container = document.getElementById(containerId);
            const status = containerId.split('-')[0];
            
            // Calculate totals
            let totalAmount = 0;
            payments.forEach(payment => {
                totalAmount += parseFloat(payment.amount || 0);
            });
            
            container.innerHTML = `
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Total Amount</p>
                        <p class="text-xl font-bold text-gray-800">KSh ${totalAmount.toLocaleString()}</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Total Transactions</p>
                        <p class="text-xl font-bold text-gray-800">${payments.length}</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Average Payment</p>
                        <p class="text-xl font-bold text-gray-800">KSh ${payments.length > 0 ? Math.round(totalAmount / payments.length).toLocaleString() : 0}</p>
                    </div>
                </div>
                
                <!-- Payments Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Member</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Invoice No.</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Method</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.length > 0 ? payments.map(payment => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        ${new Date(payment.paid_at || payment.created_at).toLocaleDateString()}
                                    </td>
                                    <td class="px-4 py-3">
                                        ${payment.members?.profiles?.first_name || ''} ${payment.members?.profiles?.last_name || ''}
                                        <p class="text-sm text-gray-500">${payment.members?.profiles?.email || ''}</p>
                                    </td>
                                    <td class="px-4 py-3">
                                        <code class="text-sm">${payment.invoice_number || 'N/A'}</code>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</div>
                                        <div class="text-sm text-gray-500">${payment.payment_for || 'Membership'}</div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            ${payment.payment_method || 'M-Pesa'}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                            ${payment.payment_status || 'pending'}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex space-x-2">
                                            <button onclick="viewPayment('${payment.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button onclick="editPayment('${payment.id}')" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deletePayment('${payment.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                        <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                                        <p class="text-lg">No payments found</p>
                                        ${status === 'all' ? `
                                            <button onclick="loadSection('add-payment')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                Record First Payment
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Mark as loaded
            container.setAttribute('data-loaded', 'true');
        }
        
        async function viewPayment(paymentId) {
            try {
                const supabase = initSupabase();
                
                const { data: payment, error } = await supabase
                    .from('payments')
                    .select('*, members(profiles(*))')
                    .eq('id', paymentId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Payment Details</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-3">Payment Information</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Invoice Number</p>
                                        <p class="font-medium">${payment.invoice_number || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Amount</p>
                                        <p class="font-medium">KSh ${parseFloat(payment.amount || 0).toLocaleString()}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Payment For</p>
                                        <p class="font-medium">${payment.payment_for || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Payment Method</p>
                                        <p class="font-medium">${payment.payment_method || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Status</p>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${payment.payment_status === 'completed' ? 'bg-green-100 text-green-800' : payment.payment_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                            ${payment.payment_status || 'N/A'}
                                        </span>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Date</p>
                                        <p class="font-medium">${new Date(payment.paid_at || payment.created_at).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-bold text-gray-800 mb-3">Member Information</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Member Name</p>
                                        <p class="font-medium">${payment.members?.profiles?.first_name || ''} ${payment.members?.profiles?.last_name || ''}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Email</p>
                                        <p class="font-medium">${payment.members?.profiles?.email || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            ${payment.mpesa_code ? `
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-bold text-gray-800 mb-3">M-Pesa Details</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm text-gray-600">Transaction Code</p>
                                            <p class="font-medium">${payment.mpesa_code}</p>
                                        </div>
                                        ${payment.phone_number ? `
                                            <div>
                                                <p class="text-sm text-gray-600">Phone Number</p>
                                                <p class="font-medium">${payment.phone_number}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button onclick="editPayment('${payment.id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    <i class="fas fa-edit mr-2"></i>Edit Payment
                                </button>
                                <button onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading payment details:', error);
                showToast('Error loading payment details: ' + error.message, 'error');
            }
        }
        
        async function editPayment(paymentId) {
            try {
                const supabase = initSupabase();
                
                const { data: payment, error } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('id', paymentId)
                    .single();
                
                if (error) throw error;
                
                // Get members for dropdown
                const { data: members } = await supabase
                    .from('members')
                    .select('*, profiles(*)')
                    .order('created_at', { ascending: false });
                
                // Format date for datetime-local input
                const formatDateForInput = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().slice(0, 16);
                };
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Payment</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editPaymentForm" class="space-y-4">
                            <input type="hidden" name="payment_id" value="${payment.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Member</label>
                                <select name="member_id" class="w-full px-3 py-2 border rounded">
                                    <option value="">Select Member</option>
                                    ${members ? members.map(member => `
                                        <option value="${member.id}" ${payment.member_id === member.id ? 'selected' : ''}>
                                            ${member.profiles?.first_name || ''} ${member.profiles?.last_name || ''} (${member.membership_number || 'No ID'})
                                        </option>
                                    `).join('') : ''}
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Invoice Number</label>
                                    <input type="text" name="invoice_number" value="${payment.invoice_number || ''}" class="w-full px-3 py-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Amount (KSh)</label>
                                    <input type="number" name="amount" step="0.01" value="${payment.amount || 0}" class="w-full px-3 py-2 border rounded">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Payment For</label>
                                    <select name="payment_for" class="w-full px-3 py-2 border rounded">
                                        <option value="membership" ${payment.payment_for === 'membership' ? 'selected' : ''}>Membership Fee</option>
                                        <option value="event" ${payment.payment_for === 'event' ? 'selected' : ''}>Event Registration</option>
                                        <option value="donation" ${payment.payment_for === 'donation' ? 'selected' : ''}>Donation</option>
                                        <option value="other" ${payment.payment_for === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Payment Method</label>
                                    <select name="payment_method" class="w-full px-3 py-2 border rounded">
                                        <option value="mpesa" ${payment.payment_method === 'mpesa' ? 'selected' : ''}>M-Pesa</option>
                                        <option value="bank" ${payment.payment_method === 'bank' ? 'selected' : ''}>Bank Transfer</option>
                                        <option value="cash" ${payment.payment_method === 'cash' ? 'selected' : ''}>Cash</option>
                                    </select>
                                </div>
                            </div>
                            
                            ${payment.payment_method === 'mpesa' ? `
                                <div id="mpesa-edit-fields">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">M-Pesa Transaction Code</label>
                                            <input type="text" name="mpesa_code" value="${payment.mpesa_code || ''}" class="w-full px-3 py-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Phone Number</label>
                                            <input type="text" name="phone_number" value="${payment.phone_number || ''}" class="w-full px-3 py-2 border rounded">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Payment Date</label>
                                    <input type="datetime-local" name="paid_at" value="${formatDateForInput(payment.paid_at)}" class="w-full px-3 py-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Status</label>
                                    <select name="payment_status" class="w-full px-3 py-2 border rounded">
                                        <option value="completed" ${payment.payment_status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="pending" ${payment.payment_status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="failed" ${payment.payment_status === 'failed' ? 'selected' : ''}>Failed</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="updatePayment()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Update Payment
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
                // Show/hide M-Pesa fields based on payment method
                const paymentMethodSelect = document.querySelector('select[name="payment_method"]');
                paymentMethodSelect.addEventListener('change', function() {
                    const mpesaFields = document.getElementById('mpesa-edit-fields');
                    if (!mpesaFields) return;
                    
                    if (this.value === 'mpesa') {
                        mpesaFields.style.display = 'block';
                    } else {
                        mpesaFields.style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error('Error loading edit payment form:', error);
                showToast('Error loading payment data: ' + error.message, 'error');
            }
        }
        
        async function updatePayment() {
            try {
                const form = document.getElementById('editPaymentForm');
                const formData = new FormData(form);
                const paymentData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const updateData = {
                    member_id: paymentData.member_id,
                    invoice_number: paymentData.invoice_number,
                    amount: paymentData.amount,
                    payment_for: paymentData.payment_for,
                    payment_method: paymentData.payment_method,
                    payment_status: paymentData.payment_status,
                    paid_at: paymentData.paid_at,
                    updated_at: new Date().toISOString()
                };
                
                if (paymentData.payment_method === 'mpesa') {
                    updateData.mpesa_code = paymentData.mpesa_code;
                    updateData.phone_number = paymentData.phone_number;
                }
                
                await supabase
                    .from('payments')
                    .update(updateData)
                    .eq('id', paymentData.payment_id);
                
                // Clear cache
                dataCache.payments = null;
                
                showToast('Payment updated successfully', 'success');
                closeModal();
                loadSection('payments');
                
            } catch (error) {
                console.error('Error updating payment:', error);
                showToast('Error updating payment: ' + error.message, 'error');
            }
        }
        
        async function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('payments')
                    .delete()
                    .eq('id', paymentId);
                
                // Clear cache
                dataCache.payments = null;
                
                showToast('Payment deleted successfully', 'success');
                loadSection('payments');
                
            } catch (error) {
                console.error('Error deleting payment:', error);
                showToast('Error deleting payment: ' + error.message, 'error');
            }
        }
        
        // ADD PAYMENT FORM
        async function loadAddPaymentForm() {
            const supabase = initSupabase();
            const { data: members } = await supabase
                .from('members')
                .select('*, profiles(*)')
                .order('created_at', { ascending: false });
            
            // Generate invoice number
            const invoiceNumber = `KESNNUR-INV-${new Date().getFullYear()}${(new Date().getMonth() + 1).toString().padStart(2, '0')}${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">Record Payment</h2>
                            <button onclick="loadSection('payments')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Payments
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <form id="addPaymentForm" class="space-y-6 max-w-2xl">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Member *</label>
                                <select name="member_id" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select Member</option>
                                    ${members ? members.map(member => `
                                        <option value="${member.id}">
                                            ${member.profiles?.first_name || ''} ${member.profiles?.last_name || ''} 
                                            (${member.membership_number || 'No ID'})
                                        </option>
                                    `).join('') : ''}
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Number</label>
                                    <input type="text" name="invoice_number" readonly
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
                                           value="${invoiceNumber}">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount (KSh) *</label>
                                    <input type="number" name="amount" step="0.01" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment For *</label>
                                    <select name="payment_for" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="membership">Membership Fee</option>
                                        <option value="event">Event Registration</option>
                                        <option value="donation">Donation</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                                    <select name="payment_method" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="mpesa">M-Pesa</option>
                                        <option value="bank">Bank Transfer</option>
                                        <option value="cash">Cash</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="mpesa-fields" style="display: none;">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">M-Pesa Transaction Code</label>
                                        <input type="text" name="mpesa_code"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                        <input type="text" name="phone_number"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="2547XXXXXXXX">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date</label>
                                    <input type="datetime-local" name="paid_at" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           value="${new Date().toISOString().slice(0, 16)}">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select name="payment_status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="completed">Completed</option>
                                        <option value="pending">Pending</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" onclick="loadSection('payments')" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="addNewPayment()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Record Payment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Show/hide M-Pesa fields based on payment method
            const paymentMethodSelect = document.querySelector('select[name="payment_method"]');
            const mpesaFields = document.getElementById('mpesa-fields');
            
            paymentMethodSelect.addEventListener('change', function() {
                if (this.value === 'mpesa') {
                    mpesaFields.style.display = 'block';
                } else {
                    mpesaFields.style.display = 'none';
                }
            });
        }
        
        async function addNewPayment() {
            try {
                const form = document.getElementById('addPaymentForm');
                const formData = new FormData(form);
                const paymentData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const insertData = {
                    member_id: paymentData.member_id,
                    invoice_number: paymentData.invoice_number,
                    amount: paymentData.amount,
                    payment_for: paymentData.payment_for,
                    payment_method: paymentData.payment_method,
                    payment_status: paymentData.payment_status,
                    paid_at: paymentData.paid_at,
                    created_by: currentUser.id
                };
                
                if (paymentData.payment_method === 'mpesa') {
                    insertData.mpesa_code = paymentData.mpesa_code;
                    insertData.phone_number = paymentData.phone_number;
                }
                
                const { data, error } = await supabase
                    .from('payments')
                    .insert([insertData])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.payments = null;
                
                showToast('Payment recorded successfully', 'success');
                setTimeout(() => {
                    loadSection('payments');
                }, 1500);
                
            } catch (error) {
                console.error('Error adding payment:', error);
                showToast('Error recording payment: ' + error.message, 'error');
            }
        }
        
        // ANNOUNCEMENTS MANAGER
        async function loadAnnouncementsManager() {
            try {
                const supabase = initSupabase();
                const { data: announcements, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('publish_at', { ascending: false });
                
                if (error) throw error;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Announcements</h2>
                                <button onclick="showAddAnnouncementModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus mr-2"></i>New Announcement
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            ${announcements && announcements.length > 0 ? announcements.map(announcement => `
                                <div class="border border-gray-200 rounded-xl p-6 mb-6 hover:bg-gray-50">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-800">${announcement.title}</h3>
                                            <p class="text-gray-600 text-sm mt-1">
                                                <i class="fas fa-calendar mr-2"></i>
                                                ${new Date(announcement.publish_at).toLocaleDateString()}
                                                <span class="mx-2">•</span>
                                                <span class="px-2 py-1 rounded-full text-xs ${announcement.priority === 'high' ? 'bg-red-100 text-red-800' : announcement.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                                                    ${announcement.priority || 'medium'}
                                                </span>
                                            </p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="editAnnouncement('${announcement.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteAnnouncement('${announcement.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="prose max-w-none">
                                        <p class="text-gray-700 whitespace-pre-line">${announcement.content}</p>
                                    </div>
                                    
                                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${announcement.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                            ${announcement.status || 'draft'}
                                        </span>
                                        <span class="text-sm text-gray-500">
                                            ${announcement.announcement_type || 'General'}
                                        </span>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="text-center py-12">
                                    <i class="fas fa-bullhorn text-gray-400 text-5xl mb-4"></i>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">No Announcements</h3>
                                    <p class="text-gray-600 mb-6">Create your first announcement to share with members</p>
                                    <button onclick="showAddAnnouncementModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-plus mr-2"></i>Create Announcement
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading announcements:', error);
                showToast('Error loading announcements: ' + error.message, 'error');
            }
        }
        
        function showAddAnnouncementModal() {
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Create Announcement</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addAnnouncementForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Title *</label>
                            <input type="text" name="title" required class="w-full px-3 py-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Content *</label>
                            <textarea name="content" rows="6" required class="w-full px-3 py-2 border rounded"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Type</label>
                                <select name="announcement_type" class="w-full px-3 py-2 border rounded">
                                    <option value="general">General</option>
                                    <option value="event">Event</option>
                                    <option value="news">News</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Priority</label>
                                <select name="priority" class="w-full px-3 py-2 border rounded">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="w-full px-3 py-2 border rounded">
                                    <option value="draft">Draft</option>
                                    <option value="published">Publish Now</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Publish Date</label>
                                <input type="datetime-local" name="publish_at" 
                                       value="${new Date().toISOString().slice(0, 16)}"
                                       class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewAnnouncement()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Publish Announcement
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        async function addNewAnnouncement() {
            try {
                const form = document.getElementById('addAnnouncementForm');
                const formData = new FormData(form);
                const announcementData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('announcements')
                    .insert([{
                        title: announcementData.title,
                        content: announcementData.content,
                        announcement_type: announcementData.announcement_type,
                        priority: announcementData.priority,
                        status: announcementData.status,
                        publish_at: announcementData.publish_at || new Date().toISOString(),
                        created_by: currentUser.id
                    }])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.announcements = null;
                
                showToast('Announcement created successfully', 'success');
                closeModal();
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error adding announcement:', error);
                showToast('Error creating announcement: ' + error.message, 'error');
            }
        }
        
        async function editAnnouncement(announcementId) {
            try {
                const supabase = initSupabase();
                
                const { data: announcement, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .eq('id', announcementId)
                    .single();
                
                if (error) throw error;
                
                // Format date for datetime-local input
                const formatDateForInput = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().slice(0, 16);
                };
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit Announcement</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editAnnouncementForm" class="space-y-4">
                            <input type="hidden" name="announcement_id" value="${announcement.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Title *</label>
                                <input type="text" name="title" value="${announcement.title}" required class="w-full px-3 py-2 border rounded">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Content *</label>
                                <textarea name="content" rows="6" required class="w-full px-3 py-2 border rounded">${announcement.content || ''}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Type</label>
                                    <select name="announcement_type" class="w-full px-3 py-2 border rounded">
                                        <option value="general" ${announcement.announcement_type === 'general' ? 'selected' : ''}>General</option>
                                        <option value="event" ${announcement.announcement_type === 'event' ? 'selected' : ''}>Event</option>
                                        <option value="news" ${announcement.announcement_type === 'news' ? 'selected' : ''}>News</option>
                                        <option value="urgent" ${announcement.announcement_type === 'urgent' ? 'selected' : ''}>Urgent</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Priority</label>
                                    <select name="priority" class="w-full px-3 py-2 border rounded">
                                        <option value="low" ${announcement.priority === 'low' ? 'selected' : ''}>Low</option>
                                        <option value="medium" ${announcement.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                        <option value="high" ${announcement.priority === 'high' ? 'selected' : ''}>High</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Status</label>
                                    <select name="status" class="w-full px-3 py-2 border rounded">
                                        <option value="draft" ${announcement.status === 'draft' ? 'selected' : ''}>Draft</option>
                                        <option value="published" ${announcement.status === 'published' ? 'selected' : ''}>Published</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Publish Date</label>
                                    <input type="datetime-local" name="publish_at" 
                                           value="${formatDateForInput(announcement.publish_at)}"
                                           class="w-full px-3 py-2 border rounded">
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateAnnouncement()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Update Announcement
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit announcement form:', error);
                showToast('Error loading announcement data: ' + error.message, 'error');
            }
        }
        
        async function updateAnnouncement() {
            try {
                const form = document.getElementById('editAnnouncementForm');
                const formData = new FormData(form);
                const announcementData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                await supabase
                    .from('announcements')
                    .update({
                        title: announcementData.title,
                        content: announcementData.content,
                        announcement_type: announcementData.announcement_type,
                        priority: announcementData.priority,
                        status: announcementData.status,
                        publish_at: announcementData.publish_at,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', announcementData.announcement_id);
                
                // Clear cache
                dataCache.announcements = null;
                
                showToast('Announcement updated successfully', 'success');
                closeModal();
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error updating announcement:', error);
                showToast('Error updating announcement: ' + error.message, 'error');
            }
        }
        
        async function deleteAnnouncement(announcementId) {
            if (!confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                await supabase
                    .from('announcements')
                    .delete()
                    .eq('id', announcementId);
                
                // Clear cache
                dataCache.announcements = null;
                
                showToast('Announcement deleted successfully', 'success');
                loadSection('announcements');
                
            } catch (error) {
                console.error('Error deleting announcement:', error);
                showToast('Error deleting announcement: ' + error.message, 'error');
            }
        }
        
        // REPORTS MANAGER
        async function loadReportsManager() {
            document.getElementById('contentArea').innerHTML = `
                <div class="tabs-container">
                    <div class="tabs-header">
                        <div class="tab active" data-tab="membership-reports">Membership</div>
                        <div class="tab" data-tab="financial-reports">Financial</div>
                        <div class="tab" data-tab="event-reports">Events</div>
                        <div class="tab" data-tab="region-reports">Regions</div>
                    </div>
                    
                    <div class="tab-content active" id="membership-reports">
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Membership Reports</h3>
                            <p class="text-gray-600 text-sm">Member statistics and trends</p>
                        </div>
                        <div id="membership-reports-content" class="data-loading">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="financial-reports">
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Financial Reports</h3>
                            <p class="text-gray-600 text-sm">Revenue and payment analysis</p>
                        </div>
                        <div id="financial-reports-content" class="data-loading">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="event-reports">
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Event Reports</h3>
                            <p class="text-gray-600 text-sm">Event participation and statistics</p>
                        </div>
                        <div id="event-reports-content" class="data-loading">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="region-reports">
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Regional Reports</h3>
                            <p class="text-gray-600 text-sm">Member distribution by region</p>
                        </div>
                        <div id="region-reports-content" class="data-loading">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Setup report tabs
            setupReportTabs();
            
            // Load initial report
            await loadMembershipReport();
        }
        
        function setupReportTabs() {
            document.querySelectorAll('.tab[data-tab$="reports"]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load report data
                    loadReportData(tabId);
                });
            });
        }
        
        async function loadReportData(reportType) {
            switch(reportType) {
                case 'membership-reports':
                    await loadMembershipReport();
                    break;
                case 'financial-reports':
                    await loadFinancialReport();
                    break;
                case 'event-reports':
                    await loadEventReport();
                    break;
                case 'region-reports':
                    await loadRegionReport();
                    break;
            }
        }
        
        async function loadMembershipReport() {
            try {
                const supabase = initSupabase();
                
                // Get membership statistics
                const { data: members } = await supabase
                    .from('members')
                    .select('membership_type, membership_status, join_date');
                
                if (!members) throw new Error('No data available');
                
                // Process data
                const typeStats = {};
                const statusStats = {};
                const monthlyStats = {};
                
                members.forEach(member => {
                    // Type stats
                    typeStats[member.membership_type] = (typeStats[member.membership_type] || 0) + 1;
                    
                    // Status stats
                    statusStats[member.membership_status] = (statusStats[member.membership_status] || 0) + 1;
                    
                    // Monthly stats
                    if (member.join_date) {
                        const date = new Date(member.join_date);
                        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        monthlyStats[monthYear] = (monthlyStats[monthYear] || 0) + 1;
                    }
                });
                
                // Sort months
                const sortedMonths = Object.keys(monthlyStats).sort().slice(-6);
                
                document.getElementById('membership-reports-content').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Membership Type Chart -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Membership Types</h4>
                            <div class="space-y-3">
                                ${Object.entries(typeStats).map(([type, count]) => `
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                                            <span class="text-sm font-bold">${count}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${(count / members.length * 100).toFixed(1)}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Status Distribution -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Status Distribution</h4>
                            <div class="space-y-3">
                                ${Object.entries(statusStats).map(([status, count]) => `
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full mr-2 ${
                                                status === 'active' ? 'bg-green-500' :
                                                status === 'pending' ? 'bg-yellow-500' :
                                                status === 'alumni' ? 'bg-purple-500' : 'bg-gray-500'
                                            }"></div>
                                            <span class="text-sm">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                                        </div>
                                        <span class="font-bold">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Monthly Trends -->
                        <div class="md:col-span-2 bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Monthly Registration Trend (Last 6 Months)</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="px-4 py-2 text-left">Month</th>
                                            <th class="px-4 py-2 text-left">New Members</th>
                                            <th class="px-4 py-2 text-left">Cumulative</th>
                                            <th class="px-4 py-2 text-left">Growth</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sortedMonths.map((month, index) => {
                                            const count = monthlyStats[month] || 0;
                                            const cumulative = sortedMonths.slice(0, index + 1).reduce((sum, m) => sum + (monthlyStats[m] || 0), 0);
                                            const prevMonth = sortedMonths[index - 1];
                                            const prevCount = prevMonth ? monthlyStats[prevMonth] || 0 : 0;
                                            const growth = prevCount > 0 ? ((count - prevCount) / prevCount * 100).toFixed(1) : '∞';
                                            return `
                                                <tr class="border-b">
                                                    <td class="px-4 py-2">${month}</td>
                                                    <td class="px-4 py-2">${count}</td>
                                                    <td class="px-4 py-2">${cumulative}</td>
                                                    <td class="px-4 py-2 ${growth > 0 ? 'text-green-600' : growth < 0 ? 'text-red-600' : ''}">
                                                        ${growth}%
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="exportReport('membership')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>Export Report
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading membership report:', error);
                document.getElementById('membership-reports-content').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading report: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadFinancialReport() {
            try {
                const supabase = initSupabase();
                
                // Get payment statistics
                const { data: payments } = await supabase
                    .from('payments')
                    .select('amount, payment_status, payment_for, paid_at')
                    .order('paid_at', { ascending: false });
                
                if (!payments) throw new Error('No data available');
                
                // Process data
                const completedPayments = payments.filter(p => p.payment_status === 'completed');
                let totalRevenue = 0;
                const revenueByType = {};
                const monthlyRevenue = {};
                
                completedPayments.forEach(payment => {
                    totalRevenue += parseFloat(payment.amount || 0);
                    
                    // Revenue by type
                    revenueByType[payment.payment_for] = (revenueByType[payment.payment_for] || 0) + parseFloat(payment.amount || 0);
                    
                    // Monthly revenue
                    if (payment.paid_at) {
                        const date = new Date(payment.paid_at);
                        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        monthlyRevenue[monthYear] = (monthlyRevenue[monthYear] || 0) + parseFloat(payment.amount || 0);
                    }
                });
                
                // Sort months
                const sortedMonths = Object.keys(monthlyRevenue).sort().slice(-6);
                
                document.getElementById('financial-reports-content').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-blue-50 rounded-lg p-6">
                            <p class="text-sm text-gray-600">Total Revenue</p>
                            <p class="text-2xl font-bold text-gray-800">KSh ${totalRevenue.toLocaleString()}</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6">
                            <p class="text-sm text-gray-600">Total Transactions</p>
                            <p class="text-2xl font-bold text-gray-800">${completedPayments.length}</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-6">
                            <p class="text-sm text-gray-600">Average Transaction</p>
                            <p class="text-2xl font-bold text-gray-800">KSh ${completedPayments.length > 0 ? Math.round(totalRevenue / completedPayments.length).toLocaleString() : 0}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Revenue by Type -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Revenue by Type</h4>
                            <div class="space-y-3">
                                ${Object.entries(revenueByType).map(([type, amount]) => `
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                                            <span class="text-sm font-bold">KSh ${Math.round(amount).toLocaleString()}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-600 h-2 rounded-full" style="width: ${(amount / totalRevenue * 100).toFixed(1)}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Monthly Revenue -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Monthly Revenue (Last 6 Months)</h4>
                            <div class="space-y-3">
                                ${sortedMonths.map(month => {
                                    const amount = monthlyRevenue[month] || 0;
                                    const percentage = totalRevenue > 0 ? (amount / totalRevenue * 100).toFixed(1) : 0;
                                    return `
                                        <div>
                                            <div class="flex justify-between mb-1">
                                                <span class="text-sm font-medium">${month}</span>
                                                <span class="text-sm font-bold">KSh ${Math.round(amount).toLocaleString()}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-purple-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="exportReport('financial')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>Export Report
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading financial report:', error);
                document.getElementById('financial-reports-content').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading report: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function loadRegionReport() {
            try {
                const supabase = initSupabase();
                
                // Get members by region
                const { data: members } = await supabase
                    .from('members')
                    .select('regions(name)');
                
                if (!members) throw new Error('No data available');
                
                // Process region data
                const regionCounts = {};
                members.forEach(member => {
                    const regionName = member.regions?.name || 'Unassigned';
                    regionCounts[regionName] = (regionCounts[regionName] || 0) + 1;
                });
                
                document.getElementById('region-reports-content').innerHTML = `
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="font-bold text-gray-800 mb-6">Member Distribution by Region</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Region Statistics -->
                            <div>
                                <div class="space-y-4">
                                    ${Object.entries(regionCounts).sort((a, b) => b[1] - a[1]).map(([region, count]) => {
                                        const percentage = (count / members.length * 100).toFixed(1);
                                        return `
                                            <div>
                                                <div class="flex justify-between mb-1">
                                                    <span class="text-sm font-medium">${region}</span>
                                                    <span class="text-sm font-bold">${count} (${percentage}%)</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-3">
                                                    <div class="bg-green-600 h-3 rounded-full" style="width: ${percentage}%"></div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Summary Stats -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h5 class="font-bold text-gray-800 mb-4">Regional Summary</h5>
                                <div class="space-y-4">
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-blue-600">${Object.keys(regionCounts).length}</div>
                                        <div class="text-sm text-gray-600">Active Regions</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-green-600">${members.length}</div>
                                        <div class="text-sm text-gray-600">Total Members</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-purple-600">${Math.max(...Object.values(regionCounts))}</div>
                                        <div class="text-sm text-gray-600">Most Members (Region)</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-3xl font-bold text-yellow-600">${Math.min(...Object.values(regionCounts))}</div>
                                        <div class="text-sm text-gray-600">Least Members (Region)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="exportReport('region')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>Export Report
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading region report:', error);
                document.getElementById('region-reports-content').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                        <p>Error loading report: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ADMIN USERS MANAGER
        async function loadUsersManager() {
            try {
                const supabase = initSupabase();
                const { data: profiles, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-white rounded-xl shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800">Admin Users</h2>
                                <button onclick="showAddUserModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-user-plus mr-2"></i>Add Admin
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">User</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Role</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Last Login</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${profiles && profiles.length > 0 ? profiles.map(profile => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center">
                                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                            <i class="fas fa-user text-blue-900 text-sm"></i>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium">${profile.first_name || ''} ${profile.last_name || ''}</p>
                                                            <p class="text-sm text-gray-500">${profile.email}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${profile.role === 'admin' ? 'bg-purple-100 text-purple-800' : profile.role === 'super_admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                                        ${profile.role ? profile.role.replace('_', ' ').toUpperCase() : 'USER'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    ${profile.last_login ? new Date(profile.last_login).toLocaleDateString() : 'Never'}
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${profile.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                        ${profile.status || 'inactive'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex space-x-2">
                                                        ${profile.id !== currentUser.id ? `
                                                            <button onclick="editUserRole('${profile.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button onclick="deleteUser('${profile.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        ` : `
                                                            <span class="px-3 py-1 text-sm text-gray-500">Current User</span>
                                                        `}
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="5" class="px-4 py-12 text-center text-gray-500">
                                                    <i class="fas fa-users text-3xl mb-3"></i>
                                                    <p class="text-lg">No admin users found</p>
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium">Admin Roles:</p>
                                        <ul class="mt-1 space-y-1">
                                            <li><span class="font-medium">Super Admin:</span> Full system access</li>
                                            <li><span class="font-medium">Admin:</span> Full management access</li>
                                            <li><span class="font-medium">Editor:</span> Limited editing access</li>
                                            <li><span class="font-medium">Member:</span> Basic access only</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error loading users: ' + error.message, 'error');
            }
        }
        
        function showAddUserModal() {
            const modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Add Admin User</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="addUserForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email Address *</label>
                            <input type="email" name="email" required class="w-full px-3 py-2 border rounded">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">First Name</label>
                                <input type="text" name="first_name" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Last Name</label>
                                <input type="text" name="last_name" class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Role *</label>
                                <select name="role" required class="w-full px-3 py-2 border rounded">
                                    <option value="member">Member</option>
                                    <option value="editor">Editor</option>
                                    <option value="admin">Admin</option>
                                    <option value="super_admin">Super Admin</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Status</label>
                                <select name="status" class="w-full px-3 py-2 border rounded">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="button" onclick="addNewUser()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Add User
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        async function addNewUser() {
            try {
                const form = document.getElementById('addUserForm');
                const formData = new FormData(form);
                const userData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                const { data, error } = await supabase
                    .from('profiles')
                    .insert([{
                        email: userData.email,
                        first_name: userData.first_name,
                        last_name: userData.last_name,
                        role: userData.role,
                        status: userData.status
                    }])
                    .select();
                
                if (error) throw error;
                
                // Clear cache
                dataCache.users = null;
                
                showToast('User added successfully', 'success');
                closeModal();
                loadSection('users');
                
            } catch (error) {
                console.error('Error adding user:', error);
                showToast('Error adding user: ' + error.message, 'error');
            }
        }
        
        async function editUserRole(userId) {
            try {
                const supabase = initSupabase();
                
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                const modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Edit User Role</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="editUserForm" class="space-y-4">
                            <input type="hidden" name="user_id" value="${profile.id}">
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Current User</label>
                                <input type="text" value="${profile.first_name || ''} ${profile.last_name || ''} (${profile.email})" readonly class="w-full px-3 py-2 border rounded bg-gray-50">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Role *</label>
                                    <select name="role" required class="w-full px-3 py-2 border rounded">
                                        <option value="member" ${profile.role === 'member' ? 'selected' : ''}>Member</option>
                                        <option value="editor" ${profile.role === 'editor' ? 'selected' : ''}>Editor</option>
                                        <option value="admin" ${profile.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        <option value="super_admin" ${profile.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Status</label>
                                    <select name="status" class="w-full px-3 py-2 border rounded">
                                        <option value="active" ${profile.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="inactive" ${profile.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                        <option value="pending" ${profile.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="button" onclick="updateUserRole()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Update User
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal(modalContent);
                
            } catch (error) {
                console.error('Error loading edit user form:', error);
                showToast('Error loading user data: ' + error.message, 'error');
            }
        }
        
        async function updateUserRole() {
            try {
                const form = document.getElementById('editUserForm');
                const formData = new FormData(form);
                const userData = Object.fromEntries(formData.entries());
                
                const supabase = initSupabase();
                
                await supabase
                    .from('profiles')
                    .update({
                        role: userData.role,
                        status: userData.status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userData.user_id);
                
                // Clear cache
                dataCache.users = null;
                
                showToast('User updated successfully', 'success');
                closeModal();
                loadSection('users');
                
            } catch (error) {
                console.error('Error updating user:', error);
                showToast('Error updating user: ' + error.message, 'error');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                const supabase = initSupabase();
                
                // Don't allow deleting yourself
                if (userId === currentUser.id) {
                    showToast('You cannot delete your own account', 'error');
                    return;
                }
                
                await supabase
                    .from('profiles')
                    .delete()
                    .eq('id', userId);
                
                // Clear cache
                dataCache.users = null;
                
                showToast('User deleted successfully', 'success');
                loadSection('users');
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error deleting user: ' + error.message, 'error');
            }
        }
        
        // EVENT REPORT (Placeholder - needs event registration data)
        async function loadEventReport() {
            document.getElementById('event-reports-content').innerHTML = `
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h4 class="font-bold text-gray-800 mb-4">Event Reports</h4>
                    <p class="text-gray-600 mb-6">Event reports will be available once event registration functionality is implemented.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">0</div>
                            <div class="text-sm text-gray-600">Total Events</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600">0</div>
                            <div class="text-sm text-gray-600">Upcoming Events</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600">0</div>
                            <div class="text-sm text-gray-600">Total Participants</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // UTILITY FUNCTIONS
        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = content;
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        function refreshData() {
            // Clear all cache
            dataCache.members = null;
            dataCache.payments = null;
            dataCache.events = null;
            dataCache.announcements = null;
            dataCache.users = null;
            dataCache.regions = null;
            
            showToast('Refreshing data...', 'info');
            loadSection(document.querySelector('.nav-item.active').getAttribute('data-section'));
        }
        
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const supabase = initSupabase();
                    await supabase.auth.signOut();
                    showToast('Logged out successfully', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Error logging out: ' + error.message, 'error');
                }
            }
        }
        
        // Export functions
        function exportMembers() {
            showToast('Export feature coming soon!', 'info');
        }
        
        function exportPayments() {
            showToast('Export feature coming soon!', 'info');
        }
        
        function exportReport(type) {
            showToast(`${type} report export coming soon!`, 'info');
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeDashboard, 100);
        });
        
    </script>
</body>
</html>
