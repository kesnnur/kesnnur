<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KESNNUR - Website Pages CMS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --kesnnur-blue: #1e3a8a;
            --kesnnur-light: #3b82f6;
        }
        
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .nav-item {
            padding: 12px 15px;
            margin: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }
        
        .editor-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .image-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .image-upload:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .preview-box {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background: white;
            margin-top: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
        }
        
        .tab-button.active {
            border-bottom-color: #1e3a8a;
            color: #1e3a8a;
        }
        
        .home-tab {
            display: none;
        }
        
        .home-tab.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                z-index: 1000;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" style="display:flex; height:100vh; align-items:center; justify-content:center; background:linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);">
        <div style="background:white; padding:40px; border-radius:15px; width:400px; max-width:90%;">
            <div style="text-align:center; margin-bottom:30px;">
                <div style="width:80px; height:80px; margin:0 auto 20px; background:#1e3a8a; border-radius:10px; display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-cog" style="color:white; font-size:30px;"></i>
                </div>
                <h2 style="font-size:24px; font-weight:bold; color:#1e293b;">KESNNUR CMS</h2>
                <p style="color:#64748b; margin-top:5px;">Edit Your Live Website Pages</p>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500; color:#475569;">Email</label>
                <input type="email" id="loginEmail" placeholder="admin@kesnnur.org" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>
            
            <div style="margin-bottom:30px;">
                <label style="display:block; margin-bottom:8px; font-weight:500; color:#475569;">Password</label>
                <input type="password" id="loginPassword" placeholder="••••••••" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>
            
            <button onclick="cmsLogin()" style="width:100%; padding:14px; background:#1e3a8a; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:background 0.3s;">Login to CMS</button>
            
            <div style="margin-top:20px; padding:15px; background:#f0f9ff; border-radius:8px; font-size:14px; color:#0369a1;">
                <strong>Default Login:</strong><br>
                Email: <code>admin@kesnnur.org</code><br>
                Password: <code>kesnnur2024</code>
            </div>
        </div>
    </div>

    <!-- Main CMS -->
    <div id="cmsDashboard" style="display:none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div style="padding:20px; border-bottom:1px solid rgba(255,255,255,0.1);">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="width:40px; height:40px; background:white; border-radius:8px; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-graduation-cap" style="color:#1e3a8a;"></i>
                    </div>
                    <div>
                        <h3 style="font-weight:bold;">KESNNUR CMS</h3>
                        <p style="font-size:12px; opacity:0.8;">Website Pages Editor</p>
                    </div>
                </div>
            </div>
            
            <div style="padding:15px;">
                <div class="nav-item active" onclick="showSection('home')">
                    <i class="fas fa-home" style="margin-right:10px;"></i> Home Page
                </div>
                
                <div class="nav-item" onclick="showSection('about')">
                    <i class="fas fa-info-circle" style="margin-right:10px;"></i> About Page
                </div>
                
                <div class="nav-item" onclick="showSection('management')">
                    <i class="fas fa-users" style="margin-right:10px;"></i> Management Page
                </div>
                
                <div class="nav-item" onclick="showSection('events')">
                    <i class="fas fa-calendar-alt" style="margin-right:10px;"></i> Events Page
                </div>
                
                <div class="nav-item" onclick="showSection('blog')">
                    <i class="fas fa-newspaper" style="margin-right:10px;"></i> Blog Page
                </div>
                
                <div class="nav-item" onclick="showSection('resources')">
                    <i class="fas fa-book-medical" style="margin-right:10px;"></i> Resources Page
                </div>
                
                <div class="nav-item" onclick="showSection('contact')">
                    <i class="fas fa-envelope" style="margin-right:10px;"></i> Contact Page
                </div>
                
                <div style="position:absolute; bottom:20px; left:20px; right:20px;">
                    <button onclick="cmsLogout()" style="width:100%; padding:12px; background:rgba(239, 68, 68, 0.9); color:white; border:none; border-radius:8px; cursor:pointer;">
                        <i class="fas fa-sign-out-alt" style="margin-right:8px;"></i> Logout
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- HOME PAGE EDITOR -->
           <!-- HOME PAGE EDITOR -->
<div id="homeSection" class="content-section active">
    <div class="editor-card">
        <h2 style="font-size:24px; font-weight:bold; color:#1e293b; margin-bottom:5px;">Home Page Editor</h2>
        <p style="color:#64748b; margin-bottom:20px;">Edit ALL sections of your homepage</p>
        
        <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #e5e7eb; padding-bottom:10px; flex-wrap:wrap;">
            <button class="tab-button active" onclick="showHomeTab('hero')">Hero</button>
            <button class="tab-button" onclick="showHomeTab('stats')">Statistics</button>
            <button class="tab-button" onclick="showHomeTab('testimonials')">Reviews</button>
            <button class="tab-button" onclick="showHomeTab('features')">Features</button>
            <button class="tab-button" onclick="showHomeTab('events')">Events</button>
            <button class="tab-button" onclick="showHomeTab('blog')">Blog</button>
            <button class="tab-button" onclick="showHomeTab('partners')">Partners</button>
            <button class="tab-button" onclick="showHomeTab('cta')">Final CTA</button>
        </div>
        
        <!-- Hero Tab -->
        <div id="homeHeroTab" class="home-tab active">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Main Title</label>
                <input type="text" id="homeTitle" placeholder="Your Nursing Career Journey Starts Here" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Subtitle</label>
                <textarea id="homeSubtitle" placeholder="Join Kenya's largest community of nursing students and novice nurses. Access mentorship, resources, and career opportunities." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:100px;"></textarea>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Hero Image URL</label>
                <input type="text" id="heroImageUrl" placeholder="https://images.unsplash.com/photo-1551601651-2a8555f1a136?ixlib=rb-4.0.3" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                <p style="color:#6b7280; font-size:12px; margin-top:5px;">Enter URL of hero background image</p>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">CTA Button Text</label>
                <input type="text" id="ctaButtonText" placeholder="Join KESNNUR Today" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
            </div>
        </div>
        
        <!-- Statistics Tab -->
        <div id="homeStatsTab" class="home-tab" style="display:none;">
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; margin-bottom:20px;">
                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Members Count</label>
                    <input type="text" id="statMembers" placeholder="1,500+" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Events Held</label>
                    <input type="text" id="statEvents" placeholder="50+" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Regions Covered</label>
                    <input type="text" id="statRegions" placeholder="24" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
            </div>
        </div>
        
        <!-- Testimonials/Reviews Tab -->
        <div id="homeTestimonialsTab" class="home-tab" style="display:none;">
            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Section Title</h3>
                <input type="text" id="reviewsTitle" placeholder="What Our Members Say" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; margin-bottom:20px;">
            </div>
            
            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Review 1</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Name</label>
                    <input type="text" id="review1Name" placeholder="Sarah M." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Role</label>
                    <input type="text" id="review1Role" placeholder="3rd Year Nursing Student" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Institution</label>
                    <input type="text" id="review1Institution" placeholder="University of Nairobi" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Review Text</label>
                    <textarea id="review1Text" placeholder="KESNNUR mentorship program transformed my nursing journey. My mentor guided me through clinical rotations." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:80px;"></textarea>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Rating (1-5)</label>
                    <select id="review1Rating" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                        <option value="5">★★★★★ (5)</option>
                        <option value="4">★★★★☆ (4)</option>
                        <option value="3">★★★☆☆ (3)</option>
                        <option value="2">★★☆☆☆ (2)</option>
                        <option value="1">★☆☆☆☆ (1)</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Review 2</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Name</label>
                    <input type="text" id="review2Name" placeholder="John K." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Role</label>
                    <input type="text" id="review2Role" placeholder="Novice Nurse" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Institution</label>
                    <input type="text" id="review2Institution" placeholder="Kenyatta National Hospital" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Review Text</label>
                    <textarea id="review2Text" placeholder="The networking events helped me secure my first nursing job. Community support is invaluable." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:80px;"></textarea>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Rating (1-5)</label>
                    <select id="review2Rating" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                        <option value="5">★★★★★ (5)</option>
                        <option value="4">★★★★☆ (4)</option>
                        <option value="3">★★★☆☆ (3)</option>
                        <option value="2">★★☆☆☆ (2)</option>
                        <option value="1">★☆☆☆☆ (1)</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Review 3</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Name</label>
                    <input type="text" id="review3Name" placeholder="Grace W." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Role</label>
                    <input type="text" id="review3Role" placeholder="2nd Year Student" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Institution</label>
                    <input type="text" id="review3Institution" placeholder="Moi University" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Review Text</label>
                    <textarea id="review3Text" placeholder="Resources and workshops have been crucial for my academic success. Highly recommended!" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:80px;"></textarea>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Rating (1-5)</label>
                    <select id="review3Rating" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                        <option value="5">★★★★★ (5)</option>
                        <option value="4">★★★★☆ (4)</option>
                        <option value="3">★★★☆☆ (3)</option>
                        <option value="2">★★☆☆☆ (2)</option>
                        <option value="1">★☆☆☆☆ (1)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Features Tab -->
        <div id="homeFeaturesTab" class="home-tab" style="display:none;">
            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Section Title</h3>
                <input type="text" id="featuresTitle" placeholder="How We Support Your Growth" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; margin-bottom:20px;">
            </div>
            
            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Feature 1</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Icon (Font Awesome class)</label>
                    <input type="text" id="feature1Icon" placeholder="fas fa-user-graduate" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                    <p style="color:#6b7280; font-size:12px; margin-top:5px;">Example: fas fa-user-graduate, fas fa-book-medical, fas fa-heart</p>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Title</label>
                    <input type="text" id="feature1Title" placeholder="Mentorship & Guidance" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Description</label>
                    <textarea id="feature1Desc" placeholder="Connect with experienced nurse mentors for personalized career guidance." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:80px;"></textarea>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Link Text</label>
                    <input type="text" id="feature1Link" placeholder="Find a Mentor" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Link URL</label>
                    <input type="text" id="feature1Url" placeholder="about.html#mentorship" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
            </div>
            
            <div style="margin-bottom:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Feature 2</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Icon (Font Awesome class)</label>
                    <input type="text" id="feature2Icon" placeholder="fas fa-book-medical" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Title</label>
                    <input type="text" id="feature2Title" placeholder="Continuous Education" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Description</label>
                    <textarea id="feature2Desc" placeholder="Access workshops and latest research to excel in nursing practice." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:80px;"></textarea>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Link Text</label>
                    <input type="text" id="feature2Link" placeholder="View Resources" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Link URL</label>
                    <input type="text" id="feature2Url" placeholder="resources.html" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
            </div>
            
            <div style="margin-bottom:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Feature 3</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Icon (Font Awesome class)</label>
                    <input type="text" id="feature3Icon" placeholder="fas fa-heart" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Title</label>
                    <input type="text" id="feature3Title" placeholder="Mental Health Support" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Description</label>
                    <textarea id="feature3Desc" placeholder="Resources and peer networks to promote wellbeing and resilience." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:80px;"></textarea>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Link Text</label>
                    <input type="text" id="feature3Link" placeholder="Explore Resources" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Link URL</label>
                    <input type="text" id="feature3Url" placeholder="resources.html#mental-health" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
            </div>
        </div>
        
        <!-- Events Tab -->
        <div id="homeEventsTab" class="home-tab" style="display:none;">
            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Section Settings</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Section Title</label>
                    <input type="text" id="eventsSectionTitle" placeholder="Upcoming Events" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Section Subtitle</label>
                    <input type="text" id="eventsSectionSubtitle" placeholder="Join our upcoming workshops and networking events" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">View All Text</label>
                    <input type="text" id="eventsViewAllText" placeholder="View All Events" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Note:</h3>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-blue-700">Events are managed separately in the <strong>Events Page Editor</strong>. The homepage shows the 3 most recent upcoming events automatically.</p>
                    <button onclick="showSection('events')" style="margin-top:10px; padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        Go to Events Editor
                    </button>
                </div>
            </div>
        </div>
      <!-- Blog Tab -->
<div id="homeBlogTab" class="home-tab" style="display:none;">
    <div style="margin-bottom:20px;">
        <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Section Settings</h3>
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:8px; font-weight:500;">Section Title</label>
            <input type="text" id="blogSectionTitle" placeholder="Latest from Our Blog" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
        </div>
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:500;">Section Subtitle</label>
            <input type="text" id="blogSectionSubtitle" placeholder="Insights and stories from the nursing community" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
        </div>
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:500;">View All Text</label>
            <input type="text" id="blogViewAllText" placeholder="View All Posts" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
        </div>
        
        <button onclick="saveBlogSettings()" style="padding:12px 24px; background:#1e3a8a; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; margin-right:10px;">
            <i class="fas fa-save mr-2"></i>Save Settings
        </button>
        <button onclick="loadBlogSectionSettings()" style="padding:12px 24px; background:#6b7280; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
            <i class="fas fa-sync mr-2"></i>Reload
        </button>
    </div>
    
    <!-- Current Blog Posts Section -->
    <div style="margin-bottom:20px;">
        <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Current Blog Posts (Showing on Homepage)</h3>
        
        <div id="currentBlogPosts" style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:20px; margin-bottom:20px;">
            <div class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-900 mb-4"></div>
                <p class="text-gray-600">Loading blog posts...</p>
            </div>
        </div>
        
        <button onclick="loadCurrentBlogPosts()" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; margin-right:10px;">
            <i class="fas fa-sync mr-2"></i>Refresh Posts
        </button>
        <button onclick="showAddBlogPostModal()" style="padding:10px 20px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
            <i class="fas fa-plus mr-2"></i>Add New Post
        </button>
    </div>
    
    <!-- Quick Blog Post Management -->
    <div style="margin-bottom:20px;">
        <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Quick Actions</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
            <button onclick="showSection('blog')" style="padding:12px; background:#0d9488; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; text-align:center;">
                <i class="fas fa-edit mr-2"></i>Full Blog Editor
            </button>
            <button onclick="viewAllBlogPosts()" style="padding:12px; background:#8b5cf6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; text-align:center;">
                <i class="fas fa-list mr-2"></i>View All Posts
            </button>
            <button onclick="checkBlogStatus()" style="padding:12px; background:#f59e0b; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; text-align:center;">
                <i class="fas fa-check-circle mr-2"></i>Check Status
            </button>
        </div>
    </div>
    
    <!-- Blog Stats -->
    <div>
        <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Blog Statistics</h3>
        <div id="blogStats" style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:20px;">
            <div class="text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-900 mb-2"></div>
                <p class="text-gray-600">Loading statistics...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Blog Post Modal -->
<div id="addBlogPostModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto;">
        <div style="padding:20px; border-bottom:1px solid #e5e7eb;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="font-size:18px; font-weight:600;">Add New Blog Post</h3>
                <button onclick="closeAddBlogPostModal()" style="background:none; border:none; font-size:20px; cursor:pointer; color:#6b7280;">×</button>
            </div>
        </div>
        
        <div style="padding:20px;">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Title *</label>
                <input type="text" id="newBlogTitle" placeholder="Post Title" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Category</label>
                <select id="newBlogCategory" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                    <option value="">Select Category</option>
                    <option value="Trends">Trends</option>
                    <option value="Student Tips">Student Tips</option>
                    <option value="Mental Health">Mental Health</option>
                    <option value="Career">Career</option>
                    <option value="Education">Education</option>
                    <option value="Research">Research</option>
                </select>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Author</label>
                <input type="text" id="newBlogAuthor" placeholder="Author Name" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Excerpt (Short Description)</label>
                <textarea id="newBlogExcerpt" placeholder="Brief summary of the post..." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; min-height:100px;"></textarea>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">
                    <input type="checkbox" id="newBlogPublished" checked>
                    <span style="margin-left:8px;">Publish Immediately</span>
                </label>
            </div>
            
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="closeAddBlogPostModal()" style="padding:12px 24px; background:#6b7280; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                    Cancel
                </button>
                <button onclick="createBlogPost()" style="padding:12px 24px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-plus mr-2"></i>Create Post
                </button>
            </div>
        </div>
    </div>
</div>
        <!-- Partners Tab -->
        <div id="homePartnersTab" class="home-tab" style="display:none;">
            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Section Settings</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; font-weight:500;">Section Title</label>
                    <input type="text" id="partnersSectionTitle" placeholder="Our Trusted Partners" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:15px;">Partners Management</h3>
                <p style="color:#64748b; margin-bottom:15px;">Add or edit partners that appear in the homepage slider</p>
                
                <div id="partnersList" class="space-y-4 mb-6">
                    <!-- Partners will be loaded here -->
                </div>
                
                <button onclick="addPartner()" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                    <i class="fas fa-plus mr-2"></i> Add New Partner
                </button>
            </div>
        </div>
        
        <!-- Final CTA Tab -->
        <div id="homeCtaTab" class="home-tab" style="display:none;">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">CTA Title</label>
                <input type="text" id="ctaTitle" placeholder="Ready to Join KESNNUR?" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">CTA Description</label>
                <textarea id="ctaDescription" placeholder="Become part of Kenya's largest community of nursing students and novice nurses." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:80px;"></textarea>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Primary Button Text</label>
                <input type="text" id="ctaPrimaryButton" placeholder="Join Now" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:500;">Secondary Button Text</label>
                <input type="text" id="ctaSecondaryButton" placeholder="Contact Us" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
            </div>
        </div>
        
        <!-- Save Button -->
        <div style="margin-top:30px; padding-top:20px; border-top:1px solid #e5e7eb;">
            <button onclick="saveHomePage()" style="padding:12px 25px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                <i class="fas fa-save" style="margin-right:8px;"></i> Save ALL Homepage Content
            </button>
            <p style="color:#64748b; font-size:14px; margin-top:10px;">Saves all sections: Hero, Stats, Reviews, Features, Events, Blog, Partners, CTA</p>
        </div>
    </div>
    
    <!-- Live Preview -->
    <div class="editor-card">
        <h3 style="font-size:18px; font-weight:600; margin-bottom:15px;">Live Preview</h3>
        <div class="preview-box">
            <div style="background:#f3f4f6; padding:20px; border-radius:6px;">
                <h3 id="previewTitle" style="font-size:24px; font-weight:bold; margin-bottom:10px;">Your Nursing Career Journey Starts Here</h3>
                <p id="previewSubtitle" style="color:#4b5563;">Join Kenya's largest community of nursing students and novice nurses...</p>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <span style="padding:4px 8px; background:#dbeafe; color:#1e40af; border-radius:4px; font-size:12px;">Hero Section</span>
                    <span style="padding:4px 8px; background:#dcfce7; color:#166534; border-radius:4px; font-size:12px;">Editable in CMS</span>
                </div>
            </div>
        </div>
    </div>
</div>
            
            <!-- ABOUT PAGE EDITOR -->
            <div id="aboutSection" class="content-section">
                <div class="editor-card">
                    <h2 style="font-size:24px; font-weight:bold; color:#1e293b; margin-bottom:5px;">About Page Editor</h2>
                    <p style="color:#64748b; margin-bottom:20px;">Edit the About Us page content</p>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:500;">Page Title</label>
                        <input type="text" id="aboutTitle" placeholder="About KESNNUR" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:500;">Our Mission</label>
                        <textarea id="aboutMission" placeholder="Our mission is to..." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:100px;"></textarea>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:500;">Our Vision</label>
                        <textarea id="aboutVision" placeholder="Our vision is to..." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:100px;"></textarea>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:500;">History</label>
                        <div id="aboutHistoryEditor" style="height:300px;"></div>
                    </div>
                    
                    <button onclick="saveAboutPage()" style="padding:12px 25px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-save" style="margin-right:8px;"></i> Save About Page
                    </button>
                </div>
            </div>
            
  <!-- In your cms.html, find the management section and replace with: -->
<div id="managementSection" class="content-section">
    <div class="editor-card">
        <h2 style="font-size:24px; font-weight:bold; color:#1e293b; margin-bottom:5px;">Management Page Editor</h2>
        <p style="color:#64748b; margin-bottom:20px;">Manage National Council, Regional Committees, and Ad Hoc Committees</p>
        
        <!-- Tabs for different sections -->
        <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #e5e7eb; padding-bottom:10px;">
            <button class="tab-button active" onclick="showManagementTab('national')">National Council</button>
            <button class="tab-button" onclick="showManagementTab('regional')">Regional Committees</button>
            <button class="tab-button" onclick="showManagementTab('adhoc')">Ad Hoc Committees</button>
        </div>
        
        <!-- National Council Tab -->
        <div id="nationalTab" class="management-tab active">
            <h3 class="text-lg font-bold mb-4 text-blue-900">National Governing Council</h3>
            <div id="managementMembers" class="space-y-4">
                <!-- NGC members load here -->
            </div>
        </div>
        
        <!-- Regional Committees Tab -->
        <div id="regionalTab" class="management-tab" style="display:none;">
            <h3 class="text-lg font-bold mb-4 text-teal-900">Regional Committees</h3>
            <div id="regionalMembers" class="space-y-4">
                <!-- Regional committees load here -->
            </div>
        </div>
        
        <!-- Ad Hoc Committees Tab -->
        <div id="adhocTab" class="management-tab" style="display:none;">
            <h3 class="text-lg font-bold mb-4 text-purple-900">Ad Hoc Committees</h3>
            <div id="adhocMembers" class="space-y-4">
                <!-- Ad hoc committees load here -->
            </div>
        </div>
        
        <button onclick="addTeamMember()" style="padding:12px 25px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; margin-top:20px;">
            <i class="fas fa-plus" style="margin-right:8px;"></i> Add Team Member / Committee
        </button>
    </div>
</div>     
          <!-- EVENTS PAGE EDITOR -->
<div id="eventsSection" class="content-section">
    <div class="editor-card">
        <h2 style="font-size:24px; font-weight:bold; color:#1e293b; margin-bottom:5px;">Events Page Editor</h2>
        <p style="color:#64748b; margin-bottom:20px;">Manage events and edit the entire events page HTML</p>
        
        <!-- Quick Navigation Tabs -->
        <div style="display:flex; gap:10px; margin-bottom:25px; border-bottom:2px solid #e5e7eb;">
            <button onclick="showEventsTab('manage')" id="tabManage" style="padding:12px 24px; background:#1e3a8a; color:white; border:none; border-radius:8px 8px 0 0; font-weight:600; cursor:pointer;">
                <i class="fas fa-calendar-alt mr-2"></i>Manage Events
            </button>
            <button onclick="showEventsTab('html')" id="tabHtml" style="padding:12px 24px; background:#6b7280; color:white; border:none; border-radius:8px 8px 0 0; font-weight:600; cursor:pointer;">
                <i class="fas fa-code mr-2"></i>Edit Page HTML
            </button>
            <button onclick="showEventsTab('preview')" id="tabPreview" style="padding:12px 24px; background:#6b7280; color:white; border:none; border-radius:8px 8px 0 0; font-weight:600; cursor:pointer;">
                <i class="fas fa-eye mr-2"></i>Live Preview
            </button>
        </div>
        
        <!-- TAB 1: Manage Events -->
        <div id="eventsManageTab" class="events-tab">
            <!-- Event Stats -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:30px;">
                <div style="background:#f0f9ff; border:1px solid #e0f2fe; border-radius:8px; padding:20px; text-align:center;">
                    <div style="font-size:28px; font-weight:700; color:#0369a1;" id="totalEvents">0</div>
                    <div style="font-size:14px; color:#64748b;">Total Events</div>
                </div>
                <div style="background:#f0fdf4; border:1px solid #dcfce7; border-radius:8px; padding:20px; text-align:center;">
                    <div style="font-size:28px; font-weight:700; color:#166534;" id="upcomingEvents">0</div>
                    <div style="font-size:14px; color:#64748b;">Upcoming</div>
                </div>
                <div style="background:#fef3c7; border:1px solid #fde68a; border-radius:8px; padding:20px; text-align:center;">
                    <div style="font-size:28px; font-weight:700; color:#92400e;" id="draftEvents">0</div>
                    <div style="font-size:14px; color:#64748b;">Drafts</div>
                </div>
                <div style="background:#f5f3ff; border:1px solid #ede9fe; border-radius:8px; padding:20px; text-align:center;">
                    <div style="font-size:28px; font-weight:700; color:#6b21a8;" id="pastEvents">0</div>
                    <div style="font-size:14px; color:#64748b;">Past Events</div>
                </div>
            </div>
            
            <!-- Actions Bar -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-bottom:20px; border-bottom:1px solid #e5e7eb;">
                <div>
                    <button onclick="showAddEventForm()" style="padding:10px 20px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; margin-right:10px;">
                        <i class="fas fa-plus mr-2"></i>Add New Event
                    </button>
                    <button onclick="refreshEventsList()" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-sync mr-2"></i>Refresh
                    </button>
                </div>
                <div style="display:flex; gap:10px;">
                    <select id="eventFilter" onchange="filterEvents()" style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px;">
                        <option value="all">All Events</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="published">Published</option>
                        <option value="draft">Drafts</option>
                        <option value="past">Past</option>
                    </select>
                    <input type="text" id="eventSearch" placeholder="Search events..." style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; width:200px;">
                </div>
            </div>
            
            <!-- Events Table -->
            <div id="eventsList" style="min-height:300px;">
                <div style="text-align:center; padding:40px;">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mb-4"></div>
                    <p style="color:#64748b;">Loading events from database...</p>
                </div>
            </div>
        </div>
        
        <!-- TAB 2: Edit HTML -->
        <div id="eventsHtmlTab" class="events-tab" style="display:none;">
            <div style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:20px; margin-bottom:20px;">
                <h3 style="font-size:18px; font-weight:600; color:#1e293b; margin-bottom:10px;">Edit Events Page HTML</h3>
                <p style="color:#64748b; margin-bottom:15px;">This HTML code powers your entire events.html page. Be careful when editing!</p>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div>
                        <h4 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:10px;">Page Sections</h4>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <button onclick="loadHtmlSection('hero')" style="padding:12px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; text-align:left; cursor:pointer;">
                                <i class="fas fa-flag mr-2"></i>Hero Section
                            </button>
                            <button onclick="loadHtmlSection('calendar')" style="padding:12px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; text-align:left; cursor:pointer;">
                                <i class="fas fa-calendar mr-2"></i>Calendar Section
                            </button>
                            <button onclick="loadHtmlSection('upcoming')" style="padding:12px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; text-align:left; cursor:pointer;">
                                <i class="fas fa-calendar-check mr-2"></i>Upcoming Events
                            </button>
                            <button onclick="loadHtmlSection('past')" style="padding:12px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; text-align:left; cursor:pointer;">
                                <i class="fas fa-history mr-2"></i>Past Events
                            </button>
                            <button onclick="loadHtmlSection('cta')" style="padding:12px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; text-align:left; cursor:pointer;">
                                <i class="fas fa-bullhorn mr-2"></i>CTA Section
                            </button>
                            <button onclick="loadHtmlSection('footer')" style="padding:12px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; text-align:left; cursor:pointer;">
                                <i class="fas fa-shoe-prints mr-2"></i>Footer
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="font-size:16px; font-weight:600; color:#1e293b; margin-bottom:10px;">Quick Edits</h4>
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <div>
                                <label style="display:block; font-size:14px; color:#4b5563; margin-bottom:5px;">Page Title</label>
                                <input type="text" id="eventsPageTitle" placeholder="KESNNUR Events" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;">
                            </div>
                            <div>
                                <label style="display:block; font-size:14px; color:#4b5563; margin-bottom:5px;">Hero Title</label>
                                <input type="text" id="eventsHeroTitle" placeholder="KESNNUR Events" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;">
                            </div>
                            <div>
                                <label style="display:block; font-size:14px; color:#4b5563; margin-bottom:5px;">Hero Description</label>
                                <textarea id="eventsHeroDesc" rows="3" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;"></textarea>
                            </div>
                            <button onclick="saveEventsPageSettings()" style="padding:12px; background:#1e3a8a; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                                <i class="fas fa-save mr-2"></i>Save Page Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- HTML Editor -->
            <div style="margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="font-size:16px; font-weight:600; color:#1e293b;">HTML Editor</h4>
                    <div style="display:flex; gap:10px;">
                        <select id="htmlSectionSelect" onchange="loadSelectedHtmlSection()" style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px;">
                            <option value="">Select Section...</option>
                            <option value="full">Full Page HTML</option>
                            <option value="hero">Hero Section</option>
                            <option value="calendar">Calendar</option>
                            <option value="upcoming">Upcoming Events</option>
                            <option value="past">Past Events</option>
                            <option value="cta">CTA Section</option>
                            <option value="footer">Footer</option>
                        </select>
                        <button onclick="loadCurrentEventsHtml()" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                            <i class="fas fa-sync mr-2"></i>Load
                        </button>
                    </div>
                </div>
                
                <textarea id="eventsHtmlEditor" rows="20" style="width:100%; padding:15px; border:1px solid #d1d5db; border-radius:8px; font-family:monospace; font-size:14px;" placeholder="HTML will appear here..."></textarea>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="saveEventsHtml()" style="padding:12px 24px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-save mr-2"></i>Save HTML
                    </button>
                    <button onclick="previewEventsHtml()" style="padding:12px 24px; background:#f59e0b; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-eye mr-2"></i>Preview
                    </button>
                    <button onclick="resetEventsHtml()" style="padding:12px 24px; background:#ef4444; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-undo mr-2"></i>Reset
                    </button>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: Live Preview -->
        <div id="eventsPreviewTab" class="events-tab" style="display:none;">
            <div style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:20px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="font-size:18px; font-weight:600; color:#1e293b;">Live Preview</h3>
                    <button onclick="refreshEventsPreview()" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-sync mr-2"></i>Refresh Preview
                    </button>
                </div>
                
                <div style="border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; height:600px;">
                    <iframe id="eventsPreviewFrame" src="events.html" style="width:100%; height:100%; border:none;"></iframe>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="openEventsPage()" style="padding:10px 20px; background:#1e3a8a; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-external-link-alt mr-2"></i>Open Live Page
                    </button>
                    <button onclick="openEventsPageNewTab()" style="padding:10px 20px; background:#6b7280; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-window-restore mr-2"></i>Open in New Tab
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Event Modal -->
<div id="eventModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto;">
        <div style="padding:20px; border-bottom:1px solid #e5e7eb;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="eventModalTitle" style="font-size:20px; font-weight:600;">Add New Event</h3>
                <button onclick="closeEventModal()" style="background:none; border:none; font-size:24px; color:#6b7280; cursor:pointer;">×</button>
            </div>
        </div>
        
        <div style="padding:20px;">
            <form id="eventForm">
                <input type="hidden" id="eventId">
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Event Title *</label>
                        <input type="text" id="eventTitle" required style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                    </div>
                    
                    <div>
                        <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Event Type *</label>
                        <select id="eventType" required style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                            <option value="">Select Type</option>
                            <option value="conference">Conference</option>
                            <option value="workshop">Workshop</option>
                            <option value="webinar">Webinar</option>
                            <option value="seminar">Seminar</option>
                            <option value="training">Training</option>
                            <option value="meeting">Meeting</option>
                            <option value="social">Social</option>
                            <option value="networking">Networking</option>
                            <option value="summit">Summit</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Start Date & Time *</label>
                        <input type="datetime-local" id="eventStartDate" required style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                    </div>
                    
                    <div>
                        <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">End Date & Time *</label>
                        <input type="datetime-local" id="eventEndDate" required style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Venue/Location *</label>
                    <input type="text" id="eventVenue" required style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Description *</label>
                    <textarea id="eventDescription" rows="4" required style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;"></textarea>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Fee Amount</label>
                        <input type="number" id="eventFee" step="0.01" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;" placeholder="0.00">
                    </div>
                    
                    <div>
                        <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Currency</label>
                        <select id="eventCurrency" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                            <option value="KES">KES (Kenyan Shilling)</option>
                            <option value="USD">USD (US Dollar)</option>
                            <option value="EUR">EUR (Euro)</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Image URL (Optional)</label>
                    <input type="url" id="eventImageUrl" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;" placeholder="https://example.com/image.jpg">
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px;">
                    <div>
                        <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Status *</label>
                        <select id="eventStatus" required style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display:block; font-weight:600; color:#4b5563; margin-bottom:8px;">Category</label>
                        <select id="eventCategory" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                            <option value="">Select Category</option>
                            <option value="professional">Professional</option>
                            <option value="educational">Educational</option>
                            <option value="networking">Networking</option>
                            <option value="certification">Certification</option>
                            <option value="research">Research</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:flex-end; gap:15px; padding-top:20px; border-top:1px solid #e5e7eb;">
                    <button type="button" onclick="closeEventModal()" style="padding:12px 24px; background:#6b7280; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        Cancel
                    </button>
                    <button type="submit" style="padding:12px 24px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-save mr-2"></i>Save Event
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- HTML Preview Modal -->
<div id="htmlPreviewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; width:90%; max-width:900px; max-height:90vh; overflow:hidden;">
        <div style="padding:20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="font-size:20px; font-weight:600;">HTML Preview</h3>
            <button onclick="closeHtmlPreviewModal()" style="background:none; border:none; font-size:24px; color:#6b7280; cursor:pointer;">×</button>
        </div>
        
        <div style="padding:20px; overflow-y:auto; max-height:70vh;">
            <div id="htmlPreviewContent" style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:20px; font-family:monospace; font-size:14px; white-space:pre-wrap; word-wrap:break-word; min-height:400px;"></div>
        </div>
        
        <div style="padding:20px; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end;">
            <button onclick="closeHtmlPreviewModal()" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                Close Preview
            </button>
        </div>
    </div>
</div>
            
            <!-- BLOG PAGE EDITOR -->
            <div id="blogSection" class="content-section">
                <div class="editor-card">
                    <h2 style="font-size:24px; font-weight:bold; color:#1e293b; margin-bottom:5px;">Blog Page Editor</h2>
                    <p style="color:#64748b; margin-bottom:20px;">Manage blog posts on your website</p>
                    
                    <div id="blogPostsList">
                        <!-- Blog posts will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- RESOURCES PAGE EDITOR -->
            <div id="resourcesSection" class="content-section">
                <div class="editor-card">
                    <h2 style="font-size:24px; font-weight:bold; color:#1e293b; margin-bottom:5px;">Resources Page Editor</h2>
                    <p style="color:#64748b; margin-bottom:20px;">Manage resources and downloads</p>
                    
                    <div id="resourcesList">
                        <!-- Resources will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- CONTACT PAGE EDITOR -->
            <div id="contactSection" class="content-section">
                <div class="editor-card">
                    <h2 style="font-size:24px; font-weight:bold; color:#1e293b; margin-bottom:5px;">Contact Page Editor</h2>
                    <p style="color:#64748b; margin-bottom:20px;">Edit contact information and form</p>
                    
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:20px; margin-bottom:20px;">
                        <div>
                            <label style="display:block; margin-bottom:8px; font-weight:500;">Email Address</label>
                            <input type="email" id="contactEmail" placeholder="info@kesnnur.org" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:8px; font-weight:500;">Phone Number</label>
                            <input type="text" id="contactPhone" placeholder="+254 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:500;">Address</label>
                        <textarea id="contactAddress" placeholder="Physical address..." style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; height:80px;"></textarea>
                    </div>
                    
                    <button onclick="saveContactPage()" style="padding:12px 25px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                        <i class="fas fa-save" style="margin-right:8px;"></i> Save Contact Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
   !-- JavaScript -->
    <script>
            // ================== SUPABASE HELPER FUNCTIONS ==================
    
    // Universal fetch function for Supabase
    async function fetchFromSupabase(table, query = '') {
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Supabase fetch failed: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error(`Error fetching from ${table}:`, error);
            throw error;
        }
    }
    
    // Insert into Supabase
    async function insertIntoSupabase(table, data) {
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`Supabase insert failed: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error(`Error inserting into ${table}:`, error);
            throw error;
        }
    }
    
    // Update in Supabase
    async function updateInSupabase(table, id, data) {
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`Supabase update failed: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error(`Error updating in ${table}:`, error);
            throw error;
        }
    }
    
    // Delete from Supabase
    async function deleteFromSupabase(table, id) {
        const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        
        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
                method: 'DELETE',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Prefer': 'return=representation'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Supabase delete failed: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error(`Error deleting from ${table}:`, error);
            throw error;
        }
    }
    
    // Notification function
    function showNotification(message, type = 'info') {
        alert(message); // Simple alert for now
    }
    
    // ================== AUTHENTICATION FUNCTIONS ==================
    
    // cmsLogin function - MUST BE DEFINED BEFORE HTML BUTTON REFERENCES IT
    function cmsLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        console.log("Login attempt for:", email);
        
        try {
            // Default credentials check
            const DEFAULT_EMAIL = "admin@kesnnur.org";
            const DEFAULT_PASSWORD = "kesnnur2024";
            
            if (email === DEFAULT_EMAIL && password === DEFAULT_PASSWORD) {
                currentUser = {
                    id: 'admin-001',
                    email: email,
                    user_metadata: { name: 'KESNNUR Admin' },
                    role: 'super_admin'
                };
                
                localStorage.setItem('cmsUser', JSON.stringify(currentUser));
                showCMS();
                alert("Welcome SUPER ADMIN!");
                return;
            }
            
            alert('Please use default credentials:\n\nEmail: admin@kesnnur.org\nPassword: kesnnur2024');
            
        } catch (error) {
            console.error('Login error:', error);
            alert('Login error. Please try again.');
        }
    }
    // ================== GLOBAL VARIABLES ==================
    let cmsSupabase = null;
    let aboutHistoryEditor = null;
    let currentUser = null;
// ================== AUTHENTICATION FUNCTIONS ==================

// cmsLogin function - MUST BE DEFINED BEFORE HTML BUTTON REFERENCES IT
function cmsLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    console.log("Login attempt for:", email);
    
    try {
        // Default credentials check
        const DEFAULT_EMAIL = "admin@kesnnur.org";
        const DEFAULT_PASSWORD = "kesnnur2024";
        
        if (email === DEFAULT_EMAIL && password === DEFAULT_PASSWORD) {
            currentUser = {
                id: 'admin-001',
                email: email,
                user_metadata: { name: 'KESNNUR Admin' },
                role: 'super_admin'
            };
            
            localStorage.setItem('cmsUser', JSON.stringify(currentUser));
            showCMS();
            alert("Welcome SUPER ADMIN!");
            return;
        }
        
        // If Supabase is initialized, try proper auth
        if (cmsSupabase && cmsSupabase.auth) {
            cmsSupabase.auth.signInWithPassword({
                email: email,
                password: password
            }).then(({ data, error }) => {
                if (!error && data.user) {
                    currentUser = data.user;
                    localStorage.setItem('cmsUser', JSON.stringify(currentUser));
                    showCMS();
                    alert("Login successful!");
                } else {
                    alert('Login failed. Please check credentials.');
                }
            }).catch(error => {
                console.error('Auth error:', error);
                alert('Login error. Using default credentials?\n\nDefault:\nEmail: admin@kesnnur.org\nPassword: kesnnur2024');
            });
        } else {
            alert('Please use default credentials:\n\nEmail: admin@kesnnur.org\nPassword: kesnnur2024');
        }
        
    } catch (error) {
        console.error('Login error:', error);
        alert('Login error. Please try again.');
    }
}

// cmsLogout function
function cmsLogout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('cmsUser');
        currentUser = null;
        
        // Try Supabase logout
        if (cmsSupabase && cmsSupabase.auth) {
            cmsSupabase.auth.signOut();
        }
        
        showLogin();
    }
}

function showLogin() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('cmsDashboard').style.display = 'none';
}

function showCMS() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('cmsDashboard').style.display = 'block';
    
    // Load home page
    loadHomePage();
}

// ================== INITIALIZATION ==================
document.addEventListener('DOMContentLoaded', function() {
    console.log("KESNNUR CMS Initializing...");
    
    // Initialize Supabase
    const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
    cmsSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Check if already logged in
    const savedUser = localStorage.getItem('cmsUser');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            showCMS();
            console.log("Auto-login successful");
            
            // Initialize blog tab when CMS is shown
            initializeBlogTab();
            
        } catch (e) {
            console.error("Login error:", e);
            localStorage.removeItem('cmsUser');
        }
    }
    
    // Initialize Quill editor
    const editorElement = document.getElementById('aboutHistoryEditor');
    if (editorElement) {
        aboutHistoryEditor = new Quill('#aboutHistoryEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });
    }
    
    // Add event listeners for blog tab
    addBlogTabListeners();
});
        
        // ================== NAVIGATION ==================
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(sectionId + 'Section');
            if (section) {
                section.classList.add('active');
            }
            
            // Add active class to clicked nav item
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            }
            
            // Load section data
            switch(sectionId) {
                case 'home':
                    loadHomePage();
                    break;
                case 'about':
                    loadAboutPage();
                    break;
                case 'management':
                    loadManagementPage();
                    break;
                case 'events':
                    loadEventsPage();
                    break;
                case 'blog':
                    loadBlogPage();
                    break;
                case 'resources':
                    loadResourcesPage();
                    break;
                case 'contact':
                    loadContactPage();
                    break;
            }
        }
        
        function showHomeTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.home-tab').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            const tab = document.getElementById('home' + tabId.charAt(0).toUpperCase() + tabId.slice(1) + 'Tab');
            if (tab) {
                tab.style.display = 'block';
                tab.classList.add('active');
            }
            
            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        // ================== PAGE FUNCTIONS ==================
      async function loadHomePage() {
    console.log("Loading home page...");
    
    try {
        const { data: settings, error } = await cmsSupabase
            .from('system_settings')
            .select('setting_key, setting_value')
            .eq('category', 'home_page');
        
        if (!error && settings) {
            console.log('Found', settings.length, 'homepage settings');
            
            settings.forEach(setting => {
                // Hero Section
                if (setting.setting_key === 'home_title') {
                    document.getElementById('homeTitle').value = setting.setting_value || "Your Nursing Career Journey Starts Here";
                    document.getElementById('previewTitle').textContent = setting.setting_value || "Your Nursing Career Journey Starts Here";
                }
                if (setting.setting_key === 'home_subtitle') {
                    document.getElementById('homeSubtitle').value = setting.setting_value || "Join Kenya's largest community of nursing students and novice nurses. Access mentorship, resources, and career opportunities.";
                    document.getElementById('previewSubtitle').textContent = setting.setting_value?.substring(0, 100) + "..." || "Join Kenya's largest community of nursing students and novice nurses...";
                }
                if (setting.setting_key === 'hero_image_url') {
                    document.getElementById('heroImageUrl').value = setting.setting_value || "https://images.unsplash.com/photo-1551601651-2a8555f1a136?ixlib=rb-4.0.3";
                }
                if (setting.setting_key === 'cta_button_text') {
                    document.getElementById('ctaButtonText').value = setting.setting_value || "Join KESNNUR Today";
                }
                
                // Statistics
                if (setting.setting_key === 'stat_members') {
                    document.getElementById('statMembers').value = setting.setting_value || "1,500+";
                }
                if (setting.setting_key === 'stat_events') {
                    document.getElementById('statEvents').value = setting.setting_value || "50+";
                }
                if (setting.setting_key === 'stat_regions') {
                    document.getElementById('statRegions').value = setting.setting_value || "24";
                }
                
                // Reviews Section
                if (setting.setting_key === 'reviews_title') {
                    document.getElementById('reviewsTitle').value = setting.setting_value || "What Our Members Say";
                }
                if (setting.setting_key === 'review1_name') {
                    document.getElementById('review1Name').value = setting.setting_value || "Sarah M.";
                }
                if (setting.setting_key === 'review1_role') {
                    document.getElementById('review1Role').value = setting.setting_value || "3rd Year Nursing Student";
                }
                if (setting.setting_key === 'review1_institution') {
                    document.getElementById('review1Institution').value = setting.setting_value || "University of Nairobi";
                }
                if (setting.setting_key === 'review1_text') {
                    document.getElementById('review1Text').value = setting.setting_value || "KESNNUR mentorship program transformed my nursing journey. My mentor guided me through clinical rotations.";
                }
                if (setting.setting_key === 'review1_rating') {
                    document.getElementById('review1Rating').value = setting.setting_value || "5";
                }
                
                // ... Add similar for review2 and review3
                
                // Features Section
                if (setting.setting_key === 'features_title') {
                    document.getElementById('featuresTitle').value = setting.setting_value || "How We Support Your Growth";
                }
                if (setting.setting_key === 'feature1_icon') {
                    document.getElementById('feature1Icon').value = setting.setting_value || "fas fa-user-graduate";
                }
                if (setting.setting_key === 'feature1_title') {
                    document.getElementById('feature1Title').value = setting.setting_value || "Mentorship & Guidance";
                }
                if (setting.setting_key === 'feature1_desc') {
                    document.getElementById('feature1Desc').value = setting.setting_value || "Connect with experienced nurse mentors for personalized career guidance.";
                }
                if (setting.setting_key === 'feature1_link') {
                    document.getElementById('feature1Link').value = setting.setting_value || "Find a Mentor";
                }
                if (setting.setting_key === 'feature1_url') {
                    document.getElementById('feature1Url').value = setting.setting_value || "about.html#mentorship";
                }
                
                // ... Add similar for feature2 and feature3
                
                // Events Section
                if (setting.setting_key === 'events_section_title') {
                    document.getElementById('eventsSectionTitle').value = setting.setting_value || "Upcoming Events";
                }
                if (setting.setting_key === 'events_section_subtitle') {
                    document.getElementById('eventsSectionSubtitle').value = setting.setting_value || "Join our upcoming workshops and networking events";
                }
                if (setting.setting_key === 'events_view_all_text') {
                    document.getElementById('eventsViewAllText').value = setting.setting_value || "View All Events";
                }
                
                // Blog Section
                if (setting.setting_key === 'blog_section_title') {
                    document.getElementById('blogSectionTitle').value = setting.setting_value || "Latest from Our Blog";
                }
                if (setting.setting_key === 'blog_section_subtitle') {
                    document.getElementById('blogSectionSubtitle').value = setting.setting_value || "Insights and stories from the nursing community";
                }
                if (setting.setting_key === 'blog_view_all_text') {
                    document.getElementById('blogViewAllText').value = setting.setting_value || "View All Posts";
                }
                
                // Partners Section
                if (setting.setting_key === 'partners_section_title') {
                    document.getElementById('partnersSectionTitle').value = setting.setting_value || "Our Trusted Partners";
                }
                
                // CTA Section
                if (setting.setting_key === 'cta_title') {
                    document.getElementById('ctaTitle').value = setting.setting_value || "Ready to Join KESNNUR?";
                }
                if (setting.setting_key === 'cta_description') {
                    document.getElementById('ctaDescription').value = setting.setting_value || "Become part of Kenya's largest community of nursing students and novice nurses.";
                }
                if (setting.setting_key === 'cta_primary_button') {
                    document.getElementById('ctaPrimaryButton').value = setting.setting_value || "Join Now";
                }
                if (setting.setting_key === 'cta_secondary_button') {
                    document.getElementById('ctaSecondaryButton').value = setting.setting_value || "Contact Us";
                }
            });
        }
    } catch (error) {
        console.log("Using default home page values:", error);
        setDefaultHomeValues();
    }
    
    // Load partners
    await loadPartnersCMS();
}

function setDefaultHomeValues() {
    // Hero
    document.getElementById('homeTitle').value = "Your Nursing Career Journey Starts Here";
    document.getElementById('homeSubtitle').value = "Join Kenya's largest community of nursing students and novice nurses. Access mentorship, resources, and career opportunities.";
    document.getElementById('heroImageUrl').value = "https://images.unsplash.com/photo-1551601651-2a8555f1a136?ixlib=rb-4.0.3";
    document.getElementById('ctaButtonText').value = "Join KESNNUR Today";
    
    // Stats
    document.getElementById('statMembers').value = "1,500+";
    document.getElementById('statEvents').value = "50+";
    document.getElementById('statRegions').value = "24";
    
    // Features
    document.getElementById('feature1Icon').value = "fas fa-user-graduate";
    document.getElementById('feature1Title').value = "Mentorship & Guidance";
    document.getElementById('feature1Desc').value = "Connect with experienced nurse mentors for personalized career guidance.";
    document.getElementById('feature1Link').value = "Find a Mentor";
    document.getElementById('feature1Url').value = "about.html#mentorship";
    
    document.getElementById('feature2Icon').value = "fas fa-book-medical";
    document.getElementById('feature2Title').value = "Continuous Education";
    document.getElementById('feature2Desc').value = "Access workshops and latest research to excel in nursing practice.";
    document.getElementById('feature2Link').value = "View Resources";
    document.getElementById('feature2Url').value = "resources.html";
    
    document.getElementById('feature3Icon').value = "fas fa-heart";
    document.getElementById('feature3Title').value = "Mental Health Support";
    document.getElementById('feature3Desc').value = "Resources and peer networks to promote wellbeing and resilience.";
    document.getElementById('feature3Link').value = "Explore Resources";
    document.getElementById('feature3Url').value = "resources.html#mental-health";
    
    // Preview
    document.getElementById('previewTitle').textContent = document.getElementById('homeTitle').value;
    document.getElementById('previewSubtitle').textContent = document.getElementById('homeSubtitle').value.substring(0, 100) + "...";
}
      async function saveHomePage() {
    // Get ALL values from ALL tabs
    const settings = [
        // Hero Section
        { setting_key: 'home_title', setting_value: document.getElementById('homeTitle').value, category: 'home_page' },
        { setting_key: 'home_subtitle', setting_value: document.getElementById('homeSubtitle').value, category: 'home_page' },
        { setting_key: 'hero_image_url', setting_value: document.getElementById('heroImageUrl').value, category: 'home_page' },
        { setting_key: 'cta_button_text', setting_value: document.getElementById('ctaButtonText').value, category: 'home_page' },
        
        // Statistics
        { setting_key: 'stat_members', setting_value: document.getElementById('statMembers').value, category: 'home_page' },
        { setting_key: 'stat_events', setting_value: document.getElementById('statEvents').value, category: 'home_page' },
        { setting_key: 'stat_regions', setting_value: document.getElementById('statRegions').value, category: 'home_page' },
        
        // Reviews
        { setting_key: 'reviews_title', setting_value: document.getElementById('reviewsTitle').value, category: 'home_page' },
        { setting_key: 'review1_name', setting_value: document.getElementById('review1Name').value, category: 'home_page' },
        { setting_key: 'review1_role', setting_value: document.getElementById('review1Role').value, category: 'home_page' },
        { setting_key: 'review1_institution', setting_value: document.getElementById('review1Institution').value, category: 'home_page' },
        { setting_key: 'review1_text', setting_value: document.getElementById('review1Text').value, category: 'home_page' },
        { setting_key: 'review1_rating', setting_value: document.getElementById('review1Rating').value, category: 'home_page' },
        
        // Features
        { setting_key: 'features_title', setting_value: document.getElementById('featuresTitle').value, category: 'home_page' },
        { setting_key: 'feature1_icon', setting_value: document.getElementById('feature1Icon').value, category: 'home_page' },
        { setting_key: 'feature1_title', setting_value: document.getElementById('feature1Title').value, category: 'home_page' },
        { setting_key: 'feature1_desc', setting_value: document.getElementById('feature1Desc').value, category: 'home_page' },
        { setting_key: 'feature1_link', setting_value: document.getElementById('feature1Link').value, category: 'home_page' },
        { setting_key: 'feature1_url', setting_value: document.getElementById('feature1Url').value, category: 'home_page' },
        
        // ... Add similar for review2, review3, feature2, feature3, events, blog, partners, cta
        
        // Events Section
        { setting_key: 'events_section_title', setting_value: document.getElementById('eventsSectionTitle').value, category: 'home_page' },
        { setting_key: 'events_section_subtitle', setting_value: document.getElementById('eventsSectionSubtitle').value, category: 'home_page' },
        { setting_key: 'events_view_all_text', setting_value: document.getElementById('eventsViewAllText').value, category: 'home_page' },
        
        // Blog Section
        { setting_key: 'blog_section_title', setting_value: document.getElementById('blogSectionTitle').value, category: 'home_page' },
        { setting_key: 'blog_section_subtitle', setting_value: document.getElementById('blogSectionSubtitle').value, category: 'home_page' },
        { setting_key: 'blog_view_all_text', setting_value: document.getElementById('blogViewAllText').value, category: 'home_page' },
        
        // Partners Section
        { setting_key: 'partners_section_title', setting_value: document.getElementById('partnersSectionTitle').value, category: 'home_page' },
        
        // CTA Section
        { setting_key: 'cta_title', setting_value: document.getElementById('ctaTitle').value, category: 'home_page' },
        { setting_key: 'cta_description', setting_value: document.getElementById('ctaDescription').value, category: 'home_page' },
        { setting_key: 'cta_primary_button', setting_value: document.getElementById('ctaPrimaryButton').value, category: 'home_page' },
        { setting_key: 'cta_secondary_button', setting_value: document.getElementById('ctaSecondaryButton').value, category: 'home_page' }
    ];
    
    try {
        let successCount = 0;
        let errorCount = 0;
        
        for (const setting of settings) {
            try {
                const { error } = await cmsSupabase
                    .from('system_settings')
                    .upsert({
                        setting_key: setting.setting_key,
                        setting_value: setting.setting_value,
                        category: setting.category,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'setting_key' });
                
                if (error) {
                    console.error('Error saving:', setting.setting_key, error);
                    errorCount++;
                } else {
                    successCount++;
                }
            } catch (err) {
                console.error('Failed to save', setting.setting_key, err);
                errorCount++;
            }
        }
        
        // Update preview
        document.getElementById('previewTitle').textContent = document.getElementById('homeTitle').value;
        document.getElementById('previewSubtitle').textContent = document.getElementById('homeSubtitle').value.substring(0, 100) + "...";
        
        alert(`Homepage saved! ${successCount} settings saved successfully.${errorCount > 0 ? ` ${errorCount} errors occurred.` : ''}`);
    } catch (error) {
        alert('Error saving homepage: ' + error.message);
    }
}
        // Load partners in CMS
async function loadPartnersCMS() {
    const container = document.getElementById('partnersList');
    if (!container) return;
    
    try {
        // Select columns that actually exist
        const { data: partners, error } = await cmsSupabase
            .from('partners')
            .select('id, name, description, logo_url, status') // Use logo_url, not logo_emoji
            .order('name', { ascending: true })
            .limit(20);
        
        if (error) throw error;
        
        container.innerHTML = '';
        
        if (partners && partners.length > 0) {
            partners.forEach(partner => {
                // Use logo_url if available, otherwise use emoji fallback
                let logoHtml = '';
                if (partner.logo_url && partner.logo_url.trim() !== '') {
                    // Check if it's an emoji or URL
                    if (partner.logo_url.startsWith('http')) {
                        logoHtml = `<img src="${partner.logo_url}" alt="${partner.name}" class="w-8 h-8 object-contain">`;
                    } else {
                        // It's an emoji text
                        logoHtml = `<div class="text-2xl">${partner.logo_url}</div>`;
                    }
                } else {
                    // Fallback emoji based on name
                    const emojiMap = {
                        'NNAK': '📘', 'NCK': '🏛️', 'MOH': '🏥', 'KNH': '❤️',
                        'UoN': '🎓', 'KMTC': '⚕️', 'WHO': '🌍', 'ICN': '🤝'
                    };
                    const emoji = emojiMap[partner.name] || '🤝';
                    logoHtml = `<div class="text-2xl">${emoji}</div>`;
                }
                
                const statusBadge = partner.status === 'active' 
                    ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Active</span>'
                    : '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Inactive</span>';
                
                const partnerDiv = document.createElement('div');
                partnerDiv.className = 'bg-gray-50 p-4 rounded-lg';
                partnerDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 flex items-center justify-center">
                                ${logoHtml}
                            </div>
                            <div>
                                <div class="flex items-center space-x-2">
                                    <h4 class="font-bold">${partner.name}</h4>
                                    ${statusBadge}
                                </div>
                                <p class="text-sm text-gray-600">${partner.description || ''}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editPartner('${partner.id}')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletePartner('${partner.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(partnerDiv);
            });
        } else {
            container.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <p class="text-yellow-700">No partners added yet.</p>
                    <button onclick="addPartner()" class="mt-2 text-blue-600 hover:text-blue-800 font-medium">
                        <i class="fas fa-plus mr-1"></i> Add First Partner
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading partners:', error);
        container.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                <p class="text-red-700">Error loading partners. Check console.</p>
            </div>
        `;
    }
}

// Add new partner
function addPartner() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Add Partner</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Partner Name *</label>
                    <input type="text" id="partnerName" class="w-full border rounded-lg p-2" placeholder="NNAK" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Description</label>
                    <input type="text" id="partnerDesc" class="w-full border rounded-lg p-2" placeholder="National Nurses Association of Kenya">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Logo (URL or Emoji)</label>
                    <input type="text" id="partnerLogo" class="w-full border rounded-lg p-2" placeholder="https://example.com/logo.png or 📘">
                    <p class="text-sm text-gray-500 mt-1">Enter image URL or single emoji character</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Website URL</label>
                    <input type="text" id="partnerWebsite" class="w-full border rounded-lg p-2" placeholder="https://example.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Partner Type</label>
                    <select id="partnerType" class="w-full border rounded-lg p-2">
                        <option value="organization">Organization</option>
                        <option value="sponsor">Sponsor</option>
                        <option value="academic">Academic</option>
                        <option value="government">Government</option>
                    </select>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg">Cancel</button>
                <button onclick="savePartner()" class="px-4 py-2 bg-blue-900 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i> Save Partner
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

async function savePartner() {
    const name = document.getElementById('partnerName').value;
    const description = document.getElementById('partnerDesc').value;
    const logo = document.getElementById('partnerLogo').value;
    const website = document.getElementById('partnerWebsite').value;
    const type = document.getElementById('partnerType').value;
    
    if (!name) {
        alert('Partner name is required');
        return;
    }
    
    try {
        const { error } = await cmsSupabase
            .from('partners')
            .insert({
                name: name,
                description: description || '',
                logo_url: logo || '',
                website_url: website || '',
                partner_type: type,
                status: 'active',
                partnership_level: 'partner',
                start_date: new Date().toISOString().split('T')[0]
            });
        
        if (error) throw error;
        
        alert('Partner added successfully!');
        document.querySelector('.fixed').remove();
        loadPartnersCMS();
        
    } catch (error) {
        alert('Error saving partner: ' + error.message);
    }
}
async function deletePartner(id) {
    if (confirm('Are you sure you want to delete this partner?')) {
        try {
            const { error } = await cmsSupabase
                .from('partners')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
            
            alert('Partner deleted successfully!');
            loadPartnersCMS();
            
        } catch (error) {
            alert('Error deleting partner: ' + error.message);
        }
    }
}
        async function loadAboutPage() {
            console.log("Loading about page...");
            // Try to load from system_settings
            try {
                const { data: settings, error } = await cmsSupabase
                    .from('system_settings')
                    .select('setting_key, setting_value')
                    .eq('category', 'about_page');
                
                if (!error && settings) {
                    settings.forEach(setting => {
                        switch(setting.setting_key) {
                            case 'about_title':
                                document.getElementById('aboutTitle').value = setting.setting_value || "About KESNNUR";
                                break;
                            case 'about_mission':
                                document.getElementById('aboutMission').value = setting.setting_value || "Our mission is to empower Kenya's future nursing leaders...";
                                break;
                            case 'about_vision':
                                document.getElementById('aboutVision').value = setting.setting_value || "Our vision is to create a premier network...";
                                break;
                            case 'about_history':
                                if (aboutHistoryEditor && setting.setting_value) {
                                    aboutHistoryEditor.root.innerHTML = setting.setting_value;
                                }
                                break;
                        }
                    });
                }
            } catch (error) {
                // Set default values
                document.getElementById('aboutTitle').value = "About KESNNUR";
                document.getElementById('aboutMission').value = "Our mission is to empower Kenya's future nursing leaders through education, mentorship, and community building.";
                document.getElementById('aboutVision').value = "Our vision is to create a premier network of nursing professionals who drive healthcare excellence in Kenya.";
                
                if (aboutHistoryEditor) {
                    aboutHistoryEditor.root.innerHTML = `
                        <p><strong>KESNNUR History</strong></p>
                        <p>Founded in 2020, the Kenya Student Nurses and Novice Nurses Union & Registry (KESNNUR) was established to bridge the gap between nursing education and professional practice.</p>
                        <p>We have grown to become Kenya's leading community for nursing students and novice nurses.</p>
                    `;
                }
            }
        }
        
        async function saveAboutPage() {
            const aboutTitle = document.getElementById('aboutTitle').value;
            const aboutMission = document.getElementById('aboutMission').value;
            const aboutVision = document.getElementById('aboutVision').value;
            const aboutHistory = aboutHistoryEditor ? aboutHistoryEditor.root.innerHTML : '';
            
            const settings = [
                { setting_key: 'about_title', setting_value: aboutTitle, category: 'about_page' },
                { setting_key: 'about_mission', setting_value: aboutMission, category: 'about_page' },
                { setting_key: 'about_vision', setting_value: aboutVision, category: 'about_page' },
                { setting_key: 'about_history', setting_value: aboutHistory, category: 'about_page' }
            ];
            
            try {
                for (const setting of settings) {
                    await cmsSupabase
                        .from('system_settings')
                        .upsert({
                            setting_key: setting.setting_key,
                            setting_value: setting.setting_value,
                            category: setting.category,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'setting_key' });
                }
                
                alert('About page saved successfully!');
            } catch (error) {
                alert('Error saving: ' + error.message);
            }
        }
        
    // ================== MANAGEMENT PAGE FUNCTIONS ==================
async function loadManagementPage() {
    console.log("Loading management page...");
    
    const nationalContainer = document.getElementById('managementMembers');
    const regionalContainer = document.getElementById('regionalMembers');
    const adhocContainer = document.getElementById('adhocMembers');
    
    // Create containers if they don't exist
    if (!regionalContainer) {
        console.warn('Regional container not found in DOM');
    }
    if (!adhocContainer) {
        console.warn('Adhoc container not found in DOM');
    }
    
    try {
        // Load ALL management sections at once (more efficient)
        const { data: allSections, error } = await cmsSupabase
            .from('management_sections')
            .select('*')
            .eq('is_active', true)
            .order('section_type', { ascending: true })
            .order('display_order', { ascending: true });
        
        if (error) throw error;
        
        // Separate by type
        const nationalCouncil = allSections.filter(s => s.section_type === 'national_council');
        const regional = allSections.filter(s => s.section_type === 'regional');
        const adhoc = allSections.filter(s => s.section_type === 'ad_hoc');
        
        console.log(`Loaded: ${nationalCouncil.length} NGC, ${regional.length} Regional, ${adhoc.length} Ad Hoc`);
        
        // Render National Council
        renderNationalCouncilCMS(nationalCouncil, nationalContainer);
        
        // Render Regional Committees
        if (regionalContainer) {
            renderRegionalCommitteesCMS(regional, regionalContainer);
        } else {
            console.error('Regional container not found! Check HTML structure.');
        }
        
        // Render Ad Hoc Committees
        if (adhocContainer) {
            renderAdHocCommitteesCMS(adhoc, adhocContainer);
        } else {
            console.error('Adhoc container not found! Check HTML structure.');
        }
        
    } catch (error) {
        console.error("Error loading management data:", error);
    }
}

// Render National Council in CMS
function renderNationalCouncilCMS(members, container) {
    if (!container) {
        console.error('National container not found');
        return;
    }
    
    if (!members || members.length === 0) {
        container.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                <p class="text-blue-700">No National Council members added yet.</p>
                <p class="text-sm text-blue-600 mt-1">Use "Add Team Member" and select "National Council"</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    members.forEach(member => {
        const colorMap = {
            'blue': 'from-blue-900 to-blue-700',
            'teal': 'from-teal-700 to-teal-500',
            'purple': 'from-purple-700 to-purple-500',
            'amber': 'from-amber-700 to-amber-500',
            'cyan': 'from-cyan-700 to-cyan-500',
            'red': 'from-red-700 to-red-500',
            'pink': 'from-pink-700 to-pink-500',
            'indigo': 'from-indigo-700 to-indigo-500',
            'green': 'from-green-700 to-green-500'
        };
        
        const hasImage = member.profile_image_url && member.profile_image_url.trim() !== '';
        const socialHandles = member.social_handles || {};
        const socialIconsHTML = generateSocialIcons(socialHandles);
        
        html += `
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-start mb-3">
                            <!-- Profile Picture or Initials -->
                            <div class="w-16 h-16 ${colorMap[member.color_scheme] || 'from-blue-900 to-blue-700'} rounded-full flex items-center justify-center overflow-hidden mr-4">
                                ${hasImage ? 
                                    `<img src="${member.profile_image_url}" 
                                          alt="${member.person_name}" 
                                          class="w-full h-full object-cover">` :
                                    `<span class="text-white font-bold text-xl">
                                        ${member.avatar_initials || member.person_name.charAt(0)}
                                     </span>`
                                }
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-lg">${member.person_name}</h4>
                                <p class="text-blue-900 font-semibold">${member.position}</p>
                                
                                ${socialIconsHTML ? `
                                    <div class="flex space-x-2 mt-2">
                                        ${socialIconsHTML}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <p class="text-gray-600 text-sm mt-2">${member.description}</p>
                        
                        ${member.tags && member.tags.length > 0 ? `
                            <div class="flex flex-wrap gap-1 mt-3">
                                ${member.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        ${Object.keys(socialHandles).some(key => socialHandles[key] && socialHandles[key].trim() !== '') ? `
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <p class="text-xs text-gray-500 mb-1">Social Media:</p>
                                <div class="text-xs space-y-1">
                                    ${socialHandles.twitter ? `<div>Twitter: ${socialHandles.twitter}</div>` : ''}
                                    ${socialHandles.linkedin ? `<div>LinkedIn: ${socialHandles.linkedin}</div>` : ''}
                                    ${socialHandles.instagram ? `<div>Instagram: ${socialHandles.instagram}</div>` : ''}
                                    ${socialHandles.facebook ? `<div>Facebook: ${socialHandles.facebook}</div>` : ''}
                                    ${socialHandles.email ? `<div>Email: ${socialHandles.email}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editTeamMember('${member.id}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTeamMember('${member.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render Regional Committees in CMS
function renderRegionalCommitteesCMS(committees, container) {
    if (!committees || committees.length === 0) {
        container.innerHTML = `
            <div class="bg-teal-50 border border-teal-200 rounded-lg p-4 text-center">
                <p class="text-teal-700">No Regional Committees added yet.</p>
                <p class="text-sm text-teal-600 mt-1">Use "Add Team Member" and select "Regional Committee"</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    committees.forEach(committee => {
        const hasImage = committee.profile_image_url && committee.profile_image_url.trim() !== '';
        const socialHandles = committee.social_handles || {};
        const socialIconsHTML = generateSocialIcons(socialHandles);
        
        html += `
            <div class="bg-white rounded-lg border p-4">
                <div class="flex justify-between items-start">
                    <div class="flex items-start">
                        ${hasImage ? `
                            <img src="${committee.profile_image_url}" 
                                 alt="${committee.person_name}" 
                                 class="w-12 h-12 rounded-full object-cover mr-3">
                        ` : `
                            <div class="w-12 h-12 bg-gradient-to-r from-teal-500 to-teal-700 rounded-full 
                                      flex items-center justify-center text-white font-bold mr-3">
                                ${committee.person_name.charAt(0)}
                            </div>
                        `}
                        <div class="flex-1">
                            <h4 class="font-bold mb-1">${committee.person_name}</h4>
                            <p class="text-teal-700 font-semibold text-sm">${committee.position}</p>
                            <p class="text-gray-600 text-sm mb-2">${committee.description}</p>
                            
                            ${socialIconsHTML ? `
                                <div class="flex space-x-2 mt-2">
                                    ${socialIconsHTML}
                                </div>
                            ` : ''}
                            
                            ${committee.tags && committee.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${committee.tags.map(tag => `
                                        <span class="bg-teal-100 text-teal-800 text-xs px-2 py-1 rounded">${tag}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editTeamMember('${committee.id}')" class="text-teal-600 hover:text-teal-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTeamMember('${committee.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render Ad Hoc Committees in CMS
function renderAdHocCommitteesCMS(committees, container) {
    if (!committees || committees.length === 0) {
        container.innerHTML = `
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                <p class="text-purple-700">No Ad Hoc Committees added yet.</p>
                <p class="text-sm text-purple-600 mt-1">Use "Add Team Member" and select "Ad Hoc Committee"</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    committees.forEach(committee => {
        const hasImage = committee.profile_image_url && committee.profile_image_url.trim() !== '';
        const socialHandles = committee.social_handles || {};
        const socialIconsHTML = generateSocialIcons(socialHandles);
        
        html += `
            <div class="bg-white rounded-lg border p-4">
                <div class="flex justify-between items-start">
                    <div class="flex items-start">
                        ${hasImage ? `
                            <img src="${committee.profile_image_url}" 
                                 alt="${committee.person_name}" 
                                 class="w-12 h-12 rounded-full object-cover mr-3">
                        ` : `
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-700 rounded-full 
                                      flex items-center justify-center text-white font-bold mr-3">
                                ${committee.person_name.charAt(0)}
                            </div>
                        `}
                        <div class="flex-1">
                            <h4 class="font-bold mb-1">${committee.person_name}</h4>
                            <p class="text-purple-700 font-semibold text-sm">${committee.position}</p>
                            <p class="text-gray-600 text-sm mb-2">${committee.description}</p>
                            
                            ${socialIconsHTML ? `
                                <div class="flex space-x-2 mt-2">
                                    ${socialIconsHTML}
                                </div>
                            ` : ''}
                            
                            ${committee.tags && committee.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${committee.tags.map(tag => `
                                        <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">${tag}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editTeamMember('${committee.id}')" class="text-purple-600 hover:text-purple-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTeamMember('${committee.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Tab switching function
function showManagementTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.management-tab').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab
    const tab = document.getElementById(tabName + 'Tab');
    if (tab) {
        tab.style.display = 'block';
        tab.classList.add('active');
    }
    
    // Add active class to clicked button
    if (event && event.target) {
        event.target.classList.add('active');
    }
}

// Helper function to generate social media icons
function generateSocialIcons(socialHandles) {
    const icons = [];
    
    if (socialHandles.twitter && socialHandles.twitter.trim() !== '') {
        icons.push(`<a href="https://twitter.com/${socialHandles.twitter.replace('@', '')}" 
                      target="_blank" 
                      class="text-blue-500 hover:text-blue-700"
                      title="Twitter">
                     <i class="fab fa-twitter"></i>
                   </a>`);
    }
    
    if (socialHandles.linkedin && socialHandles.linkedin.trim() !== '') {
        const linkedinUrl = socialHandles.linkedin.startsWith('http') ? 
                           socialHandles.linkedin : 
                           'https://' + socialHandles.linkedin;
        icons.push(`<a href="${linkedinUrl}" 
                      target="_blank" 
                      class="text-blue-800 hover:text-blue-900"
                      title="LinkedIn">
                     <i class="fab fa-linkedin"></i>
                   </a>`);
    }
    
    if (socialHandles.instagram && socialHandles.instagram.trim() !== '') {
        icons.push(`<a href="https://instagram.com/${socialHandles.instagram.replace('@', '')}" 
                      target="_blank" 
                      class="text-pink-600 hover:text-pink-800"
                      title="Instagram">
                     <i class="fab fa-instagram"></i>
                   </a>`);
    }
    
    if (socialHandles.facebook && socialHandles.facebook.trim() !== '') {
        icons.push(`<a href="https://facebook.com/${socialHandles.facebook}" 
                      target="_blank" 
                      class="text-blue-600 hover:text-blue-800"
                      title="Facebook">
                     <i class="fab fa-facebook"></i>
                   </a>`);
    }
    
    if (socialHandles.email && socialHandles.email.trim() !== '') {
        icons.push(`<a href="mailto:${socialHandles.email}" 
                      class="text-red-600 hover:text-red-800"
                      title="Email">
                     <i class="fas fa-envelope"></i>
                   </a>`);
    }
    
    return icons.join('');
}

function addTeamMember() {
    let selectedFile = null;
    let uploadProgress = 0;
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Add Team Member</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column: Basic Info & Photo Upload -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Section Type</label>
                        <select id="memberSectionType" class="w-full border rounded-lg p-2">
                            <option value="national_council">National Council</option>
                            <option value="regional">Regional Committee</option>
                            <option value="ad_hoc">Ad Hoc Committee</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Name</label>
                        <input type="text" id="memberName" class="w-full border rounded-lg p-2" placeholder="Full Name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Position</label>
                        <input type="text" id="memberPosition" class="w-full border rounded-lg p-2" placeholder="Position/Role">
                    </div>
                    
                    <!-- Photo Upload Section -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Profile Photo</label>
                        <div class="mt-1">
                            <!-- Upload Box -->
                            <div id="uploadBox" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors">
                                <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"></i>
                                <p class="text-sm text-gray-600 mb-1">Click to upload profile photo</p>
                                <p class="text-xs text-gray-500">PNG, JPG up to 5MB</p>
                                <input type="file" id="memberPhoto" class="hidden" accept="image/*">
                            </div>
                            
                            <!-- Preview Section -->
                            <div id="photoPreview" class="mt-4 hidden">
                                <div class="flex items-center space-x-4">
                                    <img id="previewImage" class="w-20 h-20 rounded-full object-cover border-2 border-blue-200">
                                    <div class="flex-1">
                                        <p id="fileName" class="text-sm font-medium"></p>
                                        <p id="fileSize" class="text-xs text-gray-500"></p>
                                        <div class="mt-2 flex items-center space-x-2">
                                            <div id="uploadProgressBar" class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div id="progressFill" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                                            </div>
                                            <span id="progressText" class="text-xs text-gray-600">0%</span>
                                        </div>
                                    </div>
                                    <button type="button" id="removePhoto" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Color Scheme</label>
                        <select id="memberColor" class="w-full border rounded-lg p-2">
                            <option value="blue">Blue</option>
                            <option value="teal">Teal</option>
                            <option value="purple">Purple</option>
                            <option value="amber">Amber</option>
                            <option value="cyan">Cyan</option>
                            <option value="red">Red</option>
                            <option value="pink">Pink</option>
                            <option value="indigo">Indigo</option>
                            <option value="green">Green</option>
                        </select>
                    </div>
                </div>
                
                <!-- Right Column: Social & Description -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="memberDescription" class="w-full border rounded-lg p-2" rows="3" placeholder="Description"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Social Media Handles</label>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <div class="w-10 text-blue-600"><i class="fab fa-twitter"></i></div>
                                <input type="text" id="memberTwitter" class="flex-1 border rounded-lg p-2" placeholder="@username">
                            </div>
                            <div class="flex items-center">
                                <div class="w-10 text-blue-800"><i class="fab fa-linkedin"></i></div>
                                <input type="text" id="memberLinkedin" class="flex-1 border rounded-lg p-2" placeholder="linkedin.com/in/username">
                            </div>
                            <div class="flex items-center">
                                <div class="w-10 text-pink-600"><i class="fab fa-instagram"></i></div>
                                <input type="text" id="memberInstagram" class="flex-1 border rounded-lg p-2" placeholder="@username">
                            </div>
                            <div class="flex items-center">
                                <div class="w-10 text-blue-600"><i class="fab fa-facebook"></i></div>
                                <input type="text" id="memberFacebook" class="flex-1 border rounded-lg p-2" placeholder="facebook.com/username">
                            </div>
                            <div class="flex items-center">
                                <div class="w-10 text-red-600"><i class="fas fa-envelope"></i></div>
                                <input type="text" id="memberEmail" class="flex-1 border rounded-lg p-2" placeholder="email@example.com">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Tags (comma separated)</label>
                        <input type="text" id="memberTags" class="w-full border rounded-lg p-2" placeholder="Leadership, Strategy, Advocacy">
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg">Cancel</button>
                <button onclick="saveNewTeamMemberWithPhoto()" class="px-4 py-2 bg-blue-900 text-white rounded-lg">
                    <i class="fas fa-save mr-2"></i> Save Member
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add event listeners for file upload
    setTimeout(() => {
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('memberPhoto');
        const previewSection = document.getElementById('photoPreview');
        const previewImage = document.getElementById('previewImage');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removePhoto = document.getElementById('removePhoto');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        // Click upload box to trigger file input
        uploadBox.addEventListener('click', () => fileInput.click());
        
        // Handle file selection
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file (PNG, JPG, JPEG)');
                    return;
                }
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    return;
                }
                
                selectedFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewSection.classList.remove('hidden');
                    uploadBox.classList.add('hidden');
                    
                    // Show file info
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    
                    // Reset progress
                    uploadProgress = 0;
                    progressFill.style.width = '0%';
                    progressText.textContent = '0%';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Remove photo
        removePhoto.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            previewSection.classList.add('hidden');
            uploadBox.classList.remove('hidden');
            
            // Reset progress
            uploadProgress = 0;
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
        });
        
        // Function to update progress
        window.updateUploadProgress = (progress) => {
            uploadProgress = progress;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
        };
        
    }, 100);
}

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

async function saveNewTeamMemberWithPhoto() {
    const sectionType = document.getElementById('memberSectionType').value;
    const name = document.getElementById('memberName').value;
    const position = document.getElementById('memberPosition').value;
    const description = document.getElementById('memberDescription').value;
    const color = document.getElementById('memberColor').value;
    const tagsInput = document.getElementById('memberTags').value;
    const twitter = document.getElementById('memberTwitter').value;
    const linkedin = document.getElementById('memberLinkedin').value;
    const instagram = document.getElementById('memberInstagram').value;
    const facebook = document.getElementById('memberFacebook').value;
    const email = document.getElementById('memberEmail').value;
    
    // Validate required fields
    if (!name || !position) {
        alert('Name and Position are required fields');
        return;
    }
    
    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
    const socialHandles = {
        twitter: twitter || '',
        linkedin: linkedin || '',
        instagram: instagram || '',
        facebook: facebook || '',
        email: email || ''
    };
    
    try {
        let imageUrl = null;
        
        // Upload photo if selected
        const fileInput = document.getElementById('memberPhoto');
        const selectedFile = fileInput.files[0];
        
        if (selectedFile) {
            // Generate unique filename
            const fileName = `profile_${Date.now()}_${selectedFile.name.replace(/\s+/g, '_')}`;
            const filePath = `${sectionType}/${fileName}`;
            
            // Show uploading state
            const saveButton = document.querySelector('button[onclick="saveNewTeamMemberWithPhoto()"]');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
            saveButton.disabled = true;
            
            // Upload to Supabase Storage
            const { data: uploadData, error: uploadError } = await cmsSupabase.storage
                .from('profile-images')
                .upload(filePath, selectedFile, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (uploadError) throw uploadError;
            
            // Get public URL
            const { data: { publicUrl } } = cmsSupabase.storage
                .from('profile-images')
                .getPublicUrl(filePath);
            
            imageUrl = publicUrl;
            
            // Reset button
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        }
        
        // Save member data to database
        const { error: dbError } = await cmsSupabase
            .from('management_sections')
            .insert({
                section_type: sectionType,
                person_name: name,
                position: position,
                description: description,
                profile_image_url: imageUrl,
                social_handles: socialHandles,
                color_scheme: color,
                tags: tags.length > 0 ? tags : null,
                avatar_initials: name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2),
                display_order: 99,
                is_active: true
            });
        
        if (dbError) throw dbError;
        
        alert('Team member added successfully!');
        document.querySelector('.fixed').remove();
        loadManagementPage();
        
    } catch (error) {
        alert('Error adding member: ' + error.message);
        console.error('Save error:', error);
        
        // Reset button
        const saveButton = document.querySelector('button[onclick="saveNewTeamMemberWithPhoto()"]');
        saveButton.innerHTML = '<i class="fas fa-save mr-2"></i> Save Member';
        saveButton.disabled = false;
    }
}

// Update editTeamMember function to include social media
async function editTeamMember(id) {
    try {
        const { data: member, error } = await cmsSupabase
            .from('management_sections')
            .select('*')
            .eq('id', id)
            .single();
        
        if (error) throw error;
        
        const socialHandles = member.social_handles || {};
        let selectedFile = null;
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">Edit Team Member</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column: Basic Info & Photo -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Section Type</label>
                            <select id="editSectionType" class="w-full border rounded-lg p-2">
                                <option value="national_council" ${member.section_type === 'national_council' ? 'selected' : ''}>National Council</option>
                                <option value="regional" ${member.section_type === 'regional' ? 'selected' : ''}>Regional Committee</option>
                                <option value="ad_hoc" ${member.section_type === 'ad_hoc' ? 'selected' : ''}>Ad Hoc Committee</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Name</label>
                            <input type="text" id="editName" class="w-full border rounded-lg p-2" value="${member.person_name}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Position</label>
                            <input type="text" id="editPosition" class="w-full border rounded-lg p-2" value="${member.position}">
                        </div>
                        
                        <!-- Photo Upload/Preview Section -->
                        <div>
                            <label class="block text-sm font-medium mb-1">Profile Photo</label>
                            <div class="mt-1">
                                <!-- Current Photo Preview -->
                                ${member.profile_image_url ? `
                                    <div class="mb-4">
                                        <p class="text-sm text-gray-600 mb-2">Current Photo:</p>
                                        <div class="flex items-center space-x-4">
                                            <img src="${member.profile_image_url}" 
                                                 alt="${member.person_name}" 
                                                 class="w-20 h-20 rounded-full object-cover border-2 border-blue-200">
                                            <div>
                                                <button type="button" onclick="removeProfilePhoto('${member.id}')" 
                                                        class="text-sm text-red-600 hover:text-red-800">
                                                    <i class="fas fa-trash mr-1"></i> Remove Photo
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Upload New Photo -->
                                <div class="mt-4">
                                    <p class="text-sm text-gray-600 mb-2">${member.profile_image_url ? 'Upload New Photo:' : 'Upload Photo:'}</p>
                                    <div id="editUploadBox" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors">
                                        <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"></i>
                                        <p class="text-sm text-gray-600 mb-1">Click to upload new photo</p>
                                        <p class="text-xs text-gray-500">PNG, JPG up to 5MB</p>
                                        <input type="file" id="editPhoto" class="hidden" accept="image/*">
                                    </div>
                                    
                                    <!-- New Photo Preview -->
                                    <div id="editPhotoPreview" class="mt-4 hidden">
                                        <div class="flex items-center space-x-4">
                                            <img id="editPreviewImage" class="w-20 h-20 rounded-full object-cover border-2 border-blue-200">
                                            <div class="flex-1">
                                                <p id="editFileName" class="text-sm font-medium"></p>
                                                <p id="editFileSize" class="text-xs text-gray-500"></p>
                                            </div>
                                            <button type="button" id="editRemovePhoto" class="text-red-600 hover:text-red-800">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Color Scheme</label>
                            <select id="editColor" class="w-full border rounded-lg p-2">
                                <option value="blue" ${member.color_scheme === 'blue' ? 'selected' : ''}>Blue</option>
                                <option value="teal" ${member.color_scheme === 'teal' ? 'selected' : ''}>Teal</option>
                                <option value="purple" ${member.color_scheme === 'purple' ? 'selected' : ''}>Purple</option>
                                <option value="amber" ${member.color_scheme === 'amber' ? 'selected' : ''}>Amber</option>
                                <option value="cyan" ${member.color_scheme === 'cyan' ? 'selected' : ''}>Cyan</option>
                                <option value="red" ${member.color_scheme === 'red' ? 'selected' : ''}>Red</option>
                                <option value="pink" ${member.color_scheme === 'pink' ? 'selected' : ''}>Pink</option>
                                <option value="indigo" ${member.color_scheme === 'indigo' ? 'selected' : ''}>Indigo</option>
                                <option value="green" ${member.color_scheme === 'green' ? 'selected' : ''}>Green</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Right Column: Social & Description -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Description</label>
                            <textarea id="editDescription" class="w-full border rounded-lg p-2" rows="3">${member.description || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Social Media Handles</label>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <div class="w-10 text-blue-600"><i class="fab fa-twitter"></i></div>
                                    <input type="text" id="editTwitter" class="flex-1 border rounded-lg p-2" value="${socialHandles.twitter || ''}" placeholder="@username">
                                </div>
                                <div class="flex items-center">
                                    <div class="w-10 text-blue-800"><i class="fab fa-linkedin"></i></div>
                                    <input type="text" id="editLinkedin" class="flex-1 border rounded-lg p-2" value="${socialHandles.linkedin || ''}" placeholder="linkedin.com/in/username">
                                </div>
                                <div class="flex items-center">
                                    <div class="w-10 text-pink-600"><i class="fab fa-instagram"></i></div>
                                    <input type="text" id="editInstagram" class="flex-1 border rounded-lg p-2" value="${socialHandles.instagram || ''}" placeholder="@username">
                                </div>
                                <div class="flex items-center">
                                    <div class="w-10 text-blue-600"><i class="fab fa-facebook"></i></div>
                                    <input type="text" id="editFacebook" class="flex-1 border rounded-lg p-2" value="${socialHandles.facebook || ''}" placeholder="facebook.com/username">
                                </div>
                                <div class="flex items-center">
                                    <div class="w-10 text-red-600"><i class="fas fa-envelope"></i></div>
                                    <input type="text" id="editEmail" class="flex-1 border rounded-lg p-2" value="${socialHandles.email || ''}" placeholder="email@example.com">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Tags (comma separated)</label>
                            <input type="text" id="editTags" class="w-full border rounded-lg p-2" value="${member.tags ? member.tags.join(', ') : ''}" placeholder="Leadership, Strategy, Advocacy">
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg">Cancel</button>
                    <button onclick="updateTeamMemberWithPhoto('${member.id}')" class="px-4 py-2 bg-blue-900 text-white rounded-lg">
                        <i class="fas fa-save mr-2"></i> Update Member
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add file upload functionality for edit form
        setTimeout(() => {
            const uploadBox = document.getElementById('editUploadBox');
            const fileInput = document.getElementById('editPhoto');
            const previewSection = document.getElementById('editPhotoPreview');
            const previewImage = document.getElementById('editPreviewImage');
            const fileName = document.getElementById('editFileName');
            const fileSize = document.getElementById('editFileSize');
            const removePhoto = document.getElementById('editRemovePhoto');
            
            if (uploadBox && fileInput) {
                uploadBox.addEventListener('click', () => fileInput.click());
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file
                        if (!file.type.startsWith('image/')) {
                            alert('Please select an image file');
                            return;
                        }
                        
                        if (file.size > 5 * 1024 * 1024) {
                            alert('File size must be less than 5MB');
                            return;
                        }
                        
                        selectedFile = file;
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImage.src = e.target.result;
                            previewSection.classList.remove('hidden');
                            uploadBox.classList.add('hidden');
                            
                            fileName.textContent = file.name;
                            fileSize.textContent = formatFileSize(file.size);
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                removePhoto.addEventListener('click', () => {
                    selectedFile = null;
                    fileInput.value = '';
                    previewSection.classList.add('hidden');
                    uploadBox.classList.remove('hidden');
                });
            }
            
            // Store selected file for update function
            window.selectedEditFile = selectedFile;
            
        }, 100);
        
    } catch (error) {
        alert('Error loading member: ' + error.message);
    }
}

// Function to remove existing profile photo
async function removeProfilePhoto(memberId) {
    if (confirm('Are you sure you want to remove this profile photo?')) {
        try {
            const { error } = await cmsSupabase
                .from('management_sections')
                .update({ profile_image_url: null })
                .eq('id', memberId);
            
            if (error) throw error;
            
            alert('Profile photo removed successfully!');
            // Close modal and reload
            document.querySelector('.fixed').remove();
            loadManagementPage();
            
        } catch (error) {
            alert('Error removing photo: ' + error.message);
        }
    }
}

// Updated update function with photo upload
async function updateTeamMemberWithPhoto(id) {
    const sectionType = document.getElementById('editSectionType').value;
    const name = document.getElementById('editName').value;
    const position = document.getElementById('editPosition').value;
    const description = document.getElementById('editDescription').value;
    const color = document.getElementById('editColor').value;
    const tagsInput = document.getElementById('editTags').value;
    const twitter = document.getElementById('editTwitter').value;
    const linkedin = document.getElementById('editLinkedin').value;
    const instagram = document.getElementById('editInstagram').value;
    const facebook = document.getElementById('editFacebook').value;
    const email = document.getElementById('editEmail').value;
    
    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
    const socialHandles = {
        twitter: twitter || '',
        linkedin: linkedin || '',
        instagram: instagram || '',
        facebook: facebook || '',
        email: email || ''
    };
    
    try {
        let imageUrl = null;
        const fileInput = document.getElementById('editPhoto');
        
        // Check if new photo was selected
        if (fileInput && fileInput.files[0]) {
            const selectedFile = fileInput.files[0];
            const fileName = `profile_${Date.now()}_${selectedFile.name.replace(/\s+/g, '_')}`;
            const filePath = `${sectionType}/${fileName}`;
            
            // Upload new photo
            const { error: uploadError } = await cmsSupabase.storage
                .from('profile-images')
                .upload(filePath, selectedFile, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (uploadError) throw uploadError;
            
            // Get public URL
            const { data: { publicUrl } } = cmsSupabase.storage
                .from('profile-images')
                .getPublicUrl(filePath);
            
            imageUrl = publicUrl;
        }
        
        // Prepare update data
        const updateData = {
            section_type: sectionType,
            person_name: name,
            position: position,
            description: description,
            social_handles: socialHandles,
            color_scheme: color,
            tags: tags.length > 0 ? tags : null,
            avatar_initials: name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2),
            updated_at: new Date().toISOString()
        };
        
        // Only update image URL if we have a new one
        if (imageUrl) {
            updateData.profile_image_url = imageUrl;
        }
        
        // Update member in database
        const { error: dbError } = await cmsSupabase
            .from('management_sections')
            .update(updateData)
            .eq('id', id);
        
        if (dbError) throw dbError;
        
        alert('Team member updated successfully!');
        document.querySelector('.fixed').remove();
        loadManagementPage();
        
    } catch (error) {
        alert('Error updating member: ' + error.message);
        console.error('Update error:', error);
    }
}

async function deleteTeamMember(id) {
    if (confirm('Are you sure you want to delete this team member?')) {
        try {
            const { error } = await cmsSupabase
                .from('management_sections')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
            
            alert('Team member deleted successfully!');
            loadManagementPage();
            
        } catch (error) {
            alert('Error deleting member: ' + error.message);
        }
    }
}
        
      // ================== EVENTS PAGE MANAGEMENT ==================

let currentEvents = [];
let currentEventHtml = '';
let eventsPageSettings = {};

// Show different tabs
function showEventsTab(tabName) {
    // Hide all tabs
    document.getElementById('eventsManageTab').style.display = 'none';
    document.getElementById('eventsHtmlTab').style.display = 'none';
    document.getElementById('eventsPreviewTab').style.display = 'none';
    
    // Reset all tab buttons
    document.getElementById('tabManage').style.background = '#6b7280';
    document.getElementById('tabHtml').style.background = '#6b7280';
    document.getElementById('tabPreview').style.background = '#6b7280';
    
    // Show selected tab
    if (tabName === 'manage') {
        document.getElementById('eventsManageTab').style.display = 'block';
        document.getElementById('tabManage').style.background = '#1e3a8a';
        loadEventsList();
    } else if (tabName === 'html') {
        document.getElementById('eventsHtmlTab').style.display = 'block';
        document.getElementById('tabHtml').style.background = '#1e3a8a';
        loadEventsPageSettings();
    } else if (tabName === 'preview') {
        document.getElementById('eventsPreviewTab').style.display = 'block';
        document.getElementById('tabPreview').style.background = '#1e3a8a';
        refreshEventsPreview();
    }
}

// Load events list from database
async function loadEventsList() {
    const container = document.getElementById('eventsList');
    if (!container) return;
    
    container.innerHTML = `
        <div style="text-align:center; padding:40px;">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mb-4"></div>
            <p style="color:#64748b;">Loading events from database...</p>
        </div>
    `;
    
    try {
        const events = await fetchFromSupabase('events', '?order=start_date.desc');
        
        if (events && events.length > 0) {
            currentEvents = events;
            updateEventStats(events);
            renderEventsTable(events);
        } else {
            container.innerHTML = `
                <div style="text-align:center; padding:40px;">
                    <i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i>
                    <h4 style="font-size:18px; font-weight:600; color:#4b5563; margin-bottom:10px;">No Events Found</h4>
                    <p style="color:#64748b;">Create your first event to get started.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading events:', error);
        container.innerHTML = `
            <div style="text-align:center; padding:40px;">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h4 style="font-size:18px; font-weight:600; color:#4b5563; margin-bottom:10px;">Error Loading Events</h4>
                <p style="color:#64748b;">Could not connect to database.</p>
            </div>
        `;
    }
}

// Update event statistics
function updateEventStats(events) {
    const now = new Date();
    
    const total = events.length;
    const upcoming = events.filter(e => {
        const startDate = new Date(e.start_date);
        return e.status === 'published' && startDate > now;
    }).length;
    
    const drafts = events.filter(e => e.status === 'draft').length;
    const past = events.filter(e => {
        const endDate = new Date(e.end_date);
        return endDate < now;
    }).length;
    
    document.getElementById('totalEvents').textContent = total;
    document.getElementById('upcomingEvents').textContent = upcoming;
    document.getElementById('draftEvents').textContent = drafts;
    document.getElementById('pastEvents').textContent = past;
}

// Render events table
function renderEventsTable(events) {
    const container = document.getElementById('eventsList');
    if (!container) return;
    
    if (events.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:40px;">
                <i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i>
                <h4 style="font-size:18px; font-weight:600; color:#4b5563; margin-bottom:10px;">No Events Found</h4>
                <p style="color:#64748b;">Create your first event to get started.</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f9fafb; border-bottom:2px solid #e5e7eb;">
                        <th style="padding:12px; text-align:left; font-weight:600; color:#4b5563;">Event</th>
                        <th style="padding:12px; text-align:left; font-weight:600; color:#4b5563;">Date</th>
                        <th style="padding:12px; text-align:left; font-weight:600; color:#4b5563;">Status</th>
                        <th style="padding:12px; text-align:left; font-weight:600; color:#4b5563;">Type</th>
                        <th style="padding:12px; text-align:left; font-weight:600; color:#4b5563;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    events.forEach(event => {
        const startDate = new Date(event.start_date);
        const endDate = new Date(event.end_date);
        const now = new Date();
        
        // Format date
        const dateStr = startDate.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
        
        // Format time
        const timeStr = startDate.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Determine status color
        let statusColor = '';
        let statusText = event.status;
        
        if (event.status === 'published') {
            if (startDate > now) {
                statusColor = 'background:#dcfce7; color:#166534;';
                statusText = 'Upcoming';
            } else if (endDate < now) {
                statusColor = 'background:#f3f4f6; color:#6b7280;';
                statusText = 'Past';
            } else {
                statusColor = 'background:#dbeafe; color:#1d4ed8;';
                statusText = 'Ongoing';
            }
        } else if (event.status === 'draft') {
            statusColor = 'background:#fef3c7; color:#92400e;';
        } else if (event.status === 'cancelled') {
            statusColor = 'background:#fee2e2; color:#dc2626;';
        } else if (event.status === 'completed') {
            statusColor = 'background:#f0fdf4; color:#166534;';
        }
        
        // Truncate description if too long
        const description = event.description || '';
        const shortDesc = description.length > 100 
            ? description.substring(0, 100) + '...' 
            : description;
        
        html += `
            <tr style="border-bottom:1px solid #e5e7eb; background:${event.status === 'draft' ? '#fefce8' : 'white'};">
                <td style="padding:12px;">
                    <div style="display:flex; align-items:start; gap:12px;">
                        ${event.image_url ? `
                            <img src="${event.image_url}" alt="${event.title}" 
                                 style="width:60px; height:60px; object-fit:cover; border-radius:6px;">
                        ` : `
                            <div style="width:60px; height:60px; background:#e5e7eb; border-radius:6px; display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-calendar-alt text-gray-400"></i>
                            </div>
                        `}
                        <div>
                            <div style="font-weight:600; color:#1e293b; font-size:16px;">${event.title}</div>
                            <div style="font-size:14px; color:#6b7280; margin-top:4px;">${shortDesc}</div>
                        </div>
                    </div>
                </td>
                <td style="padding:12px; color:#4b5563;">
                    <div>${dateStr}</div>
                    <div style="font-size:14px; color:#6b7280;">${timeStr}</div>
                </td>
                <td style="padding:12px;">
                    <span style="padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; display:inline-block; ${statusColor}">
                        ${statusText}
                    </span>
                </td>
                <td style="padding:12px; color:#4b5563; text-transform:capitalize;">
                    ${event.event_type || 'N/A'}
                </td>
                <td style="padding:12px;">
                    <div style="display:flex; gap:8px;">
                        <button onclick="editEvent('${event.id}')" 
                                style="padding:6px 12px; background:#3b82f6; color:white; border:none; border-radius:4px; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                            <i class="fas fa-edit" style="font-size:10px;"></i> Edit
                        </button>
                        <button onclick="viewEventDetails('${event.id}')" 
                                style="padding:6px 12px; background:#10b981; color:white; border:none; border-radius:4px; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                            <i class="fas fa-eye" style="font-size:10px;"></i> View
                        </button>
                        <button onclick="deleteEvent('${event.id}')" 
                                style="padding:6px 12px; background:#ef4444; color:white; border:none; border-radius:4px; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                            <i class="fas fa-trash" style="font-size:10px;"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// Show add event form
function showAddEventForm() {
    document.getElementById('eventModalTitle').textContent = 'Add New Event';
    document.getElementById('eventId').value = '';
    document.getElementById('eventForm').reset();
    
    // Set default values
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    // Format for datetime-local input (YYYY-MM-DDTHH:MM)
    const formatDateTime = (date) => {
        return date.toISOString().slice(0, 16);
    };
    
    document.getElementById('eventStartDate').value = formatDateTime(tomorrow);
    document.getElementById('eventEndDate').value = formatDateTime(new Date(tomorrow.getTime() + 2 * 60 * 60 * 1000)); // 2 hours later
    document.getElementById('eventStatus').value = 'draft';
    
    document.getElementById('eventModal').style.display = 'flex';
}

// Edit event
async function editEvent(eventId) {
    try {
        const event = await fetchFromSupabase('events', `?id=eq.${eventId}`);
        
        if (event && event[0]) {
            const e = event[0];
            document.getElementById('eventModalTitle').textContent = 'Edit Event';
            document.getElementById('eventId').value = e.id;
            document.getElementById('eventTitle').value = e.title;
            document.getElementById('eventType').value = e.event_type;
            document.getElementById('eventStartDate').value = e.start_date.substring(0, 16);
            document.getElementById('eventEndDate').value = e.end_date.substring(0, 16);
            document.getElementById('eventVenue').value = e.venue || '';
            document.getElementById('eventDescription').value = e.description || '';
            document.getElementById('eventFee').value = e.fee_amount || '';
            document.getElementById('eventCurrency').value = e.fee_currency || 'KES';
            document.getElementById('eventImageUrl').value = e.image_url || '';
            document.getElementById('eventStatus').value = e.status;
            document.getElementById('eventCategory').value = e.category || '';
            
            document.getElementById('eventModal').style.display = 'flex';
        }
    } catch (error) {
        console.error('Error loading event:', error);
        showNotification('Error loading event details', 'error');
    }
}

// View event details
async function viewEventDetails(eventId) {
    try {
        const event = await fetchFromSupabase('events', `?id=eq.${eventId}`);
        
        if (event && event[0]) {
            const e = event[0];
            const startDate = new Date(e.start_date);
            const endDate = new Date(e.end_date);
            
            const detailsHtml = `
                <div style="padding:20px;">
                    <h3 style="font-size:24px; font-weight:bold; color:#1e293b; margin-bottom:20px;">${e.title}</h3>
                    
                    ${e.image_url ? `
                        <img src="${e.image_url}" alt="${e.title}" 
                             style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;">
                    ` : ''}
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                        <div>
                            <strong style="color:#4b5563;">Type:</strong>
                            <div style="margin-top:4px;">${e.event_type || 'N/A'}</div>
                        </div>
                        <div>
                            <strong style="color:#4b5563;">Category:</strong>
                            <div style="margin-top:4px;">${e.category || 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                        <div>
                            <strong style="color:#4b5563;">Start Date:</strong>
                            <div style="margin-top:4px;">${startDate.toLocaleString()}</div>
                        </div>
                        <div>
                            <strong style="color:#4b5563;">End Date:</strong>
                            <div style="margin-top:4px;">${endDate.toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <strong style="color:#4b5563;">Venue:</strong>
                        <div style="margin-top:4px; padding:10px; background:#f3f4f6; border-radius:6px;">${e.venue || 'N/A'}</div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <strong style="color:#4b5563;">Fee:</strong>
                        <div style="margin-top:4px;">
                            ${e.fee_amount ? `${e.fee_amount} ${e.fee_currency || 'KES'}` : 'Free'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <strong style="color:#4b5563;">Description:</strong>
                        <div style="margin-top:4px; padding:15px; background:#f8fafc; border-radius:6px; white-space:pre-wrap;">
                            ${e.description || 'No description'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <strong style="color:#4b5563;">Status:</strong>
                        <span style="padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; display:inline-block; 
                               ${getStatusColor(e.status)}">
                            ${e.status.charAt(0).toUpperCase() + e.status.slice(1)}
                        </span>
                    </div>
                    
                    <div style="margin-top:30px; display:flex; justify-content:center;">
                        <button onclick="editEvent('${e.id}')" 
                                style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;">
                            <i class="fas fa-edit mr-2"></i>Edit Event
                        </button>
                    </div>
                </div>
            `;
            
            // Create modal for details
            const modalHtml = `
                <div id="eventDetailsModal" style="display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                    <div style="background:white; border-radius:12px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto;">
                        <div style="padding:20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="font-size:20px; font-weight:600;">Event Details</h3>
                            <button onclick="document.getElementById('eventDetailsModal').remove()" 
                                    style="background:none; border:none; font-size:24px; color:#6b7280; cursor:pointer;">×</button>
                        </div>
                        ${detailsHtml}
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
    } catch (error) {
        console.error('Error viewing event:', error);
        showNotification('Error loading event details', 'error');
    }
}

// Get status color for styling
function getStatusColor(status) {
    const colors = {
        'draft': 'background:#fef3c7; color:#92400e;',
        'published': 'background:#dbeafe; color:#1d4ed8;',
        'cancelled': 'background:#fee2e2; color:#dc2626;',
        'completed': 'background:#f0fdf4; color:#166534;'
    };
    return colors[status] || 'background:#f3f4f6; color:#6b7280;';
}

// Close event modal
function closeEventModal() {
    document.getElementById('eventModal').style.display = 'none';
}

// Handle event form submission
async function handleEventFormSubmit(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    submitBtn.disabled = true;
    
    const formData = new FormData(event.target);
    const eventData = {
        title: formData.get('title'),
        event_type: formData.get('eventType'),
        start_date: formData.get('startDate'),
        end_date: formData.get('endDate'),
        venue: formData.get('venue'),
        description: formData.get('description'),
        fee_amount: formData.get('fee') ? parseFloat(formData.get('fee')) : null,
        fee_currency: formData.get('currency') || 'KES',
        image_url: formData.get('imageUrl'),
        status: formData.get('status'),
        category: formData.get('category'),
        updated_at: new Date().toISOString()
    };
    
    // Convert empty strings to null for database
    Object.keys(eventData).forEach(key => {
        if (eventData[key] === '') {
            eventData[key] = null;
        }
    });
    
    const eventId = document.getElementById('eventId').value;
    
    try {
        let result;
        
        if (eventId) {
            // Update existing event
            result = await updateInSupabase('events', eventId, eventData);
            showNotification('Event updated successfully!', 'success');
        } else {
            // Create new event
            eventData.created_at = new Date().toISOString();
            result = await insertIntoSupabase('events', eventData);
            showNotification('Event created successfully!', 'success');
        }
        
        closeEventModal();
        loadEventsList();
    } catch (error) {
        console.error('Error saving event:', error);
        showNotification('Error saving event. Please try again.', 'error');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// Delete event with confirmation
async function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
        return;
    }
    
    try {
        await deleteFromSupabase('events', eventId);
        showNotification('Event deleted successfully!', 'success');
        loadEventsList();
    } catch (error) {
        console.error('Error deleting event:', error);
        showNotification('Error deleting event. Please try again.', 'error');
    }
}

// Filter events
function filterEvents() {
    const filter = document.getElementById('eventFilter').value;
    const search = document.getElementById('eventSearch').value.toLowerCase();
    
    let filteredEvents = [...currentEvents];
    
    // Apply filter
    if (filter !== 'all') {
        const now = new Date();
        filteredEvents = filteredEvents.filter(event => {
            const startDate = new Date(event.start_date);
            const endDate = new Date(event.end_date);
            
            switch (filter) {
                case 'upcoming':
                    return event.status === 'published' && startDate > now;
                case 'published':
                    return event.status === 'published';
                case 'draft':
                    return event.status === 'draft';
                case 'past':
                    return endDate < now;
                default:
                    return true;
            }
        });
    }
    
    // Apply search
    if (search) {
        filteredEvents = filteredEvents.filter(event => 
            event.title.toLowerCase().includes(search) ||
            (event.description && event.description.toLowerCase().includes(search)) ||
            (event.venue && event.venue.toLowerCase().includes(search))
        );
    }
    
    renderEventsTable(filteredEvents);
}

// Refresh events list
function refreshEventsList() {
    loadEventsList();
}

// Load events page settings
async function loadEventsPageSettings() {
    try {
        // Load saved HTML template
        const savedHtml = await fetchFromSupabase('settings', '?key=eq.events_page_html');
        
        if (savedHtml && savedHtml[0]) {
            document.getElementById('eventsHtmlEditor').value = savedHtml[0].value || '';
            currentEventHtml = savedHtml[0].value || '';
        }
        
        // Load page settings
        const settings = await fetchFromSupabase('settings', '?key=eq.events_page_settings');
        if (settings && settings[0]) {
            eventsPageSettings = JSON.parse(settings[0].value || '{}');
            
            // Populate form fields
            document.getElementById('eventsPageTitle').value = eventsPageSettings.pageTitle || 'KESNNUR Events';
            document.getElementById('eventsHeroTitle').value = eventsPageSettings.heroTitle || 'KESNNUR Events';
            document.getElementById('eventsHeroDesc').value = eventsPageSettings.heroDescription || 'Join our upcoming events and training sessions';
        } else {
            // Set defaults
            eventsPageSettings = {
                pageTitle: 'KESNNUR Events',
                heroTitle: 'KESNNUR Events',
                heroDescription: 'Join our upcoming events and training sessions'
            };
        }
        
        // Load events for HTML generation
        const events = await fetchFromSupabase('events', '?order=start_date.desc&limit=50');
        currentEvents = events || [];
        
        // Generate default HTML if editor is empty
        if (!document.getElementById('eventsHtmlEditor').value.trim() && events.length > 0) {
            generateDefaultEventsHtml(events);
        }
        
    } catch (error) {
        console.error('Error loading events page settings:', error);
        showNotification('Error loading page settings', 'error');
    }
}

// Generate default events HTML
function generateDefaultEventsHtml(events) {
    const now = new Date();
    const upcomingEvents = events.filter(e => {
        const startDate = new Date(e.start_date);
        return e.status === 'published' && startDate > now;
    });
    
    const pastEvents = events.filter(e => {
        const endDate = new Date(e.end_date);
        return endDate < now;
    });
    
    const defaultHtml = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${eventsPageSettings.pageTitle || 'KESNNUR Events'}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: #1e293b; }
        
        /* Header Styles */
        .events-header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 60px 20px; text-align: center; }
        .events-header h1 { font-size: 3rem; font-weight: 700; margin-bottom: 20px; }
        .events-header p { font-size: 1.2rem; max-width: 600px; margin: 0 auto 30px; opacity: 0.9; }
        
        /* Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        /* Event Cards */
        .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; margin: 40px 0; }
        .event-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .event-card:hover { transform: translateY(-5px); }
        .event-image { height: 200px; width: 100%; object-fit: cover; }
        .event-content { padding: 25px; }
        .event-date { display: flex; align-items: center; color: #3b82f6; font-weight: 600; margin-bottom: 10px; }
        .event-date i { margin-right: 8px; }
        .event-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 10px; color: #1e293b; }
        .event-desc { color: #64748b; margin-bottom: 20px; line-height: 1.6; }
        .event-details { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .event-type { background: #f0f9ff; color: #0369a1; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }
        .event-fee { font-weight: 700; color: #059669; }
        
        /* Sections */
        .section-title { font-size: 2rem; font-weight: 700; margin: 60px 0 30px; text-align: center; }
        .no-events { text-align: center; padding: 40px; color: #64748b; }
        
        /* Calendar */
        .calendar-section { background: #f8fafc; padding: 60px 20px; border-radius: 20px; margin: 40px 0; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .events-grid { grid-template-columns: 1fr; }
            .events-header h1 { font-size: 2.2rem; }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="events-header">
        <div class="container">
            <h1>${eventsPageSettings.heroTitle || 'KESNNUR Events'}</h1>
            <p>${eventsPageSettings.heroDescription || 'Join our upcoming events and training sessions'}</p>
            <div style="margin-top: 30px;">
                <button style="background: white; color: #1e3a8a; border: none; padding: 12px 30px; border-radius: 30px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-right: 15px;">
                    View Calendar
                </button>
                <button style="background: transparent; color: white; border: 2px solid white; padding: 12px 30px; border-radius: 30px; font-weight: 600; font-size: 1rem; cursor: pointer;">
                    Suggest Event
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Upcoming Events -->
        <section>
            <h2 class="section-title">Upcoming Events</h2>
            ${upcomingEvents.length > 0 ? `
                <div class="events-grid">
                    ${upcomingEvents.map(event => `
                        <div class="event-card">
                            ${event.image_url ? `
                                <img src="${event.image_url}" alt="${event.title}" class="event-image">
                            ` : `
                                <div style="background: linear-gradient(135deg, #3b82f6, #1e3a8a); height: 200px; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                            `}
                            <div class="event-content">
                                <div class="event-date">
                                    <i class="fas fa-calendar"></i>
                                    ${new Date(event.start_date).toLocaleDateString('en-US', { 
                                        weekday: 'short', 
                                        month: 'short', 
                                        day: 'numeric',
                                        year: 'numeric' 
                                    })}
                                </div>
                                <h3 class="event-title">${event.title}</h3>
                                <p class="event-desc">${event.description ? event.description.substring(0, 150) + '...' : 'No description available'}</p>
                                <div class="event-details">
                                    <span class="event-type">${event.event_type || 'Event'}</span>
                                    <span class="event-fee">${event.fee_amount ? `${event.fee_amount} ${event.fee_currency || 'KES'}` : 'Free'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div class="no-events">
                    <i class="fas fa-calendar-times" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 20px;"></i>
                    <h3>No upcoming events scheduled</h3>
                    <p>Check back soon for new events!</p>
                </div>
            `}
        </section>

        <!-- Past Events -->
        ${pastEvents.length > 0 ? `
            <section>
                <h2 class="section-title">Past Events</h2>
                <div class="events-grid">
                    ${pastEvents.slice(0, 6).map(event => `
                        <div class="event-card" style="opacity: 0.8;">
                            ${event.image_url ? `
                                <img src="${event.image_url}" alt="${event.title}" class="event-image" style="filter: grayscale(30%);">
                            ` : `
                                <div style="background: #e5e7eb; height: 200px; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 3rem;">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                            `}
                            <div class="event-content">
                                <div class="event-date" style="color: #6b7280;">
                                    <i class="fas fa-calendar"></i>
                                    ${new Date(event.start_date).toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric',
                                        year: 'numeric' 
                                    })}
                                </div>
                                <h3 class="event-title">${event.title}</h3>
                                <p class="event-desc">${event.description ? event.description.substring(0, 100) + '...' : 'No description available'}</p>
                                <div class="event-details">
                                    <span class="event-type" style="background: #f3f4f6; color: #6b7280;">${event.event_type || 'Event'}</span>
                                    <span style="color: #6b7280; font-style: italic;">Completed</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </section>
        ` : ''}

        <!-- CTA Section -->
        <section style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 60px; border-radius: 20px; text-align: center; margin: 60px 0;">
            <h2 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 20px;">Want to Host an Event?</h2>
            <p style="font-size: 1.2rem; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                Partner with KESNNUR to organize training, workshops, or conferences.
            </p>
            <button style="background: white; color: #059669; border: none; padding: 15px 40px; border-radius: 30px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
                Contact Us About Events
            </button>
        </section>
    </main>

    <footer style="background: #1e293b; color: white; padding: 60px 20px; text-align: center;">
        <div class="container">
            <h3 style="font-size: 1.8rem; margin-bottom: 20px;">KESNNUR Events</h3>
            <p style="color: #cbd5e1; max-width: 600px; margin: 0 auto 30px;">
                Professional training and events for nursing and research professionals.
            </p>
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 30px;">
                <a href="#" style="color: white; text-decoration: none;">
                    <i class="fab fa-facebook fa-2x"></i>
                </a>
                <a href="#" style="color: white; text-decoration: none;">
                    <i class="fab fa-twitter fa-2x"></i>
                </a>
                <a href="#" style="color: white; text-decoration: none;">
                    <i class="fab fa-linkedin fa-2x"></i>
                </a>
                <a href="#" style="color: white; text-decoration: none;">
                    <i class="fab fa-instagram fa-2x"></i>
                </a>
            </div>
            <p style="color: #94a3b8; font-size: 0.9rem;">
                &copy; ${new Date().getFullYear()} KESNNUR. All rights reserved.
            </p>
        </div>
    </footer>

    <script>
        // Simple interactivity
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers to event cards
            document.querySelectorAll('.event-card').forEach(card => {
                card.addEventListener('click', function() {
                    alert('Event details would open here');
                });
            });
            
            // Update current year in footer
            document.querySelector('footer p').innerHTML = 
                '&copy; ' + new Date().getFullYear() + ' KESNNUR. All rights reserved.';
        });
    </script>
</body>
</html>`;
    
    document.getElementById('eventsHtmlEditor').value = defaultHtml;
    currentEventHtml = defaultHtml;
}

// Save events HTML
async function saveEventsHtml() {
    const htmlContent = document.getElementById('eventsHtmlEditor').value.trim();
    
    if (!htmlContent) {
        showNotification('Please enter some HTML content', 'error');
        return;
    }
    
    try {
        const result = await insertOrUpdateSupabase('settings', {
            key: 'events_page_html',
            value: htmlContent,
            updated_at: new Date().toISOString()
        }, 'key');
        
        currentEventHtml = htmlContent;
        showNotification('HTML saved successfully!', 'success');
        
        // Also update the events.html file
        await updateEventsPageFile(htmlContent);
    } catch (error) {
        console.error('Error saving HTML:', error);
        showNotification('Error saving HTML. Please try again.', 'error');
    }
}

// Save events page settings
async function saveEventsPageSettings() {
    const pageSettings = {
        pageTitle: document.getElementById('eventsPageTitle').value,
        heroTitle: document.getElementById('eventsHeroTitle').value,
        heroDescription: document.getElementById('eventsHeroDesc').value,
        updated_at: new Date().toISOString()
    };
    
    try {
        await insertOrUpdateSupabase('settings', {
            key: 'events_page_settings',
            value: JSON.stringify(pageSettings),
            updated_at: new Date().toISOString()
        }, 'key');
        
        eventsPageSettings = pageSettings;
        showNotification('Page settings saved successfully!', 'success');
    } catch (error) {
        console.error('Error saving page settings:', error);
        showNotification('Error saving settings. Please try again.', 'error');
    }
}

// Update events.html file
async function updateEventsPageFile(htmlContent) {
    try {
        // This function would typically save the HTML to an actual file
        // For now, we'll just update the preview
        console.log('Events page HTML updated:', htmlContent.length, 'characters');
        
        // In a real implementation, you might:
        // 1. Save to a local file using a server-side endpoint
        // 2. Update a template in your static site generator
        // 3. Push to a Git repository
        
        showNotification('Events page updated (preview only - file not saved)', 'info');
    } catch (error) {
        console.error('Error updating events page file:', error);
        showNotification('Error updating page file', 'error');
    }
}

// Load HTML section
function loadHtmlSection(section) {
    const editor = document.getElementById('eventsHtmlEditor');
    const currentHtml = editor.value;
    
    // Extract section from current HTML
    let sectionHtml = '';
    
    switch (section) {
        case 'hero':
            sectionHtml = extractHtmlSection(currentHtml, 'events-header');
            break;
        case 'calendar':
            sectionHtml = extractHtmlSection(currentHtml, 'calendar-section');
            break;
        case 'upcoming':
            sectionHtml = extractHtmlSection(currentHtml, 'Upcoming Events');
            break;
        case 'past':
            sectionHtml = extractHtmlSection(currentHtml, 'Past Events');
            break;
        case 'cta':
            sectionHtml = extractHtmlSection(currentHtml, 'Want to Host an Event');
            break;
        case 'footer':
            sectionHtml = extractHtmlSection(currentHtml, '<footer');
            break;
        default:
            editor.value = currentEventHtml;
            return;
    }
    
    if (sectionHtml) {
        editor.value = sectionHtml;
    } else {
        showNotification(`Section "${section}" not found in current HTML`, 'warning');
    }
}

// Extract HTML section
function extractHtmlSection(html, identifier) {
    if (identifier.startsWith('<')) {
        // Tag-based extraction
        const startIndex = html.indexOf(identifier);
        if (startIndex === -1) return '';
        
        let depth = 0;
        let endIndex = startIndex;
        const tagName = identifier.match(/<(\w+)/)[1];
        
        for (let i = startIndex; i < html.length; i++) {
            if (html.substring(i, i + tagName.length + 2) === `<${tagName}`) {
                depth++;
            } else if (html.substring(i, i + tagName.length + 3) === `</${tagName}`) {
                depth--;
                if (depth === 0) {
                    endIndex = i + tagName.length + 3;
                    break;
                }
            }
        }
        
        return html.substring(startIndex, endIndex);
    } else {
        // Text-based extraction
        const startIndex = html.indexOf(`<!-- ${identifier} -->`) !== -1 
            ? html.indexOf(`<!-- ${identifier} -->`)
            : html.indexOf(`<h2[^>]*>${identifier}</h2>`);
        
        if (startIndex === -1) return '';
        
        // Find the next section
        const nextSection = html.indexOf('<h2 class="section-title"', startIndex + 1);
        if (nextSection !== -1) {
            return html.substring(startIndex, nextSection);
        }
        
        return html.substring(startIndex);
    }
}

// Load selected HTML section
function loadSelectedHtmlSection() {
    const section = document.getElementById('htmlSectionSelect').value;
    if (section === 'full') {
        document.getElementById('eventsHtmlEditor').value = currentEventHtml;
    } else if (section) {
        loadHtmlSection(section);
    }
}

// Load current events HTML
function loadCurrentEventsHtml() {
    const events = currentEvents;
    generateDefaultEventsHtml(events);
}

// Preview events HTML
function previewEventsHtml() {
    const htmlContent = document.getElementById('eventsHtmlEditor').value;
    
    // Create a blob and URL for the HTML content
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    // Open in new tab
    window.open(url, '_blank');
    
    // Also show in preview modal
    document.getElementById('htmlPreviewContent').textContent = htmlContent;
    document.getElementById('htmlPreviewModal').style.display = 'flex';
}

// Close HTML preview modal
function closeHtmlPreviewModal() {
    document.getElementById('htmlPreviewModal').style.display = 'none';
}

// Reset events HTML to default
function resetEventsHtml() {
    if (confirm('Are you sure you want to reset the HTML to default? This will overwrite your current changes.')) {
        generateDefaultEventsHtml(currentEvents);
        showNotification('HTML reset to default', 'info');
    }
}

// Refresh events preview
function refreshEventsPreview() {
    const previewFrame = document.getElementById('eventsPreviewFrame');
    previewFrame.src = previewFrame.src; // Reload the iframe
}

// Open events page
function openEventsPage() {
    window.location.href = 'events.html';
}

// Open events page in new tab
function openEventsPageNewTab() {
    window.open('events.html', '_blank');
}

// Initialize events page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Set up event form submission
    const eventForm = document.getElementById('eventForm');
    if (eventForm) {
        eventForm.addEventListener('submit', handleEventFormSubmit);
    }
    
    // Set up search input
    const eventSearch = document.getElementById('eventSearch');
    if (eventSearch) {
        eventSearch.addEventListener('input', filterEvents);
    }
    
    // Show manage tab by default
    showEventsTab('manage');
});
      // Load blog section settings
async function loadBlogSectionSettings() {
    try {
        const settings = await fetchFromSupabase('system_settings', '?category=eq.home_page&setting_key=like.blog%');
        
        if (settings && settings.length > 0) {
            settings.forEach(setting => {
                if (setting.setting_key === 'blog_section_title') {
                    document.getElementById('blogSectionTitle').value = setting.setting_value || '';
                } else if (setting.setting_key === 'blog_section_subtitle') {
                    document.getElementById('blogSectionSubtitle').value = setting.setting_value || '';
                } else if (setting.setting_key === 'blog_view_all_text') {
                    document.getElementById('blogViewAllText').value = setting.setting_value || '';
                }
            });
        }
        
        // Load current blog posts
        loadCurrentBlogPosts();
        
        // Load blog stats
        loadBlogStats();
        
    } catch (error) {
        console.error('Error loading blog settings:', error);
        showNotification('Error loading blog settings', 'error');
    }
}

// Save blog settings
async function saveBlogSettings() {
    const settings = [
        {
            category: 'home_page',
            setting_key: 'blog_section_title',
            setting_value: document.getElementById('blogSectionTitle').value
        },
        {
            category: 'home_page',
            setting_key: 'blog_section_subtitle',
            setting_value: document.getElementById('blogSectionSubtitle').value
        },
        {
            category: 'home_page',
            setting_key: 'blog_view_all_text',
            setting_value: document.getElementById('blogViewAllText').value
        }
    ];
    
    try {
        for (const setting of settings) {
            await saveSystemSetting(setting.category, setting.setting_key, setting.setting_value);
        }
        showNotification('Blog settings saved successfully!', 'success');
        
        // Update live preview
        updateLivePreview();
        
    } catch (error) {
        console.error('Error saving blog settings:', error);
        showNotification('Error saving blog settings', 'error');
    }
}

// Load current blog posts
async function loadCurrentBlogPosts() {
    const container = document.getElementById('currentBlogPosts');
    if (!container) return;
    
    container.innerHTML = `
        <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-900 mb-4"></div>
            <p class="text-gray-600">Loading blog posts...</p>
        </div>
    `;
    
    try {
        const posts = await fetchFromSupabase('blog_posts', '?status=eq.published&order=published_at.desc&limit=3');
        
        if (posts && posts.length > 0) {
            let html = '<div style="display:grid; gap:15px;">';
            
            posts.forEach(post => {
                const date = post.published_at ? new Date(post.published_at) : new Date();
                const formattedDate = date.toLocaleDateString('en-US');
                
                html += `
                    <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:15px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div>
                                <h4 style="font-weight:600; margin-bottom:5px;">${post.title}</h4>
                                <div style="display:flex; gap:10px; font-size:13px; color:#6b7280;">
                                    <span><i class="far fa-calendar mr-1"></i>${formattedDate}</span>
                                    <span><i class="fas fa-tag mr-1"></i>${post.category || 'Uncategorized'}</span>
                                    <span><i class="fas fa-user mr-1"></i>${post.author || 'Anonymous'}</span>
                                </div>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button onclick="editBlogPost('${post.id}')" style="padding:6px 12px; background:#3b82f6; color:white; border:none; border-radius:4px; font-size:12px; cursor:pointer;">
                                    Edit
                                </button>
                                <button onclick="toggleBlogPostStatus('${post.id}', '${post.status}')" style="padding:6px 12px; background:#10b981; color:white; border:none; border-radius:4px; font-size:12px; cursor:pointer;">
                                    ${post.status === 'published' ? 'Unpublish' : 'Publish'}
                                </button>
                            </div>
                        </div>
                        <p style="color:#4b5563; font-size:14px; margin-bottom:10px;">${post.excerpt || 'No excerpt available'}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px;">
                            <span style="color:#6b7280;">ID: ${post.id.substring(0, 8)}...</span>
                            <span style="color:#059669; font-weight:600;">
                                <i class="fas fa-eye mr-1"></i>${post.views || 0} views
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
        } else {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-newspaper text-4xl text-gray-400 mb-4"></i>
                    <h4 class="font-semibold text-gray-600 mb-2">No Published Posts</h4>
                    <p class="text-gray-500 text-sm">Create your first blog post to display here.</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading blog posts:', error);
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h4 class="font-semibold text-gray-600 mb-2">Error Loading Posts</h4>
                <p class="text-gray-500 text-sm">Could not connect to database.</p>
            </div>
        `;
    }
}

// Load blog statistics
async function loadBlogStats() {
    const container = document.getElementById('blogStats');
    if (!container) return;
    
    try {
        const [totalPosts, publishedPosts, draftPosts] = await Promise.all([
            fetchFromSupabase('blog_posts', '?select=count'),
            fetchFromSupabase('blog_posts', '?status=eq.published&select=count'),
            fetchFromSupabase('blog_posts', '?status=eq.draft&select=count')
        ]);
        
        const total = totalPosts && totalPosts[0] ? totalPosts[0].count : 0;
        const published = publishedPosts && publishedPosts[0] ? publishedPosts[0].count : 0;
        const draft = draftPosts && draftPosts[0] ? draftPosts[0].count : 0;
        
        container.innerHTML = `
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px; text-align:center;">
                <div>
                    <div style="font-size:24px; font-weight:700; color:#1e3a8a;">${total}</div>
                    <div style="font-size:13px; color:#6b7280;">Total Posts</div>
                </div>
                <div>
                    <div style="font-size:24px; font-weight:700; color:#10b981;">${published}</div>
                    <div style="font-size:13px; color:#6b7280;">Published</div>
                </div>
                <div>
                    <div style="font-size:24px; font-weight:700; color:#f59e0b;">${draft}</div>
                    <div style="font-size:13px; color:#6b7280;">Draft</div>
                </div>
            </div>
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #e5e7eb;">
                <div style="font-size:13px; color:#6b7280; text-align:center;">
                    <i class="fas fa-info-circle mr-1"></i>
                    Homepage shows 3 most recent published posts
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading blog stats:', error);
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                <span class="text-gray-600">Could not load statistics</span>
            </div>
        `;
    }
}

// Show add blog post modal
function showAddBlogPostModal() {
    document.getElementById('addBlogPostModal').style.display = 'flex';
}

// Close add blog post modal
function closeAddBlogPostModal() {
    document.getElementById('addBlogPostModal').style.display = 'none';
    // Clear form
    document.getElementById('newBlogTitle').value = '';
    document.getElementById('newBlogCategory').value = '';
    document.getElementById('newBlogAuthor').value = '';
    document.getElementById('newBlogExcerpt').value = '';
    document.getElementById('newBlogPublished').checked = true;
}

// Create new blog post
async function createBlogPost() {
    const title = document.getElementById('newBlogTitle').value.trim();
    const category = document.getElementById('newBlogCategory').value;
    const author = document.getElementById('newBlogAuthor').value.trim();
    const excerpt = document.getElementById('newBlogExcerpt').value.trim();
    const isPublished = document.getElementById('newBlogPublished').checked;
    
    if (!title) {
        showNotification('Please enter a title', 'error');
        return;
    }
    
    // Generate slug from title
    const slug = title.toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
    
    const postData = {
        title: title,
        slug: slug,
        category: category || null,
        author: author || 'KESNNUR Team',
        excerpt: excerpt || null,
        status: isPublished ? 'published' : 'draft',
        published_at: isPublished ? new Date().toISOString() : null,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
    };
    
    try {
           const SUPABASE_URL = 'https://noadhwqvaxajuckpibbo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWRod3F2YXhhanVja3BpYmJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDk0MDEsImV4cCI6MjA4NTY4NTQwMX0.tFqnonlgPjmcgC5KOiSriISFFE5FbdBrsVzsxURrbAw';
        const response = await fetch(`${SUPABASE_URL}/rest/v1/blog_posts`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(postData)
        });
        
        if (response.ok) {
            showNotification('Blog post created successfully!', 'success');
            closeAddBlogPostModal();
            loadCurrentBlogPosts();
            loadBlogStats();
        } else {
            throw new Error('Failed to create post');
        }
        
    } catch (error) {
        console.error('Error creating blog post:', error);
        showNotification('Error creating blog post', 'error');
    }
}

// Other helper functions
function editBlogPost(postId) {
    // Redirect to blog editor with post ID
    showSection('blog');
    // You can implement this to auto-load the post in blog editor
    setTimeout(() => {
        if (window.loadBlogPostForEditing) {
            window.loadBlogPostForEditing(postId);
        }
    }, 500);
}

async function toggleBlogPostStatus(postId, currentStatus) {
    const newStatus = currentStatus === 'published' ? 'draft' : 'published';
    
    try {
        const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/blog_posts?id=eq.${postId}`, {
            method: 'PATCH',
            headers: {
                'apikey': CONFIG.SUPABASE_KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                status: newStatus,
                published_at: newStatus === 'published' ? new Date().toISOString() : null,
                updated_at: new Date().toISOString()
            })
        });
        
        if (response.ok) {
            showNotification(`Post ${newStatus === 'published' ? 'published' : 'unpublished'}`, 'success');
            loadCurrentBlogPosts();
            loadBlogStats();
        } else {
            throw new Error('Failed to update status');
        }
        
    } catch (error) {
        console.error('Error toggling post status:', error);
        showNotification('Error updating post status', 'error');
    }
}

function viewAllBlogPosts() {
    showSection('blog');
}

async function checkBlogStatus() {
    try {
        const posts = await fetchFromSupabase('blog_posts', '?select=id,title,status');
        const published = posts.filter(p => p.status === 'published').length;
        const draft = posts.filter(p => p.status === 'draft').length;
        
        showNotification(`Status: ${published} published, ${draft} draft posts`, 'info');
    } catch (error) {
        showNotification('Error checking blog status', 'error');
    }
}
        
        async function loadResourcesPage() {
            console.log("Loading resources page...");
            const container = document.getElementById('resourcesList');
            container.innerHTML = `
                <div style="border:1px solid #e5e7eb; border-radius:8px; padding:15px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>Nursing Handbook 2024</strong>
                            <p style="color:#6b7280; margin-top:5px;">PDF • 2.4 MB</p>
                        </div>
                        <div>
                            <span style="padding:3px 8px; background:#f3f4f6; color:#374151; border-radius:12px; font-size:12px;">Download</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadContactPage() {
            console.log("Loading contact page...");
            // Try to load from system_settings
            try {
                const { data: settings, error } = await cmsSupabase
                    .from('system_settings')
                    .select('setting_key, setting_value')
                    .eq('category', 'contact_page');
                
                if (!error && settings) {
                    settings.forEach(setting => {
                        switch(setting.setting_key) {
                            case 'contact_email':
                                document.getElementById('contactEmail').value = setting.setting_value || "info@kesnnur.org";
                                break;
                            case 'contact_phone':
                                document.getElementById('contactPhone').value = setting.setting_value || "+254 700 000 000";
                                break;
                            case 'contact_address':
                                document.getElementById('contactAddress').value = setting.setting_value || "Nairobi, Kenya";
                                break;
                        }
                    });
                }
            } catch (error) {
                // Set default values
                document.getElementById('contactEmail').value = "info@kesnnur.org";
                document.getElementById('contactPhone').value = "+254 700 000 000";
                document.getElementById('contactAddress').value = "Nairobi, Kenya";
            }
        }
        
        async function saveContactPage() {
            const contactEmail = document.getElementById('contactEmail').value;
            const contactPhone = document.getElementById('contactPhone').value;
            const contactAddress = document.getElementById('contactAddress').value;
            
            const settings = [
                { setting_key: 'contact_email', setting_value: contactEmail, category: 'contact_page' },
                { setting_key: 'contact_phone', setting_value: contactPhone, category: 'contact_page' },
                { setting_key: 'contact_address', setting_value: contactAddress, category: 'contact_page' }
            ];
            
            try {
                for (const setting of settings) {
                    await cmsSupabase
                        .from('system_settings')
                        .upsert({
                            setting_key: setting.setting_key,
                            setting_value: setting.setting_value,
                            category: setting.category,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'setting_key' });
                }
                
                alert('Contact page saved successfully!');
            } catch (error) {
                alert('Error saving: ' + error.message);
            }
        }
        
        // Image upload handler
        document.getElementById('homeImageInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                alert('Image selected: ' + file.name + '\n\nNote: For production, implement Supabase Storage upload.');
            }
        });
        
        // Initialize first tab
        setTimeout(() => {
            const firstTab = document.querySelector('.home-tab');
            if (firstTab) {
                firstTab.style.display = 'block';
                firstTab.classList.add('active');
            }
            
            const firstTabBtn = document.querySelector('.tab-button');
            if (firstTabBtn) {
                firstTabBtn.classList.add('active');
            }
        }, 100);
    </script>
</body>
</html>
